<!doctype html>
<html lang="en">
    <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Implementing Python Decorators as a thought-experiment in PHP">

    <title>
        
            Implementing Basic Python Decorators in PHP &middot; Edd Mann
        
    </title>

    <link rel="stylesheet" href="//fonts.googleapis.com/css?family=Source+Sans+Pro:400,700,700italic,400italic">
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <link rel="stylesheet" href="/styles.css">

    <link rel="shortcut icon" href="/favicon.ico">

    <link rel="alternate" href="/rss.xml" title="" type="application/rss+xml">

    

    <script>
        var _gaq=[['_setAccount','UA-32512081-1'],['_setDomainName','eddmann.com'],['_trackPageview']];
        (function() {
            var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
            ga.src = 'https://ssl.google-analytics.com/ga.js';
            var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
        })();
    </script>
</head>

    <body>
        <div class="container content">
            <header class="masthead">
                <h3 class="masthead-title">
                    <a href="/" title="Home">Edd Mann</a>
                    <small><i class="fa fa-code"></i> Developer</small>
                </h3>
                <nav>
                    <a href="https://twitter.com/edd_mann"><i class="fa fa-twitter"></i></a>
                    <a href="https://github.com/eddmann"><i class="fa fa-github"></i></a>
                    <a href="mailto:the@eddmann.com"><i class="fa fa-envelope"></i></a>
                </nav>
                <div class="cf"></div>
            </header>

            <main>
                <article class="post">
    <h1 class="post-title">Implementing Basic Python Decorators in PHP</h1>
    <time datetime="2014-02-10T00:00:00+00:00" class="post-date">10 Feb 2014</time>
    <p>Having just stepped into the world of Python I think it is only human-nature to compare, if not contemplate solutions to, discovered given strengths in a more familiar language.
My familiar language being of-course PHP, I thought it would be a good thought experiment to see if I could design a basic decorator implementation in the language.
Decorators, as discussed in <a href="/posts/using-basic-auth-and-decorators-in-pythons-flask/">another post</a>, are an easy concept to explain.
Simply put they wrap specified functions with other functions, providing a means to compose new functions in a succinct manner.</p>



<h2 id="the-implementation">The Implementation</h2>

<p>PHP provides a means to rename existing user-land functions and subsequently redefine them, by-way of an extension called <a href="http://php.net/manual/en/book.runkit.php">runkit</a>.
For the remainder of the post I will be assuming that you have a sufficient setup configured as a prerequisite.
Below is a simple function that uses the ‘runkit’ extension to rename the existing function declaration to a meaningful wrapped name, then includes this new functions name in a call to the wrapper function.
This new logic is used to redefine the pre-existing original function name.</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">function</span> <span class="n">decorate</span><span class="p">(</span><span class="nv">$func</span><span class="p">,</span> <span class="nv">$wrap</span><span class="p">)</span>
<span class="p">{</span>
    <span class="nv">$orig</span> <span class="o">=</span> <span class="nv">$wrap</span> <span class="mf">.</span> <span class="s1">'_'</span> <span class="mf">.</span> <span class="nv">$func</span><span class="p">;</span>
    <span class="nb">runkit_function_rename</span><span class="p">(</span><span class="nv">$func</span><span class="p">,</span> <span class="nv">$orig</span><span class="p">);</span>
    <span class="nv">$body</span> <span class="o">=</span> <span class="nb">sprintf</span><span class="p">(</span>
        <span class="s2">"return call_user_func_array('%s', array_merge([ '%s' ], [ func_get_args() ]));"</span><span class="p">,</span>
        <span class="nv">$wrap</span><span class="p">,</span> <span class="nv">$orig</span>
    <span class="p">);</span>
    <span class="nb">runkit_function_add</span><span class="p">(</span><span class="nv">$func</span><span class="p">,</span> <span class="s1">''</span><span class="p">,</span> <span class="nv">$body</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<h2 id="example-usage">Example Usage</h2>

<p>Now that we have defined the ‘decorate’ method, lets put it to the test with an arbitrary example.
Below highlights an example which specifies a basic ‘hello’ function which we will soon hope to decorate.</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">function</span> <span class="n">hello</span><span class="p">(</span><span class="nv">$name</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">echo</span> <span class="s2">"Hello, </span><span class="nv">$name</span><span class="s2">!</span><span class="se">\n</span><span class="s2">"</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>We will now define a couple of decorator functions used to log and time the specified functions activity.
You will notice looking at the examples below that the functions require a function name and argument array to be supplied which is used to chain the calls together.</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">function</span> <span class="n">logger</span><span class="p">(</span><span class="nv">$func</span><span class="p">,</span> <span class="nv">$args</span><span class="p">)</span>
<span class="p">{</span>
    <span class="nv">$name</span> <span class="o">=</span> <span class="nb">explode</span><span class="p">(</span><span class="s1">'_'</span><span class="p">,</span> <span class="nv">$func</span><span class="p">);</span> <span class="c1">// last function invoked.</span>
    <span class="k">echo</span> <span class="nb">end</span><span class="p">(</span><span class="nv">$name</span><span class="p">)</span> <span class="mf">.</span> <span class="s1">'('</span> <span class="mf">.</span> <span class="nb">implode</span><span class="p">(</span><span class="s1">', '</span> <span class="p">,</span> <span class="nv">$args</span><span class="p">)</span> <span class="mf">.</span> <span class="s2">")</span><span class="se">\n</span><span class="s2">"</span><span class="p">;</span>
    <span class="k">return</span> <span class="nb">call_user_func_array</span><span class="p">(</span><span class="nv">$func</span><span class="p">,</span> <span class="nv">$args</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">function</span> <span class="n">timer</span><span class="p">(</span><span class="nv">$func</span><span class="p">,</span> <span class="nv">$args</span><span class="p">)</span>
<span class="p">{</span>
    <span class="nv">$start</span> <span class="o">=</span> <span class="nb">microtime</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span>
    <span class="nv">$result</span> <span class="o">=</span> <span class="nb">call_user_func_array</span><span class="p">(</span><span class="nv">$func</span><span class="p">,</span> <span class="nv">$args</span><span class="p">);</span>
    <span class="k">echo</span> <span class="nb">sprintf</span><span class="p">(</span><span class="s2">"%s: %f</span><span class="se">\n</span><span class="s2">"</span><span class="p">,</span> <span class="nv">$func</span><span class="p">,</span> <span class="nb">microtime</span><span class="p">(</span><span class="kc">true</span><span class="p">)</span> <span class="o">-</span> <span class="nv">$start</span><span class="p">);</span>
    <span class="k">return</span> <span class="nv">$result</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>With the sample function and decorators now defined we can compose a new function from these individual pieces.</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nf">decorate</span><span class="p">(</span><span class="s1">'hello'</span><span class="p">,</span> <span class="s1">'timer'</span><span class="p">);</span>
<span class="nf">decorate</span><span class="p">(</span><span class="s1">'hello'</span><span class="p">,</span> <span class="s1">'logger'</span><span class="p">);</span>

<span class="k">echo</span> <span class="nf">hello</span><span class="p">(</span><span class="s1">'Bob'</span><span class="p">);</span>
<span class="c1">// hello(Bob)</span>
<span class="c1">// Hello, Bob!</span>
<span class="c1">// timer_hello: 0.000007</span>
</code></pre></div></div>

<p>Looking at the example above you can see that we recompose the definition of the original ‘hello’ function to be wrapped by the ‘timer’ and ‘logger’ functions.
With this new function we then call it with the argument ‘Bob’ which in-turn invokes the logger and timer functions, before calling the original code.</p>

<h2 id="resources">Resources</h2>

<ul>
  <li><a href="http://php.net/manual/en/book.runkit.php">runkit</a></li>
  <li><a href="http://wiki.python.org/moin/PythonDecorators">Python: Decorators</a></li>
</ul>

</article>

            </main>

            <footer class="footer">
                <img src="https://www.gravatar.com/avatar/c5c2978bb14d16460f73399c394b6acd?s=160">
                <ul>
                    <li>Developer at <a href="http://www.mybuilder.com/">MyBuilder</a></li>
                    <li><a href="http://threedevsandamaybe.com/">Three Devs and a Maybe</a> podcast co-host</li>
                    <li>All ramblings can be found in the <a href="/archive/">Archive</a></li>
                </ul>
                <div class="cf"></div>
            </footer>
        </div>
    </body>
</html>
