<!doctype html>
<html lang="en">
    <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Learn how to create a 'Memes as a Service' platform using AWS Lambda, the Serverless Framework, and ImageMagick. A step-by-step guide with code examples.">

    <title>
        
            'Memes as a Service' using Lambda, Serverless and ImageMagick &middot; Edd Mann
        
    </title>

    <link rel="stylesheet" href="//fonts.googleapis.com/css?family=Source+Sans+Pro:400,700,700italic,400italic">
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <link rel="stylesheet" href="/styles.css">

    <link rel="shortcut icon" href="/favicon.ico">

    <link rel="alternate" href="/rss.xml" title="" type="application/rss+xml">

    

    <script>
        var _gaq=[['_setAccount','UA-32512081-1'],['_setDomainName','eddmann.com'],['_trackPageview']];
        (function() {
            var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
            ga.src = 'https://ssl.google-analytics.com/ga.js';
            var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
        })();
    </script>
</head>

    <body>
        <div class="container content">
            <header class="masthead">
                <h3 class="masthead-title">
                    <a href="/" title="Home">Edd Mann</a>
                    <small><i class="fa fa-code"></i> Developer</small>
                </h3>
                <nav>
                    <a href="https://twitter.com/edd_mann"><i class="fa fa-twitter"></i></a>
                    <a href="https://github.com/eddmann"><i class="fa fa-github"></i></a>
                    <a href="mailto:the@eddmann.com"><i class="fa fa-envelope"></i></a>
                </nav>
                <div class="cf"></div>
            </header>

            <main>
                <article class="post">
    <h1 class="post-title">'Memes as a Service' using Lambda, Serverless and ImageMagick</h1>
    <time datetime="2017-12-04T00:00:00+00:00" class="post-date">04 Dec 2017</time>
    <p>I’ve recently become really interested in the concept of Functions as a Service (FaaS) and the <a href="https://serverless.com/">Serverless Framework</a>.
I decided to create a small experimental AWS Lambda function to explore how it could be used to manipulate images.
For this contrived example, I came up with the (silly) idea of ‘Memes as a Service’ (everything needs to be a service nowadays).</p>



<p>The consumer will be able to supply top and bottom text, along with specifying the desired supporting image.
Fortunately, the stock Lambda Node.js environment comes equipped with support for the popular <a href="https://www.imagemagick.org/">ImageMagick</a>.
In this blog post, I will present how I went about solving this problem using the Serverless Framework.</p>

<h2 id="setup-and-configuration">Setup and Configuration</h2>

<p>I will assume that you already have the Serverless Framework and an AWS Access Key set up on your development machine.
With these installed, we first create a new Serverless application based on the provided template.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>serverless create <span class="nt">--template</span> aws-nodejs <span class="nt">--path</span> memes-as-a-service
</code></pre></div></div>

<p>We should now be able to navigate into the newly created <code class="language-plaintext highlighter-rouge">memes-as-a-service</code> directory.
As we want to interact with ImageMagick, we also need to include the <a href="http://aheckmann.github.io/gm/">suitable package</a> for Node.js.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>npm <span class="nb">install </span>gm <span class="nt">--save</span>
</code></pre></div></div>

<p>The next step is to open the <code class="language-plaintext highlighter-rouge">serverless.yml</code> file.
This file outlines the provider information (as the framework can handle other platforms such as <a href="https://cloud.google.com/">Google Cloud</a>), the required supporting resources, and the necessary function wiring.
Replace the sample contents of this file with the YAML definition below:</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">service</span><span class="pi">:</span> <span class="s">meme-as-a-service</span>

<span class="na">provider</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">aws</span>
  <span class="na">runtime</span><span class="pi">:</span> <span class="s">nodejs6.10</span>
  <span class="na">stage</span><span class="pi">:</span> <span class="s">prod</span>
  <span class="na">region</span><span class="pi">:</span> <span class="s">eu-west-1</span>
  <span class="na">environment</span><span class="pi">:</span>
    <span class="na">IMAGES_DIR</span><span class="pi">:</span> <span class="s">./images/</span>
    <span class="na">TEXT_SIZE</span><span class="pi">:</span> <span class="m">50</span>
    <span class="na">TEXT_PADDING</span><span class="pi">:</span> <span class="m">40</span>

<span class="na">plugins</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s">serverless-apigw-binary</span>

<span class="na">custom</span><span class="pi">:</span>
  <span class="na">apigwBinary</span><span class="pi">:</span>
    <span class="na">types</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s1">'</span><span class="s">*/*'</span>

<span class="na">functions</span><span class="pi">:</span>
  <span class="na">meme</span><span class="pi">:</span>
    <span class="na">handler</span><span class="pi">:</span> <span class="s">handler.meme</span>
    <span class="na">events</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">http</span><span class="pi">:</span>
          <span class="na">path</span><span class="pi">:</span> <span class="s">/</span>
          <span class="na">method</span><span class="pi">:</span> <span class="s">get</span>
</code></pre></div></div>

<p>In this definition, we configure an AWS Lambda Node.js-based container.
We provide a couple of environment variables that will be accessible within our function implementations.
We then use a <a href="https://github.com/maciejtreder/serverless-apigw-binary">Serverless plugin</a> to correctly add the required binary support to the API Gateway.
Finally, we define the single function, taking advantage of how the framework integrates with <a href="https://aws.amazon.com/cloudformation/">CloudFormation</a> to correctly wire it up to <a href="https://aws.amazon.com/api-gateway/">API Gateway</a>.
Before continuing, we should include the Serverless plugin as a development dependency.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>npm <span class="nb">install </span>serverless-apigw-binary <span class="nt">--save-dev</span>
</code></pre></div></div>

<h2 id="implementation">Implementation</h2>

<p>Now, with the blueprint in place, we can create the implementation.
Replace the sample <code class="language-plaintext highlighter-rouge">handler.js</code> contents with the following:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="dl">'</span><span class="s1">use strict</span><span class="dl">'</span><span class="p">;</span>

<span class="kd">const</span> <span class="nx">gm</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">gm</span><span class="dl">'</span><span class="p">).</span><span class="nx">subClass</span><span class="p">({</span> <span class="na">imageMagick</span><span class="p">:</span> <span class="kc">true</span> <span class="p">});</span>
<span class="kd">const</span> <span class="nx">fs</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">fs</span><span class="dl">'</span><span class="p">);</span>

<span class="kd">const</span> <span class="p">{</span> <span class="nx">IMAGES_DIR</span><span class="p">,</span> <span class="nx">TEXT_SIZE</span><span class="p">,</span> <span class="nx">TEXT_PADDING</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">;</span>

<span class="kd">const</span> <span class="nx">parseText</span> <span class="o">=</span> <span class="nx">text</span> <span class="o">=&gt;</span> <span class="p">(</span><span class="nx">text</span> <span class="o">||</span> <span class="dl">''</span><span class="p">).</span><span class="nx">toUpperCase</span><span class="p">();</span>
<span class="kd">const</span> <span class="nx">getImages</span> <span class="o">=</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="nx">fs</span><span class="p">.</span><span class="nx">readdirSync</span><span class="p">(</span><span class="nx">IMAGES_DIR</span><span class="p">);</span>
<span class="kd">const</span> <span class="nx">parseImage</span> <span class="o">=</span> <span class="nx">image</span> <span class="o">=&gt;</span> <span class="nx">getImages</span><span class="p">().</span><span class="nx">find</span><span class="p">(</span><span class="nx">file</span> <span class="o">=&gt;</span> <span class="nx">file</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">image</span><span class="p">)</span> <span class="o">===</span> <span class="mi">0</span><span class="p">);</span>
<span class="kd">const</span> <span class="nx">random</span> <span class="o">=</span> <span class="nx">arr</span> <span class="o">=&gt;</span> <span class="nx">arr</span><span class="p">[</span><span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span><span class="p">(</span><span class="nb">Math</span><span class="p">.</span><span class="nx">random</span><span class="p">()</span> <span class="o">*</span> <span class="nx">arr</span><span class="p">.</span><span class="nx">length</span><span class="p">)];</span>
<span class="kd">const</span> <span class="nx">randomImage</span> <span class="o">=</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="nx">random</span><span class="p">(</span><span class="nx">getImages</span><span class="p">());</span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span><span class="p">.</span><span class="nx">meme</span> <span class="o">=</span> <span class="p">(</span><span class="nx">event</span><span class="p">,</span> <span class="nx">context</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="nx">input</span> <span class="o">=</span> <span class="nx">event</span><span class="p">.</span><span class="nx">queryStringParameters</span> <span class="o">||</span> <span class="p">{};</span>

  <span class="kd">const</span> <span class="nx">top</span> <span class="o">=</span> <span class="nx">parseText</span><span class="p">(</span><span class="nx">input</span><span class="p">.</span><span class="nx">top</span><span class="p">);</span>
  <span class="kd">const</span> <span class="nx">bottom</span> <span class="o">=</span> <span class="nx">parseText</span><span class="p">(</span><span class="nx">input</span><span class="p">.</span><span class="nx">bottom</span><span class="p">);</span>
  <span class="kd">const</span> <span class="nx">image</span> <span class="o">=</span> <span class="nx">parseImage</span><span class="p">(</span><span class="nx">input</span><span class="p">.</span><span class="nx">image</span><span class="p">)</span> <span class="o">||</span> <span class="nx">randomImage</span><span class="p">();</span>

  <span class="kd">const</span> <span class="nx">meme</span> <span class="o">=</span> <span class="nx">gm</span><span class="p">(</span><span class="s2">`</span><span class="p">${</span><span class="nx">IMAGES_DIR</span><span class="p">}${</span><span class="nx">image</span><span class="p">}</span><span class="s2">`</span><span class="p">);</span>

  <span class="nx">meme</span><span class="p">.</span><span class="nx">size</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="p">{</span> <span class="nx">height</span> <span class="p">})</span> <span class="p">{</span>
    <span class="nx">meme</span>
      <span class="p">.</span><span class="nx">font</span><span class="p">(</span><span class="dl">'</span><span class="s1">./impact.ttf</span><span class="dl">'</span><span class="p">,</span> <span class="nx">TEXT_SIZE</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">fill</span><span class="p">(</span><span class="dl">'</span><span class="s1">white</span><span class="dl">'</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">stroke</span><span class="p">(</span><span class="dl">'</span><span class="s1">black</span><span class="dl">'</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">drawText</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="p">(</span><span class="nx">height</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">-</span> <span class="nx">TEXT_PADDING</span><span class="p">),</span> <span class="nx">top</span><span class="p">,</span> <span class="dl">'</span><span class="s1">center</span><span class="dl">'</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">drawText</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nx">height</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">-</span> <span class="nx">TEXT_PADDING</span><span class="p">,</span> <span class="nx">bottom</span><span class="p">,</span> <span class="dl">'</span><span class="s1">center</span><span class="dl">'</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">toBuffer</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">buffer</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">callback</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="p">{</span>
          <span class="na">statusCode</span><span class="p">:</span> <span class="mi">200</span><span class="p">,</span>
          <span class="na">headers</span><span class="p">:</span> <span class="p">{</span> <span class="dl">'</span><span class="s1">Content-Type</span><span class="dl">'</span><span class="p">:</span> <span class="dl">'</span><span class="s1">image/jpeg</span><span class="dl">'</span> <span class="p">},</span>
          <span class="na">body</span><span class="p">:</span> <span class="nx">buffer</span><span class="p">.</span><span class="nx">toString</span><span class="p">(</span><span class="dl">'</span><span class="s1">base64</span><span class="dl">'</span><span class="p">),</span>
          <span class="na">isBase64Encoded</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
        <span class="p">});</span>
      <span class="p">});</span>
  <span class="p">});</span>
<span class="p">};</span>
</code></pre></div></div>

<p>The function takes the query string input from the client and uses ImageMagick to add the provided text at the top and bottom of the selected image.
The Lambda function contains a directory (specified in the environment variables) of all available images that the client can choose from.
We also include the font in the distribution that we want to use for the text.
An interesting aspect is the Base64 encoding of the image response.
API Gateway supports <a href="https://aws.amazon.com/about-aws/whats-new/2016/11/binary-data-now-supported-by-api-gateway/">binary responses</a>, but to enable this, we must provide the <code class="language-plaintext highlighter-rouge">isBase64Encoded</code> flag along with the correct <code class="language-plaintext highlighter-rouge">Content-Type</code>.
We previously configured the media types that we want to be treated as binary within API Gateway using the added plugin.
Since the framework configures each API Gateway route to be in proxy mode by default, this is all we need to return the generated content.</p>

<h2 id="deployment">Deployment</h2>

<p>Finally, we can test this service by running:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>serverless deploy <span class="nt">-v</span>
</code></pre></div></div>

<p>I always use the <code class="language-plaintext highlighter-rouge">verbose</code> flag as it provides useful insight into what is happening within the framework under the hood.
Once deployed, you can visit the resulting API Gateway endpoint and experiment with generating your own memes!
You can find the complete code, along with supporting assets, in <a href="https://github.com/eddmann/memes-as-a-service-serverless">this</a> GitHub repository.</p>

<p><img src="/uploads/memes-as-a-service/memes.jpg" alt="Memes as a Service" /></p>

</article>

            </main>

            <footer class="footer">
                <img src="https://www.gravatar.com/avatar/c5c2978bb14d16460f73399c394b6acd?s=160">
                <ul>
                    <li>Developer at <a href="http://www.mybuilder.com/">MyBuilder</a></li>
                    <li><a href="http://threedevsandamaybe.com/">Three Devs and a Maybe</a> podcast co-host</li>
                    <li>All ramblings can be found in the <a href="/archive/">Archive</a></li>
                </ul>
                <div class="cf"></div>
            </footer>
        </div>
    </body>
</html>
