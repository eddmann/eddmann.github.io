<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><title>Designing Immutable Concepts with Transient Mutation in PHP - Edd Mann</title>
<meta name=description content="Explore how transient mutation can optimise immutable concepts in PHP, improving performance while maintaining immutability."><meta name=author content="Edd Mann"><script async src="https://www.googletagmanager.com/gtag/js?id=G-ZPQ7WHNXH4"></script><script>var dnt,doNotTrack=!1;if(!1&&(dnt=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,doNotTrack=dnt=="1"||dnt=="yes"),!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-ZPQ7WHNXH4")}</script><meta itemprop=name content="Designing Immutable Concepts with Transient Mutation in PHP"><meta itemprop=description content="In a recent project, we found it beneficial to introduce the Money pattern. There are many good resources on this pattern, so I will defer to those for further definition. We decided that encapsulating this into an immutable value object allowed for a cleaner API and removed the fear of unexpected mutation bugs. However, we noticed a spike in memory and processor usage when performing many successive actions on such values, such as summation."><meta itemprop=datePublished content="2016-12-14T00:00:00+00:00"><meta itemprop=dateModified content="2016-12-14T00:00:00+00:00"><meta itemprop=wordCount content="479"><meta itemprop=keywords content="Php"><meta property="og:url" content="https://eddmann.com/posts/designing-immutable-concepts-with-transient-mutation-in-php/"><meta property="og:site_name" content="Edd Mann"><meta property="og:title" content="Designing Immutable Concepts with Transient Mutation in PHP"><meta property="og:description" content="In a recent project, we found it beneficial to introduce the Money pattern. There are many good resources on this pattern, so I will defer to those for further definition. We decided that encapsulating this into an immutable value object allowed for a cleaner API and removed the fear of unexpected mutation bugs. However, we noticed a spike in memory and processor usage when performing many successive actions on such values, such as summation."><meta property="og:locale" content="en_GB"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2016-12-14T00:00:00+00:00"><meta property="article:modified_time" content="2016-12-14T00:00:00+00:00"><meta property="article:tag" content="Php"><meta name=twitter:card content="summary"><meta name=twitter:title content="Designing Immutable Concepts with Transient Mutation in PHP"><meta name=twitter:description content="In a recent project, we found it beneficial to introduce the Money pattern. There are many good resources on this pattern, so I will defer to those for further definition. We decided that encapsulating this into an immutable value object allowed for a cleaner API and removed the fear of unexpected mutation bugs. However, we noticed a spike in memory and processor usage when performing many successive actions on such values, such as summation."><meta name=twitter:site content="@edd_mann"><link rel=stylesheet href=/css/style.min.4c8b66c005db4efc68625e4ceed190f2dc110d342d05ffb19ba924cc13c3ef15.css integrity="sha256-TItmwAXbTvxoYl5M7tGQ8twRDTQtBf+xm6kkzBPD7xU="><link rel=preload as=image href=/assets/x.svg crossorigin=anonymous><link rel=preload as=image href=/assets/github.svg crossorigin=anonymous><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=manifest href=/site.webmanifest><link rel=canonical href=https://eddmann.com/posts/designing-immutable-concepts-with-transient-mutation-in-php/><script>document.documentElement.setAttribute("data-theme",localStorage.getItem("theme")||window.matchMedia("(prefers-color-scheme: dark)").matches&&"dark"||"light")</script><script src=/script.min.da71ac9c7b8bd4e644618df0ab735aed1393aad3cb5e5c57e5adc300fe7c8209.js integrity="sha256-2nGsnHuL1OZEYY3wq3Na7ROTqtPLXlxX5a3DAP58ggk=" defer></script></head><body><header class="site-header l-wrapper"><a href=https://eddmann.com/><h3 class=site-header__title>Edd Mann
<span style=--url:url(/assets/code.svg)>Developer</span></h3></a><button class=site-header__mobile-navigation-button type=button title="Toggle mobile site navigation" aria-label="Toggle mobile site navigation" aria-expanded=false aria-controls=site-navigation></button><div class=site-header__navigation id=site-navigation><nav aria-label="Primary navigation"><ul class=site-header__primary-navigation><li><a href=/archive>Archive</a></li><li><a href=/projects>Projects</a></li><li><a href=/about>About</a></li></ul></nav><nav aria-label="Social links"><ul class=site-header__social-navigation><li><a class=social-icon style=--url:url(/assets/x.svg) href=https://x.com/edd_mann rel="external noopener" target=_blank>Twitter (X)</a></li><li><a class=social-icon style=--url:url(/assets/github.svg) href=https://github.com/eddmann rel="external noopener" target=_blank>GitHub</a></li></ul></nav></div></header><main class=l-wrapper><article><header class=l-page-title><h1 class=u-transition-between-pages style=--id:designing-immutable-concepts-with-transient-mutation-in-php>Designing Immutable Concepts with Transient Mutation in PHP</h1><time datetime=2016-12-14T00:00:00Z class=published-at>Dec 14, 2016</time></header><main class=u-prose><p>In a recent project, we found it beneficial to introduce the Money pattern.
There are many good <a href=http://martinfowler.com/eaaCatalog/money.html rel="external noopener" target=_blank>resources</a> on this pattern, so I will defer to those for further definition.
We decided that encapsulating this into an <a href=http://hangar.runway7.net/punditry/immutability-value-objects rel="external noopener" target=_blank>immutable value object</a> allowed for a cleaner API and removed the fear of unexpected mutation bugs.
However, we noticed a spike in memory and processor usage when performing many successive actions on such values, such as summation.</p><p>In such cases, new &rsquo;temporary&rsquo; <code>Money</code> objects would be instantiated upon each applied addition.
Since many of these objects were merely stepping stones to generating the final result, they were simply left for the garbage collector to clean up.</p><h2 id=using-transient-mutation>Using Transient Mutation</h2><p>Instead of reverting entirely to mutation, we recalled a pattern found in Clojure called <a href=http://clojure.org/reference/transients rel="external noopener" target=_blank>Transients</a>.</p><blockquote><p>If a tree falls in the woods, does it make a sound?
If a pure function mutates some local data in order to produce an immutable return value, is that ok?</p></blockquote><p>This is an interesting proposition.
As long as the resulting value is immutable, does it matter to the caller how it is derived?
Provided we could explicitly control when mutation was permitted, we could safely reap the benefits of mutable constructs.
We ultimately settled on adding a single method, <code>withMutation</code>, to the API.
The caller would provide a <code>callable</code>, which would, in turn, be passed a mutable copy of the <code>Money</code> instance.
This allowed the user to interact with the API in a mutable manner, but only within the scope of the callable.
The final returned value would then be made immutable again.
To the caller, the operation would appear to have been performed immutably.</p><h2 id=the-implementation>The Implementation</h2><p>Below is a trait-based generalisation of the concept we introduced into our Money pattern implementation.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-php data-lang=php><span style=display:flex><span><span style=color:#66d9ef>trait</span> <span style=color:#a6e22e>WithMutable</span>
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> $mutable <span style=color:#f92672>=</span> <span style=color:#66d9ef>false</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>protected</span> <span style=color:#66d9ef>function</span> <span style=color:#a6e22e>isMutable</span>()
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> $this<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>mutable</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>function</span> <span style=color:#a6e22e>withMutable</span>(<span style=color:#a6e22e>callable</span> $fn)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        $x <span style=color:#f92672>=</span> <span style=color:#66d9ef>clone</span> $this;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        $x<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>mutable</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>;
</span></span><span style=display:flex><span>        $x <span style=color:#f92672>=</span> <span style=color:#a6e22e>call_user_func</span>($fn, $x);
</span></span><span style=display:flex><span>        $x<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>mutable</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>false</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> $x;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>As you can see, we provide an <code>isMutable</code> flag to switch between immutable and mutable modes.
We can then use <code>withMutable</code> in any process that benefits from explicit mutable constructs.
Below, you can see how we improved the performance characteristics of the <code>sum</code> example discussed earlier.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-php data-lang=php><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Money</span>
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>use</span> <span style=color:#a6e22e>WithMutable</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> $pence;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>function</span> __construct($pence)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        $this<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>pence</span> <span style=color:#f92672>=</span> $pence;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>function</span> <span style=color:#a6e22e>add</span>(<span style=color:#a6e22e>Money</span> $that)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> $this<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>update</span>($this<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>pence</span> <span style=color:#f92672>+</span> $that<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>pence</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>function</span> <span style=color:#a6e22e>update</span>($pence)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> ($this<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>isMutable</span>()) {
</span></span><span style=display:flex><span>            $this<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>pence</span> <span style=color:#f92672>=</span> $pence;
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> $this;
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> <span style=color:#66d9ef>static</span>($pence);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>function</span> <span style=color:#a6e22e>sum</span>(<span style=color:#75715e>/* Money[] */</span> <span style=color:#f92672>...</span>$monies)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>array_pop</span>($monies)<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>withMutable</span>(<span style=color:#66d9ef>function</span> ($sum) <span style=color:#66d9ef>use</span> ($monies) {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>foreach</span> ($monies <span style=color:#66d9ef>as</span> $money) {
</span></span><span style=display:flex><span>                $sum<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>add</span>($money);
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> $sum;
</span></span><span style=display:flex><span>        });
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Providing such capabilities gives the user the freedom to use mutation when appropriate in a controlled setting.
This helps reduce wasted memory and processor usage while keeping all mutation decisions encapsulated within the abstraction.</p></main><footer class=post-footer><ul class="tags tags--large"><li><a href=/archive/tag/php>php</a></li></ul><div class=related><h3 class=related__title>Related Posts</h3><ul class=related__posts><li><a href=/posts/managing-background-processes-within-symfony/>Managing Background Processes within Symfony</a></li><li><a href=/posts/using-constraint-based-ordering-in-php/>Using Constraint-based Ordering in PHP</a></li><li><a href=/posts/an-array-column-re-indexing-trick-in-php/>An 'array_column' re-indexing trick in PHP</a></li><li><a href=/posts/generating-podcast-stats-in-php/>Generating Podcast Stats in PHP</a></li><li><a href=/posts/validating-32-bit-integers-using-php/>Validating 32-bit Integers using PHP</a></li></ul></div></footer></article><div class="podcast-ad u-overlay-wrapper"><div class=podcast-ad__artwork><img src=https://compiledconversations.com/album-art.jpg alt="Compiled Conversations podcast album art" class=podcast-ad__artwork-image></div><div class=podcast-ad__content><h3 class=podcast-ad__title>Compiled Conversations</h3><p class=podcast-ad__description>Podcast I host, featuring conversations with the people shaping software and technology.</p><div class=podcast-ad__link>Check out the show</a></div><a class=u-overlay href=https://compiledconversations.com target=_blank>Listen to Compiled Conversations</a></div><div class=scroll-watcher></div></main><footer class="site-footer l-wrapper"><div>&copy; 2025, Edd Mann</div><button class=site-footer__theme-toggle type=button title="Toggle theme" aria-label="Toggle theme"><svg fill="currentcolor" viewBox="0 0 32 32" role="img"><title>Theme toggle icon</title><desc>A circle representing the moon for toggling theme</desc><path d="M16 .5C7.4.5.5 7.4.5 16S7.4 31.5 16 31.5 31.5 24.6 31.5 16 24.6.5 16 .5zm0 28.1V3.4C23 3.4 28.6 9 28.6 16S23 28.6 16 28.6z"/></svg></button></footer></body></html>