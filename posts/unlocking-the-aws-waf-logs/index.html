<!doctype html>
<html lang="en">
    <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Unlocking the AWS WAF Logs using Serverless, Lambda and AWS SDK">

    <title>
        
            Unlocking the AWS WAF Logs &middot; Edd Mann
        
    </title>

    <link rel="stylesheet" href="//fonts.googleapis.com/css?family=Source+Sans+Pro:400,700,700italic,400italic">
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <link rel="stylesheet" href="/styles.css">

    <link rel="shortcut icon" href="/favicon.ico">

    <link rel="alternate" href="/rss.xml" title="" type="application/rss+xml">

    <script>
        var _gaq=[['_setAccount','UA-32512081-1'],['_setDomainName','eddmann.com'],['_trackPageview']];
        (function() {
            var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
            ga.src = 'https://ssl.google-analytics.com/ga.js';
            var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
        })();
    </script>
</head>

    <body>
        <div class="container content">
            <header class="masthead">
                <h3 class="masthead-title">
                    <a href="/" title="Home">Edd Mann</a>
                    <small><i class="fa fa-code"></i> Developer</small>
                </h3>
                <nav>
                    <a href="https://twitter.com/edd_mann"><i class="fa fa-twitter"></i></a>
                    <a href="https://github.com/eddmann"><i class="fa fa-github"></i></a>
                    <a href="mailto:the@eddmann.com"><i class="fa fa-envelope"></i></a>
                </nav>
                <div class="cf"></div>
            </header>

            <main>
                <article class="post">
    <h1 class="post-title">Unlocking the AWS WAF Logs</h1>
    <time datetime="2018-01-12T00:00:00+00:00" class="post-date">12 Jan 2018</time>
    <p>In this article we discuss our recent move to route all requests through <a href="https://aws.amazon.com/cloudfront/">CloudFront</a>, allowing us to parse all traffic through the <a href="https://aws.amazon.com/waf/">AWS Web Application Firewall</a> (WAF).
We highlight the reasoning behind this change, and some issues/remedies ecountered when trying to garner concrete logs from the WAF instance.</p>



<h3 id="dynamic-content-delivery">Dynamic Content Delivery</h3>

<p>Since moving our infrastructure fully over to AWS, one of the first benefits we wished to take advantage of was <a href="https://aws.amazon.com/cloudfront/dynamic-content/">Dynamic Content Delivery</a> by way of CloudFront.
It may seem odd to wish to route all requests through a CDN, but in doing so we have been able to unlock the following possibilities:</p>

<ul>
  <li>Allow CloudFront to handle SSL/TLS termination.</li>
  <li>HTTP/2 support out of the box.</li>
  <li>Due to HTTP/2 being <a href="http://qnimate.com/what-is-multiplexing-in-http2/">fully multiplexed</a>, fine-grained path/query-string cache behaviors present in CloudFront are hugely beneficial.</li>
  <li>Take advantage of CloudFront’s many Edge locations - connecting the client to the nearest geographical point, and then using Amazon’s own infrastructure to route the requests to the EC2 hosted origin server(s).</li>
  <li>Along with standard static assets that can be trivially cached, we are able to begin to experiment with caching whole pages - pushing simple dynamic content to the client (i.e. logged-in navigation states).</li>
  <li>Instead of pushing the entire cached page to the client, we can also harness <a href="https://aws.amazon.com/lambda/edge/">Lambda@Edge</a> for small dynamic content changes at Edge locations.</li>
  <li>Employ the <a href="https://aws.amazon.com/waf/">AWS WAF</a> on all client requests, providing another layer of security.</li>
</ul>

<h3 id="aws-web-application-firewall">AWS Web Application Firewall</h3>

<p>As you can see there are many possibilities this opens the door to, in this post however, I would like to focus on the last one.
Soon after shifting all our traffic to go through CloudFront, we wished to take advantage of the AWS WAF.
The benefits of deploying a WAF in-front of your stack are succinctly put in a <a href="https://www.youtube.com/watch?v=4liTK5MrTNo">short talk</a> from last years re:Invent.</p>

<p>However, during development of this approach we realised that getting meaningful logs out of the product was harder than expected.
As of writing AWS does not provide any easily accessible log stream to inspect how the WAF instance is reacting to requests.
The only noticeable indicator of a WAF rule blocking a request came from the 403 HTTP response code that was generated and returned to the client.
This was a less than desirable metric to lean on, as we could get many false-positives from genuine backend 403 reponses, and still did not know which rule triggered it.</p>

<p>We did not feel confident in using such a feature without having more insight into how it was working.
We wished to be able to analyse the traffic patterns and which rules were being matched.</p>

<h3 id="unlocking-the-logs">Unlocking the Logs</h3>

<p>To remedy this we decided to explore the AWS SDK and noticed that with a little work we could query the <a href="http://docs.aws.amazon.com/waf/latest/APIReference/API_GetSampledRequests.html"><code class="language-plaintext highlighter-rouge">GetSampledRequests</code></a> action at a scheduled interval and fetch any matches found - storing them for future use.
This would allow us to look at current and historical data about the WAF’s actions.
A small caveat to how <code class="language-plaintext highlighter-rouge">GetSampledRequests</code> works however, is in that it only returns a sample (maximum of 500) from among the first 5,000 request that your resource receives during the specified time-range.
So to ensure that we receive as many hits as have actually occurred, we must configure the scheduled invocation time according to our throughput.</p>

<p>I felt this was a great opportunity to work with the <a href="https://serverless.com/">Serverless Framework</a> again, and in doing so created the <a href="https://github.com/mybuilder/aws-waf-logger">aws-waf-logger</a> project.
Using the provided <code class="language-plaintext highlighter-rouge">env.yml.sample</code> as a template, it is very easy to configure the desired Web ACL’s to monitor, the tracking frequency and which S3 bucket to store the results into.</p>

<p>The most interesting part of this project is within the transformation from what <code class="language-plaintext highlighter-rouge">GetSampledRequests</code> returns us, to clear insight about the individual ACL’s and rules we wish to track.
Using a composition of several Promises, the below piece of code takes in the desired Web ACL identifier, along with a time-frame which is based on the last time the Lambda has been executed.
We then query for all the present rules which are applied to this Web ACL, and then fetch these individual rule hits.
Once we have this data, we flattern the results into a single dimensional array, which we then subsequently clean-up the client supplied headers.</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="dl">'</span><span class="s1">use strict</span><span class="dl">'</span><span class="p">;</span>

<span class="kd">const</span> <span class="nx">AWS</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">aws-sdk</span><span class="dl">'</span><span class="p">);</span>
<span class="kd">const</span> <span class="nx">waf</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">AWS</span><span class="p">.</span><span class="nx">WAF</span><span class="p">();</span>

<span class="kd">const</span> <span class="p">{</span> <span class="nx">MAX_WAF_ITEMS</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">;</span> <span class="c1">// currently 500</span>

<span class="kd">const</span> <span class="nx">getRuleIds</span> <span class="o">=</span> <span class="nx">aclId</span> <span class="o">=&gt;</span>
  <span class="k">new</span> <span class="nb">Promise</span><span class="p">((</span><span class="nx">res</span><span class="p">,</span> <span class="nx">rej</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">waf</span><span class="p">.</span><span class="nx">getWebACL</span><span class="p">({</span> <span class="na">WebACLId</span><span class="p">:</span> <span class="nx">aclId</span> <span class="p">},</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">data</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="nx">rej</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
      <span class="k">else</span> <span class="nx">res</span><span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">WebACL</span><span class="p">.</span><span class="nx">Rules</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">r</span> <span class="o">=&gt;</span> <span class="nx">r</span><span class="p">.</span><span class="nx">RuleId</span><span class="p">));</span>
    <span class="p">});</span>
  <span class="p">});</span>

<span class="kd">const</span> <span class="nx">getRuleHits</span> <span class="o">=</span> <span class="p">(</span><span class="nx">aclId</span><span class="p">,</span> <span class="nx">ruleId</span><span class="p">,</span> <span class="p">{</span> <span class="nx">start</span><span class="p">,</span> <span class="nx">end</span> <span class="p">})</span> <span class="o">=&gt;</span>
  <span class="k">new</span> <span class="nb">Promise</span><span class="p">((</span><span class="nx">res</span><span class="p">,</span> <span class="nx">rej</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">params</span> <span class="o">=</span> <span class="p">{</span>
      <span class="na">MaxItems</span><span class="p">:</span> <span class="nx">MAX_WAF_ITEMS</span><span class="p">,</span>
      <span class="na">RuleId</span><span class="p">:</span> <span class="nx">ruleId</span><span class="p">,</span>
      <span class="na">TimeWindow</span><span class="p">:</span> <span class="p">{</span> <span class="na">StartTime</span><span class="p">:</span> <span class="nx">start</span><span class="p">,</span> <span class="na">EndTime</span><span class="p">:</span> <span class="nx">end</span> <span class="p">},</span>
      <span class="na">WebAclId</span><span class="p">:</span> <span class="nx">aclId</span><span class="p">,</span>
    <span class="p">};</span>

    <span class="nx">waf</span><span class="p">.</span><span class="nx">getSampledRequests</span><span class="p">(</span><span class="nx">params</span><span class="p">,</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">data</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="nx">rej</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
      <span class="k">else</span> <span class="p">{</span>
        <span class="nx">res</span><span class="p">(</span>
          <span class="nx">data</span><span class="p">.</span><span class="nx">SampledRequests</span><span class="p">.</span><span class="nx">reduce</span><span class="p">((</span><span class="nx">acc</span><span class="p">,</span> <span class="nx">req</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
            <span class="k">return</span> <span class="p">[...</span><span class="nx">acc</span><span class="p">,</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">assign</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="p">{</span> <span class="na">WebAclId</span><span class="p">:</span> <span class="nx">aclId</span><span class="p">,</span> <span class="na">RuleId</span><span class="p">:</span> <span class="nx">ruleId</span> <span class="p">})];</span>
          <span class="p">},</span> <span class="p">[])</span>
        <span class="p">);</span>
      <span class="p">}</span>
    <span class="p">});</span>
  <span class="p">});</span>

<span class="kd">const</span> <span class="nx">normaliseHeaders</span> <span class="o">=</span> <span class="nx">hit</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="nx">hit</span><span class="p">.</span><span class="nx">Request</span><span class="p">.</span><span class="nx">Headers</span> <span class="o">=</span> <span class="nx">hit</span><span class="p">.</span><span class="nx">Request</span><span class="p">.</span><span class="nx">Headers</span><span class="p">.</span><span class="nx">reduce</span><span class="p">((</span><span class="nx">headers</span><span class="p">,</span> <span class="p">{</span> <span class="nx">Name</span><span class="p">,</span> <span class="nx">Value</span> <span class="p">})</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">headers</span><span class="p">[</span><span class="nx">Name</span><span class="p">.</span><span class="nx">toLowerCase</span><span class="p">()]</span> <span class="o">=</span> <span class="nx">Value</span><span class="p">;</span>
    <span class="k">return</span> <span class="nx">headers</span><span class="p">;</span>
  <span class="p">},</span> <span class="p">{});</span>

  <span class="k">return</span> <span class="nx">hit</span><span class="p">;</span>
<span class="p">};</span>

<span class="kd">const</span> <span class="nx">flatten</span> <span class="o">=</span> <span class="nx">arrs</span> <span class="o">=&gt;</span> <span class="nb">Array</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">concat</span><span class="p">.</span><span class="nx">apply</span><span class="p">([],</span> <span class="nx">arrs</span><span class="p">);</span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span><span class="p">.</span><span class="nx">getWebAclHits</span> <span class="o">=</span> <span class="p">(</span><span class="nx">aclId</span><span class="p">,</span> <span class="nx">timeRange</span><span class="p">)</span> <span class="o">=&gt;</span>
  <span class="nx">getRuleIds</span><span class="p">(</span><span class="nx">aclId</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">ruleIds</span> <span class="o">=&gt;</span> <span class="nb">Promise</span><span class="p">.</span><span class="nx">all</span><span class="p">(</span><span class="nx">ruleIds</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">ruleId</span> <span class="o">=&gt;</span> <span class="nx">getRuleHits</span><span class="p">(</span><span class="nx">aclId</span><span class="p">,</span> <span class="nx">ruleId</span><span class="p">,</span> <span class="nx">timeRange</span><span class="p">))))</span>
    <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">flatten</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">hits</span> <span class="o">=&gt;</span> <span class="nx">hits</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">normaliseHeaders</span><span class="p">));</span>
</code></pre></div></div>

<p>We are then able to use this functionality to write the resulting listing to a file, or logging service of our choice.
Within the project we have provided the ability to write the results to S3 and/or directly send the hits off to <a href="https://www.loggly.com/">Loggly</a>.
Upon review, we could have possibly extracted out the Loggly logic (making the project logger agnostic), employing a decoupled S3 <code class="language-plaintext highlighter-rouge">ObjectCreated</code> event approach to send the hits off instead.</p>

<h3 id="conclusion">Conclusion</h3>

<p>Since adding these logging capabilities we have been able to clearly see what rules are being hit and in which context.
This allows us to feel more confident in the WAF product, removing the ‘black-box’ fears that we previously had towards it.</p>

<p>If you have ran into this problem, maybe the <a href="https://github.com/mybuilder/aws-waf-logger">aws-waf-logger</a> we have created could help you!</p>

</article>

            </main>

            <footer class="footer">
                <img src="https://www.gravatar.com/avatar/c5c2978bb14d16460f73399c394b6acd?s=160">
                <ul>
                    <li>Developer at <a href="http://www.mybuilder.com/">MyBuilder</a></li>
                    <li><a href="http://threedevsandamaybe.com/">Three Devs and a Maybe</a> podcast co-host</li>
                    <li>All ramblings can be found in the <a href="/archive/">Archive</a></li>
                </ul>
                <div class="cf"></div>
            </footer>
        </div>
    </body>
</html>
