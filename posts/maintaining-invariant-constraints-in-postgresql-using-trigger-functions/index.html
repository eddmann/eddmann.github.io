<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><title>Maintaining Invariant Constraints in PostgreSQL using Trigger Functions - Edd Mann</title>
<meta name=description content="Learn how to maintain complex invariant constraints in PostgreSQL using trigger functions for enhanced data integrity."><meta name=author content="Edd Mann"><script async src="https://www.googletagmanager.com/gtag/js?id=G-ZPQ7WHNXH4"></script><script>var dnt,doNotTrack=!1;if(!1&&(dnt=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,doNotTrack=dnt=="1"||dnt=="yes"),!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-ZPQ7WHNXH4")}</script><meta itemprop=name content="Maintaining Invariant Constraints in PostgreSQL using Trigger Functions"><meta itemprop=description content="Recently, a feature I was working on required me to alter a unique constraint that existed on a table column. The invariant had now been weakened to allow storing of duplicate email addresses, provided they shared an equivalent link_id (excluding NULL). Sadly, the ease with which I had initially added the general unique constraint had disappeared. However, I was able to take advantage of insertion/update triggers to regain these invariant reassurances."><meta itemprop=datePublished content="2016-03-03T00:00:00+00:00"><meta itemprop=dateModified content="2016-03-03T00:00:00+00:00"><meta itemprop=wordCount content="257"><meta itemprop=keywords content="Postgresql,Sql"><meta property="og:url" content="https://eddmann.com/posts/maintaining-invariant-constraints-in-postgresql-using-trigger-functions/"><meta property="og:site_name" content="Edd Mann"><meta property="og:title" content="Maintaining Invariant Constraints in PostgreSQL using Trigger Functions"><meta property="og:description" content="Recently, a feature I was working on required me to alter a unique constraint that existed on a table column. The invariant had now been weakened to allow storing of duplicate email addresses, provided they shared an equivalent link_id (excluding NULL). Sadly, the ease with which I had initially added the general unique constraint had disappeared. However, I was able to take advantage of insertion/update triggers to regain these invariant reassurances."><meta property="og:locale" content="en_GB"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2016-03-03T00:00:00+00:00"><meta property="article:modified_time" content="2016-03-03T00:00:00+00:00"><meta property="article:tag" content="Postgresql"><meta property="article:tag" content="Sql"><meta name=twitter:card content="summary"><meta name=twitter:title content="Maintaining Invariant Constraints in PostgreSQL using Trigger Functions"><meta name=twitter:description content="Recently, a feature I was working on required me to alter a unique constraint that existed on a table column. The invariant had now been weakened to allow storing of duplicate email addresses, provided they shared an equivalent link_id (excluding NULL). Sadly, the ease with which I had initially added the general unique constraint had disappeared. However, I was able to take advantage of insertion/update triggers to regain these invariant reassurances."><meta name=twitter:site content="@edd_mann"><link rel="preload stylesheet" as=style href=/css/style.min.6c18b9cbfe138a24784e64860eaa9d70076170f03c68d8be3b3f1ae99e51df9f.css integrity="sha256-bBi5y/4TiiR4TmSGDqqdcAdhcPA8aNi+Oz8a6Z5R358="><link rel=preload as=image href=/assets/x.svg><link rel=preload as=image href=/assets/github.svg><link rel=icon type=image/png sizes=32x32 href=/favicon-32x3x.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=manifest href=/site.webmanifest><link rel=canonical href=https://eddmann.com/posts/maintaining-invariant-constraints-in-postgresql-using-trigger-functions/></head><body><header class="site-header wrapper"><a href=https://eddmann.com/><h3 class=site-header__title>Edd Mann
<span style=--url:url(/assets/code.svg)>Developer</span></h3></a><div class=site-header__mobile-navigation-button aria-label="Toggle mobile site navigation" aria-expanded=false aria-controls=site-navigation></div><div class=site-header__navigation id=site-navigation><nav aria-label="Primary navigation"><ul class=site-header__primary-navigation><li><a href=/archive>Archive</a></li><li><a href=/projects>Projects</a></li><li><a href=/about>About</a></li></ul></nav><nav aria-label="Social links"><ul class=site-header__social-navigation><li><a class=social-icon style=--url:url(/assets/x.svg) href=https://x.com/edd_mann rel="external noopener" target=_blank>Twitter (X)</a></li><li><a class=social-icon style=--url:url(/assets/github.svg) href=https://github.com/eddmann rel="external noopener" target=_blank>GitHub</a></li></ul></nav></div></header><main class=wrapper><article><header class=page-title><h1>Maintaining Invariant Constraints in PostgreSQL using Trigger Functions</h1><time class=post__time>Mar 3, 2016</time></header><main class=prose><p>Recently, a feature I was working on required me to alter a unique constraint that existed on a table column.
The invariant had now been weakened to allow storing of duplicate <code>email</code> addresses, provided they shared an equivalent <code>link_id</code> (excluding <code>NULL</code>).
Sadly, the ease with which I had initially added the general unique constraint had disappeared.
However, I was able to take advantage of insertion/update triggers to regain these invariant reassurances.</p><p>I should note that I am in favour of placing business-critical constraints within the database layer, even if this seems like a blurring of responsibility between application logic and the data store.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>CREATE</span> <span style=color:#66d9ef>OR</span> <span style=color:#66d9ef>REPLACE</span> <span style=color:#66d9ef>FUNCTION</span> valid_record_email_address()
</span></span><span style=display:flex><span><span style=color:#66d9ef>RETURNS</span> <span style=color:#66d9ef>TRIGGER</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>AS</span> <span style=color:#960050;background-color:#1e0010>$$</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>BEGIN</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>IF</span> <span style=color:#66d9ef>NEW</span>.link_id <span style=color:#66d9ef>IS</span> <span style=color:#66d9ef>NULL</span> <span style=color:#66d9ef>AND</span> <span style=color:#66d9ef>EXISTS</span> (<span style=color:#66d9ef>SELECT</span> <span style=color:#66d9ef>TRUE</span> <span style=color:#66d9ef>FROM</span> records <span style=color:#66d9ef>WHERE</span> email <span style=color:#f92672>=</span> <span style=color:#66d9ef>NEW</span>.email <span style=color:#66d9ef>AND</span> id <span style=color:#f92672>!=</span> <span style=color:#66d9ef>NEW</span>.id) <span style=color:#66d9ef>THEN</span>
</span></span><span style=display:flex><span>        RAISE <span style=color:#66d9ef>EXCEPTION</span> <span style=color:#e6db74>&#39;Unlinked records must have a unique email address&#39;</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>END</span> <span style=color:#66d9ef>IF</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>IF</span> <span style=color:#66d9ef>NEW</span>.link_id <span style=color:#66d9ef>IS</span> <span style=color:#66d9ef>NOT</span> <span style=color:#66d9ef>NULL</span> <span style=color:#66d9ef>AND</span> <span style=color:#66d9ef>EXISTS</span> (<span style=color:#66d9ef>SELECT</span> <span style=color:#66d9ef>TRUE</span> <span style=color:#66d9ef>FROM</span> records <span style=color:#66d9ef>WHERE</span> link_id <span style=color:#f92672>!=</span> <span style=color:#66d9ef>NEW</span>.link_id <span style=color:#66d9ef>AND</span> email <span style=color:#f92672>=</span> <span style=color:#66d9ef>NEW</span>.email <span style=color:#66d9ef>AND</span> id <span style=color:#f92672>!=</span> <span style=color:#66d9ef>NEW</span>.id) <span style=color:#66d9ef>THEN</span>
</span></span><span style=display:flex><span>        RAISE <span style=color:#66d9ef>EXCEPTION</span> <span style=color:#e6db74>&#39;Only linked records can have the same email address&#39;</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>END</span> <span style=color:#66d9ef>IF</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>RETURN</span> <span style=color:#66d9ef>NEW</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>END</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>$$</span> <span style=color:#66d9ef>LANGUAGE</span> plpgsql;
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>CREATE</span> <span style=color:#66d9ef>TRIGGER</span> validate_record_email_address
</span></span><span style=display:flex><span><span style=color:#66d9ef>BEFORE</span> <span style=color:#66d9ef>INSERT</span> <span style=color:#66d9ef>OR</span> <span style=color:#66d9ef>UPDATE</span> <span style=color:#66d9ef>ON</span> records
</span></span><span style=display:flex><span><span style=color:#66d9ef>FOR</span> <span style=color:#66d9ef>EACH</span> <span style=color:#66d9ef>ROW</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>EXECUTE</span> <span style=color:#66d9ef>PROCEDURE</span> valid_record_email_address();
</span></span></code></pre></div><p>As you can see, within PostgreSQL we can write extremely clear trigger functions that modify actions occurring in the database.
We hope that the application layer will safeguard us from attempts to break this invariant.
However, as this is a critical area of our domain, we provide another level of validation to ensure data integrity.</p></main><footer class=post__tags><a href=/archive/tag/postgresql>postgresql</a><a href=/archive/tag/sql>sql</a></footer></article></main><footer class="site-footer wrapper"><div>&copy; 2025, Edd Mann</div></footer><script>(function(){document.querySelector(".site-header__mobile-navigation-button").addEventListener("click",e=>{document.documentElement.classList.toggle("mobile-navigation-open"),e.target.setAttribute("aria-expanded",e.target.getAttribute("aria-expanded")==="false"?"true":"false")});const n=document.querySelector(".site-header");let t=window.pageYOffset,e=!1;window.addEventListener("scroll",()=>{if(e)return;const s=window.pageYOffset;window.requestAnimationFrame(()=>{n.classList.toggle("is-sticky",t>s),t=s,e=!1}),e=!0})})()</script></body></html>