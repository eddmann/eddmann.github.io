<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><title>Separating out the Lambda Bref runtime from your project's Composer dependencies - Edd Mann</title>
<meta name=description content="Learn how to isolate the Lambda Bref runtime from your project's Composer dependencies to avoid conflicts and ensure compatibility."><meta name=author content="Edd Mann"><script async src="https://www.googletagmanager.com/gtag/js?id=G-ZPQ7WHNXH4"></script><script>var dnt,doNotTrack=!1;if(!1&&(dnt=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,doNotTrack=dnt=="1"||dnt=="yes"),!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-ZPQ7WHNXH4")}</script><meta itemprop=name content="Separating out the Lambda Bref runtime from your project's Composer dependencies"><meta itemprop=description content="Having had great success using AWS Lambda within our insurance product (MyBuilder Plus), late last year we made the decision to move all our web request traffic over to the platform! However, we noticed when attempting to migrate over one application in particular, that we could not use the latest release of Bref (the PHP runtime) due to a conflict between required Symfony Process component versions."><meta itemprop=datePublished content="2022-02-08T00:00:00+00:00"><meta itemprop=dateModified content="2022-02-08T00:00:00+00:00"><meta itemprop=wordCount content="357"><meta itemprop=keywords content="Lambda,Serverless,Bref,Php,Aws"><meta property="og:url" content="https://eddmann.com/posts/separating-out-the-lambda-bref-runtime-from-your-projects-composer-dependencies/"><meta property="og:site_name" content="Edd Mann"><meta property="og:title" content="Separating out the Lambda Bref runtime from your project's Composer dependencies"><meta property="og:description" content="Having had great success using AWS Lambda within our insurance product (MyBuilder Plus), late last year we made the decision to move all our web request traffic over to the platform! However, we noticed when attempting to migrate over one application in particular, that we could not use the latest release of Bref (the PHP runtime) due to a conflict between required Symfony Process component versions."><meta property="og:locale" content="en_GB"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-02-08T00:00:00+00:00"><meta property="article:modified_time" content="2022-02-08T00:00:00+00:00"><meta property="article:tag" content="Lambda"><meta property="article:tag" content="Serverless"><meta property="article:tag" content="Bref"><meta property="article:tag" content="Php"><meta property="article:tag" content="Aws"><meta name=twitter:card content="summary"><meta name=twitter:title content="Separating out the Lambda Bref runtime from your project's Composer dependencies"><meta name=twitter:description content="Having had great success using AWS Lambda within our insurance product (MyBuilder Plus), late last year we made the decision to move all our web request traffic over to the platform! However, we noticed when attempting to migrate over one application in particular, that we could not use the latest release of Bref (the PHP runtime) due to a conflict between required Symfony Process component versions."><meta name=twitter:site content="@edd_mann"><link rel=stylesheet href=/css/style.min.4c8b66c005db4efc68625e4ceed190f2dc110d342d05ffb19ba924cc13c3ef15.css integrity="sha256-TItmwAXbTvxoYl5M7tGQ8twRDTQtBf+xm6kkzBPD7xU="><link rel=preload as=image href=/assets/x.svg crossorigin=anonymous><link rel=preload as=image href=/assets/github.svg crossorigin=anonymous><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=manifest href=/site.webmanifest><link rel=canonical href=https://eddmann.com/posts/separating-out-the-lambda-bref-runtime-from-your-projects-composer-dependencies/><script>document.documentElement.setAttribute("data-theme",localStorage.getItem("theme")||window.matchMedia("(prefers-color-scheme: dark)").matches&&"dark"||"light")</script><script src=/script.min.da71ac9c7b8bd4e644618df0ab735aed1393aad3cb5e5c57e5adc300fe7c8209.js integrity="sha256-2nGsnHuL1OZEYY3wq3Na7ROTqtPLXlxX5a3DAP58ggk=" defer></script></head><body><header class="site-header l-wrapper"><a href=https://eddmann.com/><h3 class=site-header__title>Edd Mann
<span style=--url:url(/assets/code.svg)>Developer</span></h3></a><button class=site-header__mobile-navigation-button type=button title="Toggle mobile site navigation" aria-label="Toggle mobile site navigation" aria-expanded=false aria-controls=site-navigation></button><div class=site-header__navigation id=site-navigation><nav aria-label="Primary navigation"><ul class=site-header__primary-navigation><li><a href=/archive>Archive</a></li><li><a href=/projects>Projects</a></li><li><a href=/about>About</a></li><li><a href=/cv.html>CV</a></li></ul></nav><nav aria-label="Social links"><ul class=site-header__social-navigation><li><a class=social-icon style=--url:url(/assets/x.svg) href=https://x.com/edd_mann rel="external noopener" target=_blank>Twitter (X)</a></li><li><a class=social-icon style=--url:url(/assets/github.svg) href=https://github.com/eddmann rel="external noopener" target=_blank>GitHub</a></li></ul></nav></div></header><main class=l-wrapper><article><header class=l-page-title><h1 class=u-transition-between-pages style=--id:separating-out-the-lambda-bref-runtime-from-your-projects-composer-dependencies>Separating out the Lambda Bref runtime from your project's Composer dependencies</h1><time datetime=2022-02-08T00:00:00Z class=published-at>Feb 8, 2022</time></header><main class=u-prose><p>Having had great success using AWS Lambda within our insurance product (<a href=https://mybuilder-plus.com/ rel="external noopener" target=_blank>MyBuilder Plus</a>), late last year we made the decision to move <strong>all</strong> our web request traffic over to the platform!
However, we noticed when attempting to migrate over one application in particular, that we could not use the latest release of <a href=https://bref.sh/ rel="external noopener" target=_blank>Bref</a> (the PHP runtime) due to a conflict between required Symfony <a href=https://symfony.com/doc/current/components/process.html rel="external noopener" target=_blank>Process component</a> versions.</p><p>Thanks to the responsive <a href=https://bref.sh/#enterprise rel="external noopener" target=_blank>enterprise support</a> that Matthieu provides, we discussed a possible solution which involved using a <a href=https://bref.sh/docs/environment/php.html#custom-vendor-path rel="external noopener" target=_blank>separate custom autoloader</a> for use with the Bref runtime.
Looking through the Bref codebase, we noticed that as we only use the FPM and console runtimes, <a href=https://github.com/brefphp/bref/blob/master/runtime/layers/fpm/bootstrap#L35 rel="external noopener" target=_blank>both</a> <a href=https://github.com/brefphp/bref/blob/master/runtime/layers/console/bootstrap#L49 rel="external noopener" target=_blank>variants</a> spawn separate PHP processes to handle the actual request.
This means that the project autoloader does not need to be aware of Bref, and as such, we can isolate this runtime concern from the project entirely.</p><p>The project in question packages the release as a <a href=https://docs.aws.amazon.com/lambda/latest/dg/images-create.html rel="external noopener" target=_blank>container image</a>.
As such, we were able to create a multi-stage Docker build (as shown below) which handles our desired outcome.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-dockerfile data-lang=dockerfile><span style=display:flex><span><span style=color:#66d9ef>FROM</span><span style=color:#e6db74> composer:2.2.5 AS runtime</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> mkdir -p /tmp/runtime <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span> <span style=color:#f92672>&amp;&amp;</span> composer require -d /tmp/runtime bref/bref:1.5.3<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>FROM</span><span style=color:#e6db74> bref/php-81-fpm:1.5.3</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>COPY</span> --from<span style=color:#f92672>=</span>runtime /tmp/runtime/vendor /opt/runtime/vendor<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>ENV</span> BREF_AUTOLOAD_PATH /opt/runtime/vendor/autoload.php<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>COPY</span> . $LAMBDA_TASK_ROOT<span style=color:#960050;background-color:#1e0010>
</span></span></span></code></pre></div><p>Using the Composer Docker image as a base, we were able to build a <code>vendor</code> directory which included only the desired Bref dependencies.
We were then able to copy this directory into our Lambda container image, making the Bref bootstrap script aware of the custom autoloader path by way of the <code>BREF_AUTOLOAD_PATH</code> environment variable.</p><h2 id=conclusion>Conclusion</h2><p>Although we have only demonstrated this for our own use case (using a container image), the same idea could be applied for layer-based Lambda functions too.
Sadly, this approach will not work for <a href=https://bref.sh/docs/runtimes/function.html rel="external noopener" target=_blank>PHP functions</a> due to the way the handler is pulled in within the bootstrap script.
However, thanks to both the FPM and console layer abstractions, we are able to remove these runtime concerns from our project.
This gives us the ability to maintain the runtime and project requirements separately, allowing us to use the latest Bref release in a project that has dependency conflicts.</p></main><footer class=post-footer><ul class="tags tags--large"><li><a href=/archive/tag/lambda>lambda</a></li><li><a href=/archive/tag/serverless>serverless</a></li><li><a href=/archive/tag/bref>bref</a></li><li><a href=/archive/tag/php>php</a></li><li><a href=/archive/tag/aws>aws</a></li></ul><div class=related><h3 class=related__title>Related Posts</h3><ul class=related__posts><li><a href=/posts/mince-pie-challenge-viewing-and-removing-mince-pies-with-amazon-dynamodb/>Mince Pie Challenge: Viewing and Removing Mince Pies with Amazon DynamoDB</a></li><li><a href=/posts/mince-pie-challenge-adding-and-listing-mince-pies-with-amazon-dynamodb/>Mince Pie Challenge: Adding and Listing Mince Pies with Amazon DynamoDB</a></li><li><a href=/posts/mince-pie-challenge-building-a-serverless-restful-api-and-react-client/>Mince Pie Challenge: Building a Serverless RESTful API and React Client</a></li><li><a href=/posts/creating-a-winning-audio-lambda-service-using-serverless-polly-and-compiled-sox/>Creating a 'Winning' Audio Lambda Service using Serverless, Polly and compiled SOX</a></li><li><a href=/posts/memes-as-a-service-using-lambda-serverless-and-imagemagick/>'Memes as a Service' using Lambda, Serverless and ImageMagick</a></li></ul></div></footer></article><div class="podcast-ad u-overlay-wrapper"><div class=podcast-ad__artwork><img src=https://compiledconversations.com/album-art.jpg alt="Compiled Conversations podcast album art" class=podcast-ad__artwork-image></div><div class=podcast-ad__content><h3 class=podcast-ad__title>Compiled Conversations</h3><p class=podcast-ad__description>Podcast I host, featuring conversations with the people shaping software and technology.</p><div class=podcast-ad__link>Check out the show</a></div><a class=u-overlay href=https://compiledconversations.com target=_blank>Listen to Compiled Conversations</a></div><div class=scroll-watcher></div></main><footer class="site-footer l-wrapper"><div>&copy; 2025, Edd Mann</div><button class=site-footer__theme-toggle type=button title="Toggle theme" aria-label="Toggle theme"><svg fill="currentcolor" viewBox="0 0 32 32" role="img"><title>Theme toggle icon</title><desc>A circle representing the moon for toggling theme</desc><path d="M16 .5C7.4.5.5 7.4.5 16S7.4 31.5 16 31.5 31.5 24.6 31.5 16 24.6.5 16 .5zm0 28.1V3.4C23 3.4 28.6 9 28.6 16S23 28.6 16 28.6z"/></svg></button></footer></body></html>