<!doctype html>
<html lang="en">
    <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Learn how to handle newline inconsistencies and Unicode character length differences between JavaScript and PHP to ensure accurate text processing.">

    <title>
        
            Managing Newlines and Unicode within JavaScript and PHP &middot; Edd Mann
        
    </title>

    <link rel="stylesheet" href="//fonts.googleapis.com/css?family=Source+Sans+Pro:400,700,700italic,400italic">
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <link rel="stylesheet" href="/styles.css">

    <link rel="shortcut icon" href="/favicon.ico">

    <link rel="alternate" href="/rss.xml" title="" type="application/rss+xml">

    

    <script>
        var _gaq=[['_setAccount','UA-32512081-1'],['_setDomainName','eddmann.com'],['_trackPageview']];
        (function() {
            var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
            ga.src = 'https://ssl.google-analytics.com/ga.js';
            var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
        })();
    </script>
</head>

    <body>
        <div class="container content">
            <header class="masthead">
                <h3 class="masthead-title">
                    <a href="/" title="Home">Edd Mann</a>
                    <small><i class="fa fa-code"></i> Developer</small>
                </h3>
                <nav>
                    <a href="https://twitter.com/edd_mann"><i class="fa fa-twitter"></i></a>
                    <a href="https://github.com/eddmann"><i class="fa fa-github"></i></a>
                    <a href="mailto:the@eddmann.com"><i class="fa fa-envelope"></i></a>
                </nav>
                <div class="cf"></div>
            </header>

            <main>
                <article class="post">
    <h1 class="post-title">Managing Newlines and Unicode within JavaScript and PHP</h1>
    <time datetime="2016-12-22T00:00:00+00:00" class="post-date">22 Dec 2016</time>
    <p>We were recently sent a tweet regarding a text-area client/server-side length validation not correlating.
After some detective work, we were able to find two issues that could have caused this to occur.
In this post, I wish to discuss our findings and how we resolved each issue.</p>



<h2 id="newlines">Newlines</h2>

<p>The first issue we noticed was when newlines were present within the text-area input.
It seemed that client-side, newlines were being represented with a single character, whereas on the server, two were instead used.
Reading a section of the HTML5 specification confirmed our suspicions.</p>

<blockquote>
  <p>The API value‚Ä¶ is normalized so that line breaks use ‚ÄúLF‚Äù (U+000A) characters. Finally, there is the form submission value. It is normalized so that line breaks use U+000D CARRIAGE RETURN ‚ÄúCRLF‚Äù (U+000A) character pairs‚Ä¶
<a href="https://www.w3.org/TR/html5/forms.html#the-textarea-element">https://www.w3.org/TR/html5/forms.html#the-textarea-element</a></p>
</blockquote>

<h2 id="unicode-characters">Unicode Characters</h2>

<p>The second issue we observed was when the text-area contained a character outside the <a href="https://en.wikipedia.org/wiki/Plane_(Unicode)#Basic_Multilingual_Plane">Basic Multilingual Plane</a>.
There are a couple of <a href="https://mathiasbynens.be/notes/javascript-unicode">very</a> <a href="https://mathiasbynens.be/notes/javascript-encoding">interesting</a> <a href="https://mathiasbynens.be/notes/es6-unicode-regex">articles</a> discussing Unicode support within JavaScript that I highly recommend reading.
In short, JavaScript represents strings as a collection of unsigned 16-bit integers.
This means that any character that does not fit within 16 bits (requiring a <a href="http://unicodebook.readthedocs.io/unicode_encodings.html#utf-16-surrogate-pairs">surrogate pair</a>) will instead have a length of two when calling <code class="language-plaintext highlighter-rouge">.length</code>.</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="dl">'</span><span class="s1">a</span><span class="dl">'</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="c1">// 1</span>
<span class="dl">'</span><span class="s1">üçï</span><span class="dl">'</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="c1">// 2!</span>
</code></pre></div></div>

<p>This can get even more confusing when you then wish to send that string to the server.
The general consensus is to use UTF-8 character encoding during transmission (default as of HTML5), and this means that a character can be represented with between one and four bytes.
So, in the case of the above examples, a naive <code class="language-plaintext highlighter-rouge">strlen</code> will return:</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">strlen</span><span class="p">(</span><span class="s1">'a'</span><span class="p">);</span> <span class="c1">// 1</span>
<span class="nb">strlen</span><span class="p">(</span><span class="s1">'üçï'</span><span class="p">);</span> <span class="c1">// 4!</span>
</code></pre></div></div>

<blockquote>
  <p>The beauty of UTF-8 is that the ASCII character set can be represented with the identical single binary value.</p>
</blockquote>

<h2 id="newline-solution">Newline Solution</h2>

<p>With these two problems in mind, we set out to tackle them.
Regarding the newline issue, we decided that a newline would represent a single character within the supplied limit.
As the HTML5 standard handles this for us within the browser, all we are required to do is replace occurrences of CRLF on the server side.</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">strlen</span><span class="p">(</span><span class="nb">str_replace</span><span class="p">(</span><span class="s2">"</span><span class="se">\r</span><span class="s2">"</span><span class="p">,</span> <span class="s1">''</span><span class="p">,</span> <span class="nv">$message</span><span class="p">));</span> <span class="c1">// 1</span>
</code></pre></div></div>

<h2 id="unicode-solution">Unicode Solution</h2>

<p>That was relatively easy to resolve - now both newlines on the client and server side correlated with one another.
Next, we needed to address the Unicode issue - we had fortunately already resolved this on the server side thanks to the PHP <a href="http://php.net/manual/en/book.mbstring.php"><code class="language-plaintext highlighter-rouge">mb_*</code></a> functions.
As we had specified that our default encoding was UTF-8, we did not have to include the desired encoding upon invocation.</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">mb_strlen</span><span class="p">(</span><span class="s1">'üçï'</span><span class="p">);</span> <span class="c1">// 1</span>
</code></pre></div></div>

<blockquote>
  <p>Instead of naively byte-processing the length of the string as <code class="language-plaintext highlighter-rouge">strlen</code> does, <code class="language-plaintext highlighter-rouge">mb_strlen</code> takes into consideration the encoding and is able to discern multi-byte characters.</p>
</blockquote>

<p>On the client side, we were still faced with the issue of characters containing a surrogate pair.
To handle this use case when calculating the length, we took inspiration from <a href="https://mathiasbynens.be/notes/javascript-unicode">this</a> article.
We decided to replace any characters that lay outside of the BMP with a single one that did (in the case below, a simple ‚Äò_‚Äô).
An alternative approach, if you were using ES6, would be to use <code class="language-plaintext highlighter-rouge">Array.from</code>, which correctly handles the character encoding used.</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="dl">'</span><span class="s1">üçï</span><span class="dl">'</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/</span><span class="se">[\u</span><span class="sr">D800-</span><span class="se">\u</span><span class="sr">DBFF</span><span class="se">][\u</span><span class="sr">DC00-</span><span class="se">\u</span><span class="sr">DFFF</span><span class="se">]</span><span class="sr">/g</span><span class="p">,</span> <span class="dl">'</span><span class="s1">_</span><span class="dl">'</span><span class="p">).</span><span class="nx">length</span><span class="p">;</span> <span class="c1">// 1</span>
</code></pre></div></div>

</article>

            </main>

            <footer class="footer">
                <img src="https://www.gravatar.com/avatar/c5c2978bb14d16460f73399c394b6acd?s=160">
                <ul>
                    <li>Developer at <a href="http://www.mybuilder.com/">MyBuilder</a></li>
                    <li><a href="http://threedevsandamaybe.com/">Three Devs and a Maybe</a> podcast co-host</li>
                    <li>All ramblings can be found in the <a href="/archive/">Archive</a></li>
                </ul>
                <div class="cf"></div>
            </footer>
        </div>
    </body>
</html>
