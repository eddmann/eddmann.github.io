<!doctype html>
<html lang="en">
    <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Exploring optional value control-flows using multiple PHP features">

    <title>
        
            Optional Value Control-flows in PHP using Traits and Magic-methods &middot; Edd Mann
        
    </title>

    <link rel="stylesheet" href="//fonts.googleapis.com/css?family=Source+Sans+Pro:400,700,700italic,400italic">
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <link rel="stylesheet" href="/styles.css">

    <link rel="shortcut icon" href="/favicon.ico">

    <link rel="alternate" href="/rss.xml" title="" type="application/rss+xml">

    
        <link rel="canonical" href="https://tech.mybuilder.com/optional-value-control-flows-in-php-using-traits-and-magic-methods/" />
    

    <script>
        var _gaq=[['_setAccount','UA-32512081-1'],['_setDomainName','eddmann.com'],['_trackPageview']];
        (function() {
            var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
            ga.src = 'https://ssl.google-analytics.com/ga.js';
            var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
        })();
    </script>
</head>

    <body>
        <div class="container content">
            <header class="masthead">
                <h3 class="masthead-title">
                    <a href="/" title="Home">Edd Mann</a>
                    <small><i class="fa fa-code"></i> Developer</small>
                </h3>
                <nav>
                    <a href="https://twitter.com/edd_mann"><i class="fa fa-twitter"></i></a>
                    <a href="https://github.com/eddmann"><i class="fa fa-github"></i></a>
                    <a href="mailto:the@eddmann.com"><i class="fa fa-envelope"></i></a>
                </nav>
                <div class="cf"></div>
            </header>

            <main>
                <article class="post">
    <h1 class="post-title">Optional Value Control-flows in PHP using Traits and Magic-methods</h1>
    <time datetime="2015-06-10T00:00:00+00:00" class="post-date">10 Jun 2015</time>
    <p>Recently I have been interested in experimenting with different ways to handle optional values.
Their are many examples that exist demonstrating the use of the Maybe/Optional structure within the PHP landscape.
I would instead like to focus my attention on only looking into the concept of ‘orElse’, which I have found to be a prominent control-flow whilst using these types of value.</p>



<p>Typically, in an imperative mind-set we are accustom to evaluating a value, and based on its existence — defined as falsely in this regard — follow a different course of action, and by-way result.
This can be clearly seen in the following two examples:</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$cart</span> <span class="o">=</span> <span class="nv">$repository</span><span class="o">-&gt;</span><span class="nf">findById</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="k">if</span> <span class="p">(</span><span class="nv">$cart</span> <span class="o">===</span> <span class="kc">null</span><span class="p">)</span> <span class="nv">$cart</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ShoppingCart</span><span class="p">;</span>

<span class="nv">$cart</span> <span class="o">=</span> <span class="nv">$repository</span><span class="o">-&gt;</span><span class="nf">findById</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">?:</span> <span class="k">new</span> <span class="nc">ShoppingCart</span><span class="p">;</span>
</code></pre></div></div>

<p>These two examples both attempt to fetch a shopping cart from a repository, which by looking at the defined guards may not exist.
As a result of this, we are required to write extra boilerplate code to handle the presence of failure - using either a conditional block with reassignment or the ternary null trick provided within PHP.</p>

<h3 id="using-traits">Using Traits</h3>

<p>I was interested to see if there were any other ways of more clearly expressing this intent, following the discussed popular control-flow provided within Optional types.</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">trait</span> <span class="nc">OrElse</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="n">__call</span><span class="p">(</span><span class="nv">$name</span><span class="p">,</span> <span class="kt">array</span> <span class="nv">$args</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$isOrElse</span> <span class="o">=</span>
            <span class="nb">preg_match</span><span class="p">(</span><span class="s1">'/OrElse$/i'</span><span class="p">,</span> <span class="nv">$name</span><span class="p">)</span> <span class="o">===</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span>
            <span class="nb">count</span><span class="p">(</span><span class="nv">$args</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">;</span>

        <span class="k">if</span> <span class="p">(</span><span class="nv">$isOrElse</span><span class="p">)</span> <span class="p">{</span>
            <span class="nv">$orElse</span> <span class="o">=</span> <span class="nb">array_pop</span><span class="p">(</span><span class="nv">$args</span><span class="p">);</span>
            <span class="nv">$result</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="p">{</span><span class="nb">substr</span><span class="p">(</span><span class="nv">$name</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">6</span><span class="p">)}(</span><span class="mf">...</span><span class="nv">$args</span><span class="p">);</span>

            <span class="k">if</span> <span class="p">(</span><span class="nv">$result</span> <span class="o">==</span> <span class="kc">false</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">return</span> <span class="nb">is_callable</span><span class="p">(</span><span class="nv">$orElse</span><span class="p">)</span> <span class="o">?</span> <span class="nv">$orElse</span><span class="p">()</span> <span class="o">:</span> <span class="nv">$orElse</span><span class="p">;</span>
            <span class="p">}</span>

            <span class="k">return</span> <span class="nv">$result</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>This trait takes advantage of PHP’s dynamic message passing nature, essentially wrapping calls with the boilerplate code typically required.
Any unknown method calls are checked to see if they end in ‘OrElse’ and include at least a single argument.
If this is the case, the last argument is popped off the supplied parameters array and the intended method (excluding OrElse) is invoked with the remaining arguments.
Finally, the boilerplate guard logic that we typically see handling the occurrence of falsely values is encapsulated into this single location.
If a falsely value is returned from the method invocation the user defined literal or function value is returned instead.
The code initially described could now be rewritten as follows, assuming that the repository included the trait in its definition.</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$cart</span> <span class="o">=</span> <span class="nv">$repository</span><span class="o">-&gt;</span><span class="nf">findByIdOrElse</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="k">new</span> <span class="nc">ShoppingCart</span><span class="p">);</span>
<span class="nv">$cart</span> <span class="o">=</span> <span class="nv">$repository</span><span class="o">-&gt;</span><span class="nf">findByIdOrElse</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="k">function</span> <span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="k">new</span> <span class="nc">ShoppingCart</span><span class="p">;</span> <span class="p">});</span>
</code></pre></div></div>

<p>You can see from looking at the examples above how we have been able to be more expressive within the method call, describing its intent more clearly. This method now reads as one that expects the possibility of an non-existent/alternative return value. The second example is a rewrite of the first, taking into consideration the fact that all method parameters are interpreted during invocation — resulting in the possibility of a new cart being created but never required. Instead the value is wrapped in a function which is lazily called by the trait implementation if needs be.</p>

<h3 id="using-composition">Using Composition</h3>

<p>If you are against the idea of altering the behavior of the class by adding a trait — and instead wish to do such actions ad-hoc — the following example shows how the same can be achieved through composition.</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">class</span> <span class="nc">OrElse</span>
<span class="p">{</span>
    <span class="kn">use</span> <span class="nc">OrElseTrait</span> <span class="p">{</span> <span class="n">__call</span> <span class="k">as</span> <span class="n">orElseCall</span><span class="p">;</span> <span class="p">}</span>

    <span class="k">private</span> <span class="nv">$object</span><span class="p">;</span>

    <span class="k">public</span> <span class="k">function</span> <span class="n">__construct</span><span class="p">(</span><span class="nv">$object</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">object</span> <span class="o">=</span> <span class="nv">$object</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="n">__call</span><span class="p">(</span><span class="nv">$name</span><span class="p">,</span> <span class="kt">array</span> <span class="nv">$args</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">method_exists</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="n">object</span><span class="p">,</span> <span class="nv">$name</span><span class="p">))</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">object</span><span class="o">-&gt;</span><span class="nv">$name</span><span class="p">(</span><span class="mf">...</span><span class="nv">$args</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">orElseCall</span><span class="p">(</span><span class="nv">$name</span><span class="p">,</span> <span class="nv">$args</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Using a proxy class we are able to direct any existing method calls to the supplied object, handling non-existent methods by-way of the OrElse trait.
This implementation can then be used, in the following manner.</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$orElseRepository</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">OrElse</span><span class="p">(</span><span class="nv">$repository</span><span class="p">);</span>
<span class="nv">$cart</span> <span class="o">=</span> <span class="nv">$orElseRepository</span><span class="o">-&gt;</span><span class="nf">findByIdOrElse</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="k">new</span> <span class="nc">ShoppingCart</span><span class="p">);</span>
</code></pre></div></div>

<h3 id="using-basic-functions">Using Basic Functions</h3>

<p>Finally, a completely different way to control the flow of returned values is by coding up a simple function like so.</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">function</span> <span class="n">_or</span><span class="p">(...</span><span class="nv">$args</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">foreach</span> <span class="p">(</span><span class="nv">$args</span> <span class="k">as</span> <span class="nv">$arg</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nv">$result</span> <span class="o">=</span> <span class="nb">is_callable</span><span class="p">(</span><span class="nv">$arg</span><span class="p">)</span> <span class="o">?</span> <span class="nv">$arg</span><span class="p">()</span> <span class="o">:</span> <span class="nv">$arg</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nv">$result</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>This function simply iterates over all its arguments, evaluating each until one returns a truthy value which it subsequently returns.
This is by far the least obstructive manner in which to implement such control flow capabilities, but in my opinion does not read as nicely as the above two examples.
This example can be used to achieve the same results as before, using the following approach.</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$cart</span> <span class="o">=</span> <span class="nf">_or</span><span class="p">(</span><span class="nv">$repository</span><span class="o">-&gt;</span><span class="nf">findById</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="k">new</span> <span class="nc">ShoppingCart</span><span class="p">);</span>
</code></pre></div></div>

<p>I hope you have enjoyed this thought experiment into how we can extract and use concepts from different paradigms in our day-to-day code.
Also, it may have sparked some interest in seeing how you can take advantage of PHP Traits along with Magic method invocation.</p>

</article>

            </main>

            <footer class="footer">
                <img src="https://www.gravatar.com/avatar/c5c2978bb14d16460f73399c394b6acd?s=160">
                <ul>
                    <li>Developer at <a href="http://www.mybuilder.com/">MyBuilder</a></li>
                    <li><a href="http://threedevsandamaybe.com/">Three Devs and a Maybe</a> podcast co-host</li>
                    <li>All ramblings can be found in the <a href="/archive/">Archive</a></li>
                </ul>
                <div class="cf"></div>
            </footer>
        </div>
    </body>
</html>
