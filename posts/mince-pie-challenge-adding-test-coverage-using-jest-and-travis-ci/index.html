<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><title>Mince Pie Challenge: Adding Test Coverage using Jest and Travis CI - Edd Mann</title>
<meta name=description content="A comprehensive guide to enhancing your API project with test coverage using Jest and Travis CI, ensuring robust code quality and continuous integration."><meta name=author content="Edd Mann"><script async src="https://www.googletagmanager.com/gtag/js?id=G-ZPQ7WHNXH4"></script><script>var dnt,doNotTrack=!1;if(!1&&(dnt=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,doNotTrack=dnt=="1"||dnt=="yes"),!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-ZPQ7WHNXH4")}</script><meta itemprop=name content="Mince Pie Challenge: Adding Test Coverage using Jest and Travis CI"><meta itemprop=description content="Following on from adding Flow to the API project, I now wish to garner further confidence in the code by adding tests. In this post I will document the process of setting up the test-runner Jest, and adding suitable test coverage to the current authentication example."><meta itemprop=datePublished content="2018-07-18T00:00:00+00:00"><meta itemprop=dateModified content="2018-07-18T00:00:00+00:00"><meta itemprop=wordCount content="1804"><meta itemprop=keywords content="Jest,Testing,Javascript,Mince-Pie-Challenge-Series"><meta property="og:url" content="https://eddmann.com/posts/mince-pie-challenge-adding-test-coverage-using-jest-and-travis-ci/"><meta property="og:site_name" content="Edd Mann"><meta property="og:title" content="Mince Pie Challenge: Adding Test Coverage using Jest and Travis CI"><meta property="og:description" content="Following on from adding Flow to the API project, I now wish to garner further confidence in the code by adding tests. In this post I will document the process of setting up the test-runner Jest, and adding suitable test coverage to the current authentication example."><meta property="og:locale" content="en_GB"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2018-07-18T00:00:00+00:00"><meta property="article:modified_time" content="2018-07-18T00:00:00+00:00"><meta property="article:tag" content="Jest"><meta property="article:tag" content="Testing"><meta property="article:tag" content="Javascript"><meta property="article:tag" content="Mince-Pie-Challenge-Series"><meta name=twitter:card content="summary"><meta name=twitter:title content="Mince Pie Challenge: Adding Test Coverage using Jest and Travis CI"><meta name=twitter:description content="Following on from adding Flow to the API project, I now wish to garner further confidence in the code by adding tests. In this post I will document the process of setting up the test-runner Jest, and adding suitable test coverage to the current authentication example."><meta name=twitter:site content="@edd_mann"><link rel=stylesheet href=/css/style.min.a18bbea58d05187498ffb7d6a33b580609df2e92b988055a4b51e41596cc934e.css integrity="sha256-oYu+pY0FGHSY/7fWoztYBgnfLpK5iAVaS1HkFZbMk04="><link rel=preload as=image href=/assets/x.svg crossorigin=anonymous><link rel=preload as=image href=/assets/github.svg crossorigin=anonymous><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=manifest href=/site.webmanifest><link rel=canonical href=https://eddmann.com/posts/mince-pie-challenge-adding-test-coverage-using-jest-and-travis-ci/><script>document.documentElement.setAttribute("data-theme",localStorage.getItem("theme")||window.matchMedia("(prefers-color-scheme: dark)").matches&&"dark"||"light")</script><script src=/script.min.7f6917401c23509595a4da9144cfe3c8fde343c0352e6d627aa366129e1bdb48.js integrity="sha256-f2kXQBwjUJWVpNqRRM/jyP3jQ8A1Lm1ieqNmEp4b20g=" defer></script></head><body><header class="site-header l-wrapper"><a href=https://eddmann.com/><h3 class=site-header__title>Edd Mann
<span style=--url:url(/assets/code.svg)>Developer</span></h3></a><button class=site-header__mobile-navigation-button type=button title="Toggle mobile site navigation" aria-label="Toggle mobile site navigation" aria-expanded=false aria-controls=site-navigation></button><div class=site-header__navigation id=site-navigation><nav aria-label="Primary navigation"><ul class=site-header__primary-navigation><li><a href=/archive>Archive</a></li><li><a href=/projects>Projects</a></li><li><a href=/about>About</a></li></ul></nav><nav aria-label="Social links"><ul class=site-header__social-navigation><li><a class=social-icon style=--url:url(/assets/x.svg) href=https://x.com/edd_mann rel="external noopener" target=_blank>Twitter (X)</a></li><li><a class=social-icon style=--url:url(/assets/github.svg) href=https://github.com/eddmann rel="external noopener" target=_blank>GitHub</a></li></ul></nav></div></header><main class=l-wrapper><article><header class=l-page-title><h1 class=u-transition-between-pages style=--id:mince-pie-challenge-adding-test-coverage-using-jest-and-travis-ci>Mince Pie Challenge: Adding Test Coverage using Jest and Travis CI</h1><time datetime=2018-07-18T00:00:00Z class=published-at>Jul 18, 2018</time></header><main class=u-prose><p>Following on from <a href=/posts/mince-pie-challenge-setting-up-flow-with-babel-and-webpack/>adding Flow</a> to the API project, I now wish to garner further confidence in the code by adding tests.
In this post I will document the process of setting up the test-runner <a href=https://jestjs.io/ rel="external noopener" target=_blank>Jest</a>, and adding suitable test coverage to the current authentication example.</p><p>If you are keen to see how the finished example looks, you can access it within the <a href=https://github.com/eddmann/mince-pie-challenge-api-serverless/tree/04-jest rel="external noopener" target=_blank>API repository</a>.</p><p>Developed by Facebook, Jest is a unit testing framework that prides itself on minimal setup and configuration overhead.
This claim is aided by the assertion library, rich mocking support and <a href=https://jestjs.io/docs/en/snapshot-testing rel="external noopener" target=_blank>snapshot testing</a> provided out-of-the-box.
Following several standard conventions, such as placing tests within a <code>__tests__</code> directory, Jest is able to automatically locate tests and run them in parallel for speed.</p><p>One source of confusion when looking at Jest is the misrepresentation that it can only target React-based applications.
This is not the case, and is highlighted as such in their own documentation.</p><blockquote><p>Although Jest may be considered a React-specific test runner, in fact it is a universal testing platform, with the ability to adapt to any JavaScript library or framework.
You can use Jest to test any JavaScript code.</p></blockquote><p>This is great, as it means we can take advantage of the awesome features discussed, regardless of the JavaScript application we are building.</p><h2 id=setting-up-jest>Setting up Jest</h2><p>Now we have familiarised ourselves with what Jest can do, let us begin by getting it set up within the project.
The first step is to add the following configuration to the <code>package.json</code> file.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;devDependencies&#34;</span>: {
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;jest&#34;</span>: <span style=color:#e6db74>&#34;^23.1.0&#34;</span>
</span></span><span style=display:flex><span>  },
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;scripts&#34;</span>: {
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;test&#34;</span>: <span style=color:#e6db74>&#34;jest&#34;</span>
</span></span><span style=display:flex><span>  },
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;jest&#34;</span>: {
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;rootDir&#34;</span>: <span style=color:#e6db74>&#34;./src&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;cacheDirectory&#34;</span>: <span style=color:#e6db74>&#34;./node_modules/.cache/jest&#34;</span>
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Along with the expected development dependency, we add the new script definition which will allow us to execute the test suite by simply running <code>npm test</code>.
Finally, we configure several Jest-specific options, the first of which is to specify the root location to search for tests.
We also configure where Jest should store any cached items (to speed up test execution), opting for within <code>node_modules</code> as the Docker setup stores this within a stateful volume.</p><p>We can now add a new target to the <code>Makefile</code> to easily invoke desired test invocations.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-make data-lang=make><span style=display:flex><span><span style=color:#a6e22e>test</span><span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>  docker-compose run --rm serverless npm test
</span></span></code></pre></div><p>As we are using Jest in an application that does not include external assets (such as images or stylesheets), we do not need to worry about further <a href=https://jestjs.io/docs/en/webpack rel="external noopener" target=_blank>configuring Webpack</a> in this use case.</p><h2 id=separating-the-domain-logic-from-the-delivery-mechanism>Separating the Domain Logic from the Delivery Mechanism</h2><p>In the <a href=/posts/mince-pie-challenge-setting-up-flow-with-babel-and-webpack/>previous article</a> we delved into adding types to the user authentication handler abstraction.
We will now expand upon this and provide sufficient test coverage to each of the three handler options.
To do this we must first break out each handler type into separate modules, where we will define the handler up to the point that we require the concrete services.
We will leave this responsibility to the specific delivery mechanism, in this instance that will be specified in <code>src/auth.js</code>.</p><p>First, we shall create a new file <code>src/handlers/public.js</code>, which will contain the &lsquo;public&rsquo; handler definition.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#75715e>// @flow
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> { <span style=color:#a6e22e>createHandler</span> } <span style=color:#a6e22e>from</span> <span style=color:#e6db74>&#39;../helpers/handlers&#39;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>handler</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>async</span> () =&gt; ({
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>statusCode</span><span style=color:#f92672>:</span> <span style=color:#ae81ff>200</span>,
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>body</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>JSON</span>.<span style=color:#a6e22e>stringify</span>({ <span style=color:#a6e22e>userId</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;N/A&#39;</span> }),
</span></span><span style=display:flex><span>});
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>export</span> <span style=color:#66d9ef>default</span> <span style=color:#a6e22e>createHandler</span>(<span style=color:#a6e22e>handler</span>);
</span></span></code></pre></div><p>This handler is relatively simple, as we do not expect a <code>userId</code> to be supplied it can simply return a static &lsquo;N/A&rsquo;.
We will follow this by creating another new file <code>src/handlers/optional.js</code>, which will contain the &lsquo;optional&rsquo; handler definition.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#75715e>// @flow
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> { <span style=color:#a6e22e>createHandler</span>, <span style=color:#a6e22e>withOptionalHttpAuthentication</span> } <span style=color:#a6e22e>from</span> <span style=color:#e6db74>&#39;../helpers/handlers&#39;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>handler</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>async</span> ({ <span style=color:#a6e22e>userId</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;N/A&#39;</span> }) =&gt; ({
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>statusCode</span><span style=color:#f92672>:</span> <span style=color:#ae81ff>200</span>,
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>body</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>JSON</span>.<span style=color:#a6e22e>stringify</span>({ <span style=color:#a6e22e>userId</span> }),
</span></span><span style=display:flex><span>});
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>export</span> <span style=color:#66d9ef>default</span> <span style=color:#a6e22e>createHandler</span>(<span style=color:#a6e22e>withOptionalHttpAuthentication</span>(<span style=color:#a6e22e>handler</span>));
</span></span></code></pre></div><p>In this case we have to cater for the possibility that the <code>userId</code> is optionally supplied to the underlying handler implementation.
Finally, we shall create a new file <code>src/handlers/strict.js</code>, which will contain the &lsquo;strict&rsquo; handler definition.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#75715e>// @flow
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> { <span style=color:#a6e22e>createHandler</span>, <span style=color:#a6e22e>withStrictHttpAuthentication</span> } <span style=color:#a6e22e>from</span> <span style=color:#e6db74>&#39;../helpers/handlers&#39;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>handler</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>async</span> ({ <span style=color:#a6e22e>userId</span> }) =&gt; ({
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>statusCode</span><span style=color:#f92672>:</span> <span style=color:#ae81ff>200</span>,
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>body</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>JSON</span>.<span style=color:#a6e22e>stringify</span>({ <span style=color:#a6e22e>userId</span> }),
</span></span><span style=display:flex><span>});
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>export</span> <span style=color:#66d9ef>default</span> <span style=color:#a6e22e>createHandler</span>(<span style=color:#a6e22e>withStrictHttpAuthentication</span>(<span style=color:#a6e22e>handler</span>));
</span></span></code></pre></div><p>In this case we can be confident in our assumption that a valid <code>userId</code> will be supplied at all times to the underlying handler implementation.
With the handlers now defined we can update the <code>src/auth.js</code> delivery implementation, which wires the handlers and service dependencies together.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#75715e>// @flow
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> <span style=color:#a6e22e>publicHandler</span> <span style=color:#a6e22e>from</span> <span style=color:#e6db74>&#39;./handlers/public&#39;</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> <span style=color:#a6e22e>optionalHandler</span> <span style=color:#a6e22e>from</span> <span style=color:#e6db74>&#39;./handlers/optional&#39;</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> <span style=color:#a6e22e>strictHandler</span> <span style=color:#a6e22e>from</span> <span style=color:#e6db74>&#39;./handlers/strict&#39;</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> <span style=color:#a6e22e>createUserTokenAuthenticator</span> <span style=color:#a6e22e>from</span> <span style=color:#e6db74>&#39;./services/userTokenAuthenticator&#39;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> { <span style=color:#a6e22e>USER_POOL_ID</span> } <span style=color:#f92672>=</span> <span style=color:#a6e22e>process</span>.<span style=color:#a6e22e>env</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#a6e22e>USER_POOL_ID</span>) {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> Error(<span style=color:#e6db74>&#39;USER_POOL_ID is not present&#39;</span>);
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>getUserIdFromToken</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>createUserTokenAuthenticator</span>(<span style=color:#a6e22e>USER_POOL_ID</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>export</span> <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>public_</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>publicHandler</span>({});
</span></span><span style=display:flex><span><span style=color:#66d9ef>export</span> <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>optional</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>optionalHandler</span>({ <span style=color:#a6e22e>getUserIdFromToken</span> });
</span></span><span style=display:flex><span><span style=color:#66d9ef>export</span> <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>strict</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>strictHandler</span>({ <span style=color:#a6e22e>getUserIdFromToken</span> });
</span></span></code></pre></div><p>We could have just as easily provided these concrete handlers in separate files, but as this is only an example (and two require the <code>getUserIdFromToken</code> service) this will suffice.
If we now run <code>make deploy</code> with this updated implementation, we should see that no externally visible behaviour has changed.
What we have done, however, is clearly separate the domain logic from the delivery mechanism.
This means that we can now easily test the handler domain in isolation, without the need for a concrete Cognito-backed <code>getUserIdFromToken</code> service or API Gateway request.</p><h2 id=testing-the-domain-logic>Testing the Domain Logic</h2><p>We can now begin providing test coverage to the three handler implementations, to ensure that we are confident in their roles.
To do this we will first extend the global test environment that Jest provides the tests with.
We will do this by adding a small helper function that will be used to parse the response returned from the handlers.
This can be achieved by adding a <a href=https://jestjs.io/docs/en/configuration.html#setupfiles-array rel="external noopener" target=_blank>setupFiles</a> entry to the <code>package.json</code> file.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;jest&#34;</span>: {
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;setupFiles&#34;</span>: [<span style=color:#e6db74>&#34;./jestSetup.js&#34;</span>]
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>With this now defined, we can add the <code>src/jestSetup.js</code> file as follows.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#a6e22e>global</span>.<span style=color:#a6e22e>parseResponse</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>response</span> =&gt; {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>expect</span>(<span style=color:#a6e22e>response</span>).<span style=color:#a6e22e>toMatchSnapshot</span>();
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>response</span>.<span style=color:#a6e22e>body</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>JSON</span>.<span style=color:#a6e22e>parse</span>(<span style=color:#a6e22e>response</span>.<span style=color:#a6e22e>body</span>);
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>response</span>;
</span></span><span style=display:flex><span>};
</span></span></code></pre></div><p>You can see that the helper performs a snapshot assertion based on the response input, before doing any transformations.
Snapshot testing is a very powerful way of ensuring that a desired structure (React component, Object) does not unexpectedly change.
With this helper now available within our test environment, we can move on to testing the public handler use case within <code>src/__tests__/public.js</code>.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#66d9ef>import</span> <span style=color:#a6e22e>handler</span> <span style=color:#a6e22e>from</span> <span style=color:#e6db74>&#39;../handlers/public&#39;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>it</span>(<span style=color:#e6db74>&#39;successfully responds with no user id&#39;</span>, <span style=color:#66d9ef>async</span> () =&gt; {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>services</span> <span style=color:#f92672>=</span> {};
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>response</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>parseResponse</span>(<span style=color:#66d9ef>await</span> <span style=color:#a6e22e>handler</span>(<span style=color:#a6e22e>services</span>)({}, {}));
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>expect</span>(<span style=color:#a6e22e>response</span>.<span style=color:#a6e22e>statusCode</span>).<span style=color:#a6e22e>toBe</span>(<span style=color:#ae81ff>200</span>);
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>expect</span>(<span style=color:#a6e22e>response</span>.<span style=color:#a6e22e>body</span>.<span style=color:#a6e22e>userId</span>).<span style=color:#a6e22e>toBe</span>(<span style=color:#e6db74>&#39;N/A&#39;</span>);
</span></span><span style=display:flex><span>});
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>it</span>(<span style=color:#e6db74>&#39;successfully responds with no user id when access token found&#39;</span>, <span style=color:#66d9ef>async</span> () =&gt; {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>services</span> <span style=color:#f92672>=</span> { <span style=color:#a6e22e>getUserIdFromToken</span><span style=color:#f92672>:</span> () =&gt; Promise.<span style=color:#a6e22e>resolve</span>(<span style=color:#e6db74>&#39;USER_ID&#39;</span>) };
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>response</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>parseResponse</span>(
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>handler</span>(<span style=color:#a6e22e>services</span>)({ <span style=color:#a6e22e>headers</span><span style=color:#f92672>:</span> { <span style=color:#a6e22e>Authorization</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;TOKEN&#39;</span> } }, {})
</span></span><span style=display:flex><span>  );
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>expect</span>(<span style=color:#a6e22e>response</span>.<span style=color:#a6e22e>statusCode</span>).<span style=color:#a6e22e>toBe</span>(<span style=color:#ae81ff>200</span>);
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>expect</span>(<span style=color:#a6e22e>response</span>.<span style=color:#a6e22e>body</span>.<span style=color:#a6e22e>userId</span>).<span style=color:#a6e22e>toBe</span>(<span style=color:#e6db74>&#39;N/A&#39;</span>);
</span></span><span style=display:flex><span>});
</span></span></code></pre></div><p>Within each test case we are able to take advantage of <code>async/await</code> syntax to succinctly handle the asynchronous handler response.
Due to how we have delayed the inclusion of any service within the handler, we are able to easily provide any <a href=https://martinfowler.com/bliki/TestDouble.html rel="external noopener" target=_blank>test doubles</a> we see fit.
With the concrete handler now created, we only need to supply the API Gateway Event and Context objects.
If we wished to further distance ourselves from the AWS Lambda specifics, we could provide an interface that each delivery must implement to normalise the handler requirements.
Finally, we inspect the parsed response and assert that it matches our intended state.</p><p>If we now run <code>make test</code>, we can see that the first test cases are now successfully executed.
Upon this first execution you will notice that a <code>src/__tests__/__snapshots__</code> directory is created.
This stores the expected state based on the snapshot assertions we have included in the <code>parseResponse</code> function.
We can now carry on and test the optional handler&rsquo;s behaviour within <code>src/__tests__/optional.js</code>.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#66d9ef>import</span> <span style=color:#a6e22e>handler</span> <span style=color:#a6e22e>from</span> <span style=color:#e6db74>&#39;../handlers/optional&#39;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>it</span>(<span style=color:#e6db74>&#39;successfully responds with no user id when access token not found&#39;</span>, <span style=color:#66d9ef>async</span> () =&gt; {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>services</span> <span style=color:#f92672>=</span> { <span style=color:#a6e22e>getUserIdFromToken</span><span style=color:#f92672>:</span> () =&gt; Promise.<span style=color:#a6e22e>resolve</span>() };
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>response</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>parseResponse</span>(
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>handler</span>(<span style=color:#a6e22e>services</span>)({ <span style=color:#a6e22e>headers</span><span style=color:#f92672>:</span> { <span style=color:#a6e22e>Authorization</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;TOKEN&#39;</span> } }, {})
</span></span><span style=display:flex><span>  );
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>expect</span>(<span style=color:#a6e22e>response</span>.<span style=color:#a6e22e>statusCode</span>).<span style=color:#a6e22e>toBe</span>(<span style=color:#ae81ff>200</span>);
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>expect</span>(<span style=color:#a6e22e>response</span>.<span style=color:#a6e22e>body</span>.<span style=color:#a6e22e>userId</span>).<span style=color:#a6e22e>toBe</span>(<span style=color:#e6db74>&#39;N/A&#39;</span>);
</span></span><span style=display:flex><span>});
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>it</span>(<span style=color:#e6db74>&#39;successfully responds with a user id when access token found&#39;</span>, <span style=color:#66d9ef>async</span> () =&gt; {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>services</span> <span style=color:#f92672>=</span> { <span style=color:#a6e22e>getUserIdFromToken</span><span style=color:#f92672>:</span> () =&gt; Promise.<span style=color:#a6e22e>resolve</span>(<span style=color:#e6db74>&#39;USER_ID&#39;</span>) };
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>response</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>parseResponse</span>(
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>handler</span>(<span style=color:#a6e22e>services</span>)({ <span style=color:#a6e22e>headers</span><span style=color:#f92672>:</span> { <span style=color:#a6e22e>Authorization</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;TOKEN&#39;</span> } }, {})
</span></span><span style=display:flex><span>  );
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>expect</span>(<span style=color:#a6e22e>response</span>.<span style=color:#a6e22e>statusCode</span>).<span style=color:#a6e22e>toBe</span>(<span style=color:#ae81ff>200</span>);
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>expect</span>(<span style=color:#a6e22e>response</span>.<span style=color:#a6e22e>body</span>.<span style=color:#a6e22e>userId</span>).<span style=color:#a6e22e>toBe</span>(<span style=color:#e6db74>&#39;USER_ID&#39;</span>);
</span></span><span style=display:flex><span>});
</span></span></code></pre></div><p>These test cases follow the similar <a href=http://wiki.c2.com/?ArrangeActAssert rel="external noopener" target=_blank>Arrange, Act, Assert</a> pattern that is found in the previous one.
Finally, we can test the strict handler behaviour within <code>src/__tests__/strict.js</code>.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#66d9ef>import</span> <span style=color:#a6e22e>handler</span> <span style=color:#a6e22e>from</span> <span style=color:#e6db74>&#39;../handlers/strict&#39;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>it</span>(<span style=color:#e6db74>&#39;fails to respond when access token not found&#39;</span>, <span style=color:#66d9ef>async</span> () =&gt; {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>services</span> <span style=color:#f92672>=</span> { <span style=color:#a6e22e>getUserIdFromToken</span><span style=color:#f92672>:</span> () =&gt; Promise.<span style=color:#a6e22e>resolve</span>() };
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>response</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>parseResponse</span>(
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>handler</span>(<span style=color:#a6e22e>services</span>)({ <span style=color:#a6e22e>headers</span><span style=color:#f92672>:</span> { <span style=color:#a6e22e>Authorization</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;TOKEN&#39;</span> } }, {})
</span></span><span style=display:flex><span>  );
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>expect</span>(<span style=color:#a6e22e>response</span>.<span style=color:#a6e22e>statusCode</span>).<span style=color:#a6e22e>toBe</span>(<span style=color:#ae81ff>401</span>);
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>expect</span>(<span style=color:#a6e22e>response</span>.<span style=color:#a6e22e>body</span>.<span style=color:#a6e22e>title</span>).<span style=color:#a6e22e>toBe</span>(<span style=color:#e6db74>&#39;Unauthorized&#39;</span>);
</span></span><span style=display:flex><span>});
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>it</span>(<span style=color:#e6db74>&#39;successfully responds with a user id when access token found&#39;</span>, <span style=color:#66d9ef>async</span> () =&gt; {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>services</span> <span style=color:#f92672>=</span> { <span style=color:#a6e22e>getUserIdFromToken</span><span style=color:#f92672>:</span> () =&gt; Promise.<span style=color:#a6e22e>resolve</span>(<span style=color:#e6db74>&#39;USER_ID&#39;</span>) };
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>response</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>parseResponse</span>(
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>handler</span>(<span style=color:#a6e22e>services</span>)({ <span style=color:#a6e22e>headers</span><span style=color:#f92672>:</span> { <span style=color:#a6e22e>Authorization</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;TOKEN&#39;</span> } }, {})
</span></span><span style=display:flex><span>  );
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>expect</span>(<span style=color:#a6e22e>response</span>.<span style=color:#a6e22e>statusCode</span>).<span style=color:#a6e22e>toBe</span>(<span style=color:#ae81ff>200</span>);
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>expect</span>(<span style=color:#a6e22e>response</span>.<span style=color:#a6e22e>body</span>.<span style=color:#a6e22e>userId</span>).<span style=color:#a6e22e>toBe</span>(<span style=color:#e6db74>&#39;USER_ID&#39;</span>);
</span></span><span style=display:flex><span>});
</span></span></code></pre></div><p>With all three handlers now covered by tests, we can re-run <code>make test</code> and assert that the code behaves as intended.</p><h2 id=adding-continuous-integration-using-travis-ci>Adding Continuous Integration using Travis CI</h2><p>We have now spent some time introducing a type system and test coverage to our project.
All would be in vain, however, if they were not run on a regular basis.
With this in mind, we will introduce <a href=https://travis-ci.org/ rel="external noopener" target=_blank>Travis CI</a> into the project, which is a <a href=https://martinfowler.com/articles/continuousIntegration.html rel="external noopener" target=_blank>Continuous Integration</a> service that integrates with GitHub.</p><p>Our goal will be to re-run both the type checks and test coverage upon each new commit to the remote GitHub repository.
In doing so, the service will alert us to any <a href=https://en.wikipedia.org/wiki/Regression_testing rel="external noopener" target=_blank>test regressions</a> along the way.
As Travis CI integrates seamlessly with GitHub, it is very easy to <a href=https://docs.travis-ci.com/user/getting-started rel="external noopener" target=_blank>connect</a> and provide a repository configuration by way of a root <code>.travis.yml</code> file.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>sudo</span>: <span style=color:#ae81ff>required</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>services</span>:
</span></span><span style=display:flex><span>  - <span style=color:#ae81ff>docker</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>env</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>DOCKER_COMPOSE_VERSION</span>: <span style=color:#ae81ff>1.21.1</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>before_install</span>:
</span></span><span style=display:flex><span>  - <span style=color:#ae81ff>sudo rm /usr/local/bin/docker-compose</span>
</span></span><span style=display:flex><span>  - <span style=color:#ae81ff>curl -L https://github.com/docker/compose/releases/download/${DOCKER_COMPOSE_VERSION}/docker-compose-`uname -s`-`uname -m` &gt; docker-compose</span>
</span></span><span style=display:flex><span>  - <span style=color:#ae81ff>chmod +x docker-compose</span>
</span></span><span style=display:flex><span>  - <span style=color:#ae81ff>sudo mv docker-compose /usr/local/bin</span>
</span></span><span style=display:flex><span>  - <span style=color:#ae81ff>docker-compose --version</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>script</span>:
</span></span><span style=display:flex><span>  - <span style=color:#ae81ff>cp .env.example .env</span>
</span></span><span style=display:flex><span>  - <span style=color:#ae81ff>docker-compose run --rm serverless npm install</span>
</span></span><span style=display:flex><span>  - <span style=color:#ae81ff>docker-compose run --rm serverless npm run flow</span>
</span></span><span style=display:flex><span>  - <span style=color:#ae81ff>docker-compose run --rm serverless npm test</span>
</span></span></code></pre></div><p>Looking at the configuration above, you will see that we take advantage of Docker, running the container commands as we would in our local environment.
Docker comes as standard within the Travis CI environment, but Docker Compose does not.
As a result, we must first ensure that we have the desired version present for use.
We can then set up a dummy <code>.env</code> file (which is required by our Docker Compose configuration), and then test the build.
If any command returns a non-zero response, Travis CI assumes this to be an issue and will fail the build.
You can see how a successful build looks in the screenshot below.</p><p><picture><source type=image/webp srcset="/posts/mince-pie-challenge-adding-test-coverage-using-jest-and-travis-ci/travis-ci_hu_f2f9dc232a9a3e28.webp 350w, /posts/mince-pie-challenge-adding-test-coverage-using-jest-and-travis-ci/travis-ci_hu_d847419c5b38e434.webp 700w, /posts/mince-pie-challenge-adding-test-coverage-using-jest-and-travis-ci/travis-ci_hu_d1345610512ef60b.webp 1400w"><source type=image/jpeg srcset="/posts/mince-pie-challenge-adding-test-coverage-using-jest-and-travis-ci/travis-ci_hu_1533568b0fcbfbfe.jpg 350w, /posts/mince-pie-challenge-adding-test-coverage-using-jest-and-travis-ci/travis-ci_hu_6bf506f764276fde.jpg 700w, /posts/mince-pie-challenge-adding-test-coverage-using-jest-and-travis-ci/travis-ci_hu_955cf53a4fae1b55.jpg 1400w"><img src=/posts/mince-pie-challenge-adding-test-coverage-using-jest-and-travis-ci/travis-ci_hu_6bf506f764276fde.jpg alt="Travis CI" loading=lazy></picture></p><p>We now have a well-equipped Continuous Integration pipeline in place.
Join me in the <a href=/posts/mince-pie-challenge-adding-the-bootstrap-endpoint-and-serverless-offline/>next post</a> of the <a href=/archive/tag/mince-pie-challenge-series>series</a>, where we will begin implementing the Bootstrap API endpoint, experimenting with running the endpoint locally using <a href=https://github.com/dherault/serverless-offline rel="external noopener" target=_blank>Serverless Offline</a>.</p></main><footer class=post-footer><ul class="tags tags--large"><li><a href=/archive/tag/jest>jest</a></li><li><a href=/archive/tag/testing>testing</a></li><li><a href=/archive/tag/javascript>javascript</a></li><li><a href=/archive/tag/mince-pie-challenge-series>mince-pie-challenge-series</a></li></ul><div class=related><h3 class=related__title>Related Posts</h3><ul class=related__posts><li><a href=/posts/mince-pie-challenge-setting-up-flow-with-babel-and-webpack/>Mince Pie Challenge: Setting up Flow with Babel and Webpack</a></li><li><a href=/posts/mince-pie-challenge-building-a-serverless-restful-api-and-react-client/>Mince Pie Challenge: Building a Serverless RESTful API and React Client</a></li><li><a href=/posts/mince-pie-challenge-authentication-with-amazon-cognito-and-json-web-tokens/>Mince Pie Challenge: Authentication with Amazon Cognito and JSON Web Tokens</a></li><li><a href=/posts/mince-pie-challenge-setting-up-the-serverless-framework-with-docker-webpack-and-babel/>Mince Pie Challenge: Setting up the Serverless Framework with Docker, Webpack and Babel</a></li><li><a href=/posts/mince-pie-challenge-designing-the-restful-api-with-raml/>Mince Pie Challenge: Designing the RESTful API with RAML</a></li></ul></div></footer></article><div class=scroll-watcher></div></main><footer class="site-footer l-wrapper"><div>&copy; 2025, Edd Mann</div><button class=site-footer__theme-toggle type=button title="Toggle theme" aria-label="Toggle theme"><svg fill="currentcolor" viewBox="0 0 32 32" role="img"><title>Theme toggle icon</title><desc>A circle representing the moon for toggling theme</desc><path d="M16 .5C7.4.5.5 7.4.5 16S7.4 31.5 16 31.5 31.5 24.6 31.5 16 24.6.5 16 .5zm0 28.1V3.4C23 3.4 28.6 9 28.6 16S23 28.6 16 28.6z"/></svg></button></footer></body></html>