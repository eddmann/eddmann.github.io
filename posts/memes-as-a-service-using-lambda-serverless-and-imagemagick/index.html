<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><title>'Memes as a Service' using Lambda, Serverless and ImageMagick - Edd Mann</title>
<meta name=description content="Learn how to create a 'Memes as a Service' platform using AWS Lambda, the Serverless Framework, and ImageMagick. A step-by-step guide with code examples."><meta name=author content="Edd Mann"><script async src="https://www.googletagmanager.com/gtag/js?id=G-ZPQ7WHNXH4"></script><script>var dnt,doNotTrack=!1;if(!1&&(dnt=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,doNotTrack=dnt=="1"||dnt=="yes"),!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-ZPQ7WHNXH4")}</script><meta itemprop=name content="'Memes as a Service' using Lambda, Serverless and ImageMagick"><meta itemprop=description content="I’ve recently become really interested in the concept of Functions as a Service (FaaS) and the Serverless Framework. I decided to create a small experimental AWS Lambda function to explore how it could be used to manipulate images. For this contrived example, I came up with the (silly) idea of ‘Memes as a Service’ (everything needs to be a service nowadays)."><meta itemprop=datePublished content="2017-12-04T00:00:00+00:00"><meta itemprop=dateModified content="2017-12-04T00:00:00+00:00"><meta itemprop=wordCount content="723"><meta itemprop=keywords content="Serverless,Aws,Lambda,Javascript"><meta property="og:url" content="https://eddmann.com/posts/memes-as-a-service-using-lambda-serverless-and-imagemagick/"><meta property="og:site_name" content="Edd Mann"><meta property="og:title" content="'Memes as a Service' using Lambda, Serverless and ImageMagick"><meta property="og:description" content="I’ve recently become really interested in the concept of Functions as a Service (FaaS) and the Serverless Framework. I decided to create a small experimental AWS Lambda function to explore how it could be used to manipulate images. For this contrived example, I came up with the (silly) idea of ‘Memes as a Service’ (everything needs to be a service nowadays)."><meta property="og:locale" content="en_GB"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2017-12-04T00:00:00+00:00"><meta property="article:modified_time" content="2017-12-04T00:00:00+00:00"><meta property="article:tag" content="Serverless"><meta property="article:tag" content="Aws"><meta property="article:tag" content="Lambda"><meta property="article:tag" content="Javascript"><meta name=twitter:card content="summary"><meta name=twitter:title content="'Memes as a Service' using Lambda, Serverless and ImageMagick"><meta name=twitter:description content="I’ve recently become really interested in the concept of Functions as a Service (FaaS) and the Serverless Framework. I decided to create a small experimental AWS Lambda function to explore how it could be used to manipulate images. For this contrived example, I came up with the (silly) idea of ‘Memes as a Service’ (everything needs to be a service nowadays)."><meta name=twitter:site content="@edd_mann"><link rel="preload stylesheet" as=style href=/css/style.min.a5107d712048e2bf498ca68b768b337bccdd6ce7b257419de1c0762b86ab1143.css integrity="sha256-pRB9cSBI4r9JjKaLdosze8zdbOeyV0Gd4cB2K4arEUM="><link rel=preload as=image href=/assets/x.svg><link rel=preload as=image href=/assets/github.svg><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=manifest href=/site.webmanifest><link rel=canonical href=https://eddmann.com/posts/memes-as-a-service-using-lambda-serverless-and-imagemagick/></head><body><header class="site-header wrapper"><a href=https://eddmann.com/><h3 class=site-header__title>Edd Mann
<span style=--url:url(/assets/code.svg)>Developer</span></h3></a><div class=site-header__mobile-navigation-button aria-label="Toggle mobile site navigation" aria-expanded=false aria-controls=site-navigation></div><div class=site-header__navigation id=site-navigation><nav aria-label="Primary navigation"><ul class=site-header__primary-navigation><li><a href=/archive>Archive</a></li><li><a href=/projects>Projects</a></li><li><a href=/about>About</a></li></ul></nav><nav aria-label="Social links"><ul class=site-header__social-navigation><li><a class=social-icon style=--url:url(/assets/x.svg) href=https://x.com/edd_mann rel="external noopener" target=_blank>Twitter (X)</a></li><li><a class=social-icon style=--url:url(/assets/github.svg) href=https://github.com/eddmann rel="external noopener" target=_blank>GitHub</a></li></ul></nav></div></header><main class=wrapper><article><header class=page-title><h1>'Memes as a Service' using Lambda, Serverless and ImageMagick</h1><time class=post__time>Dec 4, 2017</time></header><main class=prose><p>I&rsquo;ve recently become really interested in the concept of Functions as a Service (FaaS) and the <a href=https://serverless.com/ rel="external noopener" target=_blank>Serverless Framework</a>.
I decided to create a small experimental AWS Lambda function to explore how it could be used to manipulate images.
For this contrived example, I came up with the (silly) idea of &lsquo;Memes as a Service&rsquo; (everything needs to be a service nowadays).</p><p>The consumer will be able to supply top and bottom text, along with specifying the desired supporting image.
Fortunately, the stock Lambda Node.js environment comes equipped with support for the popular <a href=https://www.imagemagick.org/ rel="external noopener" target=_blank>ImageMagick</a>.
In this blog post, I will present how I went about solving this problem using the Serverless Framework.</p><h2 id=setup-and-configuration>Setup and Configuration</h2><p>I will assume that you already have the Serverless Framework and an AWS Access Key set up on your development machine.
With these installed, we first create a new Serverless application based on the provided template.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ serverless create --template aws-nodejs --path memes-as-a-service
</span></span></code></pre></div><p>We should now be able to navigate into the newly created <code>memes-as-a-service</code> directory.
As we want to interact with ImageMagick, we also need to include the <a href=http://aheckmann.github.io/gm/ rel="external noopener" target=_blank>suitable package</a> for Node.js.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ npm install gm --save
</span></span></code></pre></div><p>The next step is to open the <code>serverless.yml</code> file.
This file outlines the provider information (as the framework can handle other platforms such as <a href=https://cloud.google.com/ rel="external noopener" target=_blank>Google Cloud</a>), the required supporting resources, and the necessary function wiring.
Replace the sample contents of this file with the YAML definition below:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>service</span>: <span style=color:#ae81ff>meme-as-a-service</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>provider</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>aws</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>runtime</span>: <span style=color:#ae81ff>nodejs6.10</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>stage</span>: <span style=color:#ae81ff>prod</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>region</span>: <span style=color:#ae81ff>eu-west-1</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>environment</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>IMAGES_DIR</span>: <span style=color:#ae81ff>./images/</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>TEXT_SIZE</span>: <span style=color:#ae81ff>50</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>TEXT_PADDING</span>: <span style=color:#ae81ff>40</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>plugins</span>:
</span></span><span style=display:flex><span>  - <span style=color:#ae81ff>serverless-apigw-binary</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>custom</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>apigwBinary</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>types</span>:
</span></span><span style=display:flex><span>      - <span style=color:#e6db74>&#39;*/*&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>functions</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>meme</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>handler</span>: <span style=color:#ae81ff>handler.meme</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>events</span>:
</span></span><span style=display:flex><span>      - <span style=color:#f92672>http</span>:
</span></span><span style=display:flex><span>          <span style=color:#f92672>path</span>: <span style=color:#ae81ff>/</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>method</span>: <span style=color:#ae81ff>get</span>
</span></span></code></pre></div><p>In this definition, we configure an AWS Lambda Node.js-based container.
We provide a couple of environment variables that will be accessible within our function implementations.
We then use a <a href=https://github.com/maciejtreder/serverless-apigw-binary rel="external noopener" target=_blank>Serverless plugin</a> to correctly add the required binary support to the API Gateway.
Finally, we define the single function, taking advantage of how the framework integrates with <a href=https://aws.amazon.com/cloudformation/ rel="external noopener" target=_blank>CloudFormation</a> to correctly wire it up to <a href=https://aws.amazon.com/api-gateway/ rel="external noopener" target=_blank>API Gateway</a>.
Before continuing, we should include the Serverless plugin as a development dependency.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ npm install serverless-apigw-binary --save-dev
</span></span></code></pre></div><h2 id=implementation>Implementation</h2><p>Now, with the blueprint in place, we can create the implementation.
Replace the sample <code>handler.js</code> contents with the following:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#e6db74>&#39;use strict&#39;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>gm</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>require</span>(<span style=color:#e6db74>&#39;gm&#39;</span>).<span style=color:#a6e22e>subClass</span>({ <span style=color:#a6e22e>imageMagick</span><span style=color:#f92672>:</span> <span style=color:#66d9ef>true</span> });
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>fs</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>require</span>(<span style=color:#e6db74>&#39;fs&#39;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> { <span style=color:#a6e22e>IMAGES_DIR</span>, <span style=color:#a6e22e>TEXT_SIZE</span>, <span style=color:#a6e22e>TEXT_PADDING</span> } <span style=color:#f92672>=</span> <span style=color:#a6e22e>process</span>.<span style=color:#a6e22e>env</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>parseText</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>text</span> =&gt; (<span style=color:#a6e22e>text</span> <span style=color:#f92672>||</span> <span style=color:#e6db74>&#39;&#39;</span>).<span style=color:#a6e22e>toUpperCase</span>();
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>getImages</span> <span style=color:#f92672>=</span> () =&gt; <span style=color:#a6e22e>fs</span>.<span style=color:#a6e22e>readdirSync</span>(<span style=color:#a6e22e>IMAGES_DIR</span>);
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>parseImage</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>image</span> =&gt; <span style=color:#a6e22e>getImages</span>().<span style=color:#a6e22e>find</span>(<span style=color:#a6e22e>file</span> =&gt; <span style=color:#a6e22e>file</span>.<span style=color:#a6e22e>indexOf</span>(<span style=color:#a6e22e>image</span>) <span style=color:#f92672>===</span> <span style=color:#ae81ff>0</span>);
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>random</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>arr</span> =&gt; <span style=color:#a6e22e>arr</span>[Math.<span style=color:#a6e22e>floor</span>(Math.<span style=color:#a6e22e>random</span>() <span style=color:#f92672>*</span> <span style=color:#a6e22e>arr</span>.<span style=color:#a6e22e>length</span>)];
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>randomImage</span> <span style=color:#f92672>=</span> () =&gt; <span style=color:#a6e22e>random</span>(<span style=color:#a6e22e>getImages</span>());
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>module</span>.<span style=color:#a6e22e>exports</span>.<span style=color:#a6e22e>meme</span> <span style=color:#f92672>=</span> (<span style=color:#a6e22e>event</span>, <span style=color:#a6e22e>context</span>, <span style=color:#a6e22e>callback</span>) =&gt; {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>input</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>event</span>.<span style=color:#a6e22e>queryStringParameters</span> <span style=color:#f92672>||</span> {};
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>top</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>parseText</span>(<span style=color:#a6e22e>input</span>.<span style=color:#a6e22e>top</span>);
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>bottom</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>parseText</span>(<span style=color:#a6e22e>input</span>.<span style=color:#a6e22e>bottom</span>);
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>image</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>parseImage</span>(<span style=color:#a6e22e>input</span>.<span style=color:#a6e22e>image</span>) <span style=color:#f92672>||</span> <span style=color:#a6e22e>randomImage</span>();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>meme</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>gm</span>(<span style=color:#e6db74>`</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>IMAGES_DIR</span><span style=color:#e6db74>}${</span><span style=color:#a6e22e>image</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>meme</span>.<span style=color:#a6e22e>size</span>(<span style=color:#66d9ef>function</span> (<span style=color:#a6e22e>err</span>, { <span style=color:#a6e22e>height</span> }) {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>meme</span>
</span></span><span style=display:flex><span>      .<span style=color:#a6e22e>font</span>(<span style=color:#e6db74>&#39;./impact.ttf&#39;</span>, <span style=color:#a6e22e>TEXT_SIZE</span>)
</span></span><span style=display:flex><span>      .<span style=color:#a6e22e>fill</span>(<span style=color:#e6db74>&#39;white&#39;</span>)
</span></span><span style=display:flex><span>      .<span style=color:#a6e22e>stroke</span>(<span style=color:#e6db74>&#39;black&#39;</span>, <span style=color:#ae81ff>2</span>)
</span></span><span style=display:flex><span>      .<span style=color:#a6e22e>drawText</span>(<span style=color:#ae81ff>0</span>, <span style=color:#f92672>-</span>(<span style=color:#a6e22e>height</span> <span style=color:#f92672>/</span> <span style=color:#ae81ff>2</span> <span style=color:#f92672>-</span> <span style=color:#a6e22e>TEXT_PADDING</span>), <span style=color:#a6e22e>top</span>, <span style=color:#e6db74>&#39;center&#39;</span>)
</span></span><span style=display:flex><span>      .<span style=color:#a6e22e>drawText</span>(<span style=color:#ae81ff>0</span>, <span style=color:#a6e22e>height</span> <span style=color:#f92672>/</span> <span style=color:#ae81ff>2</span> <span style=color:#f92672>-</span> <span style=color:#a6e22e>TEXT_PADDING</span>, <span style=color:#a6e22e>bottom</span>, <span style=color:#e6db74>&#39;center&#39;</span>)
</span></span><span style=display:flex><span>      .<span style=color:#a6e22e>toBuffer</span>(<span style=color:#66d9ef>function</span> (<span style=color:#a6e22e>err</span>, <span style=color:#a6e22e>buffer</span>) {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>callback</span>(<span style=color:#66d9ef>null</span>, {
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>statusCode</span><span style=color:#f92672>:</span> <span style=color:#ae81ff>200</span>,
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>headers</span><span style=color:#f92672>:</span> { <span style=color:#e6db74>&#39;Content-Type&#39;</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;image/jpeg&#39;</span> },
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>body</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>buffer</span>.<span style=color:#a6e22e>toString</span>(<span style=color:#e6db74>&#39;base64&#39;</span>),
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>isBase64Encoded</span><span style=color:#f92672>:</span> <span style=color:#66d9ef>true</span>,
</span></span><span style=display:flex><span>        });
</span></span><span style=display:flex><span>      });
</span></span><span style=display:flex><span>  });
</span></span><span style=display:flex><span>};
</span></span></code></pre></div><p>The function takes the query string input from the client and uses ImageMagick to add the provided text at the top and bottom of the selected image.
The Lambda function contains a directory (specified in the environment variables) of all available images that the client can choose from.
We also include the font in the distribution that we want to use for the text.
An interesting aspect is the Base64 encoding of the image response.
API Gateway supports <a href=https://aws.amazon.com/about-aws/whats-new/2016/11/binary-data-now-supported-by-api-gateway/ rel="external noopener" target=_blank>binary responses</a>, but to enable this, we must provide the <code>isBase64Encoded</code> flag along with the correct <code>Content-Type</code>.
We previously configured the media types that we want to be treated as binary within API Gateway using the added plugin.
Since the framework configures each API Gateway route to be in proxy mode by default, this is all we need to return the generated content.</p><h2 id=deployment>Deployment</h2><p>Finally, we can test this service by running:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ serverless deploy -v
</span></span></code></pre></div><p>I always use the <code>verbose</code> flag as it provides useful insight into what is happening within the framework under the hood.
Once deployed, you can visit the resulting API Gateway endpoint and experiment with generating your own memes!
You can find the complete code, along with supporting assets, in <a href=https://github.com/eddmann/memes-as-a-service-serverless rel="external noopener" target=_blank>this</a> GitHub repository.</p><p><picture><source type=image/webp srcset="/posts/memes-as-a-service-using-lambda-serverless-and-imagemagick/memes_hu_8f9165e3a976e75d.webp 350w, /posts/memes-as-a-service-using-lambda-serverless-and-imagemagick/memes_hu_da6415c86b853971.webp 600w"><source type=image/jpeg srcset="/posts/memes-as-a-service-using-lambda-serverless-and-imagemagick/memes_hu_fd0e37c8acf9700c.jpg 350w, /posts/memes-as-a-service-using-lambda-serverless-and-imagemagick/memes_hu_b6972512e38374cd.jpg 600w"><img src=/posts/memes-as-a-service-using-lambda-serverless-and-imagemagick/memes_hu_b6972512e38374cd.jpg alt="Memes as a Service" loading=lazy></picture></p></main><footer class=post__tags><a href=/archive/tag/serverless>serverless</a><a href=/archive/tag/aws>aws</a><a href=/archive/tag/lambda>lambda</a><a href=/archive/tag/javascript>javascript</a></footer></article><div class=scroll-watcher></div></main><footer class="site-footer wrapper"><div>&copy; 2025, Edd Mann</div></footer><script>(function(){document.querySelector(".site-header__mobile-navigation-button").addEventListener("click",e=>{document.documentElement.classList.toggle("mobile-navigation-open"),e.target.setAttribute("aria-expanded",e.target.getAttribute("aria-expanded")==="false"?"true":"false")});const n=document.querySelector(".site-header");let t=window.pageYOffset,e=!1;window.addEventListener("scroll",()=>{if(e)return;setTimeout(()=>{const s=window.pageYOffset;n.classList.toggle("is-sticky",s>0&&t>s),t=s,e=!1},500),e=!0})})()</script></body></html>