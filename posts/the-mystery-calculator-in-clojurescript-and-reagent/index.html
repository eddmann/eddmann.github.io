<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><title>The Mystery Calculator in ClojureScript and Reagent - Edd Mann</title>
<meta name=description content="Explore how to implement the Mystery Calculator, a classic Christmas cracker gift, using ClojureScript and Reagent with a clever binary trick."><meta name=author content="Edd Mann"><script async src="https://www.googletagmanager.com/gtag/js?id=G-ZPQ7WHNXH4"></script><script>var dnt,doNotTrack=!1;if(!1&&(dnt=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,doNotTrack=dnt=="1"||dnt=="yes"),!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-ZPQ7WHNXH4")}</script><meta itemprop=name content="The Mystery Calculator in ClojureScript and Reagent"><meta itemprop=description content="The Mystery Calculator is a commonly found Christmas cracker gift that uses a neat powers-of-two (binary) addition trick to fool the spectator. I thought it would be interesting to create a small web application in ClojureScript and Reagent that provides the ability to generate a selection of these cards and perform the trick."><meta itemprop=datePublished content="2020-10-31T00:00:00+00:00"><meta itemprop=dateModified content="2020-10-31T00:00:00+00:00"><meta itemprop=wordCount content="866"><meta itemprop=keywords content="Clojurescript,Reagent"><meta property="og:url" content="https://eddmann.com/posts/the-mystery-calculator-in-clojurescript-and-reagent/"><meta property="og:site_name" content="Edd Mann"><meta property="og:title" content="The Mystery Calculator in ClojureScript and Reagent"><meta property="og:description" content="The Mystery Calculator is a commonly found Christmas cracker gift that uses a neat powers-of-two (binary) addition trick to fool the spectator. I thought it would be interesting to create a small web application in ClojureScript and Reagent that provides the ability to generate a selection of these cards and perform the trick."><meta property="og:locale" content="en_GB"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2020-10-31T00:00:00+00:00"><meta property="article:modified_time" content="2020-10-31T00:00:00+00:00"><meta property="article:tag" content="Clojurescript"><meta property="article:tag" content="Reagent"><meta name=twitter:card content="summary"><meta name=twitter:title content="The Mystery Calculator in ClojureScript and Reagent"><meta name=twitter:description content="The Mystery Calculator is a commonly found Christmas cracker gift that uses a neat powers-of-two (binary) addition trick to fool the spectator. I thought it would be interesting to create a small web application in ClojureScript and Reagent that provides the ability to generate a selection of these cards and perform the trick."><meta name=twitter:site content="@edd_mann"><link rel=stylesheet href=/css/style.min.a18bbea58d05187498ffb7d6a33b580609df2e92b988055a4b51e41596cc934e.css integrity="sha256-oYu+pY0FGHSY/7fWoztYBgnfLpK5iAVaS1HkFZbMk04="><link rel=preload as=image href=/assets/x.svg crossorigin=anonymous><link rel=preload as=image href=/assets/github.svg crossorigin=anonymous><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=manifest href=/site.webmanifest><link rel=canonical href=https://eddmann.com/posts/the-mystery-calculator-in-clojurescript-and-reagent/><script>document.documentElement.setAttribute("data-theme",localStorage.getItem("theme")||window.matchMedia("(prefers-color-scheme: dark)").matches&&"dark"||"light")</script><script src=/script.min.da71ac9c7b8bd4e644618df0ab735aed1393aad3cb5e5c57e5adc300fe7c8209.js integrity="sha256-2nGsnHuL1OZEYY3wq3Na7ROTqtPLXlxX5a3DAP58ggk=" defer></script></head><body><header class="site-header l-wrapper"><a href=https://eddmann.com/><h3 class=site-header__title>Edd Mann
<span style=--url:url(/assets/code.svg)>Developer</span></h3></a><button class=site-header__mobile-navigation-button type=button title="Toggle mobile site navigation" aria-label="Toggle mobile site navigation" aria-expanded=false aria-controls=site-navigation></button><div class=site-header__navigation id=site-navigation><nav aria-label="Primary navigation"><ul class=site-header__primary-navigation><li><a href=/archive>Archive</a></li><li><a href=/projects>Projects</a></li><li><a href=/about>About</a></li></ul></nav><nav aria-label="Social links"><ul class=site-header__social-navigation><li><a class=social-icon style=--url:url(/assets/x.svg) href=https://x.com/edd_mann rel="external noopener" target=_blank>Twitter (X)</a></li><li><a class=social-icon style=--url:url(/assets/github.svg) href=https://github.com/eddmann rel="external noopener" target=_blank>GitHub</a></li></ul></nav></div></header><main class=l-wrapper><article><header class=l-page-title><h1 class=u-transition-between-pages style=--id:the-mystery-calculator-in-clojurescript-and-reagent>The Mystery Calculator in ClojureScript and Reagent</h1><time datetime=2020-10-31T00:00:00Z class=published-at>Oct 31, 2020</time></header><main class=u-prose><p>The Mystery Calculator is a commonly found Christmas cracker gift that uses a neat powers-of-two (binary) addition trick to fool the spectator.
I thought it would be interesting to create a small web application in <a href=https://clojurescript.org/ rel="external noopener" target=_blank>ClojureScript</a> and <a href=http://reagent-project.github.io/ rel="external noopener" target=_blank>Reagent</a> that provides the ability to generate a selection of these cards and perform the trick.</p><p>You can generate a selection of these mystery cards and perform the trick yourself by visiting <a href=https://eddmann.com/mystery-calculator-clojurescript/>here</a>.
The source code is also available on <a href=https://github.com/eddmann/mystery-calculator-clojurescript/ rel="external noopener" target=_blank>GitHub</a>.</p><p><a href=https://eddmann.com/mystery-calculator-clojurescript/><picture><source type=image/webp srcset="/posts/the-mystery-calculator-in-clojurescript-and-reagent/mystery-calculator_hu_6cafde02c3a2ca76.webp 350w, /posts/the-mystery-calculator-in-clojurescript-and-reagent/mystery-calculator_hu_60549a25374ad9e8.webp 700w, /posts/the-mystery-calculator-in-clojurescript-and-reagent/mystery-calculator_hu_e8f207a6771d5161.webp 1400w"><source type=image/jpeg srcset="/posts/the-mystery-calculator-in-clojurescript-and-reagent/mystery-calculator_hu_e01e3ae45a139dfa.jpg 350w, /posts/the-mystery-calculator-in-clojurescript-and-reagent/mystery-calculator_hu_d05611dbdcb68f13.jpg 700w, /posts/the-mystery-calculator-in-clojurescript-and-reagent/mystery-calculator_hu_2c642f1f9f0452bf.jpg 1400w"><img src=/posts/the-mystery-calculator-in-clojurescript-and-reagent/mystery-calculator_hu_d05611dbdcb68f13.jpg alt="The Mystery Calculator" loading=lazy></picture></a></p><p>The magic trick is performed as follows:</p><blockquote><p>The complete set consists of <code>N</code> cards, printed with a series of numbers, show all the cards to a friend and ask him or her to select-one number from any one card.
Show the other <code>N-1</code> cards to your friend asking him or her to say whether the number appears on these cards.
Take all the cards on which your friend says the number appears, add together the top left hand corner number of each card and the total is the number your friend selected.</p></blockquote><h2 id=how-it-works>How it works</h2><p>You may notice that all the card numbers can be written in terms of powers of two.
Upon closer inspection, you may also observe that each number can be expressed as a subset (or all) of the numbers present in the top-left-hand corner of each card.</p><p>I found it easier to visualise this by replacing the decimal number representation with binary.
If we number all the available cards (from <code>1</code> to <code>N</code>), you will see that each number on a given card has the corresponding position&rsquo;s bit set to <code>1</code>.
This means that we can calculate the mystery number by performing a binary <code>AND</code> operation on the top-left-hand corner numbers of all cards which include the chosen number.</p><p>For example, say I have picked the mystery number 28 (<code>11100</code> in binary).
That number appears on cards 3, 4 and 5 in a conventional 6-card setup.
The top-left-hand corner numbers for these cards are 4 (<code>00100</code>), 8 (<code>01000</code>) and 16 (<code>10000</code>).
If we perform the binary <code>AND</code> operation on these numbers, we produce the chosen mystery number 28 (<code>11100</code>).
This works for any number chosen from the given cards.</p><h2 id=building-the-mystery-calculator>Building the Mystery Calculator</h2><p>Now that we are familiar with how it works, we can start by building the functionality that produces these crafted cards based on a desired card count.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-clojure data-lang=clojure><span style=display:flex><span>(<span style=color:#66d9ef>defn- </span>generate-cards [num-of-cards]
</span></span><span style=display:flex><span>  (<span style=color:#a6e22e>reduce</span>
</span></span><span style=display:flex><span>    (<span style=color:#66d9ef>fn </span>[cards number]
</span></span><span style=display:flex><span>      (<span style=color:#a6e22e>map-indexed</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>#</span>(<span style=color:#66d9ef>if </span>(<span style=color:#a6e22e>bit-test</span> number %1) (conj %2 number) %2)
</span></span><span style=display:flex><span>        cards))
</span></span><span style=display:flex><span>    (repeat num-of-cards (<span style=color:#a6e22e>vector</span>))
</span></span><span style=display:flex><span>    (range <span style=color:#ae81ff>1</span> (<span style=color:#a6e22e>Math/pow</span> <span style=color:#ae81ff>2</span> num-of-cards))))
</span></span></code></pre></div><p>Using a Lisp, we are able to succinctly express how a card is formed.
First, we produce an exclusive range of all sequential numbers up to two raised to the power of the card count.
For each number and card, we check to see if the given number&rsquo;s bit is set to <code>1</code> at that card&rsquo;s position.
For example, for the first card, we would check the first bit; for the second card, the second bit; etc.
In doing this reduction, we eventually construct all the desired cards with the numbers specifically placed.</p><p>Now that we can generate these cards, we next want to present them to the user.
To achieve this, I decided to explore using Reagent, which provides an efficient way to create React components using ClojureScript.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-clojure data-lang=clojure><span style=display:flex><span>(<span style=color:#66d9ef>defn- </span>display-cards [chosen-cards cards]
</span></span><span style=display:flex><span>  (<span style=color:#66d9ef>let </span>[toggle-choice <span style=color:#f92672>#</span>((<span style=color:#66d9ef>if </span>(contains? %1 %2) disj conj) %1 %2)]
</span></span><span style=display:flex><span>    [<span style=color:#e6db74>:div.cards</span>
</span></span><span style=display:flex><span>      (<span style=color:#a6e22e>doall</span>
</span></span><span style=display:flex><span>        (for [card cards]
</span></span><span style=display:flex><span>          <span style=color:#f92672>^</span>{<span style=color:#e6db74>:key</span> card}
</span></span><span style=display:flex><span>          [<span style=color:#e6db74>:div</span> {<span style=color:#e6db74>:class</span> [<span style=color:#e6db74>&#34;card&#34;</span> (when (contains? <span style=color:#f92672>@</span>chosen-cards (first card)) <span style=color:#e6db74>&#34;chosen&#34;</span>)]
</span></span><span style=display:flex><span>                 <span style=color:#e6db74>:on-click</span> <span style=color:#f92672>#</span>(<span style=color:#a6e22e>swap!</span> chosen-cards toggle-choice (first card))}
</span></span><span style=display:flex><span>            (map (<span style=color:#66d9ef>fn </span>[num] <span style=color:#f92672>^</span>{<span style=color:#e6db74>:key</span> num} [<span style=color:#e6db74>:span</span> num]) card)]))]))
</span></span></code></pre></div><p>Passing in the generated cards from the previous function and a <a href=http://reagent-project.github.io/docs/master/reagent.core.html#var-atom rel="external noopener" target=_blank>state atom</a> which includes the user&rsquo;s selection, we can present these for React to render using <a href=https://github.com/weavejester/hiccup rel="external noopener" target=_blank>Hiccup</a>.
If the user clicks on a card, we will toggle the presence of the card&rsquo;s top-left-hand corner number within the <code>chosen-cards</code> state atom.</p><p>Finally, we can wire up the application, declaring the two state atoms with default values and displaying the mystery number if a card has been selected.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-clojure data-lang=clojure><span style=display:flex><span>(<span style=color:#66d9ef>defn- </span>clamp [x min max]
</span></span><span style=display:flex><span>  (<span style=color:#66d9ef>if </span>(&lt; x min) min (<span style=color:#66d9ef>if </span>(&gt; x max) max x)))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>(<span style=color:#66d9ef>defn- </span>app []
</span></span><span style=display:flex><span>  (<span style=color:#66d9ef>let </span>[num-of-cards (<span style=color:#a6e22e>r/atom</span> <span style=color:#ae81ff>6</span>)
</span></span><span style=display:flex><span>        chosen-cards (<span style=color:#a6e22e>r/atom</span> <span style=color:#f92672>#</span>{})]
</span></span><span style=display:flex><span>    (<span style=color:#66d9ef>fn </span>[]
</span></span><span style=display:flex><span>      [<span style=color:#e6db74>:div</span>
</span></span><span style=display:flex><span>        [<span style=color:#e6db74>:p</span>
</span></span><span style=display:flex><span>          <span style=color:#e6db74>&#34;Number of cards: &#34;</span>
</span></span><span style=display:flex><span>          [<span style=color:#e6db74>:input</span> {<span style=color:#e6db74>:type</span> <span style=color:#e6db74>&#34;number&#34;</span>
</span></span><span style=display:flex><span>                   <span style=color:#e6db74>:value</span> <span style=color:#f92672>@</span>num-of-cards
</span></span><span style=display:flex><span>                   <span style=color:#e6db74>:on-change</span> <span style=color:#f92672>#</span>(<span style=color:#a6e22e>reset!</span> num-of-cards (-&gt; % .-target .-value (<span style=color:#a6e22e>clamp</span> <span style=color:#ae81ff>4</span> <span style=color:#ae81ff>7</span>)))}]]
</span></span><span style=display:flex><span>        (<span style=color:#a6e22e>display-cards</span> chosen-cards (<span style=color:#a6e22e>generate-cards</span> <span style=color:#f92672>@</span>num-of-cards))
</span></span><span style=display:flex><span>        (<span style=color:#66d9ef>let </span>[mystery-number (reduce + <span style=color:#f92672>@</span>chosen-cards)]
</span></span><span style=display:flex><span>          (when (pos? mystery-number)
</span></span><span style=display:flex><span>            [<span style=color:#e6db74>:p.number</span> <span style=color:#e6db74>&#34;Your mystery number is &#34;</span> [<span style=color:#e6db74>:strong</span> mystery-number] <span style=color:#e6db74>&#34; ✨&#34;</span>]))])))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>(<span style=color:#66d9ef>defn </span><span style=color:#f92672>^</span><span style=color:#e6db74>:export</span> init []
</span></span><span style=display:flex><span>  (<span style=color:#a6e22e>reagent.dom/render</span> [app] (<span style=color:#a6e22e>.getElementById</span> js/document <span style=color:#e6db74>&#34;app&#34;</span>)))
</span></span></code></pre></div><p>We include a <code>clamp</code> function, which is not present in the ClojureScript core.
This provides us with the ability to restrict how many cards can be generated, as this can be an expensive browser operation.</p><h2 id=deployment>Deployment</h2><p>To ease deployment and hosting, I decided to leverage GitHub Actions and GitHub Pages.
Upon a successful Git push, using the provided <code>Makefile</code> and Docker-setup, we first compile the application and subsequently release the artifact to the <code>gh-pages</code> branch.
This branch is then used to host the web application made available <a href=https://eddmann.com/mystery-calculator-clojurescript/>here</a>.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>name</span>: <span style=color:#ae81ff>Release</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>on</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>push</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>branches</span>:
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>master</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>jobs</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>release</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>runs-on</span>: <span style=color:#ae81ff>ubuntu-latest</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>steps</span>:
</span></span><span style=display:flex><span>      - <span style=color:#f92672>uses</span>: <span style=color:#ae81ff>actions/checkout@v2</span>
</span></span><span style=display:flex><span>      - <span style=color:#f92672>run</span>: <span style=color:#ae81ff>make release</span>
</span></span><span style=display:flex><span>      - <span style=color:#f92672>uses</span>: <span style=color:#ae81ff>JamesIves/github-pages-deploy-action@releases/v3</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>with</span>:
</span></span><span style=display:flex><span>          <span style=color:#f92672>ACCESS_TOKEN</span>: <span style=color:#ae81ff>${{ secrets.ACCESS_TOKEN }}</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>BRANCH</span>: <span style=color:#ae81ff>gh-pages</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>FOLDER</span>: <span style=color:#ae81ff>public</span>
</span></span></code></pre></div></main><footer class=post-footer><ul class="tags tags--large"><li><a href=/archive/tag/clojurescript>clojurescript</a></li><li><a href=/archive/tag/reagent>reagent</a></li></ul></footer></article><div class=scroll-watcher></div></main><footer class="site-footer l-wrapper"><div>&copy; 2025, Edd Mann</div><button class=site-footer__theme-toggle type=button title="Toggle theme" aria-label="Toggle theme"><svg fill="currentcolor" viewBox="0 0 32 32" role="img"><title>Theme toggle icon</title><desc>A circle representing the moon for toggling theme</desc><path d="M16 .5C7.4.5.5 7.4.5 16S7.4 31.5 16 31.5 31.5 24.6 31.5 16 24.6.5 16 .5zm0 28.1V3.4C23 3.4 28.6 9 28.6 16S23 28.6 16 28.6z"/></svg></button></footer></body></html>