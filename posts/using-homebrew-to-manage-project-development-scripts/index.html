<!doctype html>
<html lang="en">
    <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Looking into using Homebrew to Manage Project Development Scripts">

    <title>
        
            Using Homebrew to Manage Project Development Scripts &middot; Edd Mann
        
    </title>

    <link rel="stylesheet" href="//fonts.googleapis.com/css?family=Source+Sans+Pro:400,700,700italic,400italic">
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <link rel="stylesheet" href="/styles.css">

    <link rel="shortcut icon" href="/favicon.ico">

    <link rel="alternate" href="/rss.xml" title="" type="application/rss+xml">

    <script>
        var _gaq=[['_setAccount','UA-32512081-1'],['_setDomainName','eddmann.com'],['_trackPageview']];
        (function() {
            var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
            ga.src = 'https://ssl.google-analytics.com/ga.js';
            var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
        })();
    </script>
</head>

    <body>
        <div class="container content">
            <header class="masthead">
                <h3 class="masthead-title">
                    <a href="/" title="Home">Edd Mann</a>
                    <small><i class="fa fa-code"></i> Developer</small>
                </h3>
                <nav>
                    <a href="https://twitter.com/edd_mann"><i class="fa fa-twitter"></i></a>
                    <a href="https://github.com/eddmann"><i class="fa fa-github"></i></a>
                    <a href="mailto:the@eddmann.com"><i class="fa fa-envelope"></i></a>
                </nav>
                <div class="cf"></div>
            </header>

            <main>
                <article class="post">
    <h1 class="post-title">Using Homebrew to Manage Project Development Scripts</h1>
    <time datetime="2017-05-10T00:00:00+00:00" class="post-date">10 May 2017</time>
    <p>When a project becomes sufficiently large in size you will undoubtedly encounter the need to simplify certain tasks, such as managing external dependencies or configuring environment parameters.
Within the MyBuilder code-base we have required these kinds of processes for some time.</p>



<p>Initially starting with a <code class="language-plaintext highlighter-rouge">dev-upload</code> function, it soon grew to a shared shell script which all users had to manually update (think ‘old-school’ copy n’ paste dependency management).
This was not ideal and we pondered on several different solutions to manage this problem, such as using <a href="https://getcomposer.org/doc/articles/scripts.md">Composer scripts</a>.
We eventually settled on taking advantage of <a href="https://brew.sh/">Homebrew</a> (the Mac package manager), thanks to a <a href="https://changelog.com/podcast/223">podcast</a> that Gavin had listened to.
Using this approach allows us to not only manage scripts, but far more complex installation requirements in the future.</p>

<p>In this post I would like to discuss how we went about creating a personal Homebrew <a href="http://docs.brew.sh/brew-tap.html">Tap</a> and <a href="http://docs.brew.sh/Formula-Cookbook.html">Formula</a>, configured to provide the desired up-to-date scripts which aid in managing the project.</p>

<h3 id="defining-the-formula">Defining the Formula</h3>

<p>Homebrew is well suited to accessing and downloading Taps found on GitHub, providing you abide by some conventions.
The repository name (Tap) should begin with <code class="language-plaintext highlighter-rouge">homebrew-</code> and include all Formulas within a root <code class="language-plaintext highlighter-rouge">Formula</code> directory.
Below is a simple Formula definiton which provides access to two scripts along with ‘keg-only’ access to a <code class="language-plaintext highlighter-rouge">common</code> script file which is used in both.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">ProjectDevTools</span> <span class="o">&lt;</span> <span class="no">Formula</span>
    <span class="n">desc</span> <span class="s2">"Provides scripts to make it easier to work with the code-base"</span>
    <span class="n">url</span> <span class="s1">'https://github.com/eddmann/homebrew-project-dev-tools.git'</span>

    <span class="k">def</span> <span class="nf">install</span>
        <span class="n">prefix</span><span class="p">.</span><span class="nf">install</span> <span class="s2">"src/common"</span>
        <span class="n">bin</span><span class="p">.</span><span class="nf">install</span> <span class="s2">"src/dev-rebuild"</span><span class="p">,</span> <span class="s2">"src/dev-tools-update"</span>
    <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<h3 id="setting-up-the-example-scripts">Setting up the Example Scripts</h3>

<p>Now that we have a mechanism to manage the development scripts lets create some example scripts.
I have found it beneficial to be able to reuse an environment variable guard and <code class="language-plaintext highlighter-rouge">run</code> function within each of the subsequent scripts.
The <code class="language-plaintext highlighter-rouge">run</code> function provides us with the ability to conditional suppress command invocation output, if verbose mode is not enabled.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#!/bin/bash</span>

<span class="nv">ERROR</span><span class="o">=</span><span class="s1">'\033[41;1;37m'</span>
<span class="nv">BLUE</span><span class="o">=</span><span class="s1">'\033[0;34m'</span>
<span class="nv">GREEN</span><span class="o">=</span><span class="s1">'\033[0;32m'</span>
<span class="nv">NC</span><span class="o">=</span><span class="s1">'\033[0m'</span>

<span class="k">if</span> <span class="o">[[</span> <span class="nt">-z</span> <span class="s2">"</span><span class="nv">$PROJECT_ROOT_DIR</span><span class="s2">"</span> <span class="o">||</span> <span class="o">!</span> <span class="nt">-d</span> <span class="s2">"</span><span class="nv">$PROJECT_ROOT_DIR</span><span class="s2">"</span> <span class="o">]]</span><span class="p">;</span> <span class="k">then
    </span><span class="nb">printf</span> <span class="s2">"⚠️ Make sure you have </span><span class="k">${</span><span class="nv">ERROR</span><span class="k">}</span><span class="s2">PROJECT_ROOT_DIR</span><span class="k">${</span><span class="nv">NC</span><span class="k">}</span><span class="s2"> set</span><span class="se">\n</span><span class="s2">"</span>
    <span class="nb">exit </span>1
<span class="k">fi

for </span>arg <span class="k">in</span> <span class="s2">"</span><span class="nv">$@</span><span class="s2">"</span><span class="p">;</span> <span class="k">do
    </span><span class="nb">shift

    </span><span class="k">if</span> <span class="o">[[</span> <span class="s2">"</span><span class="nv">$arg</span><span class="s2">"</span> <span class="o">==</span> <span class="s2">"-v"</span> <span class="o">]]</span><span class="p">;</span> <span class="k">then
        </span><span class="nv">VERBOSE_MODE</span><span class="o">=</span>1
        <span class="k">continue</span> <span class="c"># remove `-v` from args</span>
    <span class="k">fi

    </span><span class="nb">set</span> <span class="nt">--</span> <span class="s2">"</span><span class="nv">$@</span><span class="s2">"</span> <span class="s2">"</span><span class="nv">$arg</span><span class="s2">"</span>
<span class="k">done

function </span>run<span class="o">()</span>
<span class="o">{</span>
    <span class="k">if</span> <span class="o">[[</span> <span class="nv">$VERBOSE_MODE</span> <span class="nt">-eq</span> 1 <span class="o">]]</span><span class="p">;</span> <span class="k">then
        </span><span class="nb">echo</span> <span class="s2">"$"</span> <span class="s2">"</span><span class="nv">$@</span><span class="s2">"</span>
        <span class="nb">eval</span> <span class="si">$(</span><span class="nb">printf</span> <span class="s1">'%q '</span> <span class="s2">"</span><span class="nv">$@</span><span class="s2">"</span><span class="si">)</span>
    <span class="k">else
        </span><span class="nb">eval</span> <span class="si">$(</span><span class="nb">printf</span> <span class="s1">'%q '</span> <span class="s2">"</span><span class="nv">$@</span><span class="s2">"</span><span class="si">)</span> &amp;&gt; /dev/null
        <span class="k">if</span> <span class="o">[</span> <span class="nv">$?</span> <span class="nt">-ne</span> 0 <span class="o">]</span><span class="p">;</span> <span class="k">then
            </span><span class="nb">printf</span> <span class="s2">"</span><span class="k">${</span><span class="nv">ERROR</span><span class="k">}</span><span class="s2">⚠️ Error</span><span class="k">${</span><span class="nv">NC</span><span class="k">}</span><span class="se">\n</span><span class="s2">"</span>
            <span class="nb">exit </span>1
        <span class="k">else
            </span><span class="nb">printf</span> <span class="s2">"✓</span><span class="se">\n</span><span class="s2">"</span>
        <span class="k">fi
    fi</span>
<span class="o">}</span>
</code></pre></div></div>

<p>With this script now in-place, we can move on to defining the required steps to rebuild the contrived project.
You will notice below that we attempt to source the <code class="language-plaintext highlighter-rouge">common</code> file from the local <code class="language-plaintext highlighter-rouge">src</code> directory first, this is so throughout development we can easily work with pending changes.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#!/bin/bash</span>

<span class="nb">source </span>src/common 2&gt; /dev/null <span class="o">||</span> <span class="nb">source</span> <span class="si">$(</span>brew <span class="nt">--prefix</span> project-dev-tools<span class="si">)</span>/common

<span class="nv">APP_NAME</span><span class="o">=</span><span class="s2">"</span><span class="k">${</span><span class="nv">1</span><span class="k">:-</span><span class="p">*</span><span class="k">}</span><span class="s2">"</span>

<span class="k">for </span>app <span class="k">in</span> <span class="nv">$PROJECT_ROOT_DIR</span>/app/<span class="nv">$APP_NAME</span>/<span class="p">;</span> <span class="k">do</span>
    <span class="o">[[</span> <span class="o">!</span> <span class="nt">-d</span> <span class="s2">"</span><span class="nv">$app</span><span class="s2">"</span> <span class="o">]]</span> <span class="o">&amp;&amp;</span> <span class="k">continue

    </span><span class="nv">name</span><span class="o">=</span><span class="si">$(</span><span class="nb">basename</span> <span class="s2">"</span><span class="nv">$app</span><span class="s2">"</span><span class="si">)</span>
    <span class="nb">printf</span> <span class="s2">"💾 </span><span class="k">${</span><span class="nv">GREEN</span><span class="k">}</span><span class="nv">$name</span><span class="k">${</span><span class="nv">NC</span><span class="k">}</span><span class="s2"> </span><span class="k">${</span><span class="nv">BLUE</span><span class="k">}</span><span class="s2">[</span><span class="nv">$app</span><span class="s2">]</span><span class="k">${</span><span class="nv">NC</span><span class="k">}</span><span class="se">\n</span><span class="s2">"</span>

    <span class="nb">printf</span> <span class="s2">"&gt; running composer install... "</span>
    run composer <span class="nb">install</span> <span class="nt">-d</span> <span class="s2">"</span><span class="nv">$app</span><span class="s2">"</span>

    <span class="nb">printf</span> <span class="s2">"&gt; clearing cache... "</span>
    run <span class="nb">rm</span> <span class="nt">-fr</span> <span class="s2">"</span><span class="k">${</span><span class="nv">app</span><span class="k">}</span><span class="s2">cache/*"</span>

    <span class="nb">printf</span> <span class="s2">"</span><span class="se">\n</span><span class="s2">"</span>
<span class="k">done

</span><span class="nb">printf</span> <span class="s2">"🎉 Rebuild Complete!</span><span class="se">\n</span><span class="s2">"</span>

<span class="nb">exit </span>0
</code></pre></div></div>

<p>Another useful script that we have found is the ability to update the Formula without the need to understand how Homebrew works.
Using the script below - the Tap is updated and Formula re-installed, to ensure that we are using the latest version available within the repository.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#!/bin/bash</span>

<span class="nb">source </span>src/common 2&gt; /dev/null <span class="o">||</span> <span class="nb">source</span> <span class="si">$(</span>brew <span class="nt">--prefix</span> project-dev-tools<span class="si">)</span>/common

<span class="nb">printf</span> <span class="s2">"&gt; reinstalling project-dev-tools... "</span>
run brew reinstall project-dev-tools

<span class="nb">printf</span> <span class="s2">"🎉 Update Complete!</span><span class="se">\n</span><span class="s2">"</span>

<span class="nb">exit </span>0
</code></pre></div></div>

<p>With this now all in-place we can use the following commands to initially install the new Formula on a development machine.
Once this has been successfully run, we can move over to use the newly installed <code class="language-plaintext highlighter-rouge">dev-tools-update</code> script for future updates.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>brew tap eddmann/project-dev-tools
brew <span class="nb">install </span>project-dev-tools
</code></pre></div></div>

<h3 id="demo">Demo</h3>

<p>The example Tap and Formula can be found within <a href="https://github.com/eddmann/homebrew-project-dev-tools">this</a> GitHub repository.
You can see an interactive example of installing and using the scripts created below:</p>

<p><script type="text/javascript" src="https://asciinema.org/a/apc3kpg72qgrizdhzt1s7h1kc.js" id="asciicast-apc3kpg72qgrizdhzt1s7h1kc" async=""></script></p>

</article>

            </main>

            <footer class="footer">
                <img src="https://www.gravatar.com/avatar/c5c2978bb14d16460f73399c394b6acd?s=160">
                <ul>
                    <li>Developer at <a href="http://www.mybuilder.com/">MyBuilder</a></li>
                    <li><a href="http://threedevsandamaybe.com/">Three Devs and a Maybe</a> podcast co-host</li>
                    <li>All ramblings can be found in the <a href="/archive/">Archive</a></li>
                </ul>
                <div class="cf"></div>
            </footer>
        </div>
    </body>
</html>
