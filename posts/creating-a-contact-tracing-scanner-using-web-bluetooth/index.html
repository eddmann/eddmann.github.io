<!doctype html>
<html lang="en">
    <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Highlights how to use the Web Bluetooth API to build a Contact Tracing Scanner application">

    <title>Creating a Contact Tracing Scanner using Web Bluetooth &middot; Edd Mann</title>

    <link rel="stylesheet" href="//fonts.googleapis.com/css?family=Source+Sans+Pro:400,700,700italic,400italic">
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <link rel="stylesheet" href="/styles.css">

    <link rel="shortcut icon" href="/favicon.ico">

    <link rel="alternate" href="/rss.xml" title="" type="application/rss+xml">

    <script>
        var _gaq=[['_setAccount','UA-32512081-1'],['_setDomainName','eddmann.com'],['_trackPageview']];
        (function() {
            var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
            ga.src = 'https://ssl.google-analytics.com/ga.js';
            var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
        })();
    </script>
</head>

    <body>
        <div class="container content">
            <header class="masthead">
                <h3 class="masthead-title">
                    <a href="/" title="Home">Edd Mann</a>
                    <small><i class="fa fa-code"></i> Developer</small>
                </h3>
                <nav>
                    <a href="https://twitter.com/edd_mann"><i class="fa fa-twitter"></i></a>
                    <a href="https://github.com/eddmann"><i class="fa fa-github"></i></a>
                    <a href="mailto:the@eddmann.com"><i class="fa fa-envelope"></i></a>
                </nav>
                <div class="cf"></div>
            </header>

            <main>
                <article class="post">
    <h1 class="post-title">Creating a Contact Tracing Scanner using Web Bluetooth</h1>
    <time datetime="2020-10-19T00:00:00+00:00" class="post-date">19 Oct 2020</time>
    <p>I have recently been looking at the <a href="https://covid19.apple.com/contacttracing">Contact Tracing specifications</a> Apple and Google released earlier this year in aid of the fight against COVID-19.
Looking through these documents allowed me to grapse how the system was put together, and ease fears family members had with regards to how privacy conscious the Exposure Notification system is.</p>



<p>I decided to make a Web Bluetooth-based <a href="https://eddmann.com/contact-tracing-scanner-web/">scanning application</a> which highlighted what an Exposure Notification-enabled device actually emits.</p>

<p><a href="https://eddmann.com/contact-tracing-scanner-web/"><img src="/uploads/creating-a-contact-tracing-scanner-using-web-bluetooth/contact-tracing-scanner.png" alt="Contact Tracing Scanner using Web Bluetooth" /></a></p>

<h3 id="how-it-works">How it works</h3>

<p>The <a href="https://en.wikipedia.org/wiki/Exposure_Notification">Exposure Notification system</a> designed by Apple and Google uses the GATT Bluetooth LE protocol to emit advertisements using the registered service UUID <code class="language-plaintext highlighter-rouge">0xfd6f</code>.
These advertisements are sent using the format outlined in the <a href="https://covid19-static.cdn-apple.com/applications/covid19/current/static/contact-tracing/pdf/ExposureNotification-BluetoothSpecificationv1.2.pdf">Exposure Notification Bluetooth Specification</a>.</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">setActiveScan</span><span class="p">(</span>
  <span class="k">await</span> <span class="nb">navigator</span><span class="p">.</span><span class="nx">bluetooth</span><span class="p">.</span><span class="nx">requestLEScan</span><span class="p">({</span>
    <span class="na">filters</span><span class="p">:</span> <span class="p">[{</span> <span class="na">services</span><span class="p">:</span> <span class="p">[</span><span class="mh">0xfd6f</span><span class="p">]</span> <span class="p">}],</span>
    <span class="na">keepRepeatedDevices</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
  <span class="p">})</span>
<span class="p">);</span>
</code></pre></div></div>

<p>Using the Web Bluetooth API we are able to scan for devices which are emitting these kinds of service advertisement.
We are then able to parse the payloads service data to retrieve the current <em>Rolling Proximity Identifier</em> and <em>Encrypted Metadata</em> for that device.
You will notice that every 10 minutes or so both the device UUID and Rolling Proximity Identifier change, this is for privacy concerns and in-line with the <a href="https://covid19-static.cdn-apple.com/applications/covid19/current/static/contact-tracing/pdf/ExposureNotification-CryptographySpecificationv1.2.pdf">Exposure Notification Cryptography Specification</a>.</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">onAdvertisementReceived</span> <span class="o">=</span> <span class="nx">event</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="nx">serviceData</span> <span class="o">=</span> <span class="nx">event</span><span class="p">.</span><span class="nx">serviceData</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="nx">event</span><span class="p">.</span><span class="nx">uuids</span><span class="p">[</span><span class="mi">0</span><span class="p">]).</span><span class="nx">buffer</span><span class="p">;</span>

  <span class="nx">setDevices</span><span class="p">(</span><span class="nx">devices</span> <span class="o">=&gt;</span> <span class="p">({</span>
    <span class="p">...</span><span class="nx">devices</span><span class="p">,</span>
    <span class="p">[</span><span class="nx">event</span><span class="p">.</span><span class="nx">device</span><span class="p">.</span><span class="nx">id</span><span class="p">]:</span> <span class="p">{</span>
      <span class="na">uuid</span><span class="p">:</span> <span class="nx">event</span><span class="p">.</span><span class="nx">device</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span>
      <span class="na">rollingProximityId</span><span class="p">:</span> <span class="nx">toHex</span><span class="p">(</span><span class="nx">serviceData</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">16</span><span class="p">)),</span>
      <span class="na">metadata</span><span class="p">:</span> <span class="nx">toHex</span><span class="p">(</span><span class="nx">serviceData</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">16</span><span class="p">)),</span>
      <span class="na">rssi</span><span class="p">:</span> <span class="nx">event</span><span class="p">.</span><span class="nx">rssi</span><span class="p">,</span>
      <span class="na">lastSeen</span><span class="p">:</span> <span class="nb">Date</span><span class="p">.</span><span class="nx">now</span><span class="p">(),</span>
    <span class="p">},</span>
  <span class="p">}));</span>
<span class="p">};</span>
</code></pre></div></div>

<p>The Encrypted Metadata includes the transmitted power (txPower) value which the Bluetooth device is currently emitting at.
Upon a positive diagnosis the last 14 days <em>Temporary Exposure Key’s</em> are sent to the Diagnosis Server.
Every interested device can then download these keys and verify if they are aware of any derived Rolling Proximity Identifier.
If there is a match, then the associated payloads Encrypted Metadata can then be decrypted using the days’ Temporary Exposure Key.
This leads to a more accurate distance value being calculated based on the <em>Received Signal Strength Indicator</em> (RSSI) and transmitted power.</p>

</article>

            </main>

            <footer class="footer">
                <img src="https://www.gravatar.com/avatar/c5c2978bb14d16460f73399c394b6acd?s=160">
                <ul>
                    <li>Developer at <a href="http://www.mybuilder.com/">MyBuilder</a></li>
                    <li><a href="http://threedevsandamaybe.com/">Three Devs and a Maybe</a> podcast co-host</li>
                    <li>All ramblings can be found in the <a href="/archive/">Archive</a></li>
                </ul>
                <div class="cf"></div>
            </footer>
        </div>
    </body>
</html>
