<!doctype html>
<html lang="en">
    <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Learn how to integrate Graphviz with SVG output in PHP to create interactive, scalable graphs within your markdown posts.">

    <title>
        
            Using Graphviz with SVG Output in PHP &middot; Edd Mann
        
    </title>

    <link rel="stylesheet" href="//fonts.googleapis.com/css?family=Source+Sans+Pro:400,700,700italic,400italic">
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <link rel="stylesheet" href="/styles.css">

    <link rel="shortcut icon" href="/favicon.ico">

    <link rel="alternate" href="/rss.xml" title="" type="application/rss+xml">

    

    <script>
        var _gaq=[['_setAccount','UA-32512081-1'],['_setDomainName','eddmann.com'],['_trackPageview']];
        (function() {
            var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
            ga.src = 'https://ssl.google-analytics.com/ga.js';
            var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
        })();
    </script>
</head>

    <body>
        <div class="container content">
            <header class="masthead">
                <h3 class="masthead-title">
                    <a href="/" title="Home">Edd Mann</a>
                    <small><i class="fa fa-code"></i> Developer</small>
                </h3>
                <nav>
                    <a href="https://twitter.com/edd_mann"><i class="fa fa-twitter"></i></a>
                    <a href="https://github.com/eddmann"><i class="fa fa-github"></i></a>
                    <a href="mailto:the@eddmann.com"><i class="fa fa-envelope"></i></a>
                </nav>
                <div class="cf"></div>
            </header>

            <main>
                <article class="post">
    <h1 class="post-title">Using Graphviz with SVG Output in PHP</h1>
    <time datetime="2014-01-13T00:00:00+00:00" class="post-date">13 Jan 2014</time>
    <p>Since adding the functionality to process syntax highlighting through <a href="http://pygments.org/">Pygments</a> I had been on the lookout for similar external tools that I could integrate.
One area that I felt was lacking in my posts was accompanying visual aids, which would be useful when explaining a new concept or algorithm.
Like most developers, I feel at home in an editor, so delving into another software package did not appeal to me.</p>



<p>It was highly desirable to maintain my current workflow and store all content related to a post (unless necessary) within a single markdown file.
<a href="http://www.graphviz.org/">Graphviz</a> was the tool for the job, enabling graphs to be described using a small DSL and output in a variety of formats.
Along with the ability to describe graphs in plain text, the option to output results in <a href="http://en.wikipedia.org/wiki/Scalable_Vector_Graphics">SVG</a> allowed me to keep post dependencies to a minimum.
SVG (Scalable Vector Graphics) is an XML-based vector image format, providing lossless scaling and small file sizes.
This allowed me to embed outputted graphs within the rendered post, similar to the process of syntax highlighting with Pygments.</p>

<h2 id="implementation">Implementation</h2>

<p>Below is a simple example implementation to output SVG variants of each defined graph within a supplied string (post).
I made the assumption that the ‘dot’ command (provided by Graphviz) is present in the user’s path (this can be easily altered).
For consistency, I decided to declare graph definitions using Markdown Extra’s <a href="http://michelf.ca/projects/php-markdown/extra/#fenced-code-blocks">fenced blocks</a> notation, discussed further in the <a href="/posts/using-pythons-pygments-syntax-highlighter-in-php/">Pygments post</a>.
Providing the code block with a unique ‘.dot-show’ language type-hint allowed me to be sure of no conflicting pre-processes.</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">function</span> <span class="n">graphviz</span><span class="p">(</span><span class="nv">$post</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="nb">preg_replace_callback</span><span class="p">(</span><span class="s1">'/~~~[\s]*\.dot-show\n(.*?)\n~~~/is'</span><span class="p">,</span> <span class="k">function</span><span class="p">(</span><span class="nv">$match</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">list</span><span class="p">(</span><span class="nv">$orig</span><span class="p">,</span> <span class="nv">$dot</span><span class="p">)</span> <span class="o">=</span> <span class="nv">$match</span><span class="p">;</span>

        <span class="nv">$proc</span> <span class="o">=</span> <span class="nb">proc_open</span><span class="p">(</span>
            <span class="s1">'dot -Tsvg'</span><span class="p">,</span>
            <span class="p">[</span> <span class="p">[</span> <span class="s1">'pipe'</span><span class="p">,</span> <span class="s1">'r'</span> <span class="p">],</span> <span class="p">[</span> <span class="s1">'pipe'</span><span class="p">,</span> <span class="s1">'w'</span> <span class="p">]</span> <span class="cm">/* ignore stderr */</span> <span class="p">],</span>
            <span class="nv">$pipes</span>
        <span class="p">);</span>

        <span class="nb">fwrite</span><span class="p">(</span><span class="nv">$pipes</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nv">$dot</span><span class="p">);</span>
        <span class="nb">fclose</span><span class="p">(</span><span class="nv">$pipes</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>

        <span class="nv">$output</span> <span class="o">=</span> <span class="nb">stream_get_contents</span><span class="p">(</span><span class="nv">$pipes</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
        <span class="nb">fclose</span><span class="p">(</span><span class="nv">$pipes</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>

        <span class="k">if</span> <span class="p">(</span> <span class="o">!</span> <span class="nb">proc_close</span><span class="p">(</span><span class="nv">$proc</span><span class="p">))</span> <span class="p">{</span>
            <span class="nv">$output</span> <span class="o">=</span> <span class="nb">preg_replace</span><span class="p">(</span>
                <span class="s1">'/.*&lt;svg width="[0-9]+pt" height="([0-9]+pt)"/s'</span><span class="p">,</span>
                <span class="s1">'&lt;svg style="max-height:$1;" '</span><span class="p">,</span>
                <span class="nv">$output</span>
            <span class="p">);</span>
            <span class="nv">$output</span> <span class="o">=</span> <span class="nb">preg_replace</span><span class="p">(</span><span class="s1">'/&lt;!--(.*)--&gt;/Uis'</span><span class="p">,</span> <span class="s1">''</span><span class="p">,</span> <span class="nv">$output</span><span class="p">);</span>
            <span class="nv">$output</span> <span class="o">=</span> <span class="nb">preg_replace</span><span class="p">(</span><span class="s1">'/id="(.*?)"/s'</span><span class="p">,</span> <span class="s1">'id="$1_'</span> <span class="mf">.</span> <span class="nb">rand</span><span class="p">()</span> <span class="mf">.</span> <span class="s1">'"'</span><span class="p">,</span> <span class="nv">$output</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="nv">$output</span> <span class="o">=</span> <span class="nv">$orig</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="nv">$output</span><span class="p">;</span>
    <span class="p">},</span> <span class="nv">$post</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Looking at the example above, you will notice the use of the same regular expression replacement and process command calls found in the Pygments implementation.
All that has been altered is the processing that occurred on the outputted result and, of course, the command itself.
Comments and unnecessary headers are removed from the resulting output, along with the inclusion of random ‘id’ element names (as multiple graphs may use the same names).
The ‘max-height’ style replaces the defined width and height of the SVG element to fix an issue I found in maintaining the height ratio when resizing the graph.</p>

<h2 id="examples">Examples</h2>

<p>Now that we have an example implementation to work with, let’s see some of the impressive results we can achieve when using Graphviz and SVG output.</p>

<h3 id="uml-class-diagram">UML Class Diagram</h3>

<p>Inspired by the excellent article found <a href="http://www.ffnn.nl/pages/articles/media/uml-diagrams-using-graphviz-dot.php">here</a>, I was able to describe a simple UML Class Diagram in .dot notation and output the results in SVG.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>digraph G
{
    node [
        shape = "record"
    ]
    Animal [
        label = "{Animal|+ name : string\l+ age : int\l|+ walk() : void\l}"
    ]
    Dog [
        label = "{Dog||+ bark() : void\l}"
    ]
    Cat [
        label = "{Cat||+ meow() : void\l}"
    ]
    edge [
        arrowhead = "empty"
    ]
    Dog -&gt; Animal
    Cat -&gt; Animal
    edge [
        arrowhead = "none"
        headlabel = "0..*"
        taillabel = "0..*"
    ]
}
</code></pre></div></div>

<h3 id="binary-tree">Binary Tree</h3>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>digraph G
{
    graph[ordering="out"];
    null[shape=point];
    5 -&gt; 3;
    5 -&gt; 8;
    3 -&gt; 1;
    3 -&gt; 4;
    8 -&gt; 6;
    8 -&gt; null;
}
</code></pre></div></div>

<h3 id="circularly-doubly-linked-list">Circularly Doubly Linked-List</h3>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>digraph G
{
    n1 [label="Linked List|{size: 3}",
    shape=record];
    n1 -&gt; n2 [label="sentinel"];
    n2 [label="Entry|{null}",shape=record];
    n2 -&gt; n3 [label="next"];
    n3 [label="Entry|{A}",shape=record];
    n3 -&gt; n4 [label="next"];
    n4 [label="Entry|{B}",shape=record];
    n4 -&gt; n5 [label="next"];
    n5 [label="Entry|{C}",shape=record];
    n5 -&gt; n2 [label="next"];
    n5 -&gt; n4 [label="previous"];
    n4 -&gt; n3 [label="previous"];
    n3 -&gt; n2 [label="previous"];
    n2 -&gt; n5 [label="previous"];
}
</code></pre></div></div>

<h3 id="huffman-coding-tree">Huffman Coding Tree</h3>

<p>Using <a href="http://huffman.ooz.ie/">this</a> generator I was able to visually represent the Huffman Tree for a given string.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>digraph G
{
    edge [label=0];
    graph [ranksep=0];
    O [shape=record, label="{{O|2}|000}"];
    W [shape=record, label="{{W|2}|001}"];
    D [shape=record, label="{{D|1}|0100}"];
    H [shape=record, label="{{H|1}|0101}"];
    SPACE [shape=record, label="{{SPACE|2}|011}"];
    DHSPACE [label=4];
    T [shape=record, label="{{T|1}|1000}"];
    COMA [shape=record, label="{{COMA|1}|1001}"];
    TCOMA [label=2];
    S [shape=record, label="{{S|1}|1010}"];
    R [shape=record, label="{{R|1}|1011}"];
    SR [label=2];
    TCOMASR [label=4];
    E [shape=record, label="{{E|3}|110}"];
    L [shape=record, label="{{L|3}|111}"];
    18 -&gt; 8 -&gt; 4 -&gt; O;
    DHSPACE -&gt; 2 -&gt; D;
    10 -&gt; TCOMASR -&gt; TCOMA -&gt; T;
    SR -&gt; S;
    6 -&gt; E;4 -&gt; W [label=1];
    2 -&gt; H [label=1];
    8 -&gt; DHSPACE -&gt; SPACE [label=1];
    TCOMA -&gt; COMA [label=1];
    TCOMASR -&gt; SR -&gt; R [label=1];
    18 -&gt; 10 -&gt; 6 -&gt; L [label=1];
}
</code></pre></div></div>

<h2 id="resources">Resources</h2>

<ul>
  <li><a href="http://www.graphviz.org/">Graphviz</a></li>
  <li><a href="http://pygments.org/">Pygments</a></li>
  <li><a href="/posts/using-pythons-pygments-syntax-highlighter-in-php/">Using Python’s Pygments Syntax Highlighter in PHP</a></li>
  <li><a href="http://www.ffnn.nl/pages/articles/media/uml-diagrams-using-graphviz-dot.php">UML Diagrams Using Graphviz Dot</a></li>
  <li><a href="http://huffman.ooz.ie/">Huffman Tree Generator</a></li>
  <li><a href="https://www.cs.auckland.ac.nz/~j-hamer/ACE04-paper.pdf">Visualising Java Data Structures as Graphs</a></li>
</ul>

</article>

            </main>

            <footer class="footer">
                <img src="https://www.gravatar.com/avatar/c5c2978bb14d16460f73399c394b6acd?s=160">
                <ul>
                    <li>Developer at <a href="http://www.mybuilder.com/">MyBuilder</a></li>
                    <li><a href="http://threedevsandamaybe.com/">Three Devs and a Maybe</a> podcast co-host</li>
                    <li>All ramblings can be found in the <a href="/archive/">Archive</a></li>
                </ul>
                <div class="cf"></div>
            </footer>
        </div>
    </body>
</html>
