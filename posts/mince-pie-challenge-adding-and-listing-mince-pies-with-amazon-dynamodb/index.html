<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><title>Mince Pie Challenge: Adding and Listing Mince Pies with Amazon DynamoDB - Edd Mann</title>
<meta name=description content="Explore the process of adding and listing mince pies with Amazon DynamoDB using Lambda and offline development with DynamoDB Local."><meta name=author content="Edd Mann"><script async src="https://www.googletagmanager.com/gtag/js?id=G-ZPQ7WHNXH4"></script><script>var dnt,doNotTrack=!1;if(!1&&(dnt=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,doNotTrack=dnt=="1"||dnt=="yes"),!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-ZPQ7WHNXH4")}</script><meta itemprop=name content="Mince Pie Challenge: Adding and Listing Mince Pies with Amazon DynamoDB"><meta itemprop=description content="In the previous post we began to implement the API endpoints, starting off with creating the bootstrap response. We did this in a manner that catered for both online and offline development access. In this post we will incorporate the ability to add and list mince pies, persisting the state within Amazon DynamoDB. Following this, we will enrich our offline development process by setting up an Amazon DynamoDB Local instance using Docker."><meta itemprop=datePublished content="2018-08-16T00:00:00+00:00"><meta itemprop=dateModified content="2018-08-16T00:00:00+00:00"><meta itemprop=wordCount content="2452"><meta itemprop=keywords content="Serverless,Aws,Lambda,Dynamodb,Javascript,Mince-Pie-Challenge-Series"><meta property="og:url" content="https://eddmann.com/posts/mince-pie-challenge-adding-and-listing-mince-pies-with-amazon-dynamodb/"><meta property="og:site_name" content="Edd Mann"><meta property="og:title" content="Mince Pie Challenge: Adding and Listing Mince Pies with Amazon DynamoDB"><meta property="og:description" content="In the previous post we began to implement the API endpoints, starting off with creating the bootstrap response. We did this in a manner that catered for both online and offline development access. In this post we will incorporate the ability to add and list mince pies, persisting the state within Amazon DynamoDB. Following this, we will enrich our offline development process by setting up an Amazon DynamoDB Local instance using Docker."><meta property="og:locale" content="en_GB"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2018-08-16T00:00:00+00:00"><meta property="article:modified_time" content="2018-08-16T00:00:00+00:00"><meta property="article:tag" content="Serverless"><meta property="article:tag" content="Aws"><meta property="article:tag" content="Lambda"><meta property="article:tag" content="Dynamodb"><meta property="article:tag" content="Javascript"><meta property="article:tag" content="Mince-Pie-Challenge-Series"><meta name=twitter:card content="summary"><meta name=twitter:title content="Mince Pie Challenge: Adding and Listing Mince Pies with Amazon DynamoDB"><meta name=twitter:description content="In the previous post we began to implement the API endpoints, starting off with creating the bootstrap response. We did this in a manner that catered for both online and offline development access. In this post we will incorporate the ability to add and list mince pies, persisting the state within Amazon DynamoDB. Following this, we will enrich our offline development process by setting up an Amazon DynamoDB Local instance using Docker."><meta name=twitter:site content="@edd_mann"><link rel=stylesheet href=/css/style.min.a18bbea58d05187498ffb7d6a33b580609df2e92b988055a4b51e41596cc934e.css integrity="sha256-oYu+pY0FGHSY/7fWoztYBgnfLpK5iAVaS1HkFZbMk04="><link rel=preload as=image href=/assets/x.svg crossorigin=anonymous><link rel=preload as=image href=/assets/github.svg crossorigin=anonymous><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=manifest href=/site.webmanifest><link rel=canonical href=https://eddmann.com/posts/mince-pie-challenge-adding-and-listing-mince-pies-with-amazon-dynamodb/><script>document.documentElement.setAttribute("data-theme",localStorage.getItem("theme")||window.matchMedia("(prefers-color-scheme: dark)").matches&&"dark"||"light")</script><script src=/script.min.7f6917401c23509595a4da9144cfe3c8fde343c0352e6d627aa366129e1bdb48.js integrity="sha256-f2kXQBwjUJWVpNqRRM/jyP3jQ8A1Lm1ieqNmEp4b20g=" defer></script></head><body><header class="site-header l-wrapper"><a href=https://eddmann.com/><h3 class=site-header__title>Edd Mann
<span style=--url:url(/assets/code.svg)>Developer</span></h3></a><button class=site-header__mobile-navigation-button type=button title="Toggle mobile site navigation" aria-label="Toggle mobile site navigation" aria-expanded=false aria-controls=site-navigation></button><div class=site-header__navigation id=site-navigation><nav aria-label="Primary navigation"><ul class=site-header__primary-navigation><li><a href=/archive>Archive</a></li><li><a href=/projects>Projects</a></li><li><a href=/about>About</a></li></ul></nav><nav aria-label="Social links"><ul class=site-header__social-navigation><li><a class=social-icon style=--url:url(/assets/x.svg) href=https://x.com/edd_mann rel="external noopener" target=_blank>Twitter (X)</a></li><li><a class=social-icon style=--url:url(/assets/github.svg) href=https://github.com/eddmann rel="external noopener" target=_blank>GitHub</a></li></ul></nav></div></header><main class=l-wrapper><article><header class=l-page-title><h1 class=u-transition-between-pages style=--id:mince-pie-challenge-adding-and-listing-mince-pies-with-amazon-dynamodb>Mince Pie Challenge: Adding and Listing Mince Pies with Amazon DynamoDB</h1><time datetime=2018-08-16T00:00:00Z class=published-at>Aug 16, 2018</time></header><main class=u-prose><p>In the <a href=/posts/mince-pie-challenge-adding-the-bootstrap-endpoint-and-serverless-offline/>previous post</a> we began to implement the API endpoints, starting off with creating the bootstrap response.
We did this in a manner that catered for both online and offline development access.
In this post we will incorporate the ability to add and list mince pies, persisting the state within <a href=https://aws.amazon.com/dynamodb/ rel="external noopener" target=_blank>Amazon DynamoDB</a>.
Following this, we will enrich our offline development process by setting up an <a href=https://docs.aws.amazon.com/amazondynamodb/latest/developerguide/DynamoDBLocal.html rel="external noopener" target=_blank>Amazon DynamoDB Local</a> instance using Docker.</p><p>If you are keen to see how the finished example looks, you can access it within the <a href=https://github.com/eddmann/mince-pie-challenge-api-serverless/tree/06-add-list-pies rel="external noopener" target=_blank>API repository</a>.</p><h2 id=adding-pies-with-amazon-dynamodb>Adding Pies with Amazon DynamoDB</h2><p>If we again look back at the API <a href=/posts/mince-pie-challenge-designing-the-restful-api-with-raml/#managing-the-pies>RAML definition</a> we can see that we wish to provide the client with the ability to add a new mince pie to the challenge by making a <code>POST</code> request with the specific pie name.
If successful, the new pie resource will be returned back to the client.</p><p>To persist the pie resources and associated ratings we shall be using the fully managed NoSQL Amazon DynamoDB solution.
A deep dive into the specifics of DynamoDB is outside the scope of this series, but I would urge you to checkout <a href=https://acloud.guru/learn/aws-dynamodb rel="external noopener" target=_blank>these</a> <a href=https://docs.aws.amazon.com/amazondynamodb/latest/developerguide/GettingStarted.html rel="external noopener" target=_blank>great</a> <a href="https://www.youtube.com/watch?v=bCW3lhsJKfw" rel="external noopener" target=_blank>resources</a> on the subject.
We shall start off by defining the desired table within <code>resources.yml</code>, and grant access to the table for each of the present Lambda functions within <code>roles.yml</code>.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>Resources</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>PieTable</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>Type</span>: <span style=color:#ae81ff>AWS::DynamoDB::Table</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>Properties</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>TableName</span>: <span style=color:#ae81ff>${file(./config.${self:provider.stage}.yml):tableName}</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>AttributeDefinitions</span>:
</span></span><span style=display:flex><span>        - <span style=color:#f92672>AttributeName</span>: <span style=color:#ae81ff>Id</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>AttributeType</span>: <span style=color:#ae81ff>S</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>KeySchema</span>:
</span></span><span style=display:flex><span>        - <span style=color:#f92672>AttributeName</span>: <span style=color:#ae81ff>Id</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>KeyType</span>: <span style=color:#ae81ff>HASH</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>ProvisionedThroughput</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>ReadCapacityUnits</span>: <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>WriteCapacityUnits</span>: <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>Outputs</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>PieTableName</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>Value</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>Ref</span>: <span style=color:#ae81ff>PieTable</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#f92672>Effect</span>: <span style=color:#ae81ff>Allow</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>Action</span>:
</span></span><span style=display:flex><span>    - <span style=color:#ae81ff>dynamodb:*</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>Resource</span>: <span style=color:#e6db74>&#39;arn:aws:dynamodb:${self:provider.region}:*:table/${file(./config.${self:provider.stage}.yml):tableName}&#39;</span>
</span></span></code></pre></div><p>This table includes a unique <code>Id</code> attribute which will be used as the record key.
At this time we have statically specified some rather low <a href=https://docs.aws.amazon.com/amazondynamodb/latest/developerguide/HowItWorks.ProvisionedThroughput.html rel="external noopener" target=_blank>throughput units</a>; when we enter production these should be tuned accordingly.
We assign each Lambda function a role that grants access to perform all available actions on this table, although this could be restricted in the future for security concerns.
In a similar manner to how we have defined stage-specific parameters in the past, we shall specify the desired table name per <code>config.{stage}.yml</code> file like so.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>tableName</span>: <span style=color:#e6db74>&#39;dev-mince-pie-challenge&#39;</span>
</span></span></code></pre></div><p>With the table now present we can move on to providing the ability to add new mince pies to the challenge.
Each pie is uniquely distinguishable based on an associated UUID; to generate these identifiers we must include a new runtime dependency within <code>package.json</code>.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;dependencies&#34;</span>: {
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;uuid&#34;</span>: <span style=color:#e6db74>&#34;^3.3.2&#34;</span>
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>With this dependency available, we will now create a new service within <code>src/services/dynamoDBPieStore.js</code> which will be tasked with managing interaction between the handler and persistent state.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#75715e>// @flow
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> <span style=color:#a6e22e>type</span> { <span style=color:#a6e22e>Pie</span>, <span style=color:#a6e22e>UserId</span> } <span style=color:#a6e22e>from</span> <span style=color:#e6db74>&#39;../types&#39;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> <span style=color:#a6e22e>uuid</span> <span style=color:#a6e22e>from</span> <span style=color:#e6db74>&#39;uuid/v4&#39;</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> <span style=color:#a6e22e>AWS</span> <span style=color:#a6e22e>from</span> <span style=color:#e6db74>&#39;aws-sdk&#39;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>export</span> <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>addPie</span> <span style=color:#f92672>=</span>
</span></span><span style=display:flex><span>  (<span style=color:#a6e22e>tableName</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>string</span>) =&gt;
</span></span><span style=display:flex><span>  (<span style=color:#a6e22e>userId</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>UserId</span>, <span style=color:#a6e22e>name</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>string</span>)<span style=color:#f92672>:</span> Promise<span style=color:#f92672>&lt;</span><span style=color:#a6e22e>Pie</span><span style=color:#f92672>&gt;</span> =&gt; {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>pie</span> <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>Id</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>uuid</span>(),
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>UserId</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>userId</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>Name</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>name</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>AvgRating</span><span style=color:#f92672>:</span> <span style=color:#ae81ff>0</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>PhotoUrl</span><span style=color:#f92672>:</span> <span style=color:#66d9ef>undefined</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>ThumbnailUrl</span><span style=color:#f92672>:</span> <span style=color:#66d9ef>undefined</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>Ratings</span><span style=color:#f92672>:</span> {},
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>AddedAt</span><span style=color:#f92672>:</span> <span style=color:#66d9ef>new</span> Date().<span style=color:#a6e22e>getTime</span>(),
</span></span><span style=display:flex><span>    };
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>AWS</span>.<span style=color:#a6e22e>DynamoDB</span>.<span style=color:#a6e22e>DocumentClient</span>()
</span></span><span style=display:flex><span>      .<span style=color:#a6e22e>put</span>({ <span style=color:#a6e22e>TableName</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>tableName</span>, <span style=color:#a6e22e>Item</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>pie</span> })
</span></span><span style=display:flex><span>      .<span style=color:#a6e22e>promise</span>()
</span></span><span style=display:flex><span>      .<span style=color:#a6e22e>then</span>(() =&gt; <span style=color:#a6e22e>pie</span>);
</span></span><span style=display:flex><span>  };
</span></span></code></pre></div><p>At this time we simply expose an <code>addPie</code> function which allows us to partially apply it with the desired stage&rsquo;s table name.
Once invoked, we build up the initial pie structure, persist it to the DynamoDB table and finally return it to the caller.
This pie structure is typed by Flow, and as such needs to be added to <code>src/types/index.js</code>.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#66d9ef>export</span> <span style=color:#a6e22e>type</span> <span style=color:#a6e22e>UserId</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>string</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>type</span> <span style=color:#a6e22e>URL</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>string</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>type</span> <span style=color:#a6e22e>UUID</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>string</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>export</span> <span style=color:#a6e22e>type</span> <span style=color:#a6e22e>Pie</span> <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>Id</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>UUID</span>,
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>UserId</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>UserId</span>,
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>Name</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>string</span>,
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>AvgRating</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>number</span>,
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>PhotoUrl</span><span style=color:#f92672>:</span> <span style=color:#f92672>?</span><span style=color:#a6e22e>URL</span>,
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>ThumbnailUrl</span><span style=color:#f92672>:</span> <span style=color:#f92672>?</span><span style=color:#a6e22e>URL</span>,
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>Ratings</span><span style=color:#f92672>:</span> { [<span style=color:#a6e22e>UserId</span>]<span style=color:#f92672>:</span> <span style=color:#a6e22e>number</span> },
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>AddedAt</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>number</span>,
</span></span><span style=display:flex><span>};
</span></span></code></pre></div><p>Now we have the ability to persist new pies, we can move on to creating the internal handler (<code>src/handlers/add.js</code>) which will encapsulate this functionality.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#75715e>// @flow
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> { <span style=color:#a6e22e>badRequest</span>, <span style=color:#a6e22e>created</span>, <span style=color:#a6e22e>json</span> } <span style=color:#a6e22e>from</span> <span style=color:#e6db74>&#39;../helpers/http&#39;</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> { <span style=color:#a6e22e>createHandler</span>, <span style=color:#a6e22e>withStrictHttpAuthentication</span> } <span style=color:#a6e22e>from</span> <span style=color:#e6db74>&#39;../helpers/handlers&#39;</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> { <span style=color:#a6e22e>Resource</span> } <span style=color:#a6e22e>from</span> <span style=color:#e6db74>&#39;hal&#39;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>add</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>async</span> ({ <span style=color:#a6e22e>event</span>, <span style=color:#a6e22e>userId</span>, <span style=color:#a6e22e>services</span><span style=color:#f92672>:</span> { <span style=color:#a6e22e>addPie</span> } }) =&gt; {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> { <span style=color:#a6e22e>name</span> } <span style=color:#f92672>=</span> <span style=color:#a6e22e>json</span>(<span style=color:#a6e22e>event</span>.<span style=color:#a6e22e>body</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#a6e22e>name</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>badRequest</span>(<span style=color:#e6db74>&#39;Invalid request body&#39;</span>, [
</span></span><span style=display:flex><span>      { <span style=color:#a6e22e>name</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;name&#39;</span>, <span style=color:#a6e22e>reason</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;You must supply the pie&#39;s name.&#34;</span> },
</span></span><span style=display:flex><span>    ]);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>pie</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>addPie</span>(<span style=color:#a6e22e>userId</span>, <span style=color:#a6e22e>name</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>resource</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>Resource</span>(
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>id</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>pie</span>.<span style=color:#a6e22e>Id</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>name</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>pie</span>.<span style=color:#a6e22e>Name</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>rating</span><span style=color:#f92672>:</span> { <span style=color:#a6e22e>avg</span><span style=color:#f92672>:</span> <span style=color:#ae81ff>0</span>, <span style=color:#a6e22e>total</span><span style=color:#f92672>:</span> <span style=color:#ae81ff>0</span> },
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>addedAt</span><span style=color:#f92672>:</span> <span style=color:#66d9ef>new</span> Date(<span style=color:#a6e22e>pie</span>.<span style=color:#a6e22e>AddedAt</span>).<span style=color:#a6e22e>toISOString</span>(),
</span></span><span style=display:flex><span>    },
</span></span><span style=display:flex><span>    <span style=color:#e6db74>`/pies/</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>pie</span>.<span style=color:#a6e22e>Id</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span>
</span></span><span style=display:flex><span>  );
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>resource</span>.<span style=color:#a6e22e>link</span>(<span style=color:#e6db74>&#39;photo&#39;</span>, <span style=color:#e6db74>`/pies/</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>pie</span>.<span style=color:#a6e22e>Id</span><span style=color:#e6db74>}</span><span style=color:#e6db74>/photo`</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>created</span>(<span style=color:#a6e22e>resource</span>);
</span></span><span style=display:flex><span>};
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>export</span> <span style=color:#66d9ef>default</span> <span style=color:#a6e22e>createHandler</span>(<span style=color:#a6e22e>withStrictHttpAuthentication</span>(<span style=color:#a6e22e>add</span>));
</span></span></code></pre></div><p>This handler simply ensures that a name has been supplied within the request&rsquo;s JSON body, and then proceeds to add it to the challenge.
We ensure that only authenticated clients have access to this behaviour (by way of <code>withStrictHttpAuthentication</code>) and return a newly specified <code>created</code> response.
As we are expanding our HTTP language we need to add these functions to <code>src/helpers/http.js</code>.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#66d9ef>export</span> <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>created</span> <span style=color:#f92672>=</span> (<span style=color:#a6e22e>resource</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>HALResource</span>)<span style=color:#f92672>:</span> <span style=color:#a6e22e>Response</span> =&gt; ({
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>statusCode</span><span style=color:#f92672>:</span> <span style=color:#ae81ff>201</span>,
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>headers</span><span style=color:#f92672>:</span> {
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#39;Access-Control-Allow-Origin&#39;</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;*&#39;</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#39;Access-Control-Allow-Credentials&#39;</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;*&#39;</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#39;Content-Type&#39;</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;application/hal+json&#39;</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Location</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>resource</span>.<span style=color:#a6e22e>_links</span>.<span style=color:#a6e22e>self</span>.<span style=color:#a6e22e>href</span>,
</span></span><span style=display:flex><span>  },
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>body</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>JSON</span>.<span style=color:#a6e22e>stringify</span>(<span style=color:#a6e22e>resource</span>.<span style=color:#a6e22e>toJSON</span>()),
</span></span><span style=display:flex><span>});
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>export</span> <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>badRequest</span> <span style=color:#f92672>=</span> (
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>detail</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>string</span>,
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>errors</span><span style=color:#f92672>:</span> Array<span style=color:#f92672>&lt;</span>{ <span style=color:#a6e22e>name</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>string</span>, <span style=color:#a6e22e>reason</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>string</span> }<span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span>)<span style=color:#f92672>:</span> <span style=color:#a6e22e>Response</span> =&gt; ({
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>statusCode</span><span style=color:#f92672>:</span> <span style=color:#ae81ff>400</span>,
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>headers</span><span style=color:#f92672>:</span> {
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#39;Access-Control-Allow-Origin&#39;</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;*&#39;</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#39;Access-Control-Allow-Credentials&#39;</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;*&#39;</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#39;Content-Type&#39;</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;application/problem+json&#39;</span>,
</span></span><span style=display:flex><span>  },
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>body</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>JSON</span>.<span style=color:#a6e22e>stringify</span>({ <span style=color:#a6e22e>title</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;Bad Request&#39;</span>, <span style=color:#a6e22e>detail</span>, <span style=color:#a6e22e>errors</span> }),
</span></span><span style=display:flex><span>});
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>export</span> <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>json</span> <span style=color:#f92672>=</span> (<span style=color:#a6e22e>input</span><span style=color:#f92672>:</span> <span style=color:#f92672>?</span><span style=color:#a6e22e>string</span>)<span style=color:#f92672>:</span> { [<span style=color:#a6e22e>string</span>]<span style=color:#f92672>:</span> <span style=color:#a6e22e>any</span> } =&gt; {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>try</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>input</span> <span style=color:#f92672>?</span> <span style=color:#a6e22e>JSON</span>.<span style=color:#a6e22e>parse</span>(<span style=color:#a6e22e>input</span>) <span style=color:#f92672>:</span> {};
</span></span><span style=display:flex><span>  } <span style=color:#66d9ef>catch</span> (<span style=color:#a6e22e>e</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> {};
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>};
</span></span></code></pre></div><p>This internal handler is called from the parent <code>src/add.js</code> handler, which provides us with the concrete user authentication and pie addition services.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#75715e>// @flow
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> <span style=color:#a6e22e>add</span> <span style=color:#a6e22e>from</span> <span style=color:#e6db74>&#39;./handlers/add&#39;</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> { <span style=color:#a6e22e>addPie</span> } <span style=color:#a6e22e>from</span> <span style=color:#e6db74>&#39;./services/dynamoDBPieStore&#39;</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> <span style=color:#a6e22e>createUserTokenAuthenticator</span> <span style=color:#a6e22e>from</span> <span style=color:#e6db74>&#39;./services/userTokenAuthenticator&#39;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> { <span style=color:#a6e22e>TABLE_NAME</span>, <span style=color:#a6e22e>USER_POOL_ID</span> } <span style=color:#f92672>=</span> <span style=color:#a6e22e>process</span>.<span style=color:#a6e22e>env</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#a6e22e>TABLE_NAME</span>) {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> Error(<span style=color:#e6db74>&#39;TABLE_NAME is not present&#39;</span>);
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#a6e22e>USER_POOL_ID</span>) {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> Error(<span style=color:#e6db74>&#39;USER_POOL_ID is not present&#39;</span>);
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>export</span> <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>handler</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>add</span>({
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>getUserIdFromToken</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>createUserTokenAuthenticator</span>(<span style=color:#a6e22e>USER_POOL_ID</span>),
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>addPie</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>addPie</span>(<span style=color:#a6e22e>TABLE_NAME</span>),
</span></span><span style=display:flex><span>});
</span></span></code></pre></div><p>With the implementation in place, we can then wire up the handler within <code>functions.yml</code>.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>add-pie</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>handler</span>: <span style=color:#ae81ff>src/add.handler</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>events</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>http</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>path</span>: <span style=color:#ae81ff>/pies</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>method</span>: <span style=color:#ae81ff>post</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>cors</span>: <span style=color:#66d9ef>true</span>
</span></span></code></pre></div><p>As we define the table name &lsquo;per stage&rsquo; and access to this resource is common, we shall include the table name within the <code>serverless.yml</code> global environment configuration.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>provider</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>environment</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>TABLE_NAME</span>: <span style=color:#ae81ff>${file(./config.${self:provider.stage}.yml):tableName}</span>
</span></span></code></pre></div><p>Like the previous bootstrap endpoint, we shall add some suitable test coverage within <code>src/__tests__/add.js</code>, which will verify the intended behaviour of the service.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#66d9ef>import</span> <span style=color:#a6e22e>handler</span> <span style=color:#a6e22e>from</span> <span style=color:#e6db74>&#39;../handlers/add&#39;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>it</span>(<span style=color:#e6db74>&#39;requires an authenticated user&#39;</span>, <span style=color:#66d9ef>async</span> () =&gt; {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>services</span> <span style=color:#f92672>=</span> { <span style=color:#a6e22e>getUserIdFromToken</span><span style=color:#f92672>:</span> () =&gt; Promise.<span style=color:#a6e22e>resolve</span>() };
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>response</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>parseResponse</span>(<span style=color:#66d9ef>await</span> <span style=color:#a6e22e>handler</span>(<span style=color:#a6e22e>services</span>)({ <span style=color:#a6e22e>headers</span><span style=color:#f92672>:</span> { <span style=color:#a6e22e>Authorization</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;&#39;</span> } }, {}));
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>expect</span>(<span style=color:#a6e22e>response</span>.<span style=color:#a6e22e>statusCode</span>).<span style=color:#a6e22e>toEqual</span>(<span style=color:#ae81ff>401</span>);
</span></span><span style=display:flex><span>});
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>it</span>(<span style=color:#e6db74>&#39;requires a pie name&#39;</span>, <span style=color:#66d9ef>async</span> () =&gt; {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>services</span> <span style=color:#f92672>=</span> { <span style=color:#a6e22e>getUserIdFromToken</span><span style=color:#f92672>:</span> () =&gt; Promise.<span style=color:#a6e22e>resolve</span>(<span style=color:#e6db74>&#39;USER_ID&#39;</span>) };
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>response</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>parseResponse</span>(
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>handler</span>(<span style=color:#a6e22e>services</span>)({ <span style=color:#a6e22e>headers</span><span style=color:#f92672>:</span> { <span style=color:#a6e22e>Authorization</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;TOKEN&#39;</span> } }, {})
</span></span><span style=display:flex><span>  );
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>expect</span>(<span style=color:#a6e22e>response</span>.<span style=color:#a6e22e>statusCode</span>).<span style=color:#a6e22e>toEqual</span>(<span style=color:#ae81ff>400</span>);
</span></span><span style=display:flex><span>});
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>it</span>(<span style=color:#e6db74>&#39;adds a new mince pie&#39;</span>, <span style=color:#66d9ef>async</span> () =&gt; {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>services</span> <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>getUserIdFromToken</span><span style=color:#f92672>:</span> () =&gt; Promise.<span style=color:#a6e22e>resolve</span>(<span style=color:#e6db74>&#39;USER_ID&#39;</span>),
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>addPie</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>jest</span>.<span style=color:#a6e22e>fn</span>((<span style=color:#a6e22e>userId</span>, <span style=color:#a6e22e>name</span>) =&gt; ({
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>Id</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;123456&#39;</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>Name</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>name</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>UserId</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>userId</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>AddedAt</span><span style=color:#f92672>:</span> <span style=color:#ae81ff>12345678</span>,
</span></span><span style=display:flex><span>    })),
</span></span><span style=display:flex><span>  };
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>body</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>JSON</span>.<span style=color:#a6e22e>stringify</span>({ <span style=color:#a6e22e>name</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;Mince Pie&#39;</span> });
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>response</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>parseResponse</span>(
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>handler</span>(<span style=color:#a6e22e>services</span>)({ <span style=color:#a6e22e>headers</span><span style=color:#f92672>:</span> { <span style=color:#a6e22e>Authorization</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;TOKEN&#39;</span> }, <span style=color:#a6e22e>body</span> }, {})
</span></span><span style=display:flex><span>  );
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>expect</span>(<span style=color:#a6e22e>response</span>.<span style=color:#a6e22e>statusCode</span>).<span style=color:#a6e22e>toEqual</span>(<span style=color:#ae81ff>201</span>);
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>expect</span>(<span style=color:#a6e22e>services</span>.<span style=color:#a6e22e>addPie</span>).<span style=color:#a6e22e>toHaveBeenCalledWith</span>(<span style=color:#e6db74>&#39;USER_ID&#39;</span>, <span style=color:#e6db74>&#39;Mince Pie&#39;</span>);
</span></span><span style=display:flex><span>});
</span></span></code></pre></div><p>As discussed in a previous post, we have intentionally split the domain logic out from the external dependencies.
This allows us to easily incorporate test doubles within our tests, enabling us to inspect that the <code>addPie</code> service function is being invoked as expected.</p><p>If we now <code>make deploy</code> we shall see a new endpoint appear within the deployment summary.
We can now <code>POST</code> to this endpoint as described within the RAML documentation, and see that the expected responses are returned.
However, without going into the AWS console and viewing the table records, the client is unable to actually see any of the pies they have added.
We will address this in the next section.</p><p><picture><source type=image/webp srcset="/posts/mince-pie-challenge-adding-and-listing-mince-pies-with-amazon-dynamodb/aws-console-dynamodb_hu_92841828ac5e6ac6.webp 350w, /posts/mince-pie-challenge-adding-and-listing-mince-pies-with-amazon-dynamodb/aws-console-dynamodb_hu_b24b84cdf6558878.webp 700w, /posts/mince-pie-challenge-adding-and-listing-mince-pies-with-amazon-dynamodb/aws-console-dynamodb_hu_f15439e28f1cff85.webp 1400w"><source type=image/jpeg srcset="/posts/mince-pie-challenge-adding-and-listing-mince-pies-with-amazon-dynamodb/aws-console-dynamodb_hu_bff7664a8bf0453c.jpg 350w, /posts/mince-pie-challenge-adding-and-listing-mince-pies-with-amazon-dynamodb/aws-console-dynamodb_hu_2cebd9e6b6c61ce5.jpg 700w, /posts/mince-pie-challenge-adding-and-listing-mince-pies-with-amazon-dynamodb/aws-console-dynamodb_hu_ea465532c97ecc13.jpg 1400w"><img src=/posts/mince-pie-challenge-adding-and-listing-mince-pies-with-amazon-dynamodb/aws-console-dynamodb_hu_2cebd9e6b6c61ce5.jpg alt="DynamoDB AWS Console" loading=lazy></picture></p><h2 id=listing-pies-with-amazon-dynamodb>Listing Pies with Amazon DynamoDB</h2><p>Now we have the ability to add new pies, we will move on to granting the client access to list all pies present within the challenge.
We will start off by adding a new function to <code>src/services/dynamoDBPieStore.js</code>, which will return all the pies present.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#66d9ef>export</span> <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>allPies</span> <span style=color:#f92672>=</span> (<span style=color:#a6e22e>tableName</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>string</span>) =&gt; ()<span style=color:#f92672>:</span> Promise<span style=color:#f92672>&lt;</span>Array<span style=color:#f92672>&lt;</span><span style=color:#a6e22e>Pie</span><span style=color:#f92672>&gt;&gt;</span> =&gt;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>AWS</span>.<span style=color:#a6e22e>DynamoDB</span>.<span style=color:#a6e22e>DocumentClient</span>()
</span></span><span style=display:flex><span>    .<span style=color:#a6e22e>scan</span>({ <span style=color:#a6e22e>TableName</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>tableName</span> })
</span></span><span style=display:flex><span>    .<span style=color:#a6e22e>promise</span>()
</span></span><span style=display:flex><span>    .<span style=color:#a6e22e>then</span>(<span style=color:#a6e22e>r</span> =&gt; <span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>Items</span>);
</span></span></code></pre></div><p>From here we can implement the internal handler within <code>src/handler/list.js</code>, which will be used to generate the collection resource response.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#75715e>// @flow
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> { <span style=color:#a6e22e>createHandler</span> } <span style=color:#a6e22e>from</span> <span style=color:#e6db74>&#39;../helpers/handlers&#39;</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> { <span style=color:#a6e22e>ok</span> } <span style=color:#a6e22e>from</span> <span style=color:#e6db74>&#39;../helpers/http&#39;</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> { <span style=color:#a6e22e>Resource</span> } <span style=color:#a6e22e>from</span> <span style=color:#e6db74>&#39;hal&#39;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>list</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>async</span> ({ <span style=color:#a6e22e>services</span><span style=color:#f92672>:</span> { <span style=color:#a6e22e>allPies</span> } }) =&gt; {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>pies</span> <span style=color:#f92672>=</span> (<span style=color:#66d9ef>await</span> <span style=color:#a6e22e>allPies</span>()).<span style=color:#a6e22e>map</span>(
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>pie</span> =&gt;
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>Resource</span>(
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>id</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>pie</span>.<span style=color:#a6e22e>Id</span>,
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>name</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>pie</span>.<span style=color:#a6e22e>Name</span>,
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>thumbnail</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>pie</span>.<span style=color:#a6e22e>ThumbnailUrl</span>,
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>rating</span><span style=color:#f92672>:</span> { <span style=color:#a6e22e>avg</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>pie</span>.<span style=color:#a6e22e>AvgRating</span>, <span style=color:#a6e22e>total</span><span style=color:#f92672>:</span> Object.<span style=color:#a6e22e>keys</span>(<span style=color:#a6e22e>pie</span>.<span style=color:#a6e22e>Ratings</span>).<span style=color:#a6e22e>length</span> },
</span></span><span style=display:flex><span>        },
</span></span><span style=display:flex><span>        <span style=color:#e6db74>`/pies/</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>pie</span>.<span style=color:#a6e22e>Id</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span>
</span></span><span style=display:flex><span>      )
</span></span><span style=display:flex><span>  );
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>resource</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>Resource</span>({ <span style=color:#a6e22e>total</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>pies</span>.<span style=color:#a6e22e>length</span> }, <span style=color:#e6db74>&#39;/pies&#39;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>resource</span>.<span style=color:#a6e22e>embed</span>(<span style=color:#e6db74>&#39;pies&#39;</span>, <span style=color:#a6e22e>pies</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>ok</span>(<span style=color:#a6e22e>resource</span>);
</span></span><span style=display:flex><span>};
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>export</span> <span style=color:#66d9ef>default</span> <span style=color:#a6e22e>createHandler</span>(<span style=color:#a6e22e>list</span>);
</span></span></code></pre></div><p>As described within the <a href=/posts/mince-pie-challenge-designing-the-restful-api-with-raml/#viewing-the-pies>RAML definition</a> important details about each pie are embedded within the listing collection resource.
This stops us from having to make many individual HTTP requests per pie.
We can then encapsulate this in the concrete handler within <code>src/list.js</code>, which configures the external database service dependency.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#75715e>// @flow
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> <span style=color:#a6e22e>list</span> <span style=color:#a6e22e>from</span> <span style=color:#e6db74>&#39;./handlers/list&#39;</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> { <span style=color:#a6e22e>allPies</span> } <span style=color:#a6e22e>from</span> <span style=color:#e6db74>&#39;./services/dynamoDBPieStore&#39;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> { <span style=color:#a6e22e>TABLE_NAME</span> } <span style=color:#f92672>=</span> <span style=color:#a6e22e>process</span>.<span style=color:#a6e22e>env</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#a6e22e>TABLE_NAME</span>) {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> Error(<span style=color:#e6db74>&#39;TABLE_NAME is not present&#39;</span>);
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>export</span> <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>handler</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>list</span>({
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>allPies</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>allPies</span>(<span style=color:#a6e22e>TABLE_NAME</span>),
</span></span><span style=display:flex><span>});
</span></span></code></pre></div><p>We can now assert that the handler provides the desired results by covering the behaviour with tests within <code>src/__tests__/list.js</code>.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#66d9ef>import</span> <span style=color:#a6e22e>handler</span> <span style=color:#a6e22e>from</span> <span style=color:#e6db74>&#39;../handlers/list&#39;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>it</span>(<span style=color:#e6db74>&#39;lists mince pies&#39;</span>, <span style=color:#66d9ef>async</span> () =&gt; {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>pies</span> <span style=color:#f92672>=</span> [
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>Id</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;1&#39;</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>UserId</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;USER_ID&#39;</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>Name</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;Mince Pie&#39;</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>AvgRating</span><span style=color:#f92672>:</span> <span style=color:#ae81ff>0</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>PhotoUrl</span><span style=color:#f92672>:</span> <span style=color:#66d9ef>undefined</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>ThumbnailUrl</span><span style=color:#f92672>:</span> <span style=color:#66d9ef>undefined</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>Ratings</span><span style=color:#f92672>:</span> {},
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>AddedAt</span><span style=color:#f92672>:</span> <span style=color:#ae81ff>123456789</span>,
</span></span><span style=display:flex><span>    },
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>Id</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;2&#39;</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>UserId</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;USER_ID&#39;</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>Name</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;Another Mince Pie&#39;</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>AvgRating</span><span style=color:#f92672>:</span> <span style=color:#ae81ff>0</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>PhotoUrl</span><span style=color:#f92672>:</span> <span style=color:#66d9ef>undefined</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>ThumbnailUrl</span><span style=color:#f92672>:</span> <span style=color:#66d9ef>undefined</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>Ratings</span><span style=color:#f92672>:</span> {},
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>AddedAt</span><span style=color:#f92672>:</span> <span style=color:#ae81ff>123456789</span>,
</span></span><span style=display:flex><span>    },
</span></span><span style=display:flex><span>  ];
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>services</span> <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>allPies</span><span style=color:#f92672>:</span> () =&gt; Promise.<span style=color:#a6e22e>resolve</span>(<span style=color:#a6e22e>pies</span>),
</span></span><span style=display:flex><span>  };
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>response</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>parseResponse</span>(<span style=color:#66d9ef>await</span> <span style=color:#a6e22e>handler</span>(<span style=color:#a6e22e>services</span>)({}, {}));
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>expect</span>(<span style=color:#a6e22e>response</span>.<span style=color:#a6e22e>statusCode</span>).<span style=color:#a6e22e>toEqual</span>(<span style=color:#ae81ff>200</span>);
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>expect</span>(<span style=color:#a6e22e>response</span>.<span style=color:#a6e22e>body</span>.<span style=color:#a6e22e>total</span>).<span style=color:#a6e22e>toBe</span>(<span style=color:#ae81ff>2</span>);
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>expect</span>(<span style=color:#a6e22e>response</span>.<span style=color:#a6e22e>body</span>.<span style=color:#a6e22e>_embedded</span>.<span style=color:#a6e22e>pies</span>).<span style=color:#a6e22e>toHaveLength</span>(<span style=color:#ae81ff>2</span>);
</span></span><span style=display:flex><span>});
</span></span></code></pre></div><p>Finally, we can define the list handler within <code>functions.yml</code>, and perform another <code>make deploy</code>.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>list-pies</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>handler</span>: <span style=color:#ae81ff>src/list.handler</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>events</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>http</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>path</span>: <span style=color:#ae81ff>/pies</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>method</span>: <span style=color:#ae81ff>get</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>cors</span>: <span style=color:#66d9ef>true</span>
</span></span></code></pre></div><p>If we now visit this new endpoint we should see the pie we added from the last request.
We have now added the ability to add and list mince pies within the challenge using online AWS resources.
In similar fashion to how we were able to develop the bootstrap endpoint offline, we will now expand upon this and add the ability to interact with these endpoints using Amazon DynamoDB Local.</p><h2 id=using-amazon-dynamodb-local-for-offline-development>Using Amazon DynamoDB Local for Offline Development</h2><p>We shall be using a dedicated <a href=https://hub.docker.com/r/ccabreraruiz/dynamodb-local/ rel="external noopener" target=_blank>Docker container</a> which will expose the DynamoDB Local instance to our API.
To begin, we need to add the new service to the <code>docker-compose.yml</code> file, ensuring that the <code>serverless-offline</code> service is linked and made aware of it.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>services</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>serverless-offline</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>links</span>:
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>dynamodb</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>dynamodb</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>image</span>: <span style=color:#ae81ff>ccabreraruiz/dynamodb-local</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>ports</span>:
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>8000</span>:<span style=color:#ae81ff>8000</span>
</span></span></code></pre></div><p>The Serverless Framework is able to interact with this DynamoDB Local instance by adding an <a href=https://www.npmjs.com/package/serverless-dynamodb-local rel="external noopener" target=_blank>additional plugin</a>.
We shall add this development dependency to the <code>package.json</code> file.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;devDependencies&#34;</span>: {
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;serverless-dynamodb-local&#34;</span>: <span style=color:#e6db74>&#34;^0.2.30&#34;</span>
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>With this now available, we can define how the plugin can access the local instance within the <code>serverless.yml</code> file.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>custom</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>dynamodb</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>start</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>host</span>: <span style=color:#ae81ff>dynamodb</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>port</span>: <span style=color:#ae81ff>8000</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>plugins</span>:
</span></span><span style=display:flex><span>  - <span style=color:#ae81ff>serverless-dynamodb-local</span>
</span></span></code></pre></div><p>This plugin can be used for both provisioning and managing a DynamoDB Local instance.
As we are using Docker to provision the instance we only require the plugin to ensure that the specific resources presented in <code>resources.yml</code> are made available.
To do this we shall update the <code>Makefile</code> offline target to ensure that a freshly migrated DynamoDB table is present when we wish to develop offline.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-make data-lang=make><span style=display:flex><span><span style=color:#a6e22e>offline</span><span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>  docker-compose rm -sf dynamodb <span style=color:#f92672>&amp;&amp;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  docker-compose run --rm serverless-offline sls dynamodb migrate --stage<span style=color:#f92672>=</span>offline <span style=color:#f92672>&amp;&amp;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  docker-compose run --service-ports --rm serverless-offline sls offline --stage<span style=color:#f92672>=</span>offline
</span></span></code></pre></div><p>The next step is to decide how we will provide offline counterparts to the online Amazon Cognito and Amazon DynamoDB we will be using in online stages.
To do this we will take advantage of Webpack&rsquo;s <a href=https://webpack.js.org/configuration/resolve/#resolve-alias rel="external noopener" target=_blank>alias resolution</a> and a flag that is set when Serverless is building the offline instance.
We shall update <code>webpack.config.js</code> as follows.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>IS_OFFLINE</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>slsw</span>.<span style=color:#a6e22e>lib</span>.<span style=color:#a6e22e>webpack</span>.<span style=color:#a6e22e>isLocal</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>module</span>.<span style=color:#a6e22e>exports</span> <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>resolve</span><span style=color:#f92672>:</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>alias</span><span style=color:#f92672>:</span> {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>db</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>path</span>.<span style=color:#a6e22e>resolve</span>(
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>__dirname</span>,
</span></span><span style=display:flex><span>        <span style=color:#e6db74>`./src/services/</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>IS_OFFLINE</span> <span style=color:#f92672>?</span> <span style=color:#e6db74>&#39;localDynamoDBPieStore&#39;</span> <span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;dynamoDBPieStore&#39;</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span>
</span></span><span style=display:flex><span>      ),
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>userTokenAuthenticator</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>path</span>.<span style=color:#a6e22e>resolve</span>(
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>__dirname</span>,
</span></span><span style=display:flex><span>        <span style=color:#e6db74>`src/services/</span><span style=color:#e6db74>${</span>
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>IS_OFFLINE</span> <span style=color:#f92672>?</span> <span style=color:#e6db74>&#39;inMemoryUserTokenAuthenticator&#39;</span> <span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;cognitoUserTokenAuthenticator&#39;</span>
</span></span><span style=display:flex><span>        <span style=color:#e6db74>}</span><span style=color:#e6db74>`</span>
</span></span><span style=display:flex><span>      ),
</span></span><span style=display:flex><span>    },
</span></span><span style=display:flex><span>  },
</span></span><span style=display:flex><span>};
</span></span></code></pre></div><p>By adding this layer of indirection we provide the ability to swap out the desired <code>db</code> and <code>userTokenAuthenticator</code> service, based on whether we are in online or offline mode.
To maintain the current online functionality all we need to do is replace the paths defined within <code>src/list.js</code> and <code>src/add.js</code> with these new aliases.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#66d9ef>import</span> { <span style=color:#a6e22e>addPie</span>, <span style=color:#a6e22e>allPies</span> } <span style=color:#a6e22e>from</span> <span style=color:#e6db74>&#39;db&#39;</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> <span style=color:#a6e22e>createUserTokenAuthenticator</span> <span style=color:#a6e22e>from</span> <span style=color:#e6db74>&#39;userTokenAuthenticator&#39;</span>;
</span></span></code></pre></div><p>Now we can define the specific implementations of the service which will be used in offline mode.
In the case of <code>db</code> which will interact with the local instance, we can define it as so within <code>src/services/localDynamoDBPieStore.js</code>.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#75715e>// @flow
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> <span style=color:#a6e22e>type</span> { <span style=color:#a6e22e>Pie</span>, <span style=color:#a6e22e>UserId</span> } <span style=color:#a6e22e>from</span> <span style=color:#e6db74>&#39;../types&#39;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> <span style=color:#a6e22e>uuid</span> <span style=color:#a6e22e>from</span> <span style=color:#e6db74>&#39;uuid/v4&#39;</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> <span style=color:#a6e22e>AWS</span> <span style=color:#a6e22e>from</span> <span style=color:#e6db74>&#39;aws-sdk&#39;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>config</span> <span style=color:#f92672>=</span> { <span style=color:#a6e22e>region</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;localhost&#39;</span>, <span style=color:#a6e22e>endpoint</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;http://dynamodb:8000&#39;</span> };
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>export</span> <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>addPie</span> <span style=color:#f92672>=</span>
</span></span><span style=display:flex><span>  (<span style=color:#a6e22e>tableName</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>string</span>) =&gt;
</span></span><span style=display:flex><span>  (<span style=color:#a6e22e>userId</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>UserId</span>, <span style=color:#a6e22e>name</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>string</span>)<span style=color:#f92672>:</span> Promise<span style=color:#f92672>&lt;</span><span style=color:#a6e22e>Pie</span><span style=color:#f92672>&gt;</span> =&gt; {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>pie</span> <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>Id</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>uuid</span>(),
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>UserId</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>userId</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>Name</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>name</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>AvgRating</span><span style=color:#f92672>:</span> <span style=color:#ae81ff>0</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>PhotoUrl</span><span style=color:#f92672>:</span> <span style=color:#66d9ef>undefined</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>ThumbnailUrl</span><span style=color:#f92672>:</span> <span style=color:#66d9ef>undefined</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>Ratings</span><span style=color:#f92672>:</span> {},
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>AddedAt</span><span style=color:#f92672>:</span> <span style=color:#66d9ef>new</span> Date().<span style=color:#a6e22e>getTime</span>(),
</span></span><span style=display:flex><span>    };
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>AWS</span>.<span style=color:#a6e22e>DynamoDB</span>.<span style=color:#a6e22e>DocumentClient</span>(<span style=color:#a6e22e>config</span>)
</span></span><span style=display:flex><span>      .<span style=color:#a6e22e>put</span>({ <span style=color:#a6e22e>TableName</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>tableName</span>, <span style=color:#a6e22e>Item</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>pie</span> })
</span></span><span style=display:flex><span>      .<span style=color:#a6e22e>promise</span>()
</span></span><span style=display:flex><span>      .<span style=color:#a6e22e>then</span>(() =&gt; <span style=color:#a6e22e>pie</span>);
</span></span><span style=display:flex><span>  };
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>export</span> <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>allPies</span> <span style=color:#f92672>=</span> (<span style=color:#a6e22e>tableName</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>string</span>) =&gt; ()<span style=color:#f92672>:</span> Promise<span style=color:#f92672>&lt;</span>Array<span style=color:#f92672>&lt;</span><span style=color:#a6e22e>Pie</span><span style=color:#f92672>&gt;&gt;</span> =&gt;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>AWS</span>.<span style=color:#a6e22e>DynamoDB</span>.<span style=color:#a6e22e>DocumentClient</span>(<span style=color:#a6e22e>config</span>)
</span></span><span style=display:flex><span>    .<span style=color:#a6e22e>scan</span>({ <span style=color:#a6e22e>TableName</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>tableName</span> })
</span></span><span style=display:flex><span>    .<span style=color:#a6e22e>promise</span>()
</span></span><span style=display:flex><span>    .<span style=color:#a6e22e>then</span>(<span style=color:#a6e22e>r</span> =&gt; <span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>Items</span>);
</span></span></code></pre></div><p>You can see in this case we are required to provide the specific local endpoint that the <code>DocumentClient</code> should interact with.
In the case of the <code>userTokenAuthenticator</code>, there is sadly no local equivalent to Amazon Cognito.
We shall instead use a simple in-memory representation (<code>src/services/inMemoryUserTokenAuthenticator.js</code>), which will provide a couple of stub user tokens for us to use.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#75715e>// @flow
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> <span style=color:#a6e22e>type</span> { <span style=color:#a6e22e>UserTokenAuthenticator</span> } <span style=color:#a6e22e>from</span> <span style=color:#e6db74>&#39;../types&#39;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>users</span> <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>TOKEN1</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;User1&#39;</span>,
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>TOKEN2</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;User2&#39;</span>,
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>TOKEN3</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;User3&#39;</span>,
</span></span><span style=display:flex><span>};
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>export</span> <span style=color:#66d9ef>default</span> (<span style=color:#a6e22e>poolId</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>string</span>)<span style=color:#f92672>:</span> <span style=color:#a6e22e>UserTokenAuthenticator</span> =&gt;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>async</span> <span style=color:#a6e22e>token</span> =&gt;
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>users</span>[<span style=color:#a6e22e>token</span>];
</span></span></code></pre></div><p>With these changes, we are required to define what the new aliases point to in regards to Flow.
We shall use the online services in this case, adding them to the <code>.flowconfig</code> file like so.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ini data-lang=ini><span style=display:flex><span><span style=color:#66d9ef>[options]</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>module.name_mapper</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#39;^db$&#39; -&gt; &#39;&lt;PROJECT_ROOT&gt;/src/services/dynamoDBPieStore&#39;</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>module.name_mapper</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#39;^userTokenAuthenticator$&#39; -&gt; &#39;&lt;PROJECT_ROOT&gt;/src/services/cognitoUserTokenAuthenticator&#39;</span>
</span></span></code></pre></div><p>Finally, we can <code>make offline</code> and experiment with the new API endpoints offline.
We can supply authenticated user tokens (i.e. <code>TOKEN1</code>) in the event that we wish to add a new pie to the challenge.
In the case of the local DynamoDB instance, we are able to inspect the current state and run custom queries by visiting <code>http://0.0.0.0:8000/shell/</code>.</p><p><picture><source type=image/webp srcset="/posts/mince-pie-challenge-adding-and-listing-mince-pies-with-amazon-dynamodb/local-shell-dynamodb_hu_1e3a78b5ae97d20f.webp 350w, /posts/mince-pie-challenge-adding-and-listing-mince-pies-with-amazon-dynamodb/local-shell-dynamodb_hu_1d4af5e020de697.webp 700w, /posts/mince-pie-challenge-adding-and-listing-mince-pies-with-amazon-dynamodb/local-shell-dynamodb_hu_9c022b1921826658.webp 1400w"><source type=image/jpeg srcset="/posts/mince-pie-challenge-adding-and-listing-mince-pies-with-amazon-dynamodb/local-shell-dynamodb_hu_ec91d53e6d8dc06e.jpg 350w, /posts/mince-pie-challenge-adding-and-listing-mince-pies-with-amazon-dynamodb/local-shell-dynamodb_hu_b70c9e6f6e53c3c6.jpg 700w, /posts/mince-pie-challenge-adding-and-listing-mince-pies-with-amazon-dynamodb/local-shell-dynamodb_hu_b5165020e8b30186.jpg 1400w"><img src=/posts/mince-pie-challenge-adding-and-listing-mince-pies-with-amazon-dynamodb/local-shell-dynamodb_hu_b70c9e6f6e53c3c6.jpg alt="Local DynamoDB Shell" loading=lazy></picture></p><p>I hope you have enjoyed exploring working with DynamoDB using Lambda, and adding the ability to develop the service in an offline manner.
Join me in the <a href=/posts/mince-pie-challenge-viewing-and-removing-mince-pies-with-amazon-dynamodb/>next post</a> of the <a href=/archive/tag/mince-pie-challenge-series>series</a>, we shall be expanding the API further, by adding the capability to view and remove specified mince pies.</p></main><footer class=post-footer><ul class="tags tags--large"><li><a href=/archive/tag/serverless>serverless</a></li><li><a href=/archive/tag/aws>aws</a></li><li><a href=/archive/tag/lambda>lambda</a></li><li><a href=/archive/tag/dynamodb>dynamodb</a></li><li><a href=/archive/tag/javascript>javascript</a></li><li><a href=/archive/tag/mince-pie-challenge-series>mince-pie-challenge-series</a></li></ul><div class=related><h3 class=related__title>Related Posts</h3><ul class=related__posts><li><a href=/posts/mince-pie-challenge-building-a-serverless-restful-api-and-react-client/>Mince Pie Challenge: Building a Serverless RESTful API and React Client</a></li><li><a href=/posts/creating-a-winning-audio-lambda-service-using-serverless-polly-and-compiled-sox/>Creating a 'Winning' Audio Lambda Service using Serverless, Polly and compiled SOX</a></li><li><a href=/posts/memes-as-a-service-using-lambda-serverless-and-imagemagick/>'Memes as a Service' using Lambda, Serverless and ImageMagick</a></li><li><a href=/posts/mince-pie-challenge-setting-up-the-serverless-framework-with-docker-webpack-and-babel/>Mince Pie Challenge: Setting up the Serverless Framework with Docker, Webpack and Babel</a></li><li><a href=/posts/scheduling-ec2-instances-using-lambda-and-cloudwatch-events/>Scheduling EC2 Instances using Lambda and CloudWatch Events</a></li></ul></div></footer></article><div class=scroll-watcher></div></main><footer class="site-footer l-wrapper"><div>&copy; 2025, Edd Mann</div><button class=site-footer__theme-toggle type=button title="Toggle theme" aria-label="Toggle theme"><svg fill="currentcolor" viewBox="0 0 32 32" role="img"><title>Theme toggle icon</title><desc>A circle representing the moon for toggling theme</desc><path d="M16 .5C7.4.5.5 7.4.5 16S7.4 31.5 16 31.5 31.5 24.6 31.5 16 24.6.5 16 .5zm0 28.1V3.4C23 3.4 28.6 9 28.6 16S23 28.6 16 28.6z"/></svg></button></footer></body></html>