<!doctype html>
<html lang="en">
    <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Delving into how Git internally represents project history.">

    <title>
        
            The Internals of Git &middot; Edd Mann
        
    </title>

    <link rel="stylesheet" href="//fonts.googleapis.com/css?family=Source+Sans+Pro:400,700,700italic,400italic">
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <link rel="stylesheet" href="/styles.css">

    <link rel="shortcut icon" href="/favicon.ico">

    <link rel="alternate" href="/rss.xml" title="" type="application/rss+xml">

    

    <script>
        var _gaq=[['_setAccount','UA-32512081-1'],['_setDomainName','eddmann.com'],['_trackPageview']];
        (function() {
            var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
            ga.src = 'https://ssl.google-analytics.com/ga.js';
            var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
        })();
    </script>
</head>

    <body>
        <div class="container content">
            <header class="masthead">
                <h3 class="masthead-title">
                    <a href="/" title="Home">Edd Mann</a>
                    <small><i class="fa fa-code"></i> Developer</small>
                </h3>
                <nav>
                    <a href="https://twitter.com/edd_mann"><i class="fa fa-twitter"></i></a>
                    <a href="https://github.com/eddmann"><i class="fa fa-github"></i></a>
                    <a href="mailto:the@eddmann.com"><i class="fa fa-envelope"></i></a>
                </nav>
                <div class="cf"></div>
            </header>

            <main>
                <article class="post">
    <h1 class="post-title">The Internals of Git</h1>
    <time datetime="2014-12-27T00:00:00+00:00" class="post-date">27 Dec 2014</time>
    <p>I have been using Git for the past couple of years and remember how long it took me to get my head around the work-flow.
Throughout the past couple of months, thanks to a couple of <a href="http://ftp.newartisans.com/pub/git.from.bottom.up.pdf">well</a> <a href="http://mrchlblng.me/2014/09/practical-git-introduction/">timed</a> <a href="http://episodes.gitminutes.com/">findings</a>, I have gained an interest into how Git works internally.
In this post I hope to explain how Git uses well-designed, composed low-level commands to create the high-level actions we are familiar with using on a day-to-day basis.</p>



<p>At its core a Git repository is a key-value object store, where each SHA-1 key is generated based on multiple factors.
This file-based store is used to represent a functional <a href="http://en.wikipedia.org/wiki/Directed_acyclic_graph">Directed Acyclic Graph</a>, which through the use of commit, tree and blob objects, represents the projects history.</p>

<h2 id="an-example">An Example</h2>

<p>To better understand how history is represented within Git, lets first commit a plain-text file entitled ‘foo.txt’ with the contents ‘Hello, world’.
The only catch being, instead of using high-level commands such as <a href="http://git-scm.com/docs/git-add">git-add</a> and <a href="http://git-scm.com/docs/git-commit">git-commit</a>, we will go through the process of manually indexing and committing the file instead.</p>

<p>The first step is to store a blob object containing the contents of the ‘foo.txt’ file in the data-store - the hash of which is generated based on the contents and size of the file (or std-in) supplied.
In the case of this example we will use std-in, and not only query Git for the generated hash, but also persist the blob into the object graph.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">echo</span> <span class="s1">'Hello, world'</span> | git hash-object <span class="nt">--stdin</span> <span class="nt">-w</span>
a5c19667710254f835085b99726e523457150e03
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>tree .git/objects/
.git/objects/
| |____
| | |____a5
| | | |____c19667710254f835085b99726e523457150e03
</code></pre></div></div>

<p>You will notice, if you are following along, that the resulting hash for this blob will be identical to the one above.
That is one of Git’s ingenious strengths, identical files are only ever stored once, regardless of where they appear in the history graph.</p>

<p>The next step is to add the blob (via its hash key) to the index (staging area), specifying the file permissions and directory/name you wish to associate it with.
We can then write this tree object out to the file-store, being returned its commuted hash.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>git update-index <span class="nt">--add</span> <span class="nt">--cacheinfo</span> 100644 a5c19667710254f835085b99726e523457150e03 foo.txt
<span class="nv">$ </span>git write-tree
0906930f06d75609ca186359a6cee2c9623bf99a
<span class="nv">$ </span>git cat-file <span class="nt">-p</span> 0906930f06d75609ca186359a6cee2c9623bf99a
100644 blob a5c19667710254f835085b99726e523457150e03    foo.txt
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>tree .git/objects/
.git/objects/
| |____
| | |____09
| | | |____06930f06d75609ca186359a6cee2c9623bf99a
| | |____a5
| | | |____c19667710254f835085b99726e523457150e03
</code></pre></div></div>

<p>The pending index is stored in a file called ‘index’ until it is then persisted into the store.
Tree objects store a combination of blob objects with file attributes such as the ‘foo.txt’ filename, along with other tree objects for subsequent directories.
We are now ready to associate this generated tree with a commit object.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>git commit-tree 0906930f06d75609ca186359a6cee2c9623bf99a <span class="nt">-m</span> <span class="s2">"First commit"</span>
e5446fb51f77fd526f56b7f58ac328c5db954dc6
<span class="nv">$ </span>git cat-file <span class="nt">-p</span> e5446fb51f77fd526f56b7f58ac328c5db954dc6
tree 0906930f06d75609ca186359a6cee2c9623bf99a
author Edd Mann &lt;the@eddmann.com&gt; 1419674305 +0000
committer Edd Mann &lt;the@eddmann.com&gt; 1419674305 +0000

First commit
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>tree .git/objects/
.git/objects/
| |____
| | |____09
| | | |____06930f06d75609ca186359a6cee2c9623bf99a
| | |____a5
| | | |____c19667710254f835085b99726e523457150e03
| | |____e5
| | | |____446fb51f77fd526f56b7f58ac328c5db954dc6
</code></pre></div></div>

<p>This commit hash will differ from the one you generate as factors such as name/email and current timestamp play a role in its generation.
With this commit now persisted in the store we can update the repositories ‘HEAD’ reference to point to the generated hash commit.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>git update-ref HEAD e5446fb51f77fd526f56b7f58ac328c5db954dc6
<span class="nv">$ </span>git checkout <span class="nt">-f</span>
<span class="nv">$ </span><span class="nb">cat </span>foo.txt
Hello, world
</code></pre></div></div>

<p>As you can see, it only takes three persisted object files to represent a one file commit history.
Finally, lets generate a new file ‘baz.txt’ which is stored in a directory called ‘bar’.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">echo</span> <span class="s1">'Bonjour'</span> | git hash-object <span class="nt">--stdin</span> <span class="nt">-w</span>
632e4fe73c3da8c9018008dbda117fc6b00e3e83
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>git update-index <span class="nt">--add</span> <span class="nt">--cacheinfo</span> 100644 632e4fe73c3da8c9018008dbda117fc6b00e3e83 bar/baz.txt
<span class="nv">$ </span>git write-tree
84483aa54b5cd02e76298c097831c51914c53821
<span class="nv">$ </span>git cat-file <span class="nt">-p</span> 84483aa54b5cd02e76298c097831c51914c53821
040000 tree 8ee16db87ef1f040f79a0e4cb843668369e96f70    bar
100644 blob a5c19667710254f835085b99726e523457150e03    foo.txt
</code></pre></div></div>

<p>In a similar manner to the first example, we persist both the file-contents blob and tree objects.
The difference arrives when we wish to generate the second commit, we must now supply the parent commits hash (in our case the first commit) which will be used to calculate the graphs history when desired.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>git commit-tree 84483aa54b5cd02e76298c097831c51914c53821 <span class="nt">-m</span> <span class="s2">"Second commit"</span> <span class="nt">-p</span> HEAD
18f4f9e35fe5d521f12c5a5b7bc7b969b472d4dd
<span class="nv">$ </span>git cat-file <span class="nt">-p</span> 18f4f9e35fe5d521f12c5a5b7bc7b969b472d4dd
tree 84483aa54b5cd02e76298c097831c51914c53821
parent e5446fb51f77fd526f56b7f58ac328c5db954dc6
author Edd Mann &lt;the@eddmann.com&gt; 1419674876 +0000
committer Edd Mann &lt;the@eddmann.com&gt; 1419674876 +0000

Second commit
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>git update-ref HEAD 18f4f9e35fe5d521f12c5a5b7bc7b969b472d4dd
<span class="nv">$ </span>git checkout <span class="nt">-f</span>
<span class="nv">$ </span><span class="nb">cat </span>bar/baz.txt
Bonjour
</code></pre></div></div>

<p>I hope this quick introduction to the internals of Git has helped you realise how simple, yet powerful the system has been modeled.</p>

</article>

            </main>

            <footer class="footer">
                <img src="https://www.gravatar.com/avatar/c5c2978bb14d16460f73399c394b6acd?s=160">
                <ul>
                    <li>Developer at <a href="http://www.mybuilder.com/">MyBuilder</a></li>
                    <li><a href="http://threedevsandamaybe.com/">Three Devs and a Maybe</a> podcast co-host</li>
                    <li>All ramblings can be found in the <a href="/archive/">Archive</a></li>
                </ul>
                <div class="cf"></div>
            </footer>
        </div>
    </body>
</html>
