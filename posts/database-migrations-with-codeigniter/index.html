<!doctype html>
<html lang="en">
    <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Discover how to manage database migrations with CodeIgniter through practical examples and step-by-step guidance on synchronising your database schema with your source code.">

    <title>
        
            Database Migrations with CodeIgniter &middot; Edd Mann
        
    </title>

    <link rel="stylesheet" href="//fonts.googleapis.com/css?family=Source+Sans+Pro:400,700,700italic,400italic">
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <link rel="stylesheet" href="/styles.css">

    <link rel="shortcut icon" href="/favicon.ico">

    <link rel="alternate" href="/rss.xml" title="" type="application/rss+xml">

    

    <script>
        var _gaq=[['_setAccount','UA-32512081-1'],['_setDomainName','eddmann.com'],['_trackPageview']];
        (function() {
            var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
            ga.src = 'https://ssl.google-analytics.com/ga.js';
            var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
        })();
    </script>
</head>

    <body>
        <div class="container content">
            <header class="masthead">
                <h3 class="masthead-title">
                    <a href="/" title="Home">Edd Mann</a>
                    <small><i class="fa fa-code"></i> Developer</small>
                </h3>
                <nav>
                    <a href="https://twitter.com/edd_mann"><i class="fa fa-twitter"></i></a>
                    <a href="https://github.com/eddmann"><i class="fa fa-github"></i></a>
                    <a href="mailto:the@eddmann.com"><i class="fa fa-envelope"></i></a>
                </nav>
                <div class="cf"></div>
            </header>

            <main>
                <article class="post">
    <h1 class="post-title">Database Migrations with CodeIgniter</h1>
    <time datetime="2012-06-08T00:00:00+00:00" class="post-date">08 Jun 2012</time>
    <p>I first became aware of database migrations a few years ago when I was exploring the world of <a href="http://rubyonrails.org/">Rails</a>.
However, I have only recently used them again, prompted by a gentle nudge from SE-Radio (<a href="http://www.se-radio.net/2012/06/episode-186-martin-fowler-and-pramod-sadalage-on-agile-database-development/">Episode 186</a>) and a large web application build which re-introduced them into my development lifecycle.
Due to current events, I, for one, do not wish to see them go any time soon.</p>



<h2 id="so-what-are-database-migrations">So What Are Database Migrations?</h2>

<p>Since it is extremely rare for any common web application to not be driven by a database, it is crucial to maintain synchronisation between the state of the schema and the source code.
Migrations are used to achieve this goal, providing you with the ability to version control your schema alterations, so to speak.
Using this approach, developers can pull down schema changes along with source code alterations (if using some form of <a href="http://en.wikipedia.org/wiki/Source_Control_Management">SCM</a>), without the need to run external tear up/down scripts.
As a result, it allows you to quickly roll back and forth through the history of the schema to work with the desired version.
These migrations are commonly used to easily modify the state of the database based on the environment, for example, development, testing/QA or production.</p>

<h2 id="an-example">An Example…</h2>

<p>I have spent more and more time using CodeIgniter (and, as a result, PHP) over the past few weeks.
This coincided with my interest in migrations, as I was pleasantly surprised to discover that CodeIgniter provides a simple out-of-the-box <a href="http://codeigniter.com/user_guide/libraries/migration.html">database migration implementation</a>.
It should be noted that many different migration tools are available in most programming languages.
Be warned against vendor lock-in; spend some time making your decision.</p>

<p>Below is a sample migration that should be created inside <code class="language-plaintext highlighter-rouge">./application/migrations/</code> with the filename <code class="language-plaintext highlighter-rouge">001-create-users.php</code>.
Migration files in CodeIgniter follow the convention of prefixing the version number, followed by a descriptive name (commonly the class name).</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">class</span> <span class="nc">Migration_Create_Users</span> <span class="kd">extends</span> <span class="nc">CI_Migration</span> <span class="p">{</span>

  <span class="k">public</span> <span class="k">function</span> <span class="n">up</span><span class="p">()</span>
  <span class="p">{</span>
    <span class="nv">$fields</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span>
      <span class="s1">'id INT(11) UNSIGNED NOT NULL AUTO_INCREMENT'</span><span class="p">,</span>
      <span class="s1">'username VARCHAR(10) DEFAULT NULL'</span><span class="p">,</span>
      <span class="s1">'password VARCHAR(50) DEFAULT NULL'</span>
    <span class="p">);</span>

    <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">dbforge</span><span class="o">-&gt;</span><span class="nf">add_field</span><span class="p">(</span><span class="nv">$fields</span><span class="p">);</span>
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">dbforge</span><span class="o">-&gt;</span><span class="nf">add_key</span><span class="p">(</span><span class="s1">'id'</span><span class="p">,</span> <span class="kc">TRUE</span><span class="p">);</span>
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">dbforge</span><span class="o">-&gt;</span><span class="nf">create_table</span><span class="p">(</span><span class="s1">'users'</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="k">public</span> <span class="k">function</span> <span class="n">down</span><span class="p">()</span>
  <span class="p">{</span>
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">dbforge</span><span class="o">-&gt;</span><span class="nf">drop_table</span><span class="p">(</span><span class="s1">'users'</span><span class="p">);</span>
  <span class="p">}</span>

<span class="p">}</span>
</code></pre></div></div>

<p>The code snippet above creates a table (in MySQL) with an auto-incrementing primary key called <code class="language-plaintext highlighter-rouge">id</code> and columns for <code class="language-plaintext highlighter-rouge">username</code> and <code class="language-plaintext highlighter-rouge">password</code>.
If this migration is rolled back, the <code class="language-plaintext highlighter-rouge">users</code> table is dropped from the schema.
To run this migration, you must first ensure that migrations are enabled and that the desired version is set in your application’s configuration file (found at <code class="language-plaintext highlighter-rouge">./application/config/migration.php</code>).
Once configured, you can create a simple controller, as displayed below, which calls the migration library when visited.</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">class</span> <span class="nc">Migrate</span> <span class="kd">extends</span> <span class="nc">CI_Controller</span> <span class="p">{</span>

  <span class="k">public</span> <span class="k">function</span> <span class="n">index</span><span class="p">()</span>
  <span class="p">{</span>
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">load</span><span class="o">-&gt;</span><span class="nf">library</span><span class="p">(</span><span class="s1">'migration'</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span> <span class="o">!</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">migration</span><span class="o">-&gt;</span><span class="nb">current</span><span class="p">())</span> <span class="p">{</span>
      <span class="nf">show_error</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="n">migration</span><span class="o">-&gt;</span><span class="nf">error_string</span><span class="p">());</span>
    <span class="p">}</span>
  <span class="p">}</span>

<span class="p">}</span>
</code></pre></div></div>

<p>By adding a second migration (named <code class="language-plaintext highlighter-rouge">002-add-name-fields.php</code>) to the application, you can see how the database can be procedurally altered.</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">class</span> <span class="nc">Migration_Add_Name_Fields</span> <span class="kd">extends</span> <span class="nc">CI_Migration</span> <span class="p">{</span>

  <span class="k">public</span> <span class="k">function</span> <span class="n">up</span><span class="p">()</span>
  <span class="p">{</span>
    <span class="nv">$fields</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span>
      <span class="s1">'first_name VARCHAR(50) DEFAULT NULL'</span><span class="p">,</span>
      <span class="s1">'last_name VARCHAR(50) DEFAULT NULL'</span>
    <span class="p">);</span>

    <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">dbforge</span><span class="o">-&gt;</span><span class="nf">add_column</span><span class="p">(</span><span class="s1">'users'</span><span class="p">,</span> <span class="nv">$fields</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="k">public</span> <span class="k">function</span> <span class="n">down</span><span class="p">()</span>
  <span class="p">{</span>
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">dbforge</span><span class="o">-&gt;</span><span class="nf">drop_column</span><span class="p">(</span><span class="s1">'users'</span><span class="p">,</span> <span class="s1">'first_name'</span><span class="p">);</span>
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">dbforge</span><span class="o">-&gt;</span><span class="nf">drop_column</span><span class="p">(</span><span class="s1">'users'</span><span class="p">,</span> <span class="s1">'last_name'</span><span class="p">);</span>
  <span class="p">}</span>

<span class="p">}</span>
</code></pre></div></div>

<p>As demonstrated by these two migration examples, switching between versions is incredibly simple.
This simplicity arises from the creation of well-thought-out methods for both applying (tear up) and reverting (tear down) migrations.
Reflecting on the migration ethos, I can certainly appreciate the benefits of managing schemas in this manner.</p>

</article>

            </main>

            <footer class="footer">
                <img src="https://www.gravatar.com/avatar/c5c2978bb14d16460f73399c394b6acd?s=160">
                <ul>
                    <li>Developer at <a href="http://www.mybuilder.com/">MyBuilder</a></li>
                    <li><a href="http://threedevsandamaybe.com/">Three Devs and a Maybe</a> podcast co-host</li>
                    <li>All ramblings can be found in the <a href="/archive/">Archive</a></li>
                </ul>
                <div class="cf"></div>
            </footer>
        </div>
    </body>
</html>
