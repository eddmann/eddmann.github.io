<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><title>Unlocking the AWS WAF Logs - Edd Mann</title>
<meta name=description content="Unlock AWS WAF logs easily using Serverless, Lambda and AWS SDK to gain deep insights into your web application firewall and enhance security."><meta name=author content="Edd Mann"><script async src="https://www.googletagmanager.com/gtag/js?id=G-ZPQ7WHNXH4"></script><script>var dnt,doNotTrack=!1;if(!1&&(dnt=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,doNotTrack=dnt=="1"||dnt=="yes"),!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-ZPQ7WHNXH4")}</script><meta itemprop=name content="Unlocking the AWS WAF Logs"><meta itemprop=description content="In this post we discuss our recent move to route all requests through CloudFront. This allows us to parse all traffic through the AWS Web Application Firewall (WAF). We highlight the reasoning behind this change, and some issues and remedies encountered when trying to garner concrete logs from the WAF instance."><meta itemprop=datePublished content="2018-01-12T00:00:00+00:00"><meta itemprop=dateModified content="2018-01-12T00:00:00+00:00"><meta itemprop=wordCount content="987"><meta itemprop=keywords content="Aws,Waf,Serverless,Security"><meta property="og:url" content="https://eddmann.com/posts/unlocking-the-aws-waf-logs/"><meta property="og:site_name" content="Edd Mann"><meta property="og:title" content="Unlocking the AWS WAF Logs"><meta property="og:description" content="In this post we discuss our recent move to route all requests through CloudFront. This allows us to parse all traffic through the AWS Web Application Firewall (WAF). We highlight the reasoning behind this change, and some issues and remedies encountered when trying to garner concrete logs from the WAF instance."><meta property="og:locale" content="en_GB"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2018-01-12T00:00:00+00:00"><meta property="article:modified_time" content="2018-01-12T00:00:00+00:00"><meta property="article:tag" content="Aws"><meta property="article:tag" content="Waf"><meta property="article:tag" content="Serverless"><meta property="article:tag" content="Security"><meta name=twitter:card content="summary"><meta name=twitter:title content="Unlocking the AWS WAF Logs"><meta name=twitter:description content="In this post we discuss our recent move to route all requests through CloudFront. This allows us to parse all traffic through the AWS Web Application Firewall (WAF). We highlight the reasoning behind this change, and some issues and remedies encountered when trying to garner concrete logs from the WAF instance."><meta name=twitter:site content="@edd_mann"><link rel="preload stylesheet" as=style href=/css/style.min.5fbaacecfa2bd7648bff91abf1d24a0fb8a2e53d9c8d53d6b3afa628c3b0f7f6.css integrity="sha256-X7qs7Por12SL/5Gr8dJKD7ii5T2cjVPWs6+mKMOw9/Y="><link rel=preload as=image href=/assets/x.svg><link rel=preload as=image href=/assets/github.svg><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=manifest href=/site.webmanifest><link rel=canonical href=https://eddmann.com/posts/unlocking-the-aws-waf-logs/></head><body><header class="site-header wrapper"><a href=https://eddmann.com/><h3 class=site-header__title>Edd Mann
<span style=--url:url(/assets/code.svg)>Developer</span></h3></a><div class=site-header__mobile-navigation-button aria-label="Toggle mobile site navigation" aria-expanded=false aria-controls=site-navigation></div><div class=site-header__navigation id=site-navigation><nav aria-label="Primary navigation"><ul class=site-header__primary-navigation><li><a href=/archive>Archive</a></li><li><a href=/projects>Projects</a></li><li><a href=/about>About</a></li></ul></nav><nav aria-label="Social links"><ul class=site-header__social-navigation><li><a class=social-icon style=--url:url(/assets/x.svg) href=https://x.com/edd_mann rel="external noopener" target=_blank>Twitter (X)</a></li><li><a class=social-icon style=--url:url(/assets/github.svg) href=https://github.com/eddmann rel="external noopener" target=_blank>GitHub</a></li></ul></nav></div></header><main class=wrapper><article><header class=page-title><h1>Unlocking the AWS WAF Logs</h1><time class=post__time>Jan 12, 2018</time></header><main class=prose><p>In this post we discuss our recent move to route all requests through <a href=https://aws.amazon.com/cloudfront/ rel="external noopener" target=_blank>CloudFront</a>.
This allows us to parse all traffic through the <a href=https://aws.amazon.com/waf/ rel="external noopener" target=_blank>AWS Web Application Firewall</a> (WAF).
We highlight the reasoning behind this change, and some issues and remedies encountered when trying to garner concrete logs from the WAF instance.</p><h2 id=dynamic-content-delivery>Dynamic Content Delivery</h2><p>Since moving our infrastructure fully to AWS, one of the first benefits we wished to take advantage of was <a href=https://aws.amazon.com/cloudfront/dynamic-content/ rel="external noopener" target=_blank>Dynamic Content Delivery</a> via CloudFront.
It may seem odd to route all requests through a CDN, but in doing so we have been able to unlock the following possibilities:</p><ul><li>Allow CloudFront to handle SSL/TLS termination.</li><li>HTTP/2 support out of the box.</li><li>Due to HTTP/2 being <a href=http://qnimate.com/what-is-multiplexing-in-http2/ rel="external noopener" target=_blank>fully multiplexed</a>, fine-grained path/query-string cache behaviours present in CloudFront are hugely beneficial.</li><li>Take advantage of CloudFront&rsquo;s many Edge locations, connecting the client to the nearest geographical point and then using Amazon&rsquo;s own infrastructure to route the requests to the EC2-hosted origin server(s).</li><li>Along with standard static assets that can be trivially cached, we are able to begin to experiment with caching whole pages, pushing simple dynamic content to the client (i.e. logged-in navigation states).</li><li>Instead of pushing the entire cached page to the client, we can also harness <a href=https://aws.amazon.com/lambda/edge/ rel="external noopener" target=_blank>Lambda@Edge</a> for small dynamic content changes at Edge locations.</li><li>Employ the <a href=https://aws.amazon.com/waf/ rel="external noopener" target=_blank>AWS WAF</a> on all client requests, providing another layer of security.</li></ul><h2 id=aws-web-application-firewall>AWS Web Application Firewall</h2><p>As you can see, there are many possibilities that this opens the door to.
In this post, however, I would like to focus on the last one.
Soon after shifting all our traffic to go through CloudFront, we wished to take advantage of the AWS WAF.
The benefits of deploying a WAF in front of your stack are succinctly presented in a <a href="https://www.youtube.com/watch?v=4liTK5MrTNo" rel="external noopener" target=_blank>short talk</a> from last year&rsquo;s re:Invent.</p><p>However, during development of this approach, we realised that obtaining meaningful logs from the product was harder than expected.
As of writing, AWS does not provide any easily accessible log stream to inspect how the WAF instance is reacting to requests.
The only noticeable indicator of a WAF rule blocking a request was the 403 HTTP response code that was generated and returned to the client.
This was a less-than-desirable metric to rely on, as we could get many false positives from genuine backend 403 responses, and we still did not know which rule triggered it.</p><p>We did not feel confident using such a feature without having more insight into how it was working.
We wished to be able to analyse the traffic patterns and determine which rules were being matched.</p><h2 id=unlocking-the-logs>Unlocking the Logs</h2><p>To remedy this, we decided to explore the AWS SDK and noticed that with a little work we could query the <a href=http://docs.aws.amazon.com/waf/latest/APIReference/API_GetSampledRequests.html rel="external noopener" target=_blank><code>GetSampledRequests</code></a> action at a scheduled interval and fetch any matches found, storing them for future use.
This would allow us to look at current and historical data about the WAF&rsquo;s actions.
A small caveat to how <code>GetSampledRequests</code> works, however, is that it only returns a sample (a maximum of 500) from among the first 5,000 requests that your resource receives during the specified time range.
Therefore, to ensure that we receive as many hits as have actually occurred, we must configure the scheduled invocation time according to our throughput.</p><p>I felt this was a great opportunity to work with the <a href=https://serverless.com/ rel="external noopener" target=_blank>Serverless Framework</a> again, and in doing so, created the <a href=https://github.com/mybuilder/aws-waf-logger rel="external noopener" target=_blank>aws-waf-logger</a> project.
Using the provided <code>env.yml.sample</code> as a template, it is very easy to configure the desired Web ACLs to monitor, the tracking frequency, and the S3 bucket in which to store the results.</p><p>The most interesting part of this project is the transformation of what <code>GetSampledRequests</code> returns into clear insight about the individual ACLs and rules we wish to track.
Using a composition of several Promises, the code below takes in the desired Web ACL identifier, along with a time frame based on the last time the Lambda was executed.
We then query for all the current rules that are applied to this Web ACL, and subsequently fetch these individual rule hits.
Once we have this data, we flatten the results into a single-dimensional array, which we then clean up by removing client-supplied headers.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#e6db74>&#39;use strict&#39;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>AWS</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>require</span>(<span style=color:#e6db74>&#39;aws-sdk&#39;</span>);
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>waf</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>AWS</span>.<span style=color:#a6e22e>WAF</span>();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> { <span style=color:#a6e22e>MAX_WAF_ITEMS</span> } <span style=color:#f92672>=</span> <span style=color:#a6e22e>process</span>.<span style=color:#a6e22e>env</span>; <span style=color:#75715e>// currently 500
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>getRuleIds</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>aclId</span> =&gt;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>new</span> Promise((<span style=color:#a6e22e>res</span>, <span style=color:#a6e22e>rej</span>) =&gt; {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>waf</span>.<span style=color:#a6e22e>getWebACL</span>({ <span style=color:#a6e22e>WebACLId</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>aclId</span> }, (<span style=color:#a6e22e>err</span>, <span style=color:#a6e22e>data</span>) =&gt; {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>err</span>) <span style=color:#a6e22e>rej</span>(<span style=color:#a6e22e>err</span>);
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>else</span> <span style=color:#a6e22e>res</span>(<span style=color:#a6e22e>data</span>.<span style=color:#a6e22e>WebACL</span>.<span style=color:#a6e22e>Rules</span>.<span style=color:#a6e22e>map</span>(<span style=color:#a6e22e>r</span> =&gt; <span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>RuleId</span>));
</span></span><span style=display:flex><span>    });
</span></span><span style=display:flex><span>  });
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>getRuleHits</span> <span style=color:#f92672>=</span> (<span style=color:#a6e22e>aclId</span>, <span style=color:#a6e22e>ruleId</span>, { <span style=color:#a6e22e>start</span>, <span style=color:#a6e22e>end</span> }) =&gt;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>new</span> Promise((<span style=color:#a6e22e>res</span>, <span style=color:#a6e22e>rej</span>) =&gt; {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>params</span> <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>MaxItems</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>MAX_WAF_ITEMS</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>RuleId</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>ruleId</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>TimeWindow</span><span style=color:#f92672>:</span> { <span style=color:#a6e22e>StartTime</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>start</span>, <span style=color:#a6e22e>EndTime</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>end</span> },
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>WebAclId</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>aclId</span>,
</span></span><span style=display:flex><span>    };
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>waf</span>.<span style=color:#a6e22e>getSampledRequests</span>(<span style=color:#a6e22e>params</span>, (<span style=color:#a6e22e>err</span>, <span style=color:#a6e22e>data</span>) =&gt; {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>err</span>) <span style=color:#a6e22e>rej</span>(<span style=color:#a6e22e>err</span>);
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>res</span>(
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>data</span>.<span style=color:#a6e22e>SampledRequests</span>.<span style=color:#a6e22e>reduce</span>((<span style=color:#a6e22e>acc</span>, <span style=color:#a6e22e>req</span>) =&gt; {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> [...<span style=color:#a6e22e>acc</span>, Object.<span style=color:#a6e22e>assign</span>(<span style=color:#a6e22e>req</span>, { <span style=color:#a6e22e>WebAclId</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>aclId</span>, <span style=color:#a6e22e>RuleId</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>ruleId</span> })];
</span></span><span style=display:flex><span>          }, [])
</span></span><span style=display:flex><span>        );
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>    });
</span></span><span style=display:flex><span>  });
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>normaliseHeaders</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>hit</span> =&gt; {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>hit</span>.<span style=color:#a6e22e>Request</span>.<span style=color:#a6e22e>Headers</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>hit</span>.<span style=color:#a6e22e>Request</span>.<span style=color:#a6e22e>Headers</span>.<span style=color:#a6e22e>reduce</span>((<span style=color:#a6e22e>headers</span>, { <span style=color:#a6e22e>Name</span>, <span style=color:#a6e22e>Value</span> }) =&gt; {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>headers</span>[<span style=color:#a6e22e>Name</span>.<span style=color:#a6e22e>toLowerCase</span>()] <span style=color:#f92672>=</span> <span style=color:#a6e22e>Value</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>headers</span>;
</span></span><span style=display:flex><span>  }, {});
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>hit</span>;
</span></span><span style=display:flex><span>};
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>flatten</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>arrs</span> =&gt; Array.<span style=color:#a6e22e>prototype</span>.<span style=color:#a6e22e>concat</span>.<span style=color:#a6e22e>apply</span>([], <span style=color:#a6e22e>arrs</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>module</span>.<span style=color:#a6e22e>exports</span>.<span style=color:#a6e22e>getWebAclHits</span> <span style=color:#f92672>=</span> (<span style=color:#a6e22e>aclId</span>, <span style=color:#a6e22e>timeRange</span>) =&gt;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>getRuleIds</span>(<span style=color:#a6e22e>aclId</span>)
</span></span><span style=display:flex><span>    .<span style=color:#a6e22e>then</span>(<span style=color:#a6e22e>ruleIds</span> =&gt; Promise.<span style=color:#a6e22e>all</span>(<span style=color:#a6e22e>ruleIds</span>.<span style=color:#a6e22e>map</span>(<span style=color:#a6e22e>ruleId</span> =&gt; <span style=color:#a6e22e>getRuleHits</span>(<span style=color:#a6e22e>aclId</span>, <span style=color:#a6e22e>ruleId</span>, <span style=color:#a6e22e>timeRange</span>))))
</span></span><span style=display:flex><span>    .<span style=color:#a6e22e>then</span>(<span style=color:#a6e22e>flatten</span>)
</span></span><span style=display:flex><span>    .<span style=color:#a6e22e>then</span>(<span style=color:#a6e22e>hits</span> =&gt; <span style=color:#a6e22e>hits</span>.<span style=color:#a6e22e>map</span>(<span style=color:#a6e22e>normaliseHeaders</span>));
</span></span></code></pre></div><p>We are then able to use this functionality to write the resulting listing to a file or a logging service of our choice.
Within the project, we have provided the ability to write the results to S3 and/or directly send the hits to <a href=https://www.loggly.com/ rel="external noopener" target=_blank>Loggly</a>.
Upon review, we could have possibly extracted the Loggly logic to make the project logger-agnostic, employing a decoupled S3 <code>ObjectCreated</code> event approach to send the hits instead.</p><h2 id=conclusion>Conclusion</h2><p>Since adding these logging capabilities, we have been able to clearly see which rules are being hit and in which context.
This allows us to feel more confident in the WAF product, removing the &lsquo;black-box&rsquo; fears that we previously had towards it.</p><p>If you have encountered this problem, perhaps the <a href=https://github.com/mybuilder/aws-waf-logger rel="external noopener" target=_blank>aws-waf-logger</a> we have created could help you!</p></main><footer class=post__tags><a href=/archive/tag/aws>aws</a><a href=/archive/tag/waf>waf</a><a href=/archive/tag/serverless>serverless</a><a href=/archive/tag/security>security</a></footer></article><div class=scroll-watcher></div></main><footer class="site-footer wrapper"><div>&copy; 2025, Edd Mann</div></footer><script>(function(){document.querySelector(".site-header__mobile-navigation-button").addEventListener("click",e=>{document.documentElement.classList.toggle("mobile-navigation-open"),e.target.setAttribute("aria-expanded",e.target.getAttribute("aria-expanded")==="false"?"true":"false")});const n=document.querySelector(".site-header");let t=window.pageYOffset,e=!1;window.addEventListener("scroll",()=>{if(e)return;setTimeout(()=>{const s=window.pageYOffset;n.classList.toggle("is-sticky",s>0&&t>s),t=s,e=!1},500),e=!0})})()</script></body></html>