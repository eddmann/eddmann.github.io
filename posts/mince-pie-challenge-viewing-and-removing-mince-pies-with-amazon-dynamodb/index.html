<!doctype html>
<html lang="en">
    <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="A comprehensive guide to viewing and removing mince pies using Amazon DynamoDB as part of the Mince Pie Challenge API.">

    <title>
        
            Mince Pie Challenge: Viewing and Removing Mince Pies with Amazon DynamoDB &middot; Edd Mann
        
    </title>

    <link rel="stylesheet" href="//fonts.googleapis.com/css?family=Source+Sans+Pro:400,700,700italic,400italic">
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <link rel="stylesheet" href="/styles.css">

    <link rel="shortcut icon" href="/favicon.ico">

    <link rel="alternate" href="/rss.xml" title="" type="application/rss+xml">

    

    <script>
        var _gaq=[['_setAccount','UA-32512081-1'],['_setDomainName','eddmann.com'],['_trackPageview']];
        (function() {
            var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
            ga.src = 'https://ssl.google-analytics.com/ga.js';
            var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
        })();
    </script>
</head>

    <body>
        <div class="container content">
            <header class="masthead">
                <h3 class="masthead-title">
                    <a href="/" title="Home">Edd Mann</a>
                    <small><i class="fa fa-code"></i> Developer</small>
                </h3>
                <nav>
                    <a href="https://twitter.com/edd_mann"><i class="fa fa-twitter"></i></a>
                    <a href="https://github.com/eddmann"><i class="fa fa-github"></i></a>
                    <a href="mailto:the@eddmann.com"><i class="fa fa-envelope"></i></a>
                </nav>
                <div class="cf"></div>
            </header>

            <main>
                <article class="post">
    <h1 class="post-title">Mince Pie Challenge: Viewing and Removing Mince Pies with Amazon DynamoDB</h1>
    <time datetime="2018-10-16T00:00:00+00:00" class="post-date">16 Oct 2018</time>
    <p>In this post we will progress in implementing the proposed endpoint behaviour documented in our <a href="https://eddmann.com/posts/mince-pie-challenge-designing-the-restful-api-with-raml/#viewing-the-pies">RAML design</a>.
Using the online/offline DynamoDB abstractions that we constructed in the <a href="https://eddmann.com/posts/mince-pie-challenge-adding-and-listing-mince-pies-with-amazon-dynamodb/">previous post</a>, we will incorporate the ability to view and remove specified mince pies from the challenge.</p>



<p>If you are keen to see how the finished example looks, you can access it within the <a href="https://github.com/eddmann/mince-pie-challenge-api-serverless/tree/07-view-remove-pies">API repository</a>.</p>

<h3 id="viewing-a-pie">Viewing a Pie</h3>

<p>We will begin by adding the ability to view a specified mince pie’s full details, along with any associated actions available based on the client’s request.
To start we will add the following new handler definition to <code class="language-plaintext highlighter-rouge">functions.yml</code>.</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">view-pie</span><span class="pi">:</span>
  <span class="na">handler</span><span class="pi">:</span> <span class="s">src/view.handler</span>
  <span class="na">events</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">http</span><span class="pi">:</span>
        <span class="na">path</span><span class="pi">:</span> <span class="s">/pies/{id}</span>
        <span class="na">method</span><span class="pi">:</span> <span class="s">get</span>
        <span class="na">cors</span><span class="pi">:</span> <span class="no">true</span>
</code></pre></div></div>

<p>From here, we will create the concrete handler (<code class="language-plaintext highlighter-rouge">src/view.js</code>) which will be called upon each request.</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// @flow</span>

<span class="k">import</span> <span class="nx">view</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">./handlers/view</span><span class="dl">'</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span> <span class="nx">getPie</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">db</span><span class="dl">'</span><span class="p">;</span>
<span class="k">import</span> <span class="nx">createUserTokenAuthenticator</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">userTokenAuthenticator</span><span class="dl">'</span><span class="p">;</span>

<span class="kd">const</span> <span class="p">{</span> <span class="nx">TABLE_NAME</span><span class="p">,</span> <span class="nx">USER_POOL_ID</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">;</span>

<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">TABLE_NAME</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="dl">'</span><span class="s1">TABLE_NAME is not present</span><span class="dl">'</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">USER_POOL_ID</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="dl">'</span><span class="s1">USER_POOL_ID is not present</span><span class="dl">'</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">export</span> <span class="kd">const</span> <span class="nx">handler</span> <span class="o">=</span> <span class="nx">view</span><span class="p">({</span>
  <span class="na">getUserIdFromToken</span><span class="p">:</span> <span class="nx">createUserTokenAuthenticator</span><span class="p">(</span><span class="nx">USER_POOL_ID</span><span class="p">),</span>
  <span class="na">getPie</span><span class="p">:</span> <span class="nx">getPie</span><span class="p">(</span><span class="nx">TABLE_NAME</span><span class="p">),</span>
<span class="p">});</span>
</code></pre></div></div>

<p>This concrete handler passes the <code class="language-plaintext highlighter-rouge">getPie</code> service to the internal handler so as to correctly fetch the desired mince pie.
We will add this ability to both the <code class="language-plaintext highlighter-rouge">src/services/dynamoDBPieStore.js</code> and <code class="language-plaintext highlighter-rouge">src/services/localDynamoDBPieStore.js</code> implementations.</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="nx">type</span> <span class="p">{</span> <span class="nx">Pie</span><span class="p">,</span> <span class="nx">UUID</span><span class="p">,</span> <span class="nx">UserId</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">../types</span><span class="dl">'</span><span class="p">;</span>

<span class="k">export</span> <span class="kd">const</span> <span class="nx">getPie</span> <span class="o">=</span>
  <span class="p">(</span><span class="nx">tableName</span><span class="p">:</span> <span class="nx">string</span><span class="p">)</span> <span class="o">=&gt;</span>
  <span class="p">(</span><span class="nx">id</span><span class="p">:</span> <span class="nx">UUID</span><span class="p">):</span> <span class="nb">Promise</span><span class="o">&lt;</span><span class="nx">Pie</span><span class="o">&gt;</span> <span class="o">=&gt;</span>
    <span class="k">new</span> <span class="nx">AWS</span><span class="p">.</span><span class="nx">DynamoDB</span><span class="p">.</span><span class="nx">DocumentClient</span><span class="p">()</span>
      <span class="p">.</span><span class="kd">get</span><span class="p">({</span> <span class="na">TableName</span><span class="p">:</span> <span class="nx">tableName</span><span class="p">,</span> <span class="na">Key</span><span class="p">:</span> <span class="p">{</span> <span class="na">Id</span><span class="p">:</span> <span class="nx">id</span> <span class="p">}</span> <span class="p">})</span>
      <span class="p">.</span><span class="nx">promise</span><span class="p">()</span>
      <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">r</span> <span class="o">=&gt;</span> <span class="nx">r</span><span class="p">.</span><span class="nx">Item</span><span class="p">);</span>
</code></pre></div></div>

<p>You will notice that we use the <code class="language-plaintext highlighter-rouge">UUID</code> type which was previously internal to the <code class="language-plaintext highlighter-rouge">src/types/index.js</code> definition.
This will need to be exposed for external consumption like so, <code class="language-plaintext highlighter-rouge">export type UUID = string;</code>.</p>

<p>The next step is to implement the internal handler (<code class="language-plaintext highlighter-rouge">src/handlers/view.js</code>) which will be called to fetch the pie and generate the API response.</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// @flow</span>

<span class="k">import</span> <span class="nx">type</span> <span class="p">{</span> <span class="nx">UserId</span><span class="p">,</span> <span class="nx">Pie</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">../types</span><span class="dl">'</span><span class="p">;</span>

<span class="k">import</span> <span class="p">{</span> <span class="nx">notFound</span><span class="p">,</span> <span class="nx">ok</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">../helpers/http</span><span class="dl">'</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span> <span class="nx">createHandler</span><span class="p">,</span> <span class="nx">withOptionalHttpAuthentication</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">../helpers/handlers</span><span class="dl">'</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span> <span class="nx">Resource</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">hal</span><span class="dl">'</span><span class="p">;</span>

<span class="kd">const</span> <span class="nx">hasNotRated</span> <span class="o">=</span> <span class="p">(</span><span class="nx">userId</span><span class="p">:</span> <span class="p">?</span><span class="nx">UserId</span><span class="p">,</span> <span class="nx">pie</span><span class="p">:</span> <span class="nx">Pie</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">userId</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">pie</span><span class="p">.</span><span class="nx">Ratings</span><span class="p">[</span><span class="nx">userId</span><span class="p">];</span>
<span class="kd">const</span> <span class="nx">isOwner</span> <span class="o">=</span> <span class="p">(</span><span class="nx">userId</span><span class="p">:</span> <span class="p">?</span><span class="nx">UserId</span><span class="p">,</span> <span class="nx">pie</span><span class="p">:</span> <span class="nx">Pie</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">userId</span> <span class="o">&amp;&amp;</span> <span class="nx">userId</span> <span class="o">===</span> <span class="nx">pie</span><span class="p">.</span><span class="nx">UserId</span><span class="p">;</span>
<span class="kd">const</span> <span class="nx">isAbleToUploadPhoto</span> <span class="o">=</span> <span class="p">(</span><span class="nx">userId</span><span class="p">:</span> <span class="p">?</span><span class="nx">UserId</span><span class="p">,</span> <span class="nx">pie</span><span class="p">:</span> <span class="nx">Pie</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">isOwner</span><span class="p">(</span><span class="nx">userId</span><span class="p">,</span> <span class="nx">pie</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">pie</span><span class="p">.</span><span class="nx">PhotoUrl</span><span class="p">;</span>

<span class="kd">const</span> <span class="nx">view</span> <span class="o">=</span> <span class="k">async</span> <span class="p">({</span> <span class="nx">event</span><span class="p">,</span> <span class="nx">userId</span><span class="p">,</span> <span class="na">services</span><span class="p">:</span> <span class="p">{</span> <span class="nx">getPie</span> <span class="p">}</span> <span class="p">})</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="p">{</span> <span class="nx">id</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">event</span><span class="p">.</span><span class="nx">pathParameters</span> <span class="o">||</span> <span class="p">{};</span>

  <span class="kd">const</span> <span class="nx">pie</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">getPie</span><span class="p">(</span><span class="nx">id</span><span class="p">);</span>

  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">pie</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">notFound</span><span class="p">(</span><span class="dl">'</span><span class="s1">Unable to find the specified mince pie.</span><span class="dl">'</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="kd">const</span> <span class="nx">resource</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Resource</span><span class="p">(</span>
    <span class="p">{</span>
      <span class="na">id</span><span class="p">:</span> <span class="nx">pie</span><span class="p">.</span><span class="nx">Id</span><span class="p">,</span>
      <span class="na">name</span><span class="p">:</span> <span class="nx">pie</span><span class="p">.</span><span class="nx">Name</span><span class="p">,</span>
      <span class="na">rating</span><span class="p">:</span> <span class="p">{</span> <span class="na">avg</span><span class="p">:</span> <span class="nx">pie</span><span class="p">.</span><span class="nx">AvgRating</span><span class="p">,</span> <span class="na">total</span><span class="p">:</span> <span class="nx">pie</span><span class="p">.</span><span class="nx">TotalRatings</span> <span class="p">},</span>
      <span class="na">photo</span><span class="p">:</span> <span class="nx">pie</span><span class="p">.</span><span class="nx">PhotoUrl</span><span class="p">,</span>
      <span class="na">thumbnail</span><span class="p">:</span> <span class="nx">pie</span><span class="p">.</span><span class="nx">ThumbnailUrl</span><span class="p">,</span>
      <span class="na">addedAt</span><span class="p">:</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">(</span><span class="nx">pie</span><span class="p">.</span><span class="nx">AddedAt</span><span class="p">).</span><span class="nx">toISOString</span><span class="p">(),</span>
    <span class="p">},</span>
    <span class="s2">`/pies/</span><span class="p">${</span><span class="nx">pie</span><span class="p">.</span><span class="nx">Id</span><span class="p">}</span><span class="s2">`</span>
  <span class="p">);</span>

  <span class="k">if</span> <span class="p">(</span><span class="nx">hasNotRated</span><span class="p">(</span><span class="nx">userId</span><span class="p">,</span> <span class="nx">pie</span><span class="p">))</span> <span class="nx">resource</span><span class="p">.</span><span class="nx">link</span><span class="p">(</span><span class="dl">'</span><span class="s1">rate</span><span class="dl">'</span><span class="p">,</span> <span class="s2">`/pies/</span><span class="p">${</span><span class="nx">pie</span><span class="p">.</span><span class="nx">Id</span><span class="p">}</span><span class="s2">/rate`</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">isOwner</span><span class="p">(</span><span class="nx">userId</span><span class="p">,</span> <span class="nx">pie</span><span class="p">))</span> <span class="nx">resource</span><span class="p">.</span><span class="nx">link</span><span class="p">(</span><span class="dl">'</span><span class="s1">remove</span><span class="dl">'</span><span class="p">,</span> <span class="s2">`/pies/</span><span class="p">${</span><span class="nx">pie</span><span class="p">.</span><span class="nx">Id</span><span class="p">}</span><span class="s2">`</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">isAbleToUploadPhoto</span><span class="p">(</span><span class="nx">userId</span><span class="p">,</span> <span class="nx">pie</span><span class="p">))</span> <span class="nx">resource</span><span class="p">.</span><span class="nx">link</span><span class="p">(</span><span class="dl">'</span><span class="s1">photo</span><span class="dl">'</span><span class="p">,</span> <span class="s2">`/pies/</span><span class="p">${</span><span class="nx">pie</span><span class="p">.</span><span class="nx">Id</span><span class="p">}</span><span class="s2">/photo`</span><span class="p">);</span>

  <span class="k">return</span> <span class="nx">ok</span><span class="p">(</span><span class="nx">resource</span><span class="p">);</span>
<span class="p">};</span>

<span class="k">export</span> <span class="k">default</span> <span class="nx">createHandler</span><span class="p">(</span><span class="nx">withOptionalHttpAuthentication</span><span class="p">(</span><span class="nx">view</span><span class="p">));</span>
</code></pre></div></div>

<p>This endpoint will return different actions based on the context in which the client makes the request.
For example, if the client is deemed to be the owner of this resource we will provide the action to remove the pie, and attach a photo (if one is not already present).
If the authenticated client has not yet rated this pie, we will return the action to fulfil this request as well.
Finally, if the request comes from an unauthenticated client we will omit any user specific actions, and simply return the pie details.</p>

<p>Now we are able to specify a particular pie within the request, we have to cater for the event that the supplied identifier may not correspond to a pie within the challenge.
For this, we need to add an additional response to the helpers within <code class="language-plaintext highlighter-rouge">src/helpers/http.js</code>.</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">export</span> <span class="kd">const</span> <span class="nx">notFound</span> <span class="o">=</span> <span class="p">(</span><span class="nx">detail</span><span class="p">:</span> <span class="nx">string</span><span class="p">):</span> <span class="nx">Response</span> <span class="o">=&gt;</span> <span class="p">({</span>
  <span class="na">statusCode</span><span class="p">:</span> <span class="mi">404</span><span class="p">,</span>
  <span class="na">headers</span><span class="p">:</span> <span class="p">{</span>
    <span class="dl">'</span><span class="s1">Access-Control-Allow-Origin</span><span class="dl">'</span><span class="p">:</span> <span class="dl">'</span><span class="s1">*</span><span class="dl">'</span><span class="p">,</span>
    <span class="dl">'</span><span class="s1">Access-Control-Allow-Credentials</span><span class="dl">'</span><span class="p">:</span> <span class="dl">'</span><span class="s1">*</span><span class="dl">'</span><span class="p">,</span>
    <span class="dl">'</span><span class="s1">Content-Type</span><span class="dl">'</span><span class="p">:</span> <span class="dl">'</span><span class="s1">application/problem+json</span><span class="dl">'</span><span class="p">,</span>
  <span class="p">},</span>
  <span class="na">body</span><span class="p">:</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">({</span> <span class="na">title</span><span class="p">:</span> <span class="dl">'</span><span class="s1">Not Found</span><span class="dl">'</span><span class="p">,</span> <span class="nx">detail</span> <span class="p">}),</span>
<span class="p">});</span>
</code></pre></div></div>

<p>Now that we have built up the functionality, it is time to exercise that the behaviour works as intended.
To do this we will produce test cases (<code class="language-plaintext highlighter-rouge">src/__tests__/view.js</code>) for each type of behaviour that we expect to observe from the resource.</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="nx">handler</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">../handlers/view</span><span class="dl">'</span><span class="p">;</span>

<span class="kd">const</span> <span class="nx">createPie</span> <span class="o">=</span> <span class="nx">custom</span> <span class="o">=&gt;</span> <span class="p">({</span>
  <span class="na">Id</span><span class="p">:</span> <span class="dl">'</span><span class="s1">1</span><span class="dl">'</span><span class="p">,</span>
  <span class="na">UserId</span><span class="p">:</span> <span class="dl">'</span><span class="s1">USER_ID</span><span class="dl">'</span><span class="p">,</span>
  <span class="na">Name</span><span class="p">:</span> <span class="dl">'</span><span class="s1">Sample Mince Pie</span><span class="dl">'</span><span class="p">,</span>
  <span class="na">AvgRating</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
  <span class="na">TotalRatings</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
  <span class="na">Ratings</span><span class="p">:</span> <span class="p">{},</span>
  <span class="na">PhotoUrl</span><span class="p">:</span> <span class="dl">'</span><span class="s1">http://photo.url</span><span class="dl">'</span><span class="p">,</span>
  <span class="na">ThumbnailUrl</span><span class="p">:</span> <span class="dl">'</span><span class="s1">http://thumbnail.url</span><span class="dl">'</span><span class="p">,</span>
  <span class="na">AddedAt</span><span class="p">:</span> <span class="mi">1528217691</span><span class="p">,</span>
  <span class="p">...</span><span class="nx">custom</span><span class="p">,</span>
<span class="p">});</span>

<span class="nx">it</span><span class="p">(</span><span class="dl">'</span><span class="s1">displays a users pie</span><span class="dl">'</span><span class="p">,</span> <span class="k">async</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="nx">pie</span> <span class="o">=</span> <span class="nx">createPie</span><span class="p">({</span> <span class="na">UserId</span><span class="p">:</span> <span class="dl">'</span><span class="s1">ANOTHER_USER_ID</span><span class="dl">'</span> <span class="p">});</span>

  <span class="kd">const</span> <span class="nx">services</span> <span class="o">=</span> <span class="p">{</span>
    <span class="na">getUserIdFromToken</span><span class="p">:</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="nb">Promise</span><span class="p">.</span><span class="nx">resolve</span><span class="p">(),</span>
    <span class="na">getPie</span><span class="p">:</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="nb">Promise</span><span class="p">.</span><span class="nx">resolve</span><span class="p">(</span><span class="nx">pie</span><span class="p">),</span>
  <span class="p">};</span>

  <span class="kd">const</span> <span class="nx">response</span> <span class="o">=</span> <span class="nx">parseResponse</span><span class="p">(</span><span class="k">await</span> <span class="nx">handler</span><span class="p">(</span><span class="nx">services</span><span class="p">)({</span> <span class="na">headers</span><span class="p">:</span> <span class="p">{}</span> <span class="p">},</span> <span class="p">{}));</span>

  <span class="nx">expect</span><span class="p">(</span><span class="nx">response</span><span class="p">.</span><span class="nx">statusCode</span><span class="p">).</span><span class="nx">toBe</span><span class="p">(</span><span class="mi">200</span><span class="p">);</span>
  <span class="nx">expect</span><span class="p">(</span><span class="nx">response</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">name</span><span class="p">).</span><span class="nx">toBe</span><span class="p">(</span><span class="dl">'</span><span class="s1">Sample Mince Pie</span><span class="dl">'</span><span class="p">);</span>
  <span class="nx">expect</span><span class="p">(</span><span class="nx">response</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">_links</span><span class="p">).</span><span class="nx">not</span><span class="p">.</span><span class="nx">toHaveProperty</span><span class="p">(</span><span class="dl">'</span><span class="s1">remove</span><span class="dl">'</span><span class="p">);</span>
  <span class="nx">expect</span><span class="p">(</span><span class="nx">response</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">_links</span><span class="p">).</span><span class="nx">not</span><span class="p">.</span><span class="nx">toHaveProperty</span><span class="p">(</span><span class="dl">'</span><span class="s1">rate</span><span class="dl">'</span><span class="p">);</span>
  <span class="nx">expect</span><span class="p">(</span><span class="nx">response</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">_links</span><span class="p">).</span><span class="nx">not</span><span class="p">.</span><span class="nx">toHaveProperty</span><span class="p">(</span><span class="dl">'</span><span class="s1">photo</span><span class="dl">'</span><span class="p">);</span>
<span class="p">});</span>

<span class="nx">it</span><span class="p">(</span><span class="dl">'</span><span class="s1">displays the photo action when no photo is present for your pie</span><span class="dl">'</span><span class="p">,</span> <span class="k">async</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="nx">pie</span> <span class="o">=</span> <span class="nx">createPie</span><span class="p">({</span> <span class="na">PhotoUrl</span><span class="p">:</span> <span class="kc">undefined</span><span class="p">,</span> <span class="na">ThumbnailUrl</span><span class="p">:</span> <span class="kc">undefined</span> <span class="p">});</span>

  <span class="kd">const</span> <span class="nx">services</span> <span class="o">=</span> <span class="p">{</span>
    <span class="na">getUserIdFromToken</span><span class="p">:</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="nb">Promise</span><span class="p">.</span><span class="nx">resolve</span><span class="p">(</span><span class="dl">'</span><span class="s1">USER_ID</span><span class="dl">'</span><span class="p">),</span>
    <span class="na">getPie</span><span class="p">:</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="nb">Promise</span><span class="p">.</span><span class="nx">resolve</span><span class="p">(</span><span class="nx">pie</span><span class="p">),</span>
  <span class="p">};</span>

  <span class="kd">const</span> <span class="nx">response</span> <span class="o">=</span> <span class="nx">parseResponse</span><span class="p">(</span>
    <span class="k">await</span> <span class="nx">handler</span><span class="p">(</span><span class="nx">services</span><span class="p">)({</span> <span class="na">headers</span><span class="p">:</span> <span class="p">{</span> <span class="na">Authorization</span><span class="p">:</span> <span class="dl">'</span><span class="s1">TOKEN</span><span class="dl">'</span> <span class="p">}</span> <span class="p">},</span> <span class="p">{})</span>
  <span class="p">);</span>

  <span class="nx">expect</span><span class="p">(</span><span class="nx">response</span><span class="p">.</span><span class="nx">statusCode</span><span class="p">).</span><span class="nx">toBe</span><span class="p">(</span><span class="mi">200</span><span class="p">);</span>
  <span class="nx">expect</span><span class="p">(</span><span class="nx">response</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">_links</span><span class="p">).</span><span class="nx">toHaveProperty</span><span class="p">(</span><span class="dl">'</span><span class="s1">photo</span><span class="dl">'</span><span class="p">);</span>
<span class="p">});</span>

<span class="nx">it</span><span class="p">(</span><span class="dl">'</span><span class="s1">displays the remove action when viewing your own pie</span><span class="dl">'</span><span class="p">,</span> <span class="k">async</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="nx">pie</span> <span class="o">=</span> <span class="nx">createPie</span><span class="p">({});</span>

  <span class="kd">const</span> <span class="nx">services</span> <span class="o">=</span> <span class="p">{</span>
    <span class="na">getUserIdFromToken</span><span class="p">:</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="nb">Promise</span><span class="p">.</span><span class="nx">resolve</span><span class="p">(</span><span class="dl">'</span><span class="s1">USER_ID</span><span class="dl">'</span><span class="p">),</span>
    <span class="na">getPie</span><span class="p">:</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="nb">Promise</span><span class="p">.</span><span class="nx">resolve</span><span class="p">(</span><span class="nx">pie</span><span class="p">),</span>
  <span class="p">};</span>

  <span class="kd">const</span> <span class="nx">response</span> <span class="o">=</span> <span class="nx">parseResponse</span><span class="p">(</span>
    <span class="k">await</span> <span class="nx">handler</span><span class="p">(</span><span class="nx">services</span><span class="p">)({</span> <span class="na">headers</span><span class="p">:</span> <span class="p">{</span> <span class="na">Authorization</span><span class="p">:</span> <span class="dl">'</span><span class="s1">TOKEN</span><span class="dl">'</span> <span class="p">}</span> <span class="p">},</span> <span class="p">{})</span>
  <span class="p">);</span>

  <span class="nx">expect</span><span class="p">(</span><span class="nx">response</span><span class="p">.</span><span class="nx">statusCode</span><span class="p">).</span><span class="nx">toBe</span><span class="p">(</span><span class="mi">200</span><span class="p">);</span>
  <span class="nx">expect</span><span class="p">(</span><span class="nx">response</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">_links</span><span class="p">).</span><span class="nx">toHaveProperty</span><span class="p">(</span><span class="dl">'</span><span class="s1">remove</span><span class="dl">'</span><span class="p">);</span>
<span class="p">});</span>

<span class="nx">it</span><span class="p">(</span><span class="dl">'</span><span class="s1">displays the rate action when we have not yet rated the pie</span><span class="dl">'</span><span class="p">,</span> <span class="k">async</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="nx">pie</span> <span class="o">=</span> <span class="nx">createPie</span><span class="p">({});</span>

  <span class="kd">const</span> <span class="nx">services</span> <span class="o">=</span> <span class="p">{</span>
    <span class="na">getUserIdFromToken</span><span class="p">:</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="nb">Promise</span><span class="p">.</span><span class="nx">resolve</span><span class="p">(</span><span class="dl">'</span><span class="s1">USER_ID</span><span class="dl">'</span><span class="p">),</span>
    <span class="na">getPie</span><span class="p">:</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="nb">Promise</span><span class="p">.</span><span class="nx">resolve</span><span class="p">(</span><span class="nx">pie</span><span class="p">),</span>
  <span class="p">};</span>

  <span class="kd">const</span> <span class="nx">response</span> <span class="o">=</span> <span class="nx">parseResponse</span><span class="p">(</span>
    <span class="k">await</span> <span class="nx">handler</span><span class="p">(</span><span class="nx">services</span><span class="p">)({</span> <span class="na">headers</span><span class="p">:</span> <span class="p">{</span> <span class="na">Authorization</span><span class="p">:</span> <span class="dl">'</span><span class="s1">TOKEN</span><span class="dl">'</span> <span class="p">}</span> <span class="p">},</span> <span class="p">{})</span>
  <span class="p">);</span>

  <span class="nx">expect</span><span class="p">(</span><span class="nx">response</span><span class="p">.</span><span class="nx">statusCode</span><span class="p">).</span><span class="nx">toBe</span><span class="p">(</span><span class="mi">200</span><span class="p">);</span>
  <span class="nx">expect</span><span class="p">(</span><span class="nx">response</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">_links</span><span class="p">).</span><span class="nx">toHaveProperty</span><span class="p">(</span><span class="dl">'</span><span class="s1">rate</span><span class="dl">'</span><span class="p">);</span>
<span class="p">});</span>

<span class="nx">it</span><span class="p">(</span><span class="dl">'</span><span class="s1">does not display the rate action when we have rated the pie</span><span class="dl">'</span><span class="p">,</span> <span class="k">async</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="nx">pie</span> <span class="o">=</span> <span class="nx">createPie</span><span class="p">({</span> <span class="na">Ratings</span><span class="p">:</span> <span class="p">{</span> <span class="na">USER_ID</span><span class="p">:</span> <span class="mi">3</span> <span class="p">},</span> <span class="na">AvgRating</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span> <span class="na">TotalRatings</span><span class="p">:</span> <span class="mi">1</span> <span class="p">});</span>

  <span class="kd">const</span> <span class="nx">services</span> <span class="o">=</span> <span class="p">{</span>
    <span class="na">getUserIdFromToken</span><span class="p">:</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="nb">Promise</span><span class="p">.</span><span class="nx">resolve</span><span class="p">(</span><span class="dl">'</span><span class="s1">USER_ID</span><span class="dl">'</span><span class="p">),</span>
    <span class="na">getPie</span><span class="p">:</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="nb">Promise</span><span class="p">.</span><span class="nx">resolve</span><span class="p">(</span><span class="nx">pie</span><span class="p">),</span>
  <span class="p">};</span>

  <span class="kd">const</span> <span class="nx">response</span> <span class="o">=</span> <span class="nx">parseResponse</span><span class="p">(</span>
    <span class="k">await</span> <span class="nx">handler</span><span class="p">(</span><span class="nx">services</span><span class="p">)({</span> <span class="na">headers</span><span class="p">:</span> <span class="p">{</span> <span class="na">Authorization</span><span class="p">:</span> <span class="dl">'</span><span class="s1">TOKEN</span><span class="dl">'</span> <span class="p">}</span> <span class="p">},</span> <span class="p">{})</span>
  <span class="p">);</span>

  <span class="nx">expect</span><span class="p">(</span><span class="nx">response</span><span class="p">.</span><span class="nx">statusCode</span><span class="p">).</span><span class="nx">toBe</span><span class="p">(</span><span class="mi">200</span><span class="p">);</span>
  <span class="nx">expect</span><span class="p">(</span><span class="nx">response</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">_links</span><span class="p">).</span><span class="nx">not</span><span class="p">.</span><span class="nx">toHaveProperty</span><span class="p">(</span><span class="dl">'</span><span class="s1">rate</span><span class="dl">'</span><span class="p">);</span>
<span class="p">});</span>
</code></pre></div></div>

<p>These test cases highlight how the actions returned back to the client can be different based on the given context.
We have decided to extract out creating a pie <a href="https://blog.pragmatists.com/test-doubles-fakes-mocks-and-stubs-1a7491dfa3da#5334">stub</a> into a smaller helper function.
This function provides us with the ability to supply custom attributes that we wish to override the default properties with, per use-case.</p>

<p>With the ability to access a specified pie now available, we will follow this with work on one of the supplied owner actions - removing a pie from the challenge.</p>

<h3 id="removing-a-pie">Removing a Pie</h3>

<p>In a similar manner to how we constructed the viewing capabilities, we will start off by defining a new handler within <code class="language-plaintext highlighter-rouge">functions.yml</code> which is called upon a <code class="language-plaintext highlighter-rouge">DELETE</code> request.</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">remove-pie</span><span class="pi">:</span>
  <span class="na">handler</span><span class="pi">:</span> <span class="s">src/remove.handler</span>
  <span class="na">events</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">http</span><span class="pi">:</span>
        <span class="na">path</span><span class="pi">:</span> <span class="s">/pies/{id}</span>
        <span class="na">method</span><span class="pi">:</span> <span class="s">delete</span>
</code></pre></div></div>

<p>We will now implement the concrete handler within <code class="language-plaintext highlighter-rouge">src/remove.js</code>, which will be called by each client request.</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// @flow</span>

<span class="k">import</span> <span class="nx">remove</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">./handlers/remove</span><span class="dl">'</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span> <span class="nx">getPie</span><span class="p">,</span> <span class="nx">removePie</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">db</span><span class="dl">'</span><span class="p">;</span>
<span class="k">import</span> <span class="nx">createUserTokenAuthenticator</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">userTokenAuthenticator</span><span class="dl">'</span><span class="p">;</span>

<span class="kd">const</span> <span class="p">{</span> <span class="nx">TABLE_NAME</span><span class="p">,</span> <span class="nx">USER_POOL_ID</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">;</span>

<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">TABLE_NAME</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="dl">'</span><span class="s1">TABLE_NAME is not present</span><span class="dl">'</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">USER_POOL_ID</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="dl">'</span><span class="s1">USER_POOL_ID is not present</span><span class="dl">'</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">export</span> <span class="kd">const</span> <span class="nx">handler</span> <span class="o">=</span> <span class="nx">remove</span><span class="p">({</span>
  <span class="na">getUserIdFromToken</span><span class="p">:</span> <span class="nx">createUserTokenAuthenticator</span><span class="p">(</span><span class="nx">USER_POOL_ID</span><span class="p">),</span>
  <span class="na">getPie</span><span class="p">:</span> <span class="nx">getPie</span><span class="p">(</span><span class="nx">TABLE_NAME</span><span class="p">),</span>
  <span class="na">removePie</span><span class="p">:</span> <span class="nx">removePie</span><span class="p">(</span><span class="nx">TABLE_NAME</span><span class="p">),</span>
<span class="p">});</span>
</code></pre></div></div>

<p>The internal handler that is used within this request uses the previously created <code class="language-plaintext highlighter-rouge">getPie</code> service, along with a new <code class="language-plaintext highlighter-rouge">removePie</code> service.
We will add this capability to both the <code class="language-plaintext highlighter-rouge">src/services/dynamoDBPieStore.js</code> and <code class="language-plaintext highlighter-rouge">src/services/localDynamoDBPieStore.js</code> implementations.</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">export</span> <span class="kd">const</span> <span class="nx">removePie</span> <span class="o">=</span>
  <span class="p">(</span><span class="nx">tableName</span><span class="p">:</span> <span class="nx">string</span><span class="p">)</span> <span class="o">=&gt;</span>
  <span class="p">(</span><span class="nx">id</span><span class="p">:</span> <span class="nx">UUID</span><span class="p">):</span> <span class="nb">Promise</span><span class="o">&lt;</span><span class="k">void</span><span class="o">&gt;</span> <span class="o">=&gt;</span>
    <span class="k">new</span> <span class="nx">AWS</span><span class="p">.</span><span class="nx">DynamoDB</span><span class="p">.</span><span class="nx">DocumentClient</span><span class="p">().</span><span class="k">delete</span><span class="p">({</span> <span class="na">TableName</span><span class="p">:</span> <span class="nx">tableName</span><span class="p">,</span> <span class="na">Key</span><span class="p">:</span> <span class="p">{</span> <span class="na">Id</span><span class="p">:</span> <span class="nx">id</span> <span class="p">}</span> <span class="p">}).</span><span class="nx">promise</span><span class="p">();</span>
</code></pre></div></div>

<p>With this now in place we can create the internal handler (<code class="language-plaintext highlighter-rouge">src/handlers/remove.js</code>) that will be called to remove the specified pie resource.</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// @flow</span>

<span class="k">import</span> <span class="nx">type</span> <span class="p">{</span> <span class="nx">UserId</span><span class="p">,</span> <span class="nx">Pie</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">../types</span><span class="dl">'</span><span class="p">;</span>

<span class="k">import</span> <span class="p">{</span> <span class="nx">notFound</span><span class="p">,</span> <span class="nx">forbidden</span><span class="p">,</span> <span class="nx">noContent</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">../helpers/http</span><span class="dl">'</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span> <span class="nx">createHandler</span><span class="p">,</span> <span class="nx">withStrictHttpAuthentication</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">../helpers/handlers</span><span class="dl">'</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span> <span class="nx">Resource</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">hal</span><span class="dl">'</span><span class="p">;</span>

<span class="kd">const</span> <span class="nx">isOwner</span> <span class="o">=</span> <span class="p">(</span><span class="nx">userId</span><span class="p">:</span> <span class="nx">UserId</span><span class="p">,</span> <span class="nx">pie</span><span class="p">:</span> <span class="nx">Pie</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">userId</span> <span class="o">===</span> <span class="nx">pie</span><span class="p">.</span><span class="nx">UserId</span><span class="p">;</span>

<span class="kd">const</span> <span class="nx">remove</span> <span class="o">=</span> <span class="k">async</span> <span class="p">({</span> <span class="nx">event</span><span class="p">,</span> <span class="nx">userId</span><span class="p">,</span> <span class="na">services</span><span class="p">:</span> <span class="p">{</span> <span class="nx">getPie</span><span class="p">,</span> <span class="nx">removePie</span> <span class="p">}</span> <span class="p">})</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="p">{</span> <span class="nx">id</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">event</span><span class="p">.</span><span class="nx">pathParameters</span> <span class="o">||</span> <span class="p">{};</span>

  <span class="kd">const</span> <span class="nx">pie</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">getPie</span><span class="p">(</span><span class="nx">id</span><span class="p">);</span>

  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">pie</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">notFound</span><span class="p">(</span><span class="dl">'</span><span class="s1">Unable to find the specified mince pie.</span><span class="dl">'</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">isOwner</span><span class="p">(</span><span class="nx">userId</span><span class="p">,</span> <span class="nx">pie</span><span class="p">))</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">forbidden</span><span class="p">(</span><span class="dl">'</span><span class="s1">This mince pie does not belong to you.</span><span class="dl">'</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="k">await</span> <span class="nx">removePie</span><span class="p">(</span><span class="nx">pie</span><span class="p">.</span><span class="nx">Id</span><span class="p">);</span>

  <span class="k">return</span> <span class="nx">noContent</span><span class="p">();</span>
<span class="p">};</span>

<span class="k">export</span> <span class="k">default</span> <span class="nx">createHandler</span><span class="p">(</span><span class="nx">withStrictHttpAuthentication</span><span class="p">(</span><span class="nx">remove</span><span class="p">));</span>
</code></pre></div></div>

<p>We first ensure that the desired pie exists and is owned by the requesting client.
If this is the case, we will remove the pie and return a successful <code class="language-plaintext highlighter-rouge">204 No Content</code> response.
However, if the requesting client is not deemed to be the owner of the pie we will reject this action and return a <code class="language-plaintext highlighter-rouge">403 Forbidden</code> response.
Both of these responses will now need to be added to <code class="language-plaintext highlighter-rouge">src/helpers/http.js</code>.</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">export</span> <span class="kd">const</span> <span class="nx">noContent</span> <span class="o">=</span> <span class="p">():</span> <span class="nx">Response</span> <span class="o">=&gt;</span> <span class="p">({</span>
  <span class="na">statusCode</span><span class="p">:</span> <span class="mi">204</span><span class="p">,</span>
  <span class="na">headers</span><span class="p">:</span> <span class="p">{</span> <span class="dl">'</span><span class="s1">Access-Control-Allow-Origin</span><span class="dl">'</span><span class="p">:</span> <span class="dl">'</span><span class="s1">*</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">Access-Control-Allow-Credentials</span><span class="dl">'</span><span class="p">:</span> <span class="dl">'</span><span class="s1">*</span><span class="dl">'</span> <span class="p">},</span>
  <span class="na">body</span><span class="p">:</span> <span class="dl">''</span><span class="p">,</span>
<span class="p">});</span>

<span class="k">export</span> <span class="kd">const</span> <span class="nx">forbidden</span> <span class="o">=</span> <span class="p">(</span><span class="nx">detail</span><span class="p">:</span> <span class="nx">string</span><span class="p">):</span> <span class="nx">Response</span> <span class="o">=&gt;</span> <span class="p">({</span>
  <span class="na">statusCode</span><span class="p">:</span> <span class="mi">403</span><span class="p">,</span>
  <span class="na">headers</span><span class="p">:</span> <span class="p">{</span>
    <span class="dl">'</span><span class="s1">Access-Control-Allow-Origin</span><span class="dl">'</span><span class="p">:</span> <span class="dl">'</span><span class="s1">*</span><span class="dl">'</span><span class="p">,</span>
    <span class="dl">'</span><span class="s1">Access-Control-Allow-Credentials</span><span class="dl">'</span><span class="p">:</span> <span class="dl">'</span><span class="s1">*</span><span class="dl">'</span><span class="p">,</span>
    <span class="dl">'</span><span class="s1">Content-Type</span><span class="dl">'</span><span class="p">:</span> <span class="dl">'</span><span class="s1">application/problem+json</span><span class="dl">'</span><span class="p">,</span>
  <span class="p">},</span>
  <span class="na">body</span><span class="p">:</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">({</span> <span class="na">title</span><span class="p">:</span> <span class="dl">'</span><span class="s1">Forbidden</span><span class="dl">'</span><span class="p">,</span> <span class="nx">detail</span> <span class="p">}),</span>
<span class="p">});</span>
</code></pre></div></div>

<p>Finally, we will test that the implemented behaviour works as desired within <code class="language-plaintext highlighter-rouge">src/__tests__/remove.js</code>.</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="nx">handler</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">../handlers/remove</span><span class="dl">'</span><span class="p">;</span>

<span class="nx">it</span><span class="p">(</span><span class="dl">'</span><span class="s1">requires an authenticated user</span><span class="dl">'</span><span class="p">,</span> <span class="k">async</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="nx">services</span> <span class="o">=</span> <span class="p">{</span> <span class="na">getUserIdFromToken</span><span class="p">:</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="nb">Promise</span><span class="p">.</span><span class="nx">resolve</span><span class="p">()</span> <span class="p">};</span>

  <span class="kd">const</span> <span class="nx">response</span> <span class="o">=</span> <span class="nx">parseResponse</span><span class="p">(</span>
    <span class="k">await</span> <span class="nx">handler</span><span class="p">(</span><span class="nx">services</span><span class="p">)({</span> <span class="na">headers</span><span class="p">:</span> <span class="p">{},</span> <span class="na">pathParameters</span><span class="p">:</span> <span class="p">{</span> <span class="na">id</span><span class="p">:</span> <span class="dl">'</span><span class="s1">1</span><span class="dl">'</span> <span class="p">}</span> <span class="p">},</span> <span class="p">{})</span>
  <span class="p">);</span>

  <span class="nx">expect</span><span class="p">(</span><span class="nx">response</span><span class="p">.</span><span class="nx">statusCode</span><span class="p">).</span><span class="nx">toBe</span><span class="p">(</span><span class="mi">401</span><span class="p">);</span>
<span class="p">});</span>

<span class="nx">it</span><span class="p">(</span><span class="dl">'</span><span class="s1">requires a pie to be present</span><span class="dl">'</span><span class="p">,</span> <span class="k">async</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="nx">services</span> <span class="o">=</span> <span class="p">{</span>
    <span class="na">getUserIdFromToken</span><span class="p">:</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="nb">Promise</span><span class="p">.</span><span class="nx">resolve</span><span class="p">(</span><span class="dl">'</span><span class="s1">USER_ID</span><span class="dl">'</span><span class="p">),</span>
    <span class="na">getPie</span><span class="p">:</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="nb">Promise</span><span class="p">.</span><span class="nx">resolve</span><span class="p">(),</span>
  <span class="p">};</span>

  <span class="kd">const</span> <span class="nx">response</span> <span class="o">=</span> <span class="nx">parseResponse</span><span class="p">(</span>
    <span class="k">await</span> <span class="nx">handler</span><span class="p">(</span><span class="nx">services</span><span class="p">)(</span>
      <span class="p">{</span> <span class="na">headers</span><span class="p">:</span> <span class="p">{</span> <span class="na">Authorization</span><span class="p">:</span> <span class="dl">'</span><span class="s1">TOKEN</span><span class="dl">'</span> <span class="p">},</span> <span class="na">pathParameters</span><span class="p">:</span> <span class="p">{</span> <span class="na">id</span><span class="p">:</span> <span class="dl">'</span><span class="s1">1</span><span class="dl">'</span> <span class="p">}</span> <span class="p">},</span>
      <span class="p">{}</span>
    <span class="p">)</span>
  <span class="p">);</span>

  <span class="nx">expect</span><span class="p">(</span><span class="nx">response</span><span class="p">.</span><span class="nx">statusCode</span><span class="p">).</span><span class="nx">toBe</span><span class="p">(</span><span class="mi">404</span><span class="p">);</span>
<span class="p">});</span>

<span class="nx">it</span><span class="p">(</span><span class="dl">'</span><span class="s1">requires the user to own the pie</span><span class="dl">'</span><span class="p">,</span> <span class="k">async</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="nx">services</span> <span class="o">=</span> <span class="p">{</span>
    <span class="na">getUserIdFromToken</span><span class="p">:</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="nb">Promise</span><span class="p">.</span><span class="nx">resolve</span><span class="p">(</span><span class="dl">'</span><span class="s1">USER_ID</span><span class="dl">'</span><span class="p">),</span>
    <span class="na">getPie</span><span class="p">:</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="nb">Promise</span><span class="p">.</span><span class="nx">resolve</span><span class="p">({</span> <span class="na">Id</span><span class="p">:</span> <span class="dl">'</span><span class="s1">1</span><span class="dl">'</span><span class="p">,</span> <span class="na">UserId</span><span class="p">:</span> <span class="dl">'</span><span class="s1">ANOTHER_USER_ID</span><span class="dl">'</span> <span class="p">}),</span>
  <span class="p">};</span>

  <span class="kd">const</span> <span class="nx">response</span> <span class="o">=</span> <span class="nx">parseResponse</span><span class="p">(</span>
    <span class="k">await</span> <span class="nx">handler</span><span class="p">(</span><span class="nx">services</span><span class="p">)(</span>
      <span class="p">{</span> <span class="na">headers</span><span class="p">:</span> <span class="p">{</span> <span class="na">Authorization</span><span class="p">:</span> <span class="dl">'</span><span class="s1">TOKEN</span><span class="dl">'</span> <span class="p">},</span> <span class="na">pathParameters</span><span class="p">:</span> <span class="p">{</span> <span class="na">id</span><span class="p">:</span> <span class="dl">'</span><span class="s1">1</span><span class="dl">'</span> <span class="p">}</span> <span class="p">},</span>
      <span class="p">{}</span>
    <span class="p">)</span>
  <span class="p">);</span>

  <span class="nx">expect</span><span class="p">(</span><span class="nx">response</span><span class="p">.</span><span class="nx">statusCode</span><span class="p">).</span><span class="nx">toBe</span><span class="p">(</span><span class="mi">403</span><span class="p">);</span>
<span class="p">});</span>

<span class="nx">it</span><span class="p">(</span><span class="dl">'</span><span class="s1">removes the users pie</span><span class="dl">'</span><span class="p">,</span> <span class="k">async</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="nx">services</span> <span class="o">=</span> <span class="p">{</span>
    <span class="na">getUserIdFromToken</span><span class="p">:</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="nb">Promise</span><span class="p">.</span><span class="nx">resolve</span><span class="p">(</span><span class="dl">'</span><span class="s1">USER_ID</span><span class="dl">'</span><span class="p">),</span>
    <span class="na">getPie</span><span class="p">:</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="nb">Promise</span><span class="p">.</span><span class="nx">resolve</span><span class="p">({</span> <span class="na">Id</span><span class="p">:</span> <span class="dl">'</span><span class="s1">1</span><span class="dl">'</span><span class="p">,</span> <span class="na">UserId</span><span class="p">:</span> <span class="dl">'</span><span class="s1">USER_ID</span><span class="dl">'</span> <span class="p">}),</span>
    <span class="na">removePie</span><span class="p">:</span> <span class="nx">jest</span><span class="p">.</span><span class="nx">fn</span><span class="p">(),</span>
  <span class="p">};</span>

  <span class="kd">const</span> <span class="nx">response</span> <span class="o">=</span> <span class="nx">parseResponse</span><span class="p">(</span>
    <span class="k">await</span> <span class="nx">handler</span><span class="p">(</span><span class="nx">services</span><span class="p">)(</span>
      <span class="p">{</span> <span class="na">headers</span><span class="p">:</span> <span class="p">{</span> <span class="na">Authorization</span><span class="p">:</span> <span class="dl">'</span><span class="s1">TOKEN</span><span class="dl">'</span> <span class="p">},</span> <span class="na">pathParameters</span><span class="p">:</span> <span class="p">{</span> <span class="na">id</span><span class="p">:</span> <span class="dl">'</span><span class="s1">1</span><span class="dl">'</span> <span class="p">}</span> <span class="p">},</span>
      <span class="p">{}</span>
    <span class="p">)</span>
  <span class="p">);</span>

  <span class="nx">expect</span><span class="p">(</span><span class="nx">response</span><span class="p">.</span><span class="nx">statusCode</span><span class="p">).</span><span class="nx">toBe</span><span class="p">(</span><span class="mi">204</span><span class="p">);</span>
  <span class="nx">expect</span><span class="p">(</span><span class="nx">services</span><span class="p">.</span><span class="nx">removePie</span><span class="p">).</span><span class="nx">toHaveBeenCalledWith</span><span class="p">(</span><span class="dl">'</span><span class="s1">1</span><span class="dl">'</span><span class="p">);</span>
<span class="p">});</span>
</code></pre></div></div>

<p>With this behaviour now exercised by automated tests we are equipped to test performing these actions within both an offline and online development environment.
We will run <code class="language-plaintext highlighter-rouge">make offline</code> and test viewing a newly created mince pie as the resource owner, using <a href="https://www.getpostman.com/">Postman</a>.</p>

<p><img src="/uploads/mince-pie-challenge-viewing-and-removing-mince-pies-with-amazon-dynamodb/postman-view-pie.png" alt="Viewing Pie in Postman" /></p>

<p>You will see that as the pie owner we have the ability to remove it from the challenge.
We will now call this action and ensure that the pie has been successfully removed.</p>

<p><img src="/uploads/mince-pie-challenge-viewing-and-removing-mince-pies-with-amazon-dynamodb/postman-remove-pie.png" alt="Removing Pie in Postman" /></p>

<p>Finally, we can <code class="language-plaintext highlighter-rouge">make deploy</code> and perform the same assertions in the online development environment.</p>

<p>In this post we have made good progress in building up the underlying functionality that comprises to be the API.
In the next post we shall delve into adding a key part of the challenge itself, the ability to rate a specified mince pie 💯.</p>

</article>

            </main>

            <footer class="footer">
                <img src="https://www.gravatar.com/avatar/c5c2978bb14d16460f73399c394b6acd?s=160">
                <ul>
                    <li>Developer at <a href="http://www.mybuilder.com/">MyBuilder</a></li>
                    <li><a href="http://threedevsandamaybe.com/">Three Devs and a Maybe</a> podcast co-host</li>
                    <li>All ramblings can be found in the <a href="/archive/">Archive</a></li>
                </ul>
                <div class="cf"></div>
            </footer>
        </div>
    </body>
</html>
