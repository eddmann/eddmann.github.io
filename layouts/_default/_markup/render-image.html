{{- $source := .Page.Resources.GetMatch (.Destination) -}}
{{- if and $source (or (eq $source.MediaType.Type "image/jpeg") (eq $source.MediaType.Type "image/png")) -}}
  {{- $maxWidth := site.Params.maxImageWidth -}}
  {{- $responseSizes := slice (div $maxWidth 2) $maxWidth (math.Min $source.Width (mul $maxWidth 2)) -}}
  <picture>
    <source type="image/webp" srcset="
    {{- with $responseSizes -}}
      {{- range $i, $e := . -}}
        {{- if ge $source.Width . -}}
          {{- if $i }}, {{ end -}}{{- ($source.Resize (print . `x webp`)).RelPermalink }} {{ . }}w
        {{- end -}}
      {{- end -}}
    {{- end -}}" />
    <source type="image/jpeg" srcset="
    {{- with $responseSizes -}}
      {{- range $i, $e := . -}}
        {{- if ge $source.Width . -}}
          {{- if $i }}, {{ end -}}{{- ($source.Resize (print . `x jpg`)).RelPermalink }} {{ . }}w
        {{- end -}}
      {{- end -}}
    {{- end -}}" />
    <img src="{{- ($source.Resize (print (math.Min $source.Width $maxWidth) `x jpg`)).RelPermalink -}}" alt="{{- .PlainText -}}" loading="lazy"
      {{- with .Title -}} title="{{- . -}}" {{- end -}}
      {{- range $k, $v := .Attributes -}}
        {{- if $v -}}
          {{- printf " %s=%q" $k ($v | transform.HTMLEscape) | safeHTMLAttr -}}
        {{- end -}}
      {{- end -}}
    />
  </picture>
{{- else -}}
  <img src="{{- .Destination -}}" alt="{{- .PlainText -}}"
    {{- with .Title -}} title="{{- . -}}" {{- end -}}
    {{- range $k, $v := .Attributes -}}
      {{- if $v -}}
        {{- printf " %s=%q" $k ($v | transform.HTMLEscape) | safeHTMLAttr -}}
      {{- end -}}
    {{- end -}}
  />
{{- end -}}