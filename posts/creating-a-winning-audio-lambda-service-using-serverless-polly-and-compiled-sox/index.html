<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><title>Creating a 'Winning' Audio Lambda Service using Serverless, Polly and compiled SOX - Edd Mann</title>
<meta name=description content="Learn how to build a 'Winning' audio Lambda service using the Serverless framework, AWS Polly and compiled SOX. This comprehensive guide covers compiling native code, integrating AWS services and generating dynamic audio outputs."><meta name=author content="Edd Mann"><script async src="https://www.googletagmanager.com/gtag/js?id=G-ZPQ7WHNXH4"></script><script>var dnt,doNotTrack=!1;if(!1&&(dnt=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,doNotTrack=dnt=="1"||dnt=="yes"),!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-ZPQ7WHNXH4")}</script><meta itemprop=name content="Creating a 'Winning' Audio Lambda Service using Serverless, Polly and compiled SOX"><meta itemprop=description content="Following on from my previous post which discussed manipulating images, I would now like to expand upon this and look into how you can interact with audio using Lambda. To highlight this use-case we will be creating a simple service which, given a name and an optional voice (provided by Polly), will synthesise the name and include it in a returned “And the winner is…” applause MP3 file. This will demonstrate how to integrate Polly within Lambda, compile and execute native code within Lambda and return a binary MP3 file to the client."><meta itemprop=datePublished content="2017-12-11T00:00:00+00:00"><meta itemprop=dateModified content="2017-12-11T00:00:00+00:00"><meta itemprop=wordCount content="1233"><meta itemprop=keywords content="Serverless,Aws,Lambda,Javascript"><meta property="og:url" content="https://eddmann.com/posts/creating-a-winning-audio-lambda-service-using-serverless-polly-and-compiled-sox/"><meta property="og:site_name" content="Edd Mann"><meta property="og:title" content="Creating a 'Winning' Audio Lambda Service using Serverless, Polly and compiled SOX"><meta property="og:description" content="Following on from my previous post which discussed manipulating images, I would now like to expand upon this and look into how you can interact with audio using Lambda. To highlight this use-case we will be creating a simple service which, given a name and an optional voice (provided by Polly), will synthesise the name and include it in a returned “And the winner is…” applause MP3 file. This will demonstrate how to integrate Polly within Lambda, compile and execute native code within Lambda and return a binary MP3 file to the client."><meta property="og:locale" content="en_GB"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2017-12-11T00:00:00+00:00"><meta property="article:modified_time" content="2017-12-11T00:00:00+00:00"><meta property="article:tag" content="Serverless"><meta property="article:tag" content="Aws"><meta property="article:tag" content="Lambda"><meta property="article:tag" content="Javascript"><meta name=twitter:card content="summary"><meta name=twitter:title content="Creating a 'Winning' Audio Lambda Service using Serverless, Polly and compiled SOX"><meta name=twitter:description content="Following on from my previous post which discussed manipulating images, I would now like to expand upon this and look into how you can interact with audio using Lambda. To highlight this use-case we will be creating a simple service which, given a name and an optional voice (provided by Polly), will synthesise the name and include it in a returned “And the winner is…” applause MP3 file. This will demonstrate how to integrate Polly within Lambda, compile and execute native code within Lambda and return a binary MP3 file to the client."><meta name=twitter:site content="@edd_mann"><link rel=stylesheet href=/css/style.min.4c8b66c005db4efc68625e4ceed190f2dc110d342d05ffb19ba924cc13c3ef15.css integrity="sha256-TItmwAXbTvxoYl5M7tGQ8twRDTQtBf+xm6kkzBPD7xU="><link rel=preload as=image href=/assets/x.svg crossorigin=anonymous><link rel=preload as=image href=/assets/github.svg crossorigin=anonymous><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=manifest href=/site.webmanifest><link rel=canonical href=https://eddmann.com/posts/creating-a-winning-audio-lambda-service-using-serverless-polly-and-compiled-sox/><script>document.documentElement.setAttribute("data-theme",localStorage.getItem("theme")||window.matchMedia("(prefers-color-scheme: dark)").matches&&"dark"||"light")</script><script src=/script.min.da71ac9c7b8bd4e644618df0ab735aed1393aad3cb5e5c57e5adc300fe7c8209.js integrity="sha256-2nGsnHuL1OZEYY3wq3Na7ROTqtPLXlxX5a3DAP58ggk=" defer></script></head><body><header class="site-header l-wrapper"><a href=https://eddmann.com/><h3 class=site-header__title>Edd Mann
<span style=--url:url(/assets/code.svg)>Developer</span></h3></a><button class=site-header__mobile-navigation-button type=button title="Toggle mobile site navigation" aria-label="Toggle mobile site navigation" aria-expanded=false aria-controls=site-navigation></button><div class=site-header__navigation id=site-navigation><nav aria-label="Primary navigation"><ul class=site-header__primary-navigation><li><a href=/archive>Archive</a></li><li><a href=/projects>Projects</a></li><li><a href=/about>About</a></li></ul></nav><nav aria-label="Social links"><ul class=site-header__social-navigation><li><a class=social-icon style=--url:url(/assets/x.svg) href=https://x.com/edd_mann rel="external noopener" target=_blank>Twitter (X)</a></li><li><a class=social-icon style=--url:url(/assets/github.svg) href=https://github.com/eddmann rel="external noopener" target=_blank>GitHub</a></li></ul></nav></div></header><main class=l-wrapper><article><header class=l-page-title><h1 class=u-transition-between-pages style=--id:creating-a-winning-audio-lambda-service-using-serverless-polly-and-compiled-sox>Creating a 'Winning' Audio Lambda Service using Serverless, Polly and compiled SOX</h1><time datetime=2017-12-11T00:00:00Z class=published-at>Dec 11, 2017</time></header><main class=u-prose><p>Following on from my previous post which discussed <a href=/posts/memes-as-a-service-using-lambda-serverless-and-imagemagick/>manipulating images</a>, I would now like to expand upon this and look into how you can interact with audio using Lambda.
To highlight this use-case we will be creating a simple service which, given a name and an optional voice (provided by <a href=https://aws.amazon.com/polly/ rel="external noopener" target=_blank>Polly</a>), will synthesise the name and include it in a returned &ldquo;And the winner is&mldr;&rdquo; applause MP3 file.
This will demonstrate how to integrate Polly within Lambda, compile and execute native code within Lambda and return a binary MP3 file to the client.</p><h2 id=compiling-sox-for-lambda>Compiling SOX for Lambda</h2><p>As we wish to join our static intro and outro audio files with the dynamically produced Polly response, we will need an application that can achieve this.
I have decided to use <a href=http://sox.sourceforge.net/ rel="external noopener" target=_blank>SOX</a> for this task, as it provides us with a very simple API for joining multiple files together into a single track.
Lambda allows us to execute natively compiled code, providing that it has been correctly compiled for the underlying host operating system.
To correctly compile SOX for Lambda, we will be using a <a href=https://github.com/lambci/docker-lambda rel="external noopener" target=_blank>Docker image</a> which locally replicates the environment as best it can, providing all the necessary build tooling.
First, we need to start up a container (of this image) with <code>bash</code> running, so we can compile SOX and its required dependencies.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ docker run -it lambci/lambda:build bash
</span></span></code></pre></div><p>This will pull down the required image from Docker Hub and begin a <code>bash</code> interpreter session.
Within this session, we will start by compiling <a href=https://sourceforge.net/projects/mad/ rel="external noopener" target=_blank>MPEG Audio Decoder</a>, which is a dependency of SOX.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ curl -L -o libmad-0.15.1b.tar.gz <span style=color:#e6db74>&#34;http://downloads.sourceforge.net/project/mad/libmad/0.15.1b/libmad-0.15.1b.tar.gz&#34;</span>
</span></span><span style=display:flex><span>$ tar zxf libmad-0.15.1b.tar.gz <span style=color:#f92672>&amp;&amp;</span> cd libmad-0.15.1b
</span></span><span style=display:flex><span>$ sed -i <span style=color:#e6db74>&#39;/-fforce-mem/d&#39;</span> configure <span style=color:#75715e># https://stackoverflow.com/questions/14015747/gccs-fforce-mem-option</span>
</span></span><span style=display:flex><span>$ ./configure --prefix<span style=color:#f92672>=</span>/usr/libmad-0.15.1b --disable-shared --enable-static
</span></span><span style=display:flex><span>$ make <span style=color:#f92672>&amp;&amp;</span> make install
</span></span></code></pre></div><p>Next we will compile <a href=http://lame.sourceforge.net/ rel="external noopener" target=_blank>LAME</a>, which will allow us to encode the desired MP3 audio file within SOX.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ curl -L -o lame-3.100.tar.gz <span style=color:#e6db74>&#34;https://downloads.sourceforge.net/project/lame/lame/3.100/lame-3.100.tar.gz&#34;</span>
</span></span><span style=display:flex><span>$ tar zxf lame-3.100.tar.gz <span style=color:#f92672>&amp;&amp;</span> cd lame-3.100
</span></span><span style=display:flex><span>$ ./configure --prefix<span style=color:#f92672>=</span>/usr/lame-3.100 --disable-shared --enable-static
</span></span><span style=display:flex><span>$ make <span style=color:#f92672>&amp;&amp;</span> make install
</span></span></code></pre></div><p>Finally, we are able to compile SOX, providing locations to the previously compiled libraries.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ curl -L -o sox-14.4.2.tar.bz2 <span style=color:#e6db74>&#34;http://downloads.sourceforge.net/project/sox/sox/14.4.2/sox-14.4.2.tar.bz2&#34;</span>
</span></span><span style=display:flex><span>$ tar jxf sox-14.4.2.tar.bz2 <span style=color:#f92672>&amp;&amp;</span> cd sox-14.4.2
</span></span><span style=display:flex><span>$ CPPFLAGS<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;-I/usr/libmad-0.15.1b/include -I/usr/lame-3.100/include&#34;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  LDFLAGS<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;-L/usr/libmad-0.15.1b/lib -L/usr/lame-3.100/lib&#34;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  ./configure --prefix<span style=color:#f92672>=</span>/usr/sox-14.4.2 --disable-shared --enable-static
</span></span><span style=display:flex><span>$ make <span style=color:#f92672>&amp;&amp;</span> make install
</span></span></code></pre></div><p>You will notice that we have <a href=https://en.wikipedia.org/wiki/Static_build#Static_building rel="external noopener" target=_blank>statically compiled</a> all these applications, as we desire to depend on only a single executable within the Lambda service.
With SOX now compiled, we can open up a host terminal session and copy the newly compiled <code>sox</code> executable from the container.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ docker ps <span style=color:#75715e># displays the running container&#39;s ID</span>
</span></span><span style=display:flex><span>$ docker cp <span style=color:#f92672>{</span>CONTAINER-ID<span style=color:#f92672>}</span>:/usr/sox-14.4.2/bin/sox ~/sox
</span></span></code></pre></div><h2 id=creating-the-serverless-project>Creating the Serverless Project</h2><p>Now with the native executable compiled, we can create the accompanying Lambda service.
In a similar manner to the previous blog post, we will first create a skeleton <a href=https://serverless.com/ rel="external noopener" target=_blank>Serverless</a> project template.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ serverless create --template aws-nodejs --path and-the-winner-is
</span></span></code></pre></div><p>Running this will create the basic handler and Serverless definition file.
Replace the given Serverless definition file with the following:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>service</span>: <span style=color:#ae81ff>and-the-winner-is</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>provider</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>aws</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>runtime</span>: <span style=color:#ae81ff>nodejs6.10</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>stage</span>: <span style=color:#ae81ff>prod</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>region</span>: <span style=color:#ae81ff>eu-west-1</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>environment</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>SOX_EXEC</span>: <span style=color:#ae81ff>./sox</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>INTRO_FILE</span>: <span style=color:#ae81ff>./intro.mp3</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>OUTRO_FILE</span>: <span style=color:#ae81ff>./outro.mp3</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>iamRoleStatements</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>Effect</span>: <span style=color:#ae81ff>Allow</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>Action</span>:
</span></span><span style=display:flex><span>        - <span style=color:#ae81ff>polly:DescribeVoices</span>
</span></span><span style=display:flex><span>        - <span style=color:#ae81ff>polly:SynthesizeSpeech</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>Resource</span>: <span style=color:#e6db74>&#39;*&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>plugins</span>:
</span></span><span style=display:flex><span>  - <span style=color:#ae81ff>serverless-apigw-binary</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>custom</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>apigwBinary</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>types</span>:
</span></span><span style=display:flex><span>      - <span style=color:#e6db74>&#39;*/*&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>functions</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>winner</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>handler</span>: <span style=color:#ae81ff>handler.winner</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>events</span>:
</span></span><span style=display:flex><span>      - <span style=color:#f92672>http</span>:
</span></span><span style=display:flex><span>          <span style=color:#f92672>path</span>: <span style=color:#ae81ff>/</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>method</span>: <span style=color:#ae81ff>get</span>
</span></span></code></pre></div><p>This configuration defines a single Lambda function which is exposed via a root API Gateway path.
It also provides a couple of environment variables which specify the SOX executable location, along with the desired intro and outro audio files.
We then use a <a href=https://github.com/maciejtreder/serverless-apigw-binary rel="external noopener" target=_blank>Serverless plugin</a> to correctly add binary support to the API Gateway.
As we desire to use Polly within Lambda, we permit access to both the <code>DescribeVoices</code> and <code>SynthesizeSpeech</code> actions.
Before continuing, we should include the Serverless plugin we have defined as a development dependency.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ npm install serverless-apigw-binary --save-dev
</span></span></code></pre></div><h2 id=synthesising-the-name>Synthesising the Name</h2><p>With this definition in place, we will move on to generating (synthesising) the name provided by the client using Polly.
If the client does not supply a desired voice, we will randomly choose one from the list of available options.
After creating a new file called <code>synthesise-name.js</code>, copy the following functions into the file:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#e6db74>&#39;use strict&#39;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>AWS</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>require</span>(<span style=color:#e6db74>&#39;aws-sdk&#39;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>random</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>arr</span> =&gt; <span style=color:#a6e22e>arr</span>[Math.<span style=color:#a6e22e>floor</span>(Math.<span style=color:#a6e22e>random</span>() <span style=color:#f92672>*</span> <span style=color:#a6e22e>arr</span>.<span style=color:#a6e22e>length</span>)];
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>polly</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>AWS</span>.<span style=color:#a6e22e>Polly</span>();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>getRandomVoice</span> <span style=color:#f92672>=</span> () =&gt;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>new</span> Promise((<span style=color:#a6e22e>res</span>, <span style=color:#a6e22e>rej</span>) =&gt; {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>polly</span>.<span style=color:#a6e22e>describeVoices</span>({}, <span style=color:#66d9ef>function</span> (<span style=color:#a6e22e>err</span>, { <span style=color:#a6e22e>Voices</span> }) {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>err</span>) <span style=color:#a6e22e>rej</span>(<span style=color:#a6e22e>err</span>);
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>else</span> <span style=color:#a6e22e>res</span>(<span style=color:#a6e22e>random</span>(<span style=color:#a6e22e>Voices</span>).<span style=color:#a6e22e>Id</span>);
</span></span><span style=display:flex><span>    });
</span></span><span style=display:flex><span>  });
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>synthesiseSpeech</span> <span style=color:#f92672>=</span> (<span style=color:#a6e22e>text</span>, <span style=color:#a6e22e>voice</span>) =&gt;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>new</span> Promise((<span style=color:#a6e22e>res</span>, <span style=color:#a6e22e>rej</span>) =&gt; {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>params</span> <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>OutputFormat</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;mp3&#39;</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>SampleRate</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;22050&#39;</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>Text</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>text</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>TextType</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;text&#39;</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>VoiceId</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>voice</span>,
</span></span><span style=display:flex><span>    };
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>polly</span>.<span style=color:#a6e22e>synthesizeSpeech</span>(<span style=color:#a6e22e>params</span>, <span style=color:#66d9ef>function</span> (<span style=color:#a6e22e>err</span>, <span style=color:#a6e22e>speech</span>) {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>err</span>) <span style=color:#a6e22e>rej</span>(<span style=color:#a6e22e>err</span>);
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>else</span> <span style=color:#a6e22e>res</span>(<span style=color:#a6e22e>speech</span>.<span style=color:#a6e22e>AudioStream</span>);
</span></span><span style=display:flex><span>    });
</span></span><span style=display:flex><span>  });
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>module</span>.<span style=color:#a6e22e>exports</span> <span style=color:#f92672>=</span> (<span style=color:#a6e22e>name</span>, <span style=color:#a6e22e>voice</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>undefined</span>) =&gt;
</span></span><span style=display:flex><span>  Promise.<span style=color:#a6e22e>resolve</span>(<span style=color:#a6e22e>voice</span> <span style=color:#f92672>||</span> <span style=color:#a6e22e>getRandomVoice</span>()).<span style=color:#a6e22e>then</span>(<span style=color:#a6e22e>voice</span> =&gt; <span style=color:#a6e22e>synthesiseSpeech</span>(<span style=color:#a6e22e>name</span>, <span style=color:#a6e22e>voice</span>));
</span></span></code></pre></div><p>We have a couple of helper functions - one returns a randomly selected Polly voice (if no voice is supplied), and another generates the audio representation of the supplied name.
Combining these two helpers returns an audio buffer stream which we can later use in our response.</p><h2 id=joining-audio-files-using-sox>Joining audio files using SOX</h2><p>Having synthesised the client&rsquo;s desired name, we now wish to join the multiple audio files together and generate the output track.
SOX requires that all audio files be of the same sample rate and channel count to successfully produce a joined file.
As Polly returns a mono-channel audio file with a sample rate of 22050, the intro and outro I have provided are re-sampled to these requirements.
After creating a new file called <code>generate-track.js</code>, copy the following logic into the file:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#e6db74>&#39;use strict&#39;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>fs</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>require</span>(<span style=color:#e6db74>&#39;fs&#39;</span>);
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>tempfile</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>require</span>(<span style=color:#e6db74>&#39;tempfile&#39;</span>);
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>childProcess</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>require</span>(<span style=color:#e6db74>&#39;child_process&#39;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> { <span style=color:#a6e22e>SOX_EXEC</span>, <span style=color:#a6e22e>INTRO_FILE</span>, <span style=color:#a6e22e>OUTRO_FILE</span> } <span style=color:#f92672>=</span> <span style=color:#a6e22e>process</span>.<span style=color:#a6e22e>env</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>module</span>.<span style=color:#a6e22e>exports</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>nameAudio</span> =&gt; {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>nameTempFile</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>tempfile</span>(<span style=color:#e6db74>&#39;.mp3&#39;</span>);
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>fs</span>.<span style=color:#a6e22e>writeFileSync</span>(<span style=color:#a6e22e>nameTempFile</span>, <span style=color:#a6e22e>nameAudio</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>trackTempFile</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>tempfile</span>(<span style=color:#e6db74>&#39;.mp3&#39;</span>);
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>childProcess</span>.<span style=color:#a6e22e>execFileSync</span>(<span style=color:#a6e22e>SOX_EXEC</span>, [<span style=color:#a6e22e>INTRO_FILE</span>, <span style=color:#a6e22e>nameTempFile</span>, <span style=color:#a6e22e>OUTRO_FILE</span>, <span style=color:#a6e22e>trackTempFile</span>]);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>fs</span>.<span style=color:#a6e22e>readFileSync</span>(<span style=color:#a6e22e>trackTempFile</span>);
</span></span><span style=display:flex><span>};
</span></span></code></pre></div><p>This function simply takes in the audio buffer stream returned from the Polly service and writes it to a temporary file.
We use an external temporary file library to achieve this, so we need to include it as a project dependency.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ npm install tempfile --save
</span></span></code></pre></div><p>We then supply this file, along with the intro and outro audio files, to the SOX executable to generate the final joined output track.
As this output is written to a temporary file, we then read its contents into a buffer which we can later use within our service.</p><h2 id=wiring-it-all-together>Wiring it all together</h2><p>With the two key problems now solved, we can now wire the handler together.
Replace the sample <code>handler.js</code> file contents with the following:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#e6db74>&#39;use strict&#39;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>synthesiseName</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>require</span>(<span style=color:#e6db74>&#39;./synthesise-name&#39;</span>);
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>generateTrack</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>require</span>(<span style=color:#e6db74>&#39;./generate-track&#39;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>module</span>.<span style=color:#a6e22e>exports</span>.<span style=color:#a6e22e>winner</span> <span style=color:#f92672>=</span> (<span style=color:#a6e22e>event</span>, <span style=color:#a6e22e>context</span>, <span style=color:#a6e22e>callback</span>) =&gt; {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>input</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>event</span>.<span style=color:#a6e22e>queryStringParameters</span> <span style=color:#f92672>||</span> {};
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>synthesiseName</span>(<span style=color:#a6e22e>input</span>.<span style=color:#a6e22e>name</span> <span style=color:#f92672>||</span> <span style=color:#e6db74>&#39;All of us&#39;</span>, <span style=color:#a6e22e>input</span>.<span style=color:#a6e22e>voice</span>)
</span></span><span style=display:flex><span>    .<span style=color:#a6e22e>then</span>(<span style=color:#a6e22e>generateTrack</span>)
</span></span><span style=display:flex><span>    .<span style=color:#a6e22e>then</span>(<span style=color:#a6e22e>track</span> =&gt; {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>callback</span>(<span style=color:#66d9ef>null</span>, {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>statusCode</span><span style=color:#f92672>:</span> <span style=color:#ae81ff>200</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>headers</span><span style=color:#f92672>:</span> { <span style=color:#e6db74>&#39;Content-Type&#39;</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;audio/mpeg&#39;</span> },
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>body</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>track</span>.<span style=color:#a6e22e>toString</span>(<span style=color:#e6db74>&#39;base64&#39;</span>),
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>isBase64Encoded</span><span style=color:#f92672>:</span> <span style=color:#66d9ef>true</span>,
</span></span><span style=display:flex><span>      });
</span></span><span style=display:flex><span>    });
</span></span><span style=display:flex><span>};
</span></span></code></pre></div><p>This composes the two functions together, returning the resulting audio track back to the client.
API Gateway requires that we Base-64 encode the binary response, so we do so within the callback.</p><h2 id=we-are-all-winners>We are all winners</h2><p>With the implementation now fully complete, we can deploy the Lambda service by executing:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ serverless deploy -v
</span></span></code></pre></div><p>Finally, we can visit the returned endpoint URL and enjoy creating our own winning audio tracks!
You can find the code in its entirety, along with supporting assets, in <a href=https://github.com/eddmann/and-the-winner-is-serverless rel="external noopener" target=_blank>this</a> GitHub repository.</p><audio preload=metadata controls><source src=/posts/creating-a-winning-audio-lambda-service-using-serverless-polly-and-compiled-sox/winner.mp3 type=audio/mpeg>Your browser does not support the audio element.</audio></main><footer class=post-footer><ul class="tags tags--large"><li><a href=/archive/tag/serverless>serverless</a></li><li><a href=/archive/tag/aws>aws</a></li><li><a href=/archive/tag/lambda>lambda</a></li><li><a href=/archive/tag/javascript>javascript</a></li></ul><div class=related><h3 class=related__title>Related Posts</h3><ul class=related__posts><li><a href=/posts/memes-as-a-service-using-lambda-serverless-and-imagemagick/>'Memes as a Service' using Lambda, Serverless and ImageMagick</a></li><li><a href=/posts/scheduling-ec2-instances-using-lambda-and-cloudwatch-events/>Scheduling EC2 Instances using Lambda and CloudWatch Events</a></li><li><a href=/posts/bitcoin-internals-verifying-merkle-roots-using-merkle-proofs-in-javascript/>Bitcoin Internals: Verifying Merkle Roots using Merkle Proofs in JavaScript</a></li><li><a href=/posts/bitcoin-internals-how-blocks-use-merkle-trees-in-javascript/>Bitcoin Internals: How Blocks use Merkle Trees in JavaScript</a></li><li><a href=/posts/handling-retries-and-back-off-attempts-with-javascript-promises/>Handling Retries and Back-off Attempts with JavaScript Promises</a></li></ul></div></footer></article><div class="podcast-ad u-overlay-wrapper"><div class=podcast-ad__artwork><img src=https://compiledconversations.com/album-art.jpg alt="Compiled Conversations podcast album art" class=podcast-ad__artwork-image></div><div class=podcast-ad__content><h3 class=podcast-ad__title>Compiled Conversations</h3><p class=podcast-ad__description>Podcast I host, featuring conversations with the people shaping software and technology.</p><div class=podcast-ad__link>Check out the show</a></div><a class=u-overlay href=https://compiledconversations.com target=_blank>Listen to Compiled Conversations</a></div><div class=scroll-watcher></div></main><footer class="site-footer l-wrapper"><div>&copy; 2025, Edd Mann</div><button class=site-footer__theme-toggle type=button title="Toggle theme" aria-label="Toggle theme"><svg fill="currentcolor" viewBox="0 0 32 32" role="img"><title>Theme toggle icon</title><desc>A circle representing the moon for toggling theme</desc><path d="M16 .5C7.4.5.5 7.4.5 16S7.4 31.5 16 31.5 31.5 24.6 31.5 16 24.6.5 16 .5zm0 28.1V3.4C23 3.4 28.6 9 28.6 16S23 28.6 16 28.6z"/></svg></button></footer></body></html>