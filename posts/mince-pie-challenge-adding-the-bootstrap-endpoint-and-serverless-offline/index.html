<p>Up until now, we have spent our time setting up the API project to provide a confident testing pipeline (with types) and Amazon Cognito authentication.
We will now move on to implementing the first <strong>real</strong> API endpoint, that being the Bootstrap response.
Along the way we will configure <a href="https://github.com/dherault/serverless-offline">Serverless Offline</a>, allowing us to locally interact with the API, without having to provision any online resources.</p>

<!--more-->

<p>If you are keen to see how the finished example looks, you can access it within the <a href="https://github.com/eddmann/mince-pie-challenge-api-serverless/tree/05-bootstrap-offline">API repository</a>.</p>

<h3 id="adding-the-bootstrap-endpoint">Adding the Bootstrap Endpoint</h3>

<p>If we <a href="https://eddmann.com/posts/mince-pie-challenge-designing-the-restful-api-with-raml/#bootstrap">look back</a> at the RAML API definition, we can see that this endpoint is used to help aid the client in discovering all the different endpoints/actions that are available to them.
We also provide the base endpoint and some Amazon Cognito User Pool specific information.
To start with, we will replace the user authentication handler examples present within <code class="language-plaintext highlighter-rouge">functions.yml</code> with our Bootstrap handler.</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">bootstrap</span><span class="pi">:</span>
  <span class="na">handler</span><span class="pi">:</span> <span class="s">src/bootstrap.handler</span>
  <span class="na">environment</span><span class="pi">:</span>
    <span class="na">USER_POOL_CLIENT_ID</span><span class="pi">:</span> <span class="s">${file(./config.${self:provider.stage}.yml):userPoolClientId}</span>
    <span class="na">BASE_ENDPOINT_URL</span><span class="pi">:</span> <span class="s">${file(./config.${self:provider.stage}.yml):baseEndpointUrl}</span>
  <span class="na">events</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">http</span><span class="pi">:</span>
        <span class="na">path</span><span class="pi">:</span> <span class="s">/</span>
        <span class="na">method</span><span class="pi">:</span> <span class="s">get</span>
        <span class="na">cors</span><span class="pi">:</span> <span class="no">true</span>
</code></pre></div></div>

<p>In this case we are explicitly supplying several additional environment variables to this particular handler.
As these are only required within this endpoint, following the <a href="https://en.wikipedia.org/wiki/Principle_of_least_privilege">principle of least privilege</a> states that they should only be supplied within here.
We are fetching these values from the stage specific configuration file (<code class="language-plaintext highlighter-rouge">config.dev.yml</code>), referencing the User Pool Client resource in a similar manor to how we reference the User Pool in the previous post.
We also <a href="https://serverless.com/framework/docs/providers/aws/events/apigateway/#enabling-cors">enable CORS</a> support within the API Gateway endpoint, as the API will be hosted on a different sub-domain to the client.</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># ..</span>
<span class="na">baseEndpointUrl</span><span class="pi">:</span> <span class="s1">'</span><span class="s">https://dev.api.mincepiechallenge.com'</span>
<span class="na">userPoolClientId</span><span class="pi">:</span>
  <span class="na">Ref</span><span class="pi">:</span> <span class="s">PieUserPoolClient</span>
</code></pre></div></div>

<p>With this endpoint now defined, we can move on to implementing the behaviour.
We will first add a <a href="https://github.com/byteclubfr/js-hal">new dependency</a> to the <code class="language-plaintext highlighter-rouge">package.json</code>, this provides a nice abstraction around managing HAL resources.</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"dependencies"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"hal"</span><span class="p">:</span><span class="w"> </span><span class="s2">"^1.2.0"</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p>From here, we can implement the delivery specific handler within <code class="language-plaintext highlighter-rouge">src/bootstrap.js</code>.</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// @flow</span>

<span class="k">import</span> <span class="nx">bootstrap</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">./handlers/bootstrap</span><span class="dl">'</span><span class="p">;</span>

<span class="kd">const</span> <span class="p">{</span> <span class="nx">USER_POOL_ID</span><span class="p">,</span> <span class="nx">USER_POOL_CLIENT_ID</span><span class="p">,</span> <span class="nx">BASE_ENDPOINT_URL</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">;</span>

<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">USER_POOL_ID</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="dl">'</span><span class="s1">USER_POOL_ID is not present</span><span class="dl">'</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">USER_POOL_CLIENT_ID</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="dl">'</span><span class="s1">USER_POOL_CLIENT_ID is not present</span><span class="dl">'</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">BASE_ENDPOINT_URL</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="dl">'</span><span class="s1">BASE_ENDPOINT_URL is not present</span><span class="dl">'</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">export</span> <span class="kd">const</span> <span class="nx">handler</span> <span class="o">=</span> <span class="nx">bootstrap</span><span class="p">({</span>
  <span class="na">getPoolId</span><span class="p">:</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="nx">USER_POOL_ID</span><span class="p">,</span>
  <span class="na">getClientId</span><span class="p">:</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="nx">USER_POOL_CLIENT_ID</span><span class="p">,</span>
  <span class="na">getBaseEndpointUrl</span><span class="p">:</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="nx">BASE_ENDPOINT_URL</span><span class="p">,</span>
<span class="p">});</span>
</code></pre></div></div>

<p>This file exports the concrete handler that is called when the API Gateway endpoint is triggered.
We pull together all the externally required dependencies, in this case environment variables.
We ensure these environment variables are present and then encapsulate them into small services that the underlying handler will use.</p>

<p>This allows us to now create the underlying handler implementation within <code class="language-plaintext highlighter-rouge">src/handlers/bootstrap.js</code>.</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// @flow</span>

<span class="k">import</span> <span class="p">{</span> <span class="nx">createHandler</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">../helpers/handlers</span><span class="dl">'</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span> <span class="nx">ok</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">../helpers/http</span><span class="dl">'</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span> <span class="nx">Resource</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">hal</span><span class="dl">'</span><span class="p">;</span>

<span class="kd">const</span> <span class="nx">bootstrap</span> <span class="o">=</span> <span class="k">async</span> <span class="p">({</span> <span class="na">services</span><span class="p">:</span> <span class="p">{</span> <span class="nx">getPoolId</span><span class="p">,</span> <span class="nx">getClientId</span><span class="p">,</span> <span class="nx">getBaseEndpointUrl</span> <span class="p">}</span> <span class="p">})</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="nx">resource</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Resource</span><span class="p">(</span>
    <span class="p">{</span>
      <span class="na">cognito</span><span class="p">:</span> <span class="p">{</span>
        <span class="na">poolId</span><span class="p">:</span> <span class="nx">getPoolId</span><span class="p">(),</span>
        <span class="na">clientId</span><span class="p">:</span> <span class="nx">getClientId</span><span class="p">(),</span>
      <span class="p">},</span>
      <span class="na">baseEndpointUrl</span><span class="p">:</span> <span class="nx">getBaseEndpointUrl</span><span class="p">(),</span>
    <span class="p">},</span>
    <span class="dl">'</span><span class="s1">/</span><span class="dl">'</span>
  <span class="p">);</span>

  <span class="nx">resource</span><span class="p">.</span><span class="nx">link</span><span class="p">(</span><span class="dl">'</span><span class="s1">list</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">/pies</span><span class="dl">'</span><span class="p">);</span>
  <span class="nx">resource</span><span class="p">.</span><span class="nx">link</span><span class="p">(</span><span class="dl">'</span><span class="s1">add</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">/pies</span><span class="dl">'</span><span class="p">);</span>
  <span class="nx">resource</span><span class="p">.</span><span class="nx">link</span><span class="p">(</span><span class="dl">'</span><span class="s1">view</span><span class="dl">'</span><span class="p">,</span> <span class="p">{</span> <span class="na">href</span><span class="p">:</span> <span class="dl">'</span><span class="s1">/pies/{id}</span><span class="dl">'</span><span class="p">,</span> <span class="na">templated</span><span class="p">:</span> <span class="kc">true</span> <span class="p">});</span>

  <span class="k">return</span> <span class="nx">ok</span><span class="p">(</span><span class="nx">resource</span><span class="p">);</span>
<span class="p">};</span>

<span class="k">export</span> <span class="k">default</span> <span class="nx">createHandler</span><span class="p">(</span><span class="nx">bootstrap</span><span class="p">);</span>
</code></pre></div></div>

<p>The handler uses the newly added dependency to build up a HAL compliant resource which is returned to the client.
The supplied services are then used to correctly set the resource values based on the current setup.
We finally return a newly created <code class="language-plaintext highlighter-rouge">ok</code> response, which needs to be added to <code class="language-plaintext highlighter-rouge">src/helpers/http.js</code>.</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// @flow</span>

<span class="k">import</span> <span class="nx">type</span> <span class="p">{</span> <span class="nx">HALResource</span><span class="p">,</span> <span class="nx">Response</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">../types</span><span class="dl">'</span><span class="p">;</span>

<span class="k">export</span> <span class="kd">const</span> <span class="nx">ok</span> <span class="o">=</span> <span class="p">(</span><span class="nx">resource</span><span class="p">:</span> <span class="nx">HALResource</span><span class="p">):</span> <span class="nx">Response</span> <span class="o">=&gt;</span> <span class="p">({</span>
  <span class="na">statusCode</span><span class="p">:</span> <span class="mi">200</span><span class="p">,</span>
  <span class="na">headers</span><span class="p">:</span> <span class="p">{</span>
    <span class="dl">'</span><span class="s1">Access-Control-Allow-Origin</span><span class="dl">'</span><span class="p">:</span> <span class="dl">'</span><span class="s1">*</span><span class="dl">'</span><span class="p">,</span>
    <span class="dl">'</span><span class="s1">Access-Control-Allow-Credentials</span><span class="dl">'</span><span class="p">:</span> <span class="dl">'</span><span class="s1">*</span><span class="dl">'</span><span class="p">,</span>
    <span class="dl">'</span><span class="s1">Content-Type</span><span class="dl">'</span><span class="p">:</span> <span class="dl">'</span><span class="s1">application/hal+json</span><span class="dl">'</span><span class="p">,</span>
  <span class="p">},</span>
  <span class="na">body</span><span class="p">:</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">resource</span><span class="p">.</span><span class="nx">toJSON</span><span class="p">()),</span>
<span class="p">});</span>
</code></pre></div></div>

<p>The helper function requires that a <code class="language-plaintext highlighter-rouge">HALResource</code> be supplied, along with a <code class="language-plaintext highlighter-rouge">Response</code> returned.
We shall define the structure of what a <code class="language-plaintext highlighter-rouge">HALResource</code> looks like within <code class="language-plaintext highlighter-rouge">src/types/index.js</code>.</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">export</span> <span class="nx">type</span> <span class="nx">HALResource</span> <span class="o">=</span> <span class="p">{</span>
  <span class="na">_links</span><span class="p">:</span> <span class="p">{</span> <span class="p">[</span><span class="nx">string</span><span class="p">]:</span> <span class="nx">any</span> <span class="p">},</span>
  <span class="na">toJSON</span><span class="p">:</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{},</span>
<span class="p">};</span>
</code></pre></div></div>

<p>Within our domain, a <code class="language-plaintext highlighter-rouge">HALResource</code> must provide a set of <code class="language-plaintext highlighter-rouge">_links</code> and a <code class="language-plaintext highlighter-rouge">toJSON</code> method, which converts the internal representation into JSON which can be consumed by the client.
We can now move on to covering this new handler with sufficient test coverage.
We will create a new test within <code class="language-plaintext highlighter-rouge">src/__tests__/bootstrap.js</code>, and ensure that the handler responds with the expected output, based on the supplied service definitions.</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="nx">handler</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">../handlers/bootstrap</span><span class="dl">'</span><span class="p">;</span>

<span class="nx">it</span><span class="p">(</span><span class="dl">'</span><span class="s1">displays the bootstrap details</span><span class="dl">'</span><span class="p">,</span> <span class="k">async</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="nx">services</span> <span class="o">=</span> <span class="p">{</span>
    <span class="na">getPoolId</span><span class="p">:</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="dl">'</span><span class="s1">POOL_ID</span><span class="dl">'</span><span class="p">,</span>
    <span class="na">getClientId</span><span class="p">:</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="dl">'</span><span class="s1">CLIENT_ID</span><span class="dl">'</span><span class="p">,</span>
    <span class="na">getBaseEndpointUrl</span><span class="p">:</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="dl">'</span><span class="s1">BASE_ENDPOINT_URL</span><span class="dl">'</span><span class="p">,</span>
  <span class="p">};</span>

  <span class="kd">const</span> <span class="nx">response</span> <span class="o">=</span> <span class="nx">parseResponse</span><span class="p">(</span><span class="k">await</span> <span class="nx">handler</span><span class="p">(</span><span class="nx">services</span><span class="p">)({},</span> <span class="p">{}));</span>

  <span class="nx">expect</span><span class="p">(</span><span class="nx">response</span><span class="p">.</span><span class="nx">statusCode</span><span class="p">).</span><span class="nx">toBe</span><span class="p">(</span><span class="mi">200</span><span class="p">);</span>
  <span class="nx">expect</span><span class="p">(</span><span class="nx">response</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">cognito</span><span class="p">.</span><span class="nx">poolId</span><span class="p">).</span><span class="nx">toBe</span><span class="p">(</span><span class="dl">'</span><span class="s1">POOL_ID</span><span class="dl">'</span><span class="p">);</span>
  <span class="nx">expect</span><span class="p">(</span><span class="nx">response</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">cognito</span><span class="p">.</span><span class="nx">clientId</span><span class="p">).</span><span class="nx">toBe</span><span class="p">(</span><span class="dl">'</span><span class="s1">CLIENT_ID</span><span class="dl">'</span><span class="p">);</span>
  <span class="nx">expect</span><span class="p">(</span><span class="nx">response</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">baseEndpointUrl</span><span class="p">).</span><span class="nx">toBe</span><span class="p">(</span><span class="dl">'</span><span class="s1">BASE_ENDPOINT_URL</span><span class="dl">'</span><span class="p">);</span>
<span class="p">});</span>
</code></pre></div></div>

<p>With this addition we can run <code class="language-plaintext highlighter-rouge">make test</code> locally to ensure the handler honours the agreement.
Committing these changes to the GitHub repository will in-turn invoke a new Travis CI build.
Finally, we can run <code class="language-plaintext highlighter-rouge">make deploy</code> to see this endpoint in action within our <code class="language-plaintext highlighter-rouge">dev</code> AWS stage.</p>

<p><img src="/uploads/posts/mince-pie-challenge-adding-the-bootstrap-endpoint-and-serverless-offline/online-bootstrap.png" alt="Online Bootstrap Endpoint" /></p>

<h3 id="adding-serverless-offline">Adding Serverless Offline</h3>

<p>We can now access this Bootstrap endpoint online within our <code class="language-plaintext highlighter-rouge">dev</code> AWS stage.
This is great - but wouldn’t it be even better if we could interact with this project locally!
In doing so, we would be able to quickly inspect the API’s behaviour without having to deploy the resources to AWS.
Once we are settled on the implementation, we could then deploy the changes to our online <code class="language-plaintext highlighter-rouge">dev</code> stage, and then subsequently <code class="language-plaintext highlighter-rouge">prod</code> when we wish to release it to the world.</p>

<p>To do this we will add Serverless Offline to our project, which locally emulates AWS Lambda and API Gateway.
Internally, it starts up a small HTTP server which handles request lifecycles like API Gateway does, invoking the desired handlers.
To start with, we shall add a new development dependency to the <code class="language-plaintext highlighter-rouge">package.json</code> file.</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"devDependencies"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"serverless-offline"</span><span class="p">:</span><span class="w"> </span><span class="s2">"^3.25.6"</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p>We can then update the <code class="language-plaintext highlighter-rouge">serverless.yml</code> configuration, amending the default stage (if one is not provided within command-line invocation) to be <code class="language-plaintext highlighter-rouge">offline</code>.
For the sake of clarity we will also specify the default <code class="language-plaintext highlighter-rouge">host</code> and <code class="language-plaintext highlighter-rouge">port</code> the Serverless Offline HTTP server should bind itself to.</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">provider</span><span class="pi">:</span>
  <span class="na">stage</span><span class="pi">:</span> <span class="s">${opt:stage, 'offline'}</span>

<span class="na">custom</span><span class="pi">:</span>
  <span class="na">serverless-offline</span><span class="pi">:</span>
    <span class="na">host</span><span class="pi">:</span> <span class="s">0.0.0.0</span>
    <span class="na">port</span><span class="pi">:</span> <span class="m">3000</span>
</code></pre></div></div>

<p>As we now wish to make container requests to port 3000, we will create an additional service exposing this port within the <code class="language-plaintext highlighter-rouge">docker-compose.yml</code> file.</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">services</span><span class="pi">:</span>
  <span class="na">serverless-offline</span><span class="pi">:</span>
    <span class="na">build</span><span class="pi">:</span> <span class="s">.</span>
    <span class="na">env_file</span><span class="pi">:</span> <span class="s">.env</span>
    <span class="na">ports</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">3000:3000</span>
    <span class="na">volumes</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">.:/opt/app</span>
      <span class="pi">-</span> <span class="s">app-modules:/opt/app/node_modules</span>
</code></pre></div></div>

<p>Subsequently, as we are now defaulting to a new <code class="language-plaintext highlighter-rouge">offline</code> stage, we must define the required configuration within a <code class="language-plaintext highlighter-rouge">config.offline.yml</code> file.</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">baseEndpointUrl</span><span class="pi">:</span> <span class="s1">'</span><span class="s">http://0.0.0.0:3000'</span>
<span class="na">userPoolId</span><span class="pi">:</span> <span class="s1">'</span><span class="s">OFFLINE_USER_POOL_ID'</span>
<span class="na">userPoolClientId</span><span class="pi">:</span> <span class="s1">'</span><span class="s">OFFLINE_USER_POOL_CLIENT_ID'</span>
</code></pre></div></div>

<p>As we do not wish to use the online Amazon Cognito instance whilst in the <code class="language-plaintext highlighter-rouge">offline</code> stage, we will provide static dummy pool identifiers instead.
We can then add a new target to <code class="language-plaintext highlighter-rouge">Makefile</code>, to correctly open the service ports and run the offline HTTP server.</p>

<div class="language-make highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nl">offline</span><span class="o">:</span>
  <span class="err">docker-compose</span> <span class="err">run</span> <span class="err">--service-ports</span> <span class="err">--rm</span> <span class="err">serverless-offline</span> <span class="err">sls</span> <span class="err">offline</span> <span class="nv">--stage</span><span class="o">=</span>offline
</code></pre></div></div>

<p>With his in place we can run <code class="language-plaintext highlighter-rouge">make offline</code>, you should now be able to access the offline endpoint by visiting <code class="language-plaintext highlighter-rouge">http://0.0.0.0:3000</code>.
Any changes that you now make to the handler implementation will be automatically represented within the offline instance, providing you with a much quicker development REPL cycle.</p>

<p><img src="/uploads/posts/mince-pie-challenge-adding-the-bootstrap-endpoint-and-serverless-offline/offline-bootstrap.png" alt="Offline Bootstrap Endpoint" /></p>

<p>We have now created our first Mince Pie Challenge API endpoint, which not only works within the online <code class="language-plaintext highlighter-rouge">dev</code> stage, but also is equipped to handle offline access.
Join me in the next post where we will be adding the ability to add and list Mince Pies to the API, using both an online and local <a href="https://aws.amazon.com/dynamodb/">Amazon DynamoDB</a> instance.</p>
