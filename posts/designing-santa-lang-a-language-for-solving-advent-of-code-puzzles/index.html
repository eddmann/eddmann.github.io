<!doctype html>
<html lang="en">
    <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="This article documents my experience developing a functional, C-like programming language for solving Advent of Code puzzles">

    <title>
        
            Designing santa-lang, a language for solving Advent of Code puzzles &middot; Edd Mann
        
    </title>

    <script async src="https://www.googletagmanager.com/gtag/js?id=G-ZPQ7WHNXH4"></script>
    <script>
       window.dataLayer = window.dataLayer || [];
       function gtag(){dataLayer.push(arguments);}
       gtag('js', new Date());
       gtag('config', 'G-ZPQ7WHNXH4');
    </script>

    <link rel="stylesheet" href="//fonts.googleapis.com/css?family=Source+Sans+Pro:400,700,700italic,400italic">
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <link rel="stylesheet" href="/styles.css">

    <link rel="shortcut icon" href="/favicon.ico">

    <link rel="alternate" href="/rss.xml" title="" type="application/rss+xml">

    
</head>

    <body>
        <div class="container content">
            <header class="masthead">
                <h3 class="masthead-title">
                    <a href="/" title="Home">Edd Mann</a>
                    <small><i class="fa fa-code"></i> Developer</small>
                </h3>
                <nav>
                    <a href="https://twitter.com/edd_mann"><i class="fa fa-twitter"></i></a>
                    <a href="https://github.com/eddmann"><i class="fa fa-github"></i></a>
                    <a href="mailto:the@eddmann.com"><i class="fa fa-envelope"></i></a>
                </nav>
                <div class="cf"></div>
            </header>

            <main>
                <article class="post">
    <h1 class="post-title">Designing santa-lang, a language for solving Advent of Code puzzles</h1>
    <time datetime="2022-11-30T00:00:00+00:00" class="post-date">30 Nov 2022</time>
    <p>Over the past several years I have been slowly working <a href="https://github.com/eddmann/advent-of-code/tree/master/2015">my</a> <a href="https://github.com/eddmann/advent-of-code/tree/master/2016/python">way</a> <a href="https://github.com/eddmann/advent-of-code/tree/master/2017/rust">through</a> the previous Advent of Code calendars.
For each calendar I opt to solve the puzzles in a new programming language, to familiarise myself with other ways of understanding and working.
However, there comes a time in each calendar that I grow to dislike some aspect of the language.
So I had an ideaâ€¦ why not give this whole programming language design a go.
That way if I grow to dislike the language, I only have myself to blame!</p>



<p><a href="https://github.com/eddmann/santa-lang-ts"><img style="max-width:350px;margin:0 auto;" src="/uploads/designing-santa-lang-a-language-for-solving-advent-of-code-puzzles/logo.png" alt="santa-lang" /></a></p>

<p>Welcome <em>santa-lang</em>, my <a href="https://en.wikipedia.org/wiki/Interpreter_(computing)">tree-walking interpreted</a> programming language designed to help tackle Advent of Code puzzles.
In this article I would like to discuss the high-level thought process and design considerations that went into building the initial language.</p>

<h2 id="the-design-specification">The Design Specification</h2>

<p>The first step I took was to clearly lay out the overall design goals of the language.
Having did a little research into how other languages had been formed and continued to grow, it looked as though the underlying core values and design principles shaped each new decision.
As such, I decided to compile a list of my desired direction and feature set for a language that would best help me solve Advent of Code puzzles.</p>

<h2 id="the-language">The Language</h2>

<ul>
  <li>Dynamically typed, C-like language with a rich suite of core types - integers, decimals, strings, lists, hash-maps, sets.</li>
  <li><a href="https://en.wikipedia.org/wiki/Persistent_data_structure">Persistent (Immutable) data-structures</a>, which follow the same value semantics as integers, decimals and strings.</li>
  <li>Cheap function/closure definition, composition and invocation - aided by the inclusion of <a href="https://en.wikipedia.org/wiki/Currying">auto-currying</a>,</li>
  <li>Everything is a function, with infix invocation being purely syntactic sugar i.e. <code class="language-plaintext highlighter-rouge">1 + 2</code> is boiled down to <code class="language-plaintext highlighter-rouge">+(1, 2)</code>.</li>
  <li>Everything is an expression, with the last statement within a block being its return value (by default) i.e. <code class="language-plaintext highlighter-rouge">let x = if y &gt; 5 { y } else { y - 1 }</code>.</li>
  <li>The ability to handle lazy sequences and infinite ranges.</li>
  <li>Rich suite of in-built functions targeting the core types and data-structures, following <a href="https://www.quora.com/Why-is-it-better-to-have-100-functions-operate-on-one-data-structure-than-10-functions-on-10-data-structures-on-Clojure">Clojureâ€™s philosophy</a>.</li>
  <li>No mutation, opting for readability and correctness over out right speed.</li>
</ul>

<h2 id="the-aoc-runner">The AoC Runner</h2>

<p>Whilst writing the list above, I soon realised that there was a differentiation between the core language requirements, and the Advent of Code <em>runner</em>/<em>runtime</em> in which it would be evaluated.
Thinking upon past experience whilst solving Advent of Code puzzles, and how a language runtime could aid in solution development, I devised the list below:</p>

<ul>
  <li>The source file can be optionally structured to represent the two parts of an Advent of Code solution.</li>
  <li>Based on this source file structure, there is an in-built test runner which can be used to validate test input supplied with a puzzle.</li>
  <li>Easy means of downloading, parsing and interacting with the puzzle input.</li>
  <li>The ability to run the written solutions within a Cli and Web-IDE based setting.</li>
  <li>Detailed error handling, with clear understanding of where the issue is within the source file.</li>
</ul>

<h2 id="the-initial-implementation">The Initial Implementation</h2>

<p>With my desired language and runtime goals laid out, I set off in developing the initial implementation.
Fortunately there are <a href="https://interpreterbook.com/">some</a> <a href="https://monkeylang.org/">amazing</a> <a href="https://craftinginterpreters.com/">resources</a> out there to help get started building your own programming language.
With respect to my runtime requirements (Cli and Web), and with the feeling that this journey would no doubt be a huge learning experience in itself;
I felt it best to opt for a host language I was comfortable in, as such, I chose <a href="https://github.com/eddmann/santa-lang-ts">TypeScript</a>.</p>

<h2 id="show-me-the-code">Show me the code?!</h2>

<p>One of the biggest takeaways from the initial development phase was the importance of spending time in the <a href="https://github.com/eddmann/santa-lang-ts/tree/main/src/lang">language</a> you are designing, and exercising its use within the domain you want to solve problems in.
In my case this was Advent of Code puzzles.
Below is such an example of this process, where I went about solving <a href="https://adventofcode.com/2020/day/1">day 1</a> of the 2020 calendar in <em>santa-lang</em>.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>input: read("aoc://2020/1")

part_one: {
  input
    |&gt; ints
    |&gt; combinations(2)
    |&gt; find(|[a, b]| a + b == 2020)
    |&gt; reduce(*);
}

part_two: {
  input
    |&gt; ints
    |&gt; combinations(3)
    |&gt; find(|[a, b, c]| a + b + c == 2020)
    |&gt; reduce(*);
}

test: {
  input: "1721\n979\n366\n299\n675\n1456"
  part_one: 514579
  part_two: 241861950
}
</code></pre></div></div>

<p>The source file has been structured to represent how an Advent of Code day puzzle is laid out.
The language formally includes the concept of <em>sections</em>, in which this case (aided by the <em>runner</em>) are used to define the <code class="language-plaintext highlighter-rouge">input</code>, <code class="language-plaintext highlighter-rouge">part_one</code>, <code class="language-plaintext highlighter-rouge">part_two</code> and <code class="language-plaintext highlighter-rouge">test</code> blocks.
Both <code class="language-plaintext highlighter-rouge">part_*</code> sections are supplied the resulting evaluation of the <code class="language-plaintext highlighter-rouge">input</code> section, within a global <code class="language-plaintext highlighter-rouge">input</code> variable.
The in-built <code class="language-plaintext highlighter-rouge">read</code> function is host runtime specific (Cli and Web), and provides a means to read the relevant input file (into a string) based on the use of the <code class="language-plaintext highlighter-rouge">aoc://</code> schema.
Tests added to help aid in the solution of the puzzle can be defined in <code class="language-plaintext highlighter-rouge">test</code> sections, with the expected answers being supplied for automatic test-runner validation.</p>

<p>Within the above example, you can see how we have exercised the languagesâ€™ function threading (<code class="language-plaintext highlighter-rouge">|&gt;</code>) and partial application support, list destructuring and use of rich built-in functions (<code class="language-plaintext highlighter-rouge">ints</code>, <code class="language-plaintext highlighter-rouge">combinations</code>).
The language itself pushes you towards a more functional mindset, declaring the puzzle solution as opposed to imperatively laying out each step.</p>

<p>Below are several other example solutions which exercise more of the built-in language and runtime constructs provided.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>input: read("aoc://2021/1")

let parse_measurements = lines &gt;&gt; map(int);

part_one: {
  let measures = parse_measurements(input);

  zip(measures, measures[1..])
    |&gt; count(|[a, b]| a &lt; b);
}

part_two: {
  let measures = parse_measurements(input);

  let windows = zip(measures, measures[1..], measures[2..])
    |&gt; map(sum);

  zip(windows, windows[1..])
    |&gt; count(|[a, b]| a &lt; b);
}

test: {
  input: "199\n200\n208\n210\n200\n207\n240\n269\n260\n263"
  part_one: 7
  part_two: 5
}
</code></pre></div></div>

<p>Within the above solution to <a href="https://adventofcode.com/2021/day/1">day 1</a> of the 2021 calendar, you can see use of function composition (<code class="language-plaintext highlighter-rouge">&gt;&gt;</code>), <code class="language-plaintext highlighter-rouge">let</code> bindings, named function definitions and list slicing.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>input: read("aoc://2015/1")

part_one: {
  input |&gt; fold(0) |floor, direction| {
    if direction == "(" { floor + 1 } else { floor - 1 };
  }
}

part_two: {
  zip(1.., input) |&gt; fold(0) |floor, [index, direction]| {
    let next = if direction == "(" { floor + 1 } else { floor - 1 };
    if next &lt; 0 { break index } else { next };
  }
}

test: {
  input: "()())"
  part_one: -1
  part_two: 5
}
</code></pre></div></div>

<p>Within the above solution to <a href="https://adventofcode.com/2015/day/1">day 1</a> of the 2015 calendar, you can see use of infinite ranges, <a href="https://kotlinlang.org/docs/lambdas.html#passing-trailing-lambdas">trailing Lambdaâ€™s</a>, <code class="language-plaintext highlighter-rouge">if</code> expressions and short-circuiting a fold operation early (inspired by <a href="https://clojuredocs.org/clojure.core/reduced">Clojureâ€™s</a> capability).</p>

<p>For more examples, check out the TypeScript implementations <a href="https://github.com/eddmann/santa-lang-ts#readme">README</a> and <a href="https://github.com/eddmann/santa-lang-ts/tree/main/examples">examples</a> directory.
One example of note is the re-implementation of <a href="https://github.com/eddmann/santa-lang-ts/blob/main/examples/map-filter-fold-reduce.santa">map, filter, fold and reduce</a> within the language itself - effectively highlighting use of pattern matching.</p>

<h2 id="the-cli-runtime">The Cli runtime</h2>

<p>Once I had built the <a href="https://github.com/eddmann/santa-lang-ts/tree/main/src/lang">core language</a> and <a href="https://github.com/eddmann/santa-lang-ts/tree/main/src/lang/src/runner">runner</a>, a lot of time was then focused on developing the <a href="https://github.com/eddmann/santa-lang-ts/tree/main/src/cli">Cli</a> runtime.
This was to ensure that I had the correct level of abstraction for what would be required as a runtime (Cli, Web) and core language/runner responsibility.</p>

<p>The resulting Cli is compiled into a single JavaScript artifact using <a href="https://esbuild.github.io/">esbuild</a>, and then subsequently packaged into a <a href="https://github.com/eddmann/santa-lang-ts/blob/main/src/cli/pkg.json">binary</a> distribution (using <a href="https://github.com/vercel/pkg">pkg</a>) and <a href="https://github.com/eddmann/santa-lang-ts/blob/main/src/cli/Dockerfile">Docker image</a>.
The inclusion of a Docker image provides me with the ability to easily run the <a href="https://github.com/eddmann/advent-of-code/blob/master/.github/workflows/2018-santa-lang-test.yml">test suite</a> within my GitHub Action CI environment, inline with other calendarâ€™s solutions.</p>

<p><img src="/uploads/designing-santa-lang-a-language-for-solving-advent-of-code-puzzles/cli-runtime.png" alt="Cli runtime" /></p>

<p>With the optional <code class="language-plaintext highlighter-rouge">-t</code> flag we are able to switch between exercising and validating the test input, and the real input.
Additionally, input and output (per runtime) is abstracted away from the core language.
In the case of the <a href="https://github.com/eddmann/santa-lang-ts/blob/main/src/cli/src/io.ts">Cli</a> I was able to optionally download (and locally cache) the userâ€™s puzzle input with the inclusion of a <code class="language-plaintext highlighter-rouge">SANTA_CLI_SESSION_TOKEN</code> environment variable.</p>

<p><img src="/uploads/designing-santa-lang-a-language-for-solving-advent-of-code-puzzles/cli-runtime-error.png" alt="Cli runtime error" /></p>

<p>One of my design goals was to ensure that it was easy to locate and determine errors found at runtime.
Aided by the error details the core language emits, I was able present errors and the source location in a concise manner.</p>

<h2 id="the-web-runtime">The Web runtime</h2>

<p>With the Cli runtime built, I then moved on to developing the <a href="https://github.com/eddmann/santa-lang-ts/tree/main/src/web">Web</a> runtime equivalent.</p>

<p><a href="https://eddmann.com/santa-lang-ts/"><img src="/uploads/designing-santa-lang-a-language-for-solving-advent-of-code-puzzles/web-runtime.png" alt="Web runtime" /></a></p>

<p>I opted to use <a href="https://nextjs.org/">Next.js</a> (purely out of interest, <a href="https://reactjs.org/docs/create-a-new-react-app.html">CRA</a> would have sufficed) and <a href="https://esbuild.github.io/">esbuild</a> to compile and package the resulting artifact.
Unlike the Cli, which only required source file location input, this version also needed a means for the user to enter a given solution.
For this I employed <a href="https://codemirror.net/">CodeMirror</a>, which has a great library with React bindings.
Upon solution execution, to not block the userâ€™s main browser thread, the language runtime is evaluated within a dedicated <a href="https://github.com/eddmann/santa-lang-ts/blob/main/src/web/worker.ts">web worker</a>.</p>

<h2 id="the-bonus-aws-lambda-runtime">The (bonus) AWS Lambda runtime</h2>

<p>After developing the language and initial Cli and Web runtimes, I took a little time off to focus on my annual <a href="https://eddmann.com/posts/allocating-secret-santas-using-an-aws-step-function-workflow-and-every-available-lambda-runtime/">allocating Secret Santaâ€™s</a> challenge.
This year I decided to combine every supported Lambda runtime into a Step Function workflow (becauseâ€¦ why not?!).
One such runtime was <code class="language-plaintext highlighter-rouge">provided.al2</code>, which provides a means of executing your own custom runtime.
With this project in my mind, I thought wouldnâ€™t it be cool to be able to run <em>santa-lang</em> within Lambda!
As such, I went about building a <a href="https://github.com/eddmann/santa-lang-ts/tree/main/src/lambda">Lambda</a> runtime which used a defined <em>section</em> to handle the given request.</p>

<p><img src="/uploads/designing-santa-lang-a-language-for-solving-advent-of-code-puzzles/lambda-runtime.png" alt="Lambda runtime" /></p>

<p>The runtime itself was packaged in a similar means to the Cli binary distribution (using <em>pkg</em>), except it honoured the <a href="https://github.com/eddmann/santa-lang-ts/blob/main/src/lambda/src/index.ts">Custom Runtime API</a> contract laid out for AWS Lambda.
This highlighted the languages versatility for not only solving Advent of Code puzzles (by way of the <em>runner</em>), but also being used as a general-purpose language.</p>

<h2 id="conclusion">Conclusion</h2>

<p>Upon reflection, I am very happy with how this project has begun!
I feel the choice to build the initial implementation in TypeScript was invaluable, as throughout the development and endless refinement stages (which still are ongoing) it has been frictionless experience.
With the inclusion of libraries such as <a href="https://immutable-js.com/">Immutable.js</a>, I have been able to delegate a lot of the ancillary <em>heavy lifting</em>, and focus on the core problem at hand.
The one caveat to this decision however, is due to choosing such a high-level host language, comes at the cost of performance.
But as performance was not a key design goal of this project (favouring readability and correctness) I feel this will suffice.</p>

<p>Another take away from this experience, is how the building blocks that compose the end language and runtime can all be built and tested at each isolated level.
For example, the <a href="https://github.com/eddmann/santa-lang-ts/tree/main/src/lang/src/lexer">lexer</a>, <a href="https://github.com/eddmann/santa-lang-ts/tree/main/src/lang/src/parser">parser</a>, <a href="https://github.com/eddmann/santa-lang-ts/tree/main/src/lang/src/evaluator">evaluator</a> and subsequent AoC <a href="https://github.com/eddmann/santa-lang-ts/tree/main/src/lang/src/runner">runner</a> are all separate concerns, built on top of base in which previous responsibility has formed.
I found that <a href="https://interpreterbook.com/">the book</a>, laid this concept out very well, and I borrowed a lot of inspiration from it.</p>

<p>On top of this, I have been able to define the specification and intended language behaviour all through the included tests.
This provides me not only with confidence in my current implementation, but also a blueprint to implement the language again (i.e. in another host language ðŸ˜‰).</p>

<h2 id="whats-next">Whatâ€™s nextâ€¦</h2>

<p>December is fast approaching, and that can only mean one thingâ€¦ another <a href="https://adventofcode.com/2022">Advent of Code calendar</a> is about to commence!
This year, I wish to use <em>santa-lang</em> as my primary language in solving as many of the calendars puzzles as possible.
In the new year I hope to reflect on this experience with a future article, detailing how this experience went.</p>

<p>Until next year! ðŸ‘‹</p>

</article>

            </main>

            <footer class="footer">
                <img src="https://www.gravatar.com/avatar/c5c2978bb14d16460f73399c394b6acd?s=160">
                <ul>
                    <li>Developer at <a href="http://www.mybuilder.com/">MyBuilder</a></li>
                    <li><a href="http://threedevsandamaybe.com/">Three Devs and a Maybe</a> podcast co-host</li>
                    <li>All ramblings can be found in the <a href="/archive/">Archive</a></li>
                </ul>
                <div class="cf"></div>
            </footer>
        </div>
    </body>
</html>
