<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><title>Managing Newlines and Unicode within JavaScript and PHP - Edd Mann</title>
<meta name=description content="Learn how to handle newline inconsistencies and Unicode character length differences between JavaScript and PHP to ensure accurate text processing."><meta name=author content="Edd Mann"><script async src="https://www.googletagmanager.com/gtag/js?id=G-ZPQ7WHNXH4"></script><script>var dnt,doNotTrack=!1;if(!1&&(dnt=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,doNotTrack=dnt=="1"||dnt=="yes"),!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-ZPQ7WHNXH4")}</script><meta itemprop=name content="Managing Newlines and Unicode within JavaScript and PHP"><meta itemprop=description content="We were recently sent a tweet regarding a text-area client/server-side length validation not correlating. After some detective work, we were able to find two issues that could have caused this to occur. In this post, I wish to discuss our findings and how we resolved each issue."><meta itemprop=datePublished content="2016-12-22T00:00:00+00:00"><meta itemprop=dateModified content="2016-12-22T00:00:00+00:00"><meta itemprop=wordCount content="534"><meta itemprop=keywords content="Javascript,Php"><meta property="og:url" content="https://eddmann.com/posts/managing-newlines-and-unicode-within-javascript-and-php/"><meta property="og:site_name" content="Edd Mann"><meta property="og:title" content="Managing Newlines and Unicode within JavaScript and PHP"><meta property="og:description" content="We were recently sent a tweet regarding a text-area client/server-side length validation not correlating. After some detective work, we were able to find two issues that could have caused this to occur. In this post, I wish to discuss our findings and how we resolved each issue."><meta property="og:locale" content="en_GB"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2016-12-22T00:00:00+00:00"><meta property="article:modified_time" content="2016-12-22T00:00:00+00:00"><meta property="article:tag" content="Javascript"><meta property="article:tag" content="Php"><meta name=twitter:card content="summary"><meta name=twitter:title content="Managing Newlines and Unicode within JavaScript and PHP"><meta name=twitter:description content="We were recently sent a tweet regarding a text-area client/server-side length validation not correlating. After some detective work, we were able to find two issues that could have caused this to occur. In this post, I wish to discuss our findings and how we resolved each issue."><meta name=twitter:site content="@edd_mann"><link rel=stylesheet href=/css/style.min.38ebe85b7a95b0ed5f3ec14e02666c3ac5666f40e38576814a1bdbdf87e4f477.css integrity="sha256-OOvoW3qVsO1fPsFOAmZsOsVmb0DjhXaBShvb34fk9Hc="><link rel=preload as=image href=/assets/x.svg><link rel=preload as=image href=/assets/github.svg><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=manifest href=/site.webmanifest><link rel=canonical href=https://eddmann.com/posts/managing-newlines-and-unicode-within-javascript-and-php/><script>(function(){document.documentElement.setAttribute("data-theme",localStorage.getItem("theme")||window.matchMedia("(prefers-color-scheme: dark)").matches&&"dark"||"light")})()</script><script src=/script.min.1052707861642a4eb63c758a2c16cbf5deb3b3ea2582f09f743a7d4c55fb9828.js integrity="sha256-EFJweGFkKk62PHWKLBbL9d6zs+olgvCfdDp9TFX7mCg=" defer></script></head><body><header class="site-header wrapper"><a href=https://eddmann.com/><h3 class=site-header__title>Edd Mann
<span style=--url:url(/assets/code.svg)>Developer</span></h3></a><button class=site-header__mobile-navigation-button type=button title="Toggle mobile site navigation" aria-label="Toggle mobile site navigation" aria-expanded=false aria-controls=site-navigation></button><div class=site-header__navigation id=site-navigation><nav aria-label="Primary navigation"><ul class=site-header__primary-navigation><li><a href=/archive>Archive</a></li><li><a href=/projects>Projects</a></li><li><a href=/about>About</a></li></ul></nav><nav aria-label="Social links"><ul class=site-header__social-navigation><li><a class=social-icon style=--url:url(/assets/x.svg) href=https://x.com/edd_mann rel="external noopener" target=_blank>Twitter (X)</a></li><li><a class=social-icon style=--url:url(/assets/github.svg) href=https://github.com/eddmann rel="external noopener" target=_blank>GitHub</a></li></ul></nav></div></header><main class=wrapper><article><header class=page-title><h1 class=transition-between-pages style=--id:managing-newlines-and-unicode-within-javascript-and-php>Managing Newlines and Unicode within JavaScript and PHP</h1><time class=post__time>Dec 22, 2016</time></header><main class=prose><p>We were recently sent a tweet regarding a text-area client/server-side length validation not correlating.
After some detective work, we were able to find two issues that could have caused this to occur.
In this post, I wish to discuss our findings and how we resolved each issue.</p><h2 id=newlines>Newlines</h2><p>The first issue we noticed was when newlines were present within the text-area input.
It seemed that client-side, newlines were being represented with a single character, whereas on the server, two were instead used.
Reading a section of the HTML5 specification confirmed our suspicions.</p><blockquote><p>The API value&mldr; is normalized so that line breaks use &ldquo;LF&rdquo; (U+000A) characters. Finally, there is the form submission value. It is normalized so that line breaks use U+000D CARRIAGE RETURN &ldquo;CRLF&rdquo; (U+000A) character pairs&mldr;
<a href=https://www.w3.org/TR/html5/forms.html#the-textarea-element rel="external noopener" target=_blank>https://www.w3.org/TR/html5/forms.html#the-textarea-element</a></p></blockquote><h2 id=unicode-characters>Unicode Characters</h2><p>The second issue we observed was when the text-area contained a character outside the <a href=https://en.wikipedia.org/wiki/Plane_%28Unicode%29#Basic_Multilingual_Plane rel="external noopener" target=_blank>Basic Multilingual Plane</a>.
There are a couple of <a href=https://mathiasbynens.be/notes/javascript-unicode rel="external noopener" target=_blank>very</a> <a href=https://mathiasbynens.be/notes/javascript-encoding rel="external noopener" target=_blank>interesting</a> <a href=https://mathiasbynens.be/notes/es6-unicode-regex rel="external noopener" target=_blank>articles</a> discussing Unicode support within JavaScript that I highly recommend reading.
In short, JavaScript represents strings as a collection of unsigned 16-bit integers.
This means that any character that does not fit within 16 bits (requiring a <a href=http://unicodebook.readthedocs.io/unicode_encodings.html#utf-16-surrogate-pairs rel="external noopener" target=_blank>surrogate pair</a>) will instead have a length of two when calling <code>.length</code>.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#e6db74>&#39;a&#39;</span>.<span style=color:#a6e22e>length</span>; <span style=color:#75715e>// 1
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#e6db74>&#39;üçï&#39;</span>.<span style=color:#a6e22e>length</span>; <span style=color:#75715e>// 2!
</span></span></span></code></pre></div><p>This can get even more confusing when you then wish to send that string to the server.
The general consensus is to use UTF-8 character encoding during transmission (default as of HTML5), and this means that a character can be represented with between one and four bytes.
So, in the case of the above examples, a naive <code>strlen</code> will return:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-php data-lang=php><span style=display:flex><span><span style=color:#a6e22e>strlen</span>(<span style=color:#e6db74>&#39;a&#39;</span>); <span style=color:#75715e>// 1
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>strlen</span>(<span style=color:#e6db74>&#39;üçï&#39;</span>); <span style=color:#75715e>// 4!
</span></span></span></code></pre></div><blockquote><p>The beauty of UTF-8 is that the ASCII character set can be represented with the identical single binary value.</p></blockquote><h2 id=newline-solution>Newline Solution</h2><p>With these two problems in mind, we set out to tackle them.
Regarding the newline issue, we decided that a newline would represent a single character within the supplied limit.
As the HTML5 standard handles this for us within the browser, all we are required to do is replace occurrences of CRLF on the server side.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-php data-lang=php><span style=display:flex><span><span style=color:#a6e22e>strlen</span>(<span style=color:#a6e22e>str_replace</span>(<span style=color:#e6db74>&#34;</span><span style=color:#ae81ff>\r</span><span style=color:#e6db74>&#34;</span>, <span style=color:#e6db74>&#39;&#39;</span>, $message)); <span style=color:#75715e>// 1
</span></span></span></code></pre></div><h2 id=unicode-solution>Unicode Solution</h2><p>That was relatively easy to resolve - now both newlines on the client and server side correlated with one another.
Next, we needed to address the Unicode issue - we had fortunately already resolved this on the server side thanks to the PHP <a href=http://php.net/manual/en/book.mbstring.php rel="external noopener" target=_blank><code>mb_*</code></a> functions.
As we had specified that our default encoding was UTF-8, we did not have to include the desired encoding upon invocation.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-php data-lang=php><span style=display:flex><span><span style=color:#a6e22e>mb_strlen</span>(<span style=color:#e6db74>&#39;üçï&#39;</span>); <span style=color:#75715e>// 1
</span></span></span></code></pre></div><blockquote><p>Instead of naively byte-processing the length of the string as <code>strlen</code> does, <code>mb_strlen</code> takes into consideration the encoding and is able to discern multi-byte characters.</p></blockquote><p>On the client side, we were still faced with the issue of characters containing a surrogate pair.
To handle this use case when calculating the length, we took inspiration from <a href=https://mathiasbynens.be/notes/javascript-unicode rel="external noopener" target=_blank>this</a> article.
We decided to replace any characters that lay outside of the BMP with a single one that did (in the case below, a simple &lsquo;_&rsquo;).
An alternative approach, if you were using ES6, would be to use <code>Array.from</code>, which correctly handles the character encoding used.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#e6db74>&#39;üçï&#39;</span>.<span style=color:#a6e22e>replace</span>(<span style=color:#e6db74>/[\uD800-\uDBFF][\uDC00-\uDFFF]/g</span>, <span style=color:#e6db74>&#39;_&#39;</span>).<span style=color:#a6e22e>length</span>; <span style=color:#75715e>// 1
</span></span></span></code></pre></div></main><footer class=post__tags><a href=/archive/tag/javascript>javascript</a><a href=/archive/tag/php>php</a></footer></article><div class="related-posts prose"><h3>Related Posts</h3><ul><li><a href=/posts/designing-immutable-concepts-with-transient-mutation-in-php/>Designing Immutable Concepts with Transient Mutation in PHP</a></li><li><a href=/posts/managing-background-processes-within-symfony/>Managing Background Processes within Symfony</a></li><li><a href=/posts/using-constraint-based-ordering-in-php/>Using Constraint-based Ordering in PHP</a></li><li><a href=/posts/throttling-and-debouncing-function-invocation-in-javascript/>Throttling and Debouncing Function Invocation in JavaScript</a></li><li><a href=/posts/an-array-column-re-indexing-trick-in-php/>An 'array_column' re-indexing trick in PHP</a></li></ul></div><div class=scroll-watcher></div></main><footer class="site-footer wrapper"><div>&copy; 2025, Edd Mann</div><button class=theme-toggle type=button title="Toggle theme" aria-label="Toggle theme"><svg fill="currentcolor" viewBox="0 0 32 32" role="img"><title>Theme toggle icon</title><desc>A circle representing the moon for toggling theme</desc><path d="M16 .5C7.4.5.5 7.4.5 16S7.4 31.5 16 31.5 31.5 24.6 31.5 16 24.6.5 16 .5zm0 28.1V3.4C23 3.4 28.6 9 28.6 16S23 28.6 16 28.6z"/></svg></button></footer></body></html>