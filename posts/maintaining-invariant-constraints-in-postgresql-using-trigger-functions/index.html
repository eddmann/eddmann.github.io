<!doctype html>
<html lang="en">
    <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Taking advantage of trigger functions to maintain complex invariant constraints in PostgreSQL">

    <title>
        
            Maintaining Invariant Constraints in PostgreSQL using Trigger Functions &middot; Edd Mann
        
    </title>

    <link rel="stylesheet" href="//fonts.googleapis.com/css?family=Source+Sans+Pro:400,700,700italic,400italic">
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <link rel="stylesheet" href="/styles.css">

    <link rel="shortcut icon" href="/favicon.ico">

    <link rel="alternate" href="/rss.xml" title="" type="application/rss+xml">

    

    <script>
        var _gaq=[['_setAccount','UA-32512081-1'],['_setDomainName','eddmann.com'],['_trackPageview']];
        (function() {
            var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
            ga.src = 'https://ssl.google-analytics.com/ga.js';
            var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
        })();
    </script>
</head>

    <body>
        <div class="container content">
            <header class="masthead">
                <h3 class="masthead-title">
                    <a href="/" title="Home">Edd Mann</a>
                    <small><i class="fa fa-code"></i> Developer</small>
                </h3>
                <nav>
                    <a href="https://twitter.com/edd_mann"><i class="fa fa-twitter"></i></a>
                    <a href="https://github.com/eddmann"><i class="fa fa-github"></i></a>
                    <a href="mailto:the@eddmann.com"><i class="fa fa-envelope"></i></a>
                </nav>
                <div class="cf"></div>
            </header>

            <main>
                <article class="post">
    <h1 class="post-title">Maintaining Invariant Constraints in PostgreSQL using Trigger Functions</h1>
    <time datetime="2016-03-03T00:00:00+00:00" class="post-date">03 Mar 2016</time>
    <p>Recently a feature I was working on required me to alter a unique constraint which existed upon a table column.
The invariant had now been weakened to allow storing of duplicate <code class="language-plaintext highlighter-rouge">email</code> addresses based on if they share an equivalent <code class="language-plaintext highlighter-rouge">link_id</code> (excluding NULL).
Sadly the ease in which I was able to add the general unique constraint had disappear.
However, I was able to take advantage of insertion/update triggers to again provide me with these invariant reassurances.

I should note that Iâ€™m in favor of having business critical constraints placed within the database layer, even if this seems like a blurring of responsibility between application logic and the data-store.</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">CREATE</span> <span class="k">OR</span> <span class="k">REPLACE</span> <span class="k">FUNCTION</span> <span class="n">valid_record_email_address</span><span class="p">()</span>
<span class="k">RETURNS</span> <span class="k">TRIGGER</span>
<span class="k">AS</span> <span class="err">$$</span>
<span class="k">BEGIN</span>
    <span class="n">IF</span> <span class="k">NEW</span><span class="p">.</span><span class="n">link_id</span> <span class="k">IS</span> <span class="k">NULL</span> <span class="k">AND</span> <span class="k">EXISTS</span> <span class="p">(</span><span class="k">SELECT</span> <span class="k">TRUE</span> <span class="k">FROM</span> <span class="n">records</span> <span class="k">WHERE</span> <span class="n">email</span> <span class="o">=</span> <span class="k">NEW</span><span class="p">.</span><span class="n">email</span> <span class="k">AND</span> <span class="n">id</span> <span class="o">!=</span> <span class="k">NEW</span><span class="p">.</span><span class="n">id</span><span class="p">)</span> <span class="k">THEN</span>
        <span class="n">RAISE</span> <span class="n">EXCEPTION</span> <span class="s1">'Unlinked records must have a unique email address'</span><span class="p">;</span>
    <span class="k">END</span> <span class="n">IF</span><span class="p">;</span>

    <span class="n">IF</span> <span class="k">NEW</span><span class="p">.</span><span class="n">link_id</span> <span class="k">IS</span> <span class="k">NOT</span> <span class="k">NULL</span> <span class="k">AND</span> <span class="k">EXISTS</span> <span class="p">(</span><span class="k">SELECT</span> <span class="k">TRUE</span> <span class="k">FROM</span> <span class="n">records</span> <span class="k">WHERE</span> <span class="n">link_id</span> <span class="o">!=</span> <span class="k">NEW</span><span class="p">.</span><span class="n">link_id</span> <span class="k">AND</span> <span class="n">email</span> <span class="o">=</span> <span class="k">NEW</span><span class="p">.</span><span class="n">email</span> <span class="k">AND</span> <span class="n">id</span> <span class="o">!=</span> <span class="k">NEW</span><span class="p">.</span><span class="n">id</span><span class="p">)</span> <span class="k">THEN</span>
        <span class="n">RAISE</span> <span class="n">EXCEPTION</span> <span class="s1">'Only linked records can have the same email address'</span><span class="p">;</span>
    <span class="k">END</span> <span class="n">IF</span><span class="p">;</span>

    <span class="k">RETURN</span> <span class="k">NEW</span><span class="p">;</span>
<span class="k">END</span>
<span class="err">$$</span> <span class="k">LANGUAGE</span> <span class="n">plpgsql</span><span class="p">;</span>
<span class="k">SQL</span><span class="p">;</span>
</code></pre></div></div>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">CREATE</span> <span class="k">TRIGGER</span> <span class="n">validate_record_email_address</span>
<span class="k">BEFORE</span> <span class="k">INSERT</span> <span class="k">OR</span> <span class="k">UPDATE</span> <span class="k">ON</span> <span class="n">records</span>
<span class="k">FOR</span> <span class="k">EACH</span> <span class="k">ROW</span>
    <span class="k">EXECUTE</span> <span class="k">PROCEDURE</span> <span class="n">valid_record_email_address</span><span class="p">();</span>
<span class="k">SQL</span><span class="p">;</span>
</code></pre></div></div>

<p>As you can see within PostgreSQL we are able to write extremely clear trigger functions which can be used to alter actions that occur in the database.
We hope that the application layer will safe-guard us from an attempt to break this invariant, but as this is a critical area of our domain we can provide another level of validation just to make sure.</p>

</article>

            </main>

            <footer class="footer">
                <img src="https://www.gravatar.com/avatar/c5c2978bb14d16460f73399c394b6acd?s=160">
                <ul>
                    <li>Developer at <a href="http://www.mybuilder.com/">MyBuilder</a></li>
                    <li><a href="http://threedevsandamaybe.com/">Three Devs and a Maybe</a> podcast co-host</li>
                    <li>All ramblings can be found in the <a href="/archive/">Archive</a></li>
                </ul>
                <div class="cf"></div>
            </footer>
        </div>
    </body>
</html>
