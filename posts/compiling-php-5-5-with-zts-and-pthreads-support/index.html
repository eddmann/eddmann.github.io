<!doctype html>
<html lang="en">
    <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Compiling PHP 5.5 from source, with ZTS and pthreads support on CentOS 6.5">

    <title>
        
            Compiling PHP 5.5 with ZTS and pthreads Support &middot; Edd Mann
        
    </title>

    <link rel="stylesheet" href="//fonts.googleapis.com/css?family=Source+Sans+Pro:400,700,700italic,400italic">
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <link rel="stylesheet" href="/styles.css">

    <link rel="shortcut icon" href="/favicon.ico">

    <link rel="alternate" href="/rss.xml" title="" type="application/rss+xml">

    

    <script>
        var _gaq=[['_setAccount','UA-32512081-1'],['_setDomainName','eddmann.com'],['_trackPageview']];
        (function() {
            var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
            ga.src = 'https://ssl.google-analytics.com/ga.js';
            var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
        })();
    </script>
</head>

    <body>
        <div class="container content">
            <header class="masthead">
                <h3 class="masthead-title">
                    <a href="/" title="Home">Edd Mann</a>
                    <small><i class="fa fa-code"></i> Developer</small>
                </h3>
                <nav>
                    <a href="https://twitter.com/edd_mann"><i class="fa fa-twitter"></i></a>
                    <a href="https://github.com/eddmann"><i class="fa fa-github"></i></a>
                    <a href="mailto:the@eddmann.com"><i class="fa fa-envelope"></i></a>
                </nav>
                <div class="cf"></div>
            </header>

            <main>
                <article class="post">
    <h1 class="post-title">Compiling PHP 5.5 with ZTS and pthreads Support</h1>
    <time datetime="2014-01-30T00:00:00+00:00" class="post-date">30 Jan 2014</time>
    <p><a href="http://en.wikipedia.org/wiki/POSIX_Threads">POSIX Threads</a> are a standard for threading implementations available in many Unix-like operating systems.
Written in C they provide developers with high-level thread management methods, synchronization etc. 
Support for these methods in PHP is provided by an extension called <a href="http://pthreads.org/">pthreads</a>, enabling user-land multi-threaded applications to be built.
Designed in a similar manner to the implementation specified in Java, PHP can now ‘can create, read, write, execute and synchronize with Threads, Workers and Stackables’.
This is a major step in the right direction for PHP development, providing better suited solutions than simply <a href="http://en.wikipedia.org/wiki/Fork_(system_call)">forking</a> (process copying).
To experiment with this extension however, it is required to have a PHP built with ZTS enabled (Thread-safety support).
This option can only be specified at compile-time and as such I felt that it would be an ideal time to provide a simple guide to compile PHP from source.
For this example I am working with a base CentOS 6.5 installation.</p>

<h2 id="compiling-php-55-with-zts-support">Compiling PHP 5.5 with ZTS Support</h2>

<p>To compile PHP from source we must first make sure the development tools required are present (such as GCC).
One issue that cropped up when trying to install the ‘Development Tools’ group was the complaint of not having access to kernel packages.
To overcome this problem I simply removed ‘kernal*’ from the excluded list provided in ‘/etc/yum.conf’.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">sed</span> <span class="nt">-i</span> <span class="s2">"s/^</span><span class="se">\e</span><span class="s2">xclude.*</span><span class="nv">$/</span><span class="s2">exclude=/g"</span> /etc/yum.conf
<span class="nv">$ </span>yum groupinstall <span class="nt">-y</span> <span class="s1">'Development Tools'</span>
</code></pre></div></div>

<p>Looking at the first command above we remove all excludes that have currently been set, in my case this was only ‘kernal*’, but I recommend you check your setup first.
We are now able to install the required packages to download the compressed source code and compile the XML library provided in PHP.
I decided to set a global variable with the desired version of PHP I wished to compile, making the command listing more flexible when updates arise.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ VERSION</span><span class="o">=</span>5.5.8 <span class="c"># set version</span>
<span class="nv">$ </span>yum <span class="nb">install</span> <span class="nt">-y</span> wget libxml2-devel
<span class="nv">$ </span><span class="nb">cd</span> /usr/local/src
<span class="nv">$ </span>wget http://www.php.net/distributions/php-<span class="nv">$VERSION</span>.tar.gz
<span class="nv">$ </span><span class="nb">tar </span>zxvf php-<span class="nv">$VERSION</span>.tar.gz
<span class="nv">$ </span><span class="nb">cd</span> /usr/local/src/php-<span class="nv">$VERSION</span>
<span class="nv">$ </span>./configure <span class="nt">--prefix</span><span class="o">=</span>/usr <span class="nt">--with-config-file-path</span><span class="o">=</span>/etc <span class="nt">--enable-maintainer-zts</span>
<span class="nv">$ </span>make
<span class="nv">$ </span>make <span class="nb">install</span>
<span class="nv">$ </span><span class="nb">cp </span>php.ini-development /etc/php.ini
</code></pre></div></div>

<p>We download and uncompress the source code into the preferred ‘/usr/local/src’ directorty.
From here we configure the build to meet are requirements.
As I only desire to use this build to test pthreads (on the CLI) I only specify that the binary file should be placed in ‘/usr/bin’, configuration location at ‘/etc’ and enable ZTS.
With the options in place, we can now make the build and then install the compilation using the provided Makefile.
Finally I copy across the development ‘php.ini’ file to the specified ‘/etc’ directory.</p>

<h2 id="compiling-pthreads-extension">Compiling pthreads Extension</h2>

<p>PHP comes with <a href="http://pecl.php.net/">PECL</a> (PHP Extension Community Library) command support by default, which saves us the hassle of having to compile the extension manually.
We can instead just run the installation command below.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>pecl <span class="nb">install </span>pthreads
<span class="nv">$ </span><span class="nb">echo</span> <span class="s2">"extension=pthreads.so"</span> <span class="o">&gt;&gt;</span> /etc/php.ini
</code></pre></div></div>

<p>With the extension now successfully installed, we must now include the extension to be loaded in the ‘php.ini’ configuration file.
We can test that the extension has been successfully loaded with the PHP interpretor by running and inspecting the output from the following command.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>php <span class="nt">-m</span> | <span class="nb">grep </span>pthreads
</code></pre></div></div>

<h2 id="resources">Resources</h2>

<ul>
  <li><a href="http://docs.php.net/manual/en/book.pthreads.php">pthreads</a></li>
  <li><a href="https://github.com/krakjoe/pthreads">Github: pthreads</a></li>
  <li><a href="http://benramsey.com/blog/2012/03/build-php-54-on-centos-62/">Build PHP 5.4 on CentOS 6.2</a></li>
</ul>

</article>

            </main>

            <footer class="footer">
                <img src="https://www.gravatar.com/avatar/c5c2978bb14d16460f73399c394b6acd?s=160">
                <ul>
                    <li>Developer at <a href="http://www.mybuilder.com/">MyBuilder</a></li>
                    <li><a href="http://threedevsandamaybe.com/">Three Devs and a Maybe</a> podcast co-host</li>
                    <li>All ramblings can be found in the <a href="/archive/">Archive</a></li>
                </ul>
                <div class="cf"></div>
            </footer>
        </div>
    </body>
</html>
